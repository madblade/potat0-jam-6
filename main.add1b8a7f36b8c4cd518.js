(self.webpackChunkpotat0_jam_6=self.webpackChunkpotat0_jam_6||[]).push([[179],{370:(e,t,n)=>{"use strict";function i(e){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}n(493);var a=function(e,t){if("object"!==i(e)||"object"!==i(t))throw Error("[Extend] Could not extend ".concat(e," with ").concat(t,"."));for(var n in t)if(t.hasOwnProperty(n)){var a=t[n];if(e.hasOwnProperty(n))throw Error("[Extend] Tried to override existing property ".concat(n));if(n in e){if(!e.super)throw Error("[Extend] Cannot add ".concat(n," to super."));e.super[n]=e[n]}if("function"!=typeof a)throw Error("[Extend] Could not extend prototype with ".concat(a));e[n]=a}},o=function(e,t){if("function"!=typeof e||"function"!=typeof t)throw Error("[Inherit] Could not inherit from/to non-function: ".concat(e," / ").concat(t,"."));e.prototype=Object.assign(Object.create(t.prototype),{constructor:e,super:Object.create(null)})},r=function(e,t){e||console.warn("[assert failed] ".concat(t))},s=n(755),l=n.n(s);l().fn.center=function(){this.css("position","absolute");var e=Math.max(0,(l()(window).height()-l()(this).outerHeight())/2+l()(window).scrollTop()),t=Math.max(0,(l()(window).width()-l()(this).outerWidth())/2+l()(window).scrollLeft());return this.css("left","".concat(t,"px")),this.css("top","".concat(e,"px")),this},l()(window).resize((function(){l()("#announce").center(),l()(".settings").center()}));var c=function(e){this.stateManager=e,this.stateName="ingame"};a(c.prototype,{start:function(){l()("#announce").removeClass().empty(),this.stateManager.app.engine.ux.setGamePaused(!1)},end:function(){var e=this.stateManager.app,t=e.engine.controls,n=e.engine.ux;return e.engine.graphics.rendererManager.setInTitleScene(!1),t.stopListeners(),t.stopKeyboardInteraction(),n.setGamePaused(!0),new Promise((function(e){l()("#announce").empty(),e()}))},navigate:function(){console.warn("[States/Ingame] Should not be able to navigate menus whilst in-game.");var e=this.stateManager.app.engine.controls;e.stopListeners(),e.requestStartControls()}});var h=function(e){this.stateManager=e,this.stateName="loading",this.html='\n        <div class="container"> <div class="col-12">\n\n            <div class="flex-fill title noselect loading-menu">\n                <p>Chargement…</p>\n            </div>\n            <div class="flex-fill loading-menu" id="loading-task"></div>\n            <div class="flex-fill progress">\n                <div id="loading-progress" class="progress-bar progress-bar-striped"\n                    role="progressbar"\n                    aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">\n                </div>\n            </div>\n            <div class="loading-menu" id="loading-file"></div>\n\n        </div> </div>\n        ',this.progressElement=null,this.taskElement=null};a(h.prototype,{start:function(){l()("#announce").empty().removeClass().addClass("main-menu").append(this.html).css("position","").show(),this.progressElement=l()("#loading-progress"),this.taskElement=l()("#loading-task")},end:function(){return new Promise((function(e){l()("#announce").empty(),e()}))},notifyTaskName:function(e){this.taskElement&&this.taskElement.html("Chargement des fichiers “".concat(e,"”…"))},notifyProgress:function(e,t,n){var i=Math.floor(100*parseFloat(t)/parseFloat(n));this.progressElement||(this.progressElement=l()("#loading-progress")),this.progressElement&&this.progressElement.attr("aria-valuenow",i).css("width","".concat(i,"%"));var a=l()("#loading-file");a&&a.html(e)},notifyError:function(e){console.log("[States/Loading] There was an error loading ".concat(e,"."))},navigate:function(){}});var d=function(e){this.stateManager=e,this.stateName="settings"};a(d.prototype,{start:function(){this.stateManager.app.engine.settings.run()},end:function(){return this.stateManager.app.engine.settings.stop()},navigate:function(e){this.stateManager.app.engine.settings.navigate(e)}});var u=function(e){this.activeItem=0,this.maxActiveItem=e-1};a(u.prototype,{selectItems:function(){throw Error("[Navigable] selectItems is abstract.")},navigate:function(e){this.settingsModule?this.settingsModule.gamepadActive=!0:this.stateManager&&(this.stateManager.app.engine.settings.gamepadActive=!0);var t=!1;return"up"===e?(this.activeItem--,this.activeItem<0&&(this.activeItem=this.maxActiveItem),t=!0,this.highlightActiveItem()):"down"===e?(this.activeItem++,this.activeItem>this.maxActiveItem&&(this.activeItem=0),t=!0,this.highlightActiveItem()):"enter"===e?(t=!0,this.clickActiveItem()):"back"===e&&(t=!0,this.clickReturn()),t},highlightActiveItem:function(){var e=this.selectItems();if(!(e.length<1))for(var t=this.activeItem,n=0;n<e.length;++n)n===t?e[n].addClass("gamepad-selected"):e[n].removeClass("gamepad-selected")},clickActiveItem:function(){var e=this.selectItems();e.length<1||e[this.activeItem].trigger("click")},clickReturn:function(){var e=l()("#return");e&&e.trigger("click")}});var p='\n<div class="container small-title">\n    <h2>'.concat("Rad","</h2>\n</div>\n"),m=function(e){this.stateManager=e,this.stateName="main",this.htmlHead='\n        <div class="container">\n        ',this.htmlTail="</div>",u.call(this,3)};o(m,u),a(m.prototype,{getMainMenuHTML:function(){var e=this.stateManager.app.engine.settings.gamepadActive,t=this.activeItem;return'\n            <div class="col-12"><div class="col-12">\n\n            <div class="row mt-3">\n                <div class="col-4"></div>\n                <div id="volume-control-wrapper"\n                    class="input-group mb-1 center-block col-4 slider-container '.concat(this.hl(e,t,0),'">\n                    <div class="col-2" id="volume-status"><i class="fas fa-volume-mute fa-2x"></i></div>\n                    <div class="col-10 input-group-append flex-fill">\n                        <input type="range" min="0" max="100" value="0" class="slider"\n                            id="main-volume-controller">\n                    </div>\n                </div>\n            </div>\n\n            <div class="input-group mb-1 center-block" id="play-quick">\n                <div class="input-group-append flex-fill">\n                    <button id="button-play"\n                        class="btn btn-outline-secondary flex-fill ').concat(this.hl(e,t,1),'"\n                        type="button">Nouvelle Partie</button>\n                </div>\n            </div>\n\n            <div class="input-group mb-1 center-block" id="load">\n                <div class="input-group-append flex-fill">\n                    <button id="button-load"\n                        class="btn btn-outline-secondary flex-fill ').concat(this.hl(e,t,2),'"\n                        type="button">Charger</button>\n                </div>\n            </div>\n\n\n            <div class="row mt-3" id="gamepad-detector">\n                ').concat(this.getDetectGamepadHTML(e),"\n            </div>\n\n            </div></div>\n        ")},getDetectGamepadHTML:function(e){return e?'\n            <div class="col-4"></div>\n            <div class="col-4 mb-1 center-block gamepad-status">\n                <div class="col-3">\n                    <span class="fa-stack fa-2x">\n                        <i class="fas fa-gamepad fa-stack-1x"></i>\n                    </span>\n                </div>\n                <div class="col-9 input-group-append flex-fill">\n                    Manette détectée.\n                </div>\n            </div>\n            ':'\n            <div class="col-4"></div>\n                <div class="col-4 mb-1 center-block gamepad-status">\n                    <div class="col-3">\n                        <span class="fa-stack fa-2x">\n                            <i class="fas fa-gamepad fa-stack-1x"></i>\n                            <i class="fa fa-ban fa-stack-1x nested-icon"></i>\n                        </span>\n                    </div>\n                    <div class="col-9 input-group-append flex-fill">\n                        Aucune manette détectée.\n                    </div>\n                </div>\n            '},updateGamepadStatus:function(){var e=this.stateManager.app.engine.settings.gamepadActive;l()("#gamepad-detector").html(this.getDetectGamepadHTML(e))},hl:function(e,t,n){return e&&t===n?"gamepad-selected":""},startListeners:function(){var e=this,t=this.stateManager.app,n=t.engine.audio,i=l()("#button-play");i.click((function(){t.engine.ux.startNewGame()})),i.mouseenter((function(){n.playMenuSound()}));var a=l()("#button-load");a.click((function(){e.stateManager.setState("level-select")})),a.mouseenter((function(){n.playMenuSound()})),t.engine.settings.audioMenu.startVolumeController(),t.engine.graphics.run()},start:function(){l()("#announce").empty().removeClass().addClass("main-menu").append(this.htmlHead+this.getMainMenuHTML()+this.htmlTail).center().show(),this.startListeners()},stopListeners:function(){var e=l()("#button-play");e.off("click"),e.off("mouseenter");var t=l()("#button-load");t.off("click"),t.off("mouseenter"),this.stateManager.app.engine.settings.audioMenu.stopVolumeController()},end:function(){return this.stopListeners(),new Promise((function(e){l()("#announce").empty(),e()}))},selectItems:function(){return[l()("#volume-control-wrapper"),l()("#button-play"),l()("#button-load")]},navigate:function(e){if(this.super.navigate.call(this,e),0===this.activeItem){var t=this.stateManager.app.engine.audio,n=l()("#main-volume-controller"),i=l()("#volume-status");if("right"===e||"left"===e){var a=t.getVolume(),o="right"===e?Math.min(a+.05,1):Math.max(a-.05,0);t.setVolume(o),0===o?i.html('<i class="fas fa-volume-mute fa-2x">'):(i.html('<i class="fas fa-volume-up fa-2x">'),t.playText(" Cxy")),n.val(Math.floor(100*o))}else if("enter"===e)if(t.isMute()){var r=Math.floor(100*t.getVolume());n.val(r),i.html('<i class="fas fa-volume-up fa-2x">'),t.unMute()}else i.html('<i class="fas fa-volume-mute fa-2x">'),t.mute()}}});var f=function(e){this.stateManager=e,this.stateName="level-select",this.htmlHead='\n    <div class="container">\n        '.concat(p,"\n    "),this.htmlControls='\n    <div class="container">\n\n        <hr />\n\n        \x3c!-- Current progress --\x3e\n        \x3c!-- <div class="input-group">--\x3e\n        \x3c!--     <div class="input-group-prepend mb-1 flex-fill">--\x3e\n        \x3c!--         <span class="input-group-text flex-fill">Last Checkpoint</span>--\x3e\n        \x3c!--     </div>--\x3e\n        \x3c!--     <div class="input-group-append mb-1">--\x3e\n        \x3c!--         <button class="btn btn-outline-light"--\x3e\n        \x3c!--             id="button-resume" style="float:none">--\x3e\n        \x3c!--             Charger--\x3e\n        \x3c!--         </button>--\x3e\n        \x3c!--     </div>--\x3e\n        \x3c!-- </div>--\x3e\n\n        \x3c!-- <div class="input-group">--\x3e\n        \x3c!--     <div class="custom-file">--\x3e\n        \x3c!--         <input type="file" class="custom-file-input" id="load-game-path" disabled>--\x3e\n        \x3c!--         <label class="custom-file-label" for="customFileLang">Import Save File (coming soon)</label>--\x3e\n        \x3c!--     </div>--\x3e\n\n        \x3c!--     <div class="input-group-append mb-1">--\x3e\n        \x3c!--         <button class="btn btn-outline-light" id="button-load-game" style="float:none" disabled>--\x3e\n        \x3c!--             Import--\x3e\n        \x3c!--         </button>--\x3e\n        \x3c!--     </div>--\x3e\n        \x3c!-- </div>--\x3e\n\n        <div class="input-group">\n            <button class="btn btn-outline-secondary btn-block" id="return">\n                Retour\n            </button>\n        </div>\n    </div>\n      ',u.call(this,2)};o(f,u),a(f.prototype,{getCommandsHTML:function(){return this.htmlControls},getInstancesHTMLContainer:function(){return'\n            <div class="container" id="game-instances-table">\n                '.concat(this.getInstancesHTMLTable(),"\n            </div>\n        ")},getInstancesHTMLTable:function(){var e='\n            <hr/>\n            <div class="noselect"\n            style="width:100%"><div class="row">',t=this.stateManager.app,n=t.model.levels.getLevels();if(n)for(var i=n.length,a=t.engine.ux.playerState.getFarthestLevel(),o=0;o<i;++o){var r=n[o],s=r.getID()<=a,l=s?r.getTitle():"???";e+='\n                    <div class="col col-4">\n                        <div class="input-group">\n                            <div class="input-group-prepend mb-1 flex-fill">\n                                <span class="input-group-text flex-fill">'.concat(l,'</span>\n                            </div>\n                            <div class="input-group-append mb-1">\n                                <button class="btn btn-outline-light level-join"\n                                    id="button-join-level-').concat(o,'" style="float:none"  ').concat(s?"":"disabled",">\n                                    Charger\n                                </button>\n                            </div>\n                        </div>\n                    </div>\n                ")}return e+"</div></div>"},start:function(){l()("#announce").empty().removeClass().addClass("level-select").append(this.htmlHead+this.getInstancesHTMLContainer()+this.getCommandsHTML()).center().show();var e=this.stateManager.app.engine.ux.playerState.getFarthestLevel();this.maxActiveItem=2+(e+1)-1,this.startListeners()},startTableListeners:function(){var e=this.stateManager.app;l()(".level-join").click((function(){var t=l()(this).attr("id").substring("button-join-level-".length),n=parseInt(t,10),i=e.engine.ux,a=e.model.levels.getLevel(n);"Générique"===a.getTitle()?i.app.engine.audio.playCredits():i.app.engine.audio.playMusic(),i.joinLevel(a)}))},startListeners:function(){var e=this.stateManager.app;this.startTableListeners(),l()("#return").click((function(){e.setState("main")}))},stopTableListeners:function(){l()(".level-join").off("click")},stopListeners:function(){this.stopTableListeners(),l()("#button-return-main").off("click")},end:function(){return this.stopListeners(),new Promise((function(e){l()("#announce").empty().removeClass("hub"),e()}))},navigate:function(e){this.super.navigate.call(this,e),"back"===e&&l()("#return").trigger("click")},selectItems:function(){var e=this.stateManager.app,t=[];if(e.model.levels.getLevels())for(var n=e.engine.ux.playerState.getFarthestLevel(),i=0;i<=n;++i){var a="#button-join-level-".concat(i);t.push(l()(a))}return t.push(l()("#return")),t}});var g=function(e){this.stateManager=e,this.stateName="preingame",this.html='\n        <table class="table border rounded noselect" style="width:100%">\n            <tr id="request-pl"><td>Cliquez ici pour jouer</td></tr>\n        </table>\n    '};a(g.prototype,{start:function(){var e=this;l()("#announce").empty().removeClass().addClass("settings").append(this.html).center().show(),l()("#request-pl").click((function(){var t=e.stateManager;t.setState("ingame"),t.app.engine.controls.requestStartControls(),t.app.setFocused(!0)}))},end:function(){return l()("#request-pl").off("click"),new Promise((function(e){l()("#announce").empty().removeClass("settings"),e()}))},navigate:function(e){"enter"===e&&l()("#request-pl").trigger("click")}});var v=function(e){this.app=e,this.states={},this.previousState="",this.state="",this.focus=!1,this.registerState(new c(this)),this.registerState(new h(this)),this.registerState(new d(this)),this.registerState(new f(this)),this.registerState(new m(this)),this.registerState(new g(this))};v.prototype.register=[],a(v.prototype,{registerState:function(e){var t=e.stateName;this.states.hasOwnProperty(t)||(this.states[t]=e)},setState:function(e,t){this.previousState=this.state,this.state=e,this.states.hasOwnProperty(this.state)?this.states.hasOwnProperty(this.previousState)?this.states[this.previousState].end().then(function(){var e=this.states[this.state];e.start.bind(e)(t)}.bind(this)):this.states[this.state].start(t):console.error('[StateManager] State "'.concat(e,'" does not exist.'))},getState:function(e){if(this.states.hasOwnProperty(e))return this.states[e];console.error('[StateManager] State "'.concat(e,' does not exist."'))},navigate:function(e){var t=this.state;if(this.states.hasOwnProperty(t)){var n=this.states[t];n.navigate?n.navigate(e):console.error('[StateManager] State "'.concat(t,'" does not implement navigate().'))}},cleanupDOM:function(){l()("#announce").empty(),l()("#container").empty(),l()("#position").empty(),l()("#chat").empty(),l()("#mini-map").empty(),l()("#items").empty(),l()("#hud").empty()}});var y=n(219),w=n(212),b={preload:function(){var e=this;return this.initLoadingManager(),this.loadTextures(),this.loadReferenceMeshes(),this.initPhysics(),this.animationManager.initializeAnimations(),this.initAudio(),new Promise((function(t){setTimeout((function(){return e.resolveIfLoaded(t)}),100)}))},initPhysics:function(){this.app.engine.physics.preload()},initAudio:function(){this.app.engine.audio.preload(this.loadingManager)},initLoadingManager:function(){var e=this.app.state.getState("loading");this.loadingManager=new w.lLk,this.loadingManager.onProgress=function(t,n,i){e&&e.notifyProgress(t,n,i),console.log("[Graphics/Loader] Loading file ".concat(t," (").concat(n," of ").concat(i,")."))},this.loadingManager.onStart=function(t,n,i){e&&e.notifyProgress(t,n,i),console.log("[Graphics/Loader] Started loading ".concat(t," (").concat(n," of ").concat(i,")."))},this.loadingManager.onLoad=function(){console.log("[Graphics/Loader] Loading complete!")},this.loadingManager.onError=function(t){e&&e.notifyError(t),console.log("[Graphics/Loader] There was an error loading ".concat(t,"."))}},resolveIfLoaded:function(e){var t=this;this._nbTexturesLoaded===this._nbTexturesToLoad&&this._nbMeshesToLoad===this._nbMeshesLoadedOrError&&this.app.engine.physics.isLoaded&&this.app.engine.audio.isDoneLoadingSounds()?(console.log("[Graphics/Core] Everything loaded."),e()):setTimeout((function(){return t.resolveIfLoaded(e)}),100)},run:function(){this.initializeDOM(),this.fps=this.fps||new y.Z,this.initializeCameras(),this.resize(),this.requestId&&cancelAnimationFrame(this.requestId),this.animate()},initializeDOM:function(){this.container=document.getElementById("container"),this.container.appendChild(this.rendererManager.renderer.domElement)},animate:function(){var e=this.app.model.frontend,t=this.app.model.backend,n=this.app.engine.controls,i=this.app.engine.physics,a=this.app.engine.ai,o=this.animationManager,r=this.app.engine.ux;if(this.requestId=requestAnimationFrame(this.animate.bind(this)),r.refresh(),r.isGamePaused())n.updateControlsDevice(0);else{a.refresh(),e.refresh();var s=i.refresh();t.refresh(),n.updateControlsDevice(s),this.refreshMainCamera(s),o.refresh(s),this.render(s),o.restore(),this.fps.update()}},refreshMainCamera:function(e){this.processPortalUpdates(),this.cameraManager.refresh(e)},render:function(e){var t=this.sceneManager,n=this.cameraManager;this.rendererManager.render(t,n,e)},pingStandalone:function(){var e=this.app.standalone;if(e){var t=e.server;t&&e.isRunning()&&(this.now=Date.now(),this.elapsed=this.now-(this.then||0),this.elapsed>16&&(this.then=this.now-this.elapsed%16,t._updateGameLoops()))}},stop:function(){},cleanupFullGraphics:function(){this.sceneManager.cleanup(),this.cameraManager.cleanup(),this.rendererManager.cleanup(),this.animationManager.cleanup()},resize:function(){var e=window.innerWidth,t=window.innerHeight;this.cameraManager.resize(e,t),this.rendererManager.resize(e,t),this.sceneManager.resize(e,t)},initializeCameras:function(){var e=this.app.model.backend.selfModel.worldId,t=this.cameraManager.mainCamera;t.setThirdPerson(),this.animationManager.currentCameraPosition.copy(t.getCameraPosition()),this.addToScene(t.get3DObject(),e),this.addToScene(this.cameraManager.mainRaycasterCamera.get3DObject(),e)},getCameraInteraction:function(){return this.app.model.frontend.getCameraInteraction()}},x={DIRECTIONAL:.5,HEMISPHERE:.125,AMBIENT:1},M=Object.freeze({DIRECTIONAL:16777215,AMBIENT:16777215,HEMISPHERE_SKY:15658751,HEMISPHERE_GROUND:7829384}),S={createLight:function(e,t,n){var i;switch(e){case"sun":if(i=new w.Ox3(M.DIRECTIONAL,x.DIRECTIONAL),this.hasShadowMap()){if(!t||-1!==parseInt(t,10)||"flat"!==n)break;i.castShadow=!0,i.shadow.bias=-.004,i.shadow.radius=1;var a=this.hasHighResShadows();i.shadow.mapSize.width=a?4096:2048,i.shadow.mapSize.height=a?4096:2048,i.shadow.camera.near=1,i.shadow.camera.far=200,i.shadow.camera.top=32,i.shadow.camera.bottom=-32,i.shadow.camera.left=32,i.shadow.camera.right=-32}break;case"hemisphere":i=new w.vmT(M.HEMISPHERE_SKY,M.HEMISPHERE_GROUND,x.HEMISPHERE);break;default:i=new w.Mig(M.AMBIENT,x.AMBIENT)}return i}},C={createMaterial:function(e,t,n){var i;switch(e){case"flat-phong":i=new w.xoR({specular:16777215,flatShading:!0,color:t&&t.color?t.color:null});break;case"smooth-phong":(i=new w.xoR({shininess:t&&t.shininess?t.shininess:0,specular:"#858585",emissive:0,side:w.Wl3,color:t&&t.color?t.color:null})).receiveShadow=!0;break;case"toon":for(var a=t.nbColors,o=new Uint8Array(a),r=0;r<=o.length;++r){var s=r/o.length,l=Math.pow(s,10);o[r]=256*l}var c=new w.IEO(o,o.length,1,w.Y8D);c.minFilter=w.TyD,c.magFilter=w.TyD,c.generateMipmaps=!1,(i=new w.IKL({side:w.Wl3,color:t&&t.color?t.color:null,gradientMap:c})).receiveShadow=!0;break;case"textured-phong":void 0===n&&(n="-1");var h=this.instancedMaterials.get(n);if(h)(i=h[0])||console.error("[Materials] Could not get instanced material for ".concat(n,"."));else{var d={side:w.Wl3,map:this.textureAtlas,transparent:!1},u=[i=new w.YBo(d)];this.instancedMaterials.set(n,u)}break;case"textured-phong-water":void 0===n&&(n="-1");var p=this.waterMaterials.get(n);if(p)(i=p)||console.error("[Materials] Could not get instanced material for ".concat(n,"."));else{var m={side:w.Wl3,map:this.textureAtlas,transparent:!0};i=new w.YBo(m),this.waterMaterials.set(n,i)}break;case"basic-black":i=new w.vBJ({wireframe:!0,color:0});break;case"grey-phong-double":i=new w.xoR({specular:11184810,flatShading:!0,side:w.ehD,color:t&&t.color?t.color:null});break;default:i=new w.vBJ({color:16711680})}return i}};const T=n.p+"12a5e7492e1448b886ec0946045404fc.glb",k=n.p+"b091d2113b023c702f17aa4cf0a0c7ed.glb",P=n.p+"4241154f2aa9da8ac29c7a2fff0473ea.glb",I=n.p+"46e8a639a22deed8741f7272d3a62cd3.glb";var A=Object.freeze({NONE:0,BLOCK_GRASS:1,BLOCK_STONE:2,BLOCK_DIRT:3,BLOCK_WOOD:4,BLOCK_PLANKS:5,BLOCK_STONEBRICKS:6,BLOCK_BRICKS:7,BLOCK_LEAVES:8,BLOCK_WATER:16,BLOCK_SAND:17,BLOCK_IRON:18,BLOCK_OBSIDIAN:19,ORE_GOLD:20,ORE_COAL:21,ORE_DIAMOND:22,ORE_REDSTONE:23,BLOCK_WOOL_WHITE:32,BLOCK_WOOL_GREY:33,BLOCK_WOOL_CYAN:34,BLOCK_WOOL_ORANGE:35,BLOCK_WOOL_DARK_PURPLE:36,BLOCK_WOOL_LIGHT_PURPLE:37,BLOCK_WOOL_DARK_BLUE:38,BLOCK_WOOL_LIGHT_BLUE:39,BLOCK_WOOL_BROWN:40,BLOCK_WOOL_YELLOW:41,BLOCK_WOOL_DARK_GREEN:42,BLOCK_WOOL_LIGHT_GREEN:43,BLOCK_WOOL_RED:44,BLOCK_WOOL_ROSE:45,BLOCK_WOOL_BLACK:46,BLOCK_WOOL_DARK_GREY:47,BLOCK_LAPIS:48,BLOCK_SPONGE:49,BLOCK_BEDROCK:50,BLOCK_MOSSY_STONE:51,BLOCK_CRACKED_STONE:52,BLOCK_ENDER:53,BLOCK_NETHER:54,BLOCK_DIAMOND:55,BLOCK_GOLD:56,KATANA:257,NAGAMAKI:258,NODACHI:259,YARI:260,NAGINATA:261,YA:300,YUMI:301,TEPPO:302,PORTAL_GUN_SINGLE:513,PORTAL_GUN_DOUBLE:514}),E={isItemNaught:function(e){return e===A.NONE},isItemBlock:function(e){return e>A.NONE&&e<256},isItemX:function(e){return e===A.PORTAL_GUN_SINGLE||e===A.PORTAL_GUN_DOUBLE},isItemX2:function(e){return e===A.PORTAL_GUN_SINGLE},isItemPlaceable:function(e){return E.isItemBlock(e)||E.isItemX(e)},isItemMelee:function(e){return e>=A.KATANA&&e<A.YA},isItemRanged:function(e){return e>=A.YUMI&&e<512},isItemUseable:function(e){return E.isItemMelee(e)||E.isItemRanged(e)},isItemIDSupported:function(e){if("number"!=typeof e)return!1;for(var t in A)if(A.hasOwnProperty(t)&&A[t]===e)return!0;return!1}},O=n(47),L=n(531),_={loadReferenceMeshes:function(){var e=this;this.referenceMeshes=new Map;var t=new Map([["tato",T],["bigcup",k],["littlecup",P],["axolotl",I]]);this._nbMeshesToLoad=t.size;var n=new O.E(this.loadingManager);t.forEach((function(t,i){e.loadMesh(t,n,(function(t){e.referenceMeshes.set(i,t),e._nbMeshesLoadedOrError++}),(function(){e._nbMeshesLoadedOrError++}))}))},loadMesh:function(e,t,n,i){var a=this,o=this.app.state.getState("loading");t.load(e,(function(t){e===T?a.finalizeMainCharacter(t,n):n&&n(t)}),(function(){o.notifyTaskName("mesh")}),(function(e){i&&i(),console.error(e)}))},finalizeMainCharacter:function(e,t){t&&t(e)},prepareMainCharacter:function(e){var t=L.b.clone(e.scene).children[0];t.name="gltf0",t.position.set(0,-.15,.07),t.scale.set(.44,.44,.44),t.traverse((function(e){e.isMesh&&(e.userData.hasPrimaryImage=!0,e.userData.hasReflection=!0)}));var n=new w.Tme;n.name="inner",n.add(t);var i=new w.Tme;return i.name="outer",i.add(n),i.userData.animations=e.animations,i.getInnerObject=function(){return n},i},prepareBigCup:function(e){var t=L.b.clone(e.scene),n=t.children[0],i=t.children[1],a=t.children[2];n.name="gltf0",n.geometry.computeVertexNormals();var o=new w.L5g,r=new w.xoR({color:"#703e9b"}),s=new w.Kj0(o,r);s.position.set(0,3.5,0),s.rotation.set(Math.PI/5,0,Math.PI/4),s.scale.multiplyScalar(.001);var l=new w.Tme;l.name="inner",l.add(n),l.add(i),l.add(a),l.add(s),l.position.set(0,-.5,0),l.scale.set(.4,.4,.4);var c=new w.Tme;return c.name="outer",c.add(l),c.getInnerObject=function(){return l},c},prepareLittleCup:function(e){var t=L.b.clone(e.scene).children[0];t.name="gltf0",t.position.set(0,-.15,.07),t.scale.set(.44,.44,.44);var n=new w.Tme;n.name="inner",n.add(t);var i=new w.Tme;return i.name="outer",i.add(n),i.getInnerObject=function(){return n},i},prepareAxolotl:function(e){var t=L.b.clone(e.scene).children[0];t.name="gltf0",t.position.set(0,-.15,.07),t.scale.set(.44,.44,.44);var n=new w.Tme;n.name="inner",n.add(t);var i=new w.Tme;return i.name="outer",i.add(n),i.getInnerObject=function(){return n},i},getItemMesh:function(e,t,n){var i=this.getMeshIDFromItemID(e);if(i)return e===A.PORTAL_GUN_DOUBLE||A.PORTAL_GUN_SINGLE,this.loadReferenceMeshFromMemory(i,t,n);var a=this.createGeometry("box"),o=this.createMaterial("flat-phong"),r=this.createMesh(a,o);r.scale.set(.4,.4,.4),r.position.set(.4,-.25,-.25),this.renderOnTop(r);var s=new w.Tme;return s.rotation.reorder("ZYX"),s.add(r),s},getMeshIDFromItemID:function(e){switch(e){case A.PORTAL_GUN_SINGLE:case A.PORTAL_GUN_DOUBLE:return"portal-gun";case A.YA:return"ya";case A.YARI:return"yari";case A.YUMI:return"yumi-morph";case A.KATANA:return"katana";case A.NAGINATA:return"naginata";case A.NAGAMAKI:return"nagamaki";case A.NODACHI:return"nodachi";default:return}},renderOnTop:function(e){if(e.children&&4===e.children.length){var t=e.children[0],n=e.children[1],i=e.children[2],a=e.children[3];t.renderOrder=996,t.material.transparent=!0,n.renderOrder=997,n.material.transparent=!0,i.renderOrder=998,i.material.transparent=!0,a.renderOrder=996,a.material.transparent=!0,this.hasShadowVolumes()||(t.onBeforeRender=function(e){return e.clearDepth()})}e.material&&(e.material.transparent=!0,e.material.morphTargets=!0,e.renderOrder=999,this.hasShadowVolumes()||(e.onBeforeRender=function(e){return e.clearDepth()}))},loadReferenceMeshFromMemory:function(e,t,n){if(this.referenceMeshes.has(e)){var i,a=this.referenceMeshes.get(e);switch(a instanceof w.Tme||a.scene instanceof w.ZAu||console.warn('[Graphics/Meshes] "'.concat(e,'" should be an instance of Object3D.')),e){case"tato":i=this.prepareMainCharacter(a);break;case"bigcup":i=this.prepareBigCup(a);break;case"littlecup":i=this.prepareLittleCup(a);break;case"axolotl":i=this.prepareAxolotl(a);break;default:i=n?a.clone():a}return i.rotation.reorder("ZYX"),i}console.error('[Graphics/Meshes] Could not charge a new "'.concat(e,'" mesh.'))},createGeometry:function(e){var t;switch(e){case"plane":t=new w._12(32,32,32,32);break;case"box":t=new w.DvJ(.45,.45,.45);break;default:t=new w.DvJ(.5,.5,1)}return t},createMesh:function(e,t){return new w.Kj0(e,t)}};const R=n.p+"537ec85b965d414829ab56e82a783970.jpg";var D={loadTextures:function(){this._nbTexturesToLoad=1,this.textureWaterNormals=this.loadTextureNormals()},loadTextureNormals:function(){var e=this,t=new w.dpR(this.loadingManager),n=this.app.state.getState("loading");t.load(R,(function(t){t.wrapS=t.wrapT=w.rpg,e.textureWaterNormals=t,e._nbTexturesLoaded++}),(function(){n.notifyTaskName("texture")}),(function(){console.error("[Graphics/Textures] Failed to load water normals.")}))},loadTextureAtlas:function(e){var t=this;(new w.dpR).load("app/assets/textures/".concat(e),(function(e){console.log("[Graphics/Textures] Texture Atlas loaded."),e.magFilter=w.TyD,e.minFilter=w.TyD,t.textureAtlas=e,t._nbTexturesLoaded++}),void 0,(function(){console.error("[Graphics/Textures] Failed to load texture atlas.")}))},getTextureCoordinates:function(e){var t;return"minecraft>1.5"===e?t={1:[[0,15],[0,15],[0,15],[0,15],[0,15],[0,15]],2:[[1,15],[1,15],[1,15],[1,15],[1,15],[1,15]],3:[[2,15],[2,15],[2,15],[2,15],[2,15],[2,15]],4:[[4,14],[4,14],[5,14],[4,14],[4,14],[5,14]],5:[[4,15],[4,15],[4,15],[4,15],[4,15],[4,15]],6:[[6,12],[6,12],[6,12],[6,12],[6,12],[6,12]],7:[[7,15],[7,15],[7,15],[7,15],[7,15],[7,15]],8:[[5,12],[5,12],[5,12],[5,12],[5,12],[5,12]],16:[[14,3],[14,3],[14,3],[14,3],[14,3],[14,3]],17:[[2,14],[2,14],[2,14],[2,14],[2,14],[2,14]],18:[[1,13],[1,13],[1,13],[1,13],[1,13],[1,13]],19:[[7,4],[7,4],[7,4],[7,4],[7,4],[7,4]],20:[[0,13],[0,13],[0,13],[0,13],[0,13],[0,13]],21:[[2,13],[2,13],[2,13],[2,13],[2,13],[2,13]],22:[[2,12],[2,12],[2,12],[2,12],[2,12],[2,12]],23:[[3,12],[3,12],[3,12],[3,12],[3,12],[3,12]],32:[[0,11],[0,11],[0,11],[0,11],[0,11],[0,11]],33:[[1,1],[1,1],[1,1],[1,1],[1,1],[1,1]],34:[[1,2],[1,2],[1,2],[1,2],[1,2],[1,2]],35:[[2,2],[2,2],[2,2],[2,2],[2,2],[2,2]],36:[[1,3],[1,3],[1,3],[1,3],[1,3],[1,3]],37:[[2,3],[2,3],[2,3],[2,3],[2,3],[2,3]],38:[[1,4],[1,4],[1,4],[1,4],[1,4],[1,4]],39:[[2,4],[2,4],[2,4],[2,4],[2,4],[2,4]],40:[[1,5],[1,5],[1,5],[1,5],[1,5],[1,5]],41:[[2,5],[2,5],[2,5],[2,5],[2,5],[2,5]],42:[[1,6],[1,6],[1,6],[1,6],[1,6],[1,6]],43:[[2,6],[2,6],[2,6],[2,6],[2,6],[2,6]],44:[[1,7],[1,7],[1,7],[1,7],[1,7],[1,7]],45:[[2,7],[2,7],[2,7],[2,7],[2,7],[2,7]],46:[[1,8],[1,8],[1,8],[1,8],[1,8],[1,8]],47:[[2,8],[2,8],[2,8],[2,8],[2,8],[2,8]],48:[[0,6],[0,6],[0,6],[0,6],[0,6],[0,6]],49:[[0,12],[0,12],[0,12],[0,12],[0,12],[0,12]],50:[[1,14],[1,14],[1,14],[1,14],[1,14],[1,14]],51:[[4,13],[4,13],[4,13],[4,13],[4,13],[4,13]],52:[[5,9],[5,9],[5,9],[5,9],[5,9],[5,9]],53:[[15,5],[15,5],[15,5],[15,5],[15,5],[15,5]],54:[[7,9],[7,9],[7,9],[7,9],[7,9],[7,9]],55:[[8,14],[8,14],[8,14],[8,14],[8,14],[8,14]],56:[[7,14],[7,14],[7,14],[7,14],[7,14],[7,14]]}:(console.warn("[Textures] Unsupported MC texture version."),t={1:[[0,1],[0,1],[0,2],[0,1],[0,1],[0,0]],2:[[5,0],[5,0],[5,0],[5,0],[5,0],[5,0]],3:[[6,0],[6,0],[6,0],[6,0],[6,0],[6,0]],4:[[4,1],[4,1],[4,2],[4,1],[4,1],[4,0]],5:[[7,0],[7,0],[7,0],[7,0],[7,0],[7,0]],6:[[10,0],[10,0],[10,0],[10,0],[10,0],[10,0]],7:[[3,0],[3,0],[3,0],[3,0],[3,0],[3,0]],8:[[14,0],[14,0],[14,0],[14,0],[14,0],[14,0]],17:[[1,0],[1,0],[1,0],[1,0],[1,0],[1,0]],18:[[1,10],[1,10],[1,10],[1,10],[1,10],[1,10]]}),t}},z=n(953),F={loadReferenceGeometryFromMemory:function(e){if(this.referenceMeshes.has(e)){var t=this.referenceMeshes.get(e);return t instanceof z.Z||console.warn("[Graphics/Entities] Should be an instance of Geometry."),t}console.error('[Graphics/Meshes] Could not charge a new "'.concat(e,'" mesh.'))},initializeEntity:function(e,t,n){var i=this.loadReferenceGeometryFromMemory(t);if(i){var a=(new w.u9r).fromGeometry(i),o=new w.Kj0(a,new w.YBo({color:n,vertexColors:!0,morphTargets:!0}));o.scale.set(1,1,1);var r=new w.Xcj(o),s=w.m7l.CreateFromMorphTargetSequence("run",i.morphTargets,30,!1);return r.clipAction(s).setDuration(1).play(),this.animationManager.addEntityAnimation(e,r),o}},finalizeEntity:function(e,t,n){if(t&&t instanceof w.Tme){var i=new w.Tme,a=new w.Tme,o=this.createMesh(this.createGeometry("box"),this.createMaterial("flat-phong",{color:n}));return i.rotation.reorder("ZYX"),i.add(a),a.add(t),a.add(o),o.position.y=1.6,a.rotation.x=Math.PI/2,a.rotation.y=Math.PI,a.position.z=-.7999,i._id=e,i.getWrapper=function(){return a},i.getHead=function(){return o},i}console.warn("[Graphics/Entities] Tried to finalize an entity that was not correctly initialized.")}},B={loadItems:function(e){this.loadItemMesh("portal-gun",e)},loadItemMesh:function(e,t,n){var i=this;"portal-gun"===e||"yumi-morph"===e||"yari"===e||"ya"===e||"nagamaki"===e||"naginata"===e||"nodachi"===e||"katana"===e?new O.E(this.loadingManager).load("app/assets/models/".concat(e,".glb"),(function(n){"portal-gun"===e?i.finalizePortalMesh(n,t):"katana"===e?i.finalizeKatanaPackMesh(n,t):"ya"===e?i.finalizeYaPackMesh(n,t):"yumi-morph"===e?i.finalizeYumiMorphPackMesh(n,t):"yari"===e?i.finalizeYariPackMesh(n,t):"nagamaki"===e?i.finalizeNagamakiPackMesh(n,t):"naginata"===e?i.finalizeNaginataPackMesh(n,t):"nodachi"===e&&i.finalizeNodachiPackMesh(n,t)}),void 0,(function(e){n&&n(),console.error(e)})):console.error("[Graphics/Items] Unsupported mesh.")},finalizeYumiMorphPackMesh:function(e,t){var n=e.scene.children[0];this._resetMaterial(n,!0),n.material.morphTargets=!0;var i=new w.Xcj(n),a=new w.m7l("bow-stretch",1,e.animations[0].tracks),o=i.clipAction(a);o.clampWhenFinished=!0,o.setDuration(1).setLoop(w.YKA,1).play(),this.mixers.set("yumi",i),this.times.set("yumi",Date.now()),this.clips.set("yumi",o);var r=n.geometry,s=r.attributes.position,l=s.count;r.setAttribute("color",new w.TlE(new Float32Array(3*l),3));for(var c=r.attributes.color,h=0;h<l;++h){var d=void 0,u=void 0,p=void 0,m=s.getY(h);Math.abs(m-5.85)<.3||Math.abs(m-2.46)<.1||Math.abs(m-8)<.1?d=u=p=2:(d=122/256,u=62/256,p=0),c.setXYZ(h,d,u,p)}n.rotation.reorder("ZXY");var f=n.scale;f.set(.2*f.x,.2*f.y,.2*f.z),n.rotation.set(-Math.PI/2,Math.PI/2,Math.PI/2),n.position.set(.3,-.15,-.25),this.renderOnTop(n);var g=new w.Tme;g.rotation.reorder("ZYX"),g.add(n),t(g)},finalizeYaPackMesh:function(e,t){var n=e.scene.children[0];this._resetMaterial(n);var i=n.geometry,a=i.attributes.position,o=a.count;i.setAttribute("color",new w.TlE(new Float32Array(3*o),3));for(var r=i.attributes.color,s=0;s<o;++s){var l=void 0,c=void 0,h=void 0,d=a.getX(s),u=a.getY(s);d<-15.4?l=c=h=1:d>-3&&Math.abs(u)>.02?l=c=h=2:(l=61/256,c=31/256,h=0),r.setXYZ(s,l,c,h)}var p=n.scale,m=this._packObject(n);p.set(6*p.x,6*p.y,6*p.z),n.position.set(0,-1.5,0),t(m)},_resetMaterial:function(e,t){e.material=new w.xoR({color:7368816,shininess:t?0:1e3,specular:t?0:16777215,vertexColors:!0});var n=e.geometry,i=n.attributes.position.count;n.setAttribute("color",new w.TlE(new Float32Array(3*i),3))},_packObject:function(e){e.rotation.reorder("ZYX");var t=e.scale;t.set(.4*t.x,.4*t.y,.4*t.z),e.rotation.set(Math.PI+5*Math.PI/8,0,-Math.PI/2),e.position.set(.4,-.25,-.25);var n=new w.Tme;return n.rotation.reorder("ZYX"),n.add(e),n},finalizeKatanaTypePackMesh:function(e,t,n,i,a,o,r,s,l,c,h,d){var u=e.scene.children[0];this._resetMaterial(u);for(var p=u.geometry,m=p.attributes.position,f=m.count,g=p.attributes.color,v=0;v<f;++v){var y=void 0,w=void 0,b=void 0,x=m.getX(v),M=m.getY(v),S=m.getZ(v);x<o?(y=.5+.5*Math.random(),w=.5+.5*Math.random(),b=.5+.5*Math.random()):x>t&&Math.abs(S)<r&&Math.abs(M)<s?(y=n/256,w=i/256,b=a):(y=l/256,w=c/256,b=h),g.setXYZ(v,y,w,b)}d(this._packObject(u))},finalizeYariPackMesh:function(e,t){this.finalizeKatanaTypePackMesh(e,-9.7,61,31,0,-15.7,.7,.05,255,215,0,t)},finalizeNodachiPackMesh:function(e,t){this.finalizeKatanaTypePackMesh(e,-1.3,61,31,0,-1.975,.7,.05,255,215,0,t)},finalizeNaginataPackMesh:function(e,t){this.finalizeKatanaTypePackMesh(e,-7.8,61,31,0,-8.47,.7,.07,255,215,0,t)},finalizeNagamakiPackMesh:function(e,t){this.finalizeKatanaTypePackMesh(e,-2.4,61,31,0,-3.052,.7,.09,255,215,0,t)},finalizeKatanaPackMesh:function(e,t){this.finalizeKatanaTypePackMesh(e,-1.3,0,0,0,-1.975,.7,.09,255,215,0,t)},finalizeKatanaMesh:function(e,t){var n=e.scene.children[0];console.log(n),n.children[0].material.roughness=1,n.children[0].material.metalness=.5,n.children[0].material.color=new w.Ilk(16777215);for(var i=new Uint8Array(49152),a=0;a<16384;++a){var o=3*a,r=Math.random()>.5?255:0;i[o]=r,i[o+1]=r,i[o+2]=r}var s=new w.IEO(i,128,128,w.UCm);s.wrapT=w.rpg,s.wrapS=w.rpg,s.repeat.set(9,1),n.children[0].material.roughnessMap=s,n.children[0].material.needsUpdate=!0;for(var l=n.children[0].geometry,c=new Float32Array(144),h=0;h<72;++h)c.set([Math.random(),Math.random()],h);l.setAttribute("uv",new w.TlE(c,2)),l.attributes.uv.needsUpdate=!0,l.uvsNeedUpdate=!0,l.needsUpdate=!0,n.scale.set(.08,.08,.08),n.position.set(.4,-.25,-.25);var d=new w.Tme;d.rotation.reorder("ZYX"),d.add(n),t(d)},finalizePortalMesh:function(e,t){var n=e.scene.children[0];n.scale.set(.08,.08,.08),n.rotation.set(0,Math.PI,0),n.position.set(.3,-.1,-.5),n.children[0].material=new w.xoR({color:0}),n.children[1].material=new w.xoR({color:2237098}),n.children[2].material=new w.xoR({color:16777215}),n.children[3].material=new w.xoR({color:10066329});var i=new w.Tme;i.rotation.reorder("ZYX"),i.add(n),t(i)},finalizeModelMesh:function(){}},W=function(e,t,n,i){this.screenId=e,this.mesh=t,this.renderTarget=n,this.worldId=i,this.otherWorldId=null,this.cameras=new Set};function j(e){return(j="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}a(W.prototype,{getId:function(){return this.screenId},getMesh:function(){return this.mesh},getRenderTarget:function(){return this.renderTarget},getWorldId:function(){return this.worldId},getOtherWorldId:function(){return this.otherWorldId},setOtherWorldId:function(e){this.otherWorldId=e},isLinked:function(){return null!==this.otherWorldId||void 0!==this.otherWorldId}});var N={addStubPortalObject:function(e){var t=e.worldId,n=e.portalId;if(this.getScene(t,!0)){var i=this.getScreen(n);if(!i){var a=e.tempPosition,o=e.tempOtherPosition,r=e.tempOrientation,s=e.tempWidth,l=e.tempHeight,c=window.innerWidth,h=window.innerHeight,d=new w.dd2(c,h,{minFilter:w.wem,magFilter:w.TyD,format:w.UCm}),u=new w.BKK(s,l),p=this.getPortalVertexShader(),m=this.getPortalFragmentShader(),f=new w.jyz({side:w.ehD,uniforms:{texture1:{type:"t",value:d.texture}},vertexShader:p,fragmentShader:m}),g=new w.Kj0(u,f),v=Math.floor(a[0]),y=Math.floor(a[1]),b=Math.floor(a[2]),x=Math.floor(o[0]),M=Math.floor(o[1]),S=Math.floor(o[2]),C=Math.PI/2;b!==S?(g.rotation.x=C,g.rotation.y=C+parseFloat(r),g.position.x=a[0]+.5,g.position.y=a[1]+.5,g.position.z=a[2]+1):y!==M?(g.rotation.y=C-parseFloat(r),g.position.x=a[0]+.5,g.position.y=a[1]+1,g.position.z=a[2]+.5):v!==x&&(g.rotation.z=C,g.position.x=a[0]+1,g.position.y=a[1]+.5,g.position.z=a[2]+.5,g.rotation.x=C+parseFloat(r)),i=new W(n,g,d,t),this.addScreen(n,i)}i&&this.addToScene(i.getMesh(),t)}else console.log("Could not load scene from ".concat(t," (").concat(j(t),")."))},completeStubPortalObject:function(e,t,n,i){var a=e.worldId,o=e.portalId;e.portalLinkedForward=t.portalId;var r=this.getScreen(o);r?(this.cameraManager.addCamera(e,t,n,i,r),this.cameraManager.addCameraToScene(n,a,r)):console.log("Could not get screen to complete: ".concat(o,"."))},processPortalUpdates:function(){var e=this.portalUpdates;if(!(e.length<1)){for(var t,n=!1,i=[],a=0;a<e.length;++a){t=e[a];var o=parseInt(t.destinationWid,10),r=parseInt(t.portal.worldId,10),s=parseInt(this.previousFrameWorld,10),l=parseInt(this.currentFrameWorld,10);o!==s&&o!==l&&r!==s&&r!==l||(this.addPortalGraphics(t.portal,t.otherPortal,t.cameraPath,t.cameraTransform,t.depth,t.originPid,t.destinationPid,t.destinationWid,t.pidPathString),i.push(a),n=!0)}for(var c=i.length-1;c>=0;--c)e.splice(i[c],1);n||(t=e.shift(),this.addPortalGraphics(t.portal,t.otherPortal,t.cameraPath,t.cameraTransform,t.depth,t.originPid,t.destinationPid,t.destinationWid,t.pidPathString))}},flushPortalUpdates:function(){this.portalUpdates=[]},unflushPortalUpdates:function(){for(var e=this.portalUpdates,t=this.lastRenderPaths,n=this.lastRenderGates,i=this.cameraManager,a=this.sceneManager,o=new Set,r=new Set,s=0,l=e.length;s<l;++s){var c=e[s];o.add(c.pidPathString),r.add(c.originPid)}t.forEach((function(e){o.has(e)||i.removeCameraFromScene(e)})),n.forEach((function(e){r.has(e)||a.removeScreen(e)})),this.rendererManager.setRenderRegister([]),this.lastRenderPaths=new Set,this.lastRenderGates=new Set},addPortalGraphics:function(e,t,n,i,a,o,r,s,l){var c=this.rendererManager.getRenderRegister();for(var h in c)if(c.hasOwnProperty(h)&&c[h].id===l)return;this.addStubPortalObject(e),this.completeStubPortalObject(e,t,n,i);var d=this.sceneManager.screens,u=this.cameraManager.subCameras,p=this.sceneManager.subScenes;c.push({id:l,depth:a,screen1:d.get(o),screen2:d.get(r),sceneId:s,scene:p.get(s),camera:u.get(l)}),this.lastRenderPaths.add(l),this.lastRenderGates.add(o),c.sort((function(e,t){return t.depth-e.depth})),this.rendererManager.setRenderRegister(c)},addPortalObject:function(e,t,n,i,a,o,r,s,l){this.portalUpdates.push({portal:e,otherPortal:t,cameraPath:n,cameraTransform:i,depth:a,originPid:o,destinationPid:r,destinationWid:s,pidPathString:l})},removePartOfPortalObject:function(e,t){var n=e.portalId,i=t.portalId,a=this.getScreen(i),o=this.getScreen(n);o?(o.setOtherWorldId(null),o.getRenderTarget().setSize(0,0)):console.log("WARN @portals.js: screen to be altered not found."),a||console.log("WARN @portals.js: screen to be removed not found.")},removePortalObject:function(e){var t=e.portalId;console.log("Removing full portal: p(".concat(e.portalId,")"));var n=this.getScreen(t);this.removeScreen(n.screenId)}},U=function(e,t,n,i,a){var o=new w.cPb(e,t,n,i);o.position.set(0,0,0),o.rotation.set(0,0,0);var r=new w.Tme,s=new w.Tme,l=new w.Tme;r.add(o),s.add(r),l.add(s),l.rotation.reorder("ZYX"),this.worldId=a,this.cameraId=null,this.cameraTransform=[0,0,0,0,0,0],this.up=l,this.yaw=s,this.pitch=r,this.cameraObject=o,this.screen=null};a(U.prototype,{setCameraId:function(e){this.cameraId=e},getCameraId:function(){return this.cameraId},setWorldId:function(e){this.worldId=e},getWorldId:function(){return this.worldId},getRecorder:function(){return this.cameraObject},get3DObject:function(){return this.up},getCameraPosition:function(){return this.up.position},getUpRotation:function(){return this.up.rotation},rotateX:function(e){var t=this.pitch;t.rotation.x+=e,t.rotation.x=Math.max(0,Math.min(1.1*Math.PI/2,t.rotation.x))},rotateZ:function(e){this.yaw.rotation.z+=e},setUpRotation:function(e,t,n){var i=this.up;i.rotation.x=e,i.rotation.y=t,i.rotation.z=n},getXRotation:function(){return this.pitch.rotation.x},setXRotation:function(e){this.pitch.rotation.x=e},getZRotation:function(){return this.yaw.rotation.z},setZRotation:function(e){this.yaw.rotation.z=e},copyCameraPosition:function(e){if(e){var t=this.up.position,n=e.getCameraPosition();t.x=n.x,t.y=n.y,t.z=n.z}},copyCameraUpRotation:function(e){if(e){var t=this.up.rotation,n=e.getUpRotation();t.x=n.x,t.y=n.y,t.z=n.z}},addPositionTransform:function(){var e=this.up.position,t=this.cameraTransform;t&&(e.x+=t[0],e.y+=t[1],e.z+=t[2])},addRotationTransform:function(){},setCameraPosition:function(e,t,n){var i=this.up;i.position.x=e,i.position.y=t,i.position.z=n},setScreen:function(e){e&&(this.screen=e)},getScreen:function(){return this.screen},setCameraTransform:function(e){this.cameraTransform=e},getCameraTransform:function(){return this.cameraTransform},setFirstPerson:function(){this.cameraObject.position.z=0},setThirdPerson:function(){this.cameraObject.position.set(0,0,2),this.setXRotation(Math.PI/3)},getCameraForwardVector:function(){var e=new w.Pa4(0,-1,0),t=new w._fP;return this.cameraObject.getWorldQuaternion(t),e.applyQuaternion(t),e},getModelForwardVector:function(){var e=new w.Pa4(0,0,-1),t=new w._fP;return this.cameraObject.getWorldQuaternion(t),e.applyQuaternion(t),e}});var V={createWaterCamera:function(){var e=this.mainFOV,t=this.mainAspect,n=this.mainNear,i=this.mainFar,a=new w.dd2(512,512,{minFilter:w.wem,magFilter:w.wem,format:w.UCm});return{camera:new w.cPb(e,t,n,i),waterRenderTarget:a,mirrorPlane:new w.JOQ,normal:new w.Pa4,mirrorWorldPosition:new w.Pa4,cameraWorldPosition:new w.Pa4,rotationMatrix:new w.yGw,lookAtPosition:new w.Pa4(0,0,-1),clipPlane:new w.Ltg,view:new w.Pa4,target:new w.Pa4,q:new w.Ltg,textureMatrix:new w.yGw,clipBias:.01,eye:new w.Pa4(0,0,0)}},updateWaterCamera:function(e){var t=this.waterCamera;if(t){var n=t.camera,i=t.clipBias,a=t.mirrorPlane,o=t.normal,r=t.mirrorWorldPosition,s=t.cameraWorldPosition,l=t.lookAtPosition,c=t.clipPlane,h=t.view,d=t.target,u=t.q,p=t.textureMatrix,m=t.rotationMatrix,f=t.eye;this._waterCameraObject||(this._waterCameraObject=new w.Tme,this._waterCameraObject.position.set(0,0,0),this._waterCameraObject.rotation.set(0,0,0),this._waterCameraObject.updateMatrixWorld());var g=this._waterCameraObject;r.setFromMatrixPosition(g.matrixWorld),s.setFromMatrixPosition(e.matrixWorld),m.extractRotation(g.matrixWorld),o.set(0,0,1),o.applyMatrix4(m),h.subVectors(r,s),h.reflect(o).negate(),h.add(r),m.extractRotation(e.matrixWorld),l.set(0,0,-1),l.applyMatrix4(m),l.add(s),d.subVectors(r,l),d.reflect(o).negate(),d.add(r),n.position.copy(h),n.up.set(0,1,0),n.up.applyMatrix4(m),n.up.reflect(o),n.lookAt(d),n.far=e.far,n.updateMatrixWorld(),n.projectionMatrix.copy(e.projectionMatrix),p.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),p.multiply(n.projectionMatrix),p.multiply(n.matrixWorldInverse),a.setFromNormalAndCoplanarPoint(o,r),a.applyMatrix4(n.matrixWorldInverse),c.set(a.normal.x,a.normal.y,a.normal.z,a.constant);var v=n.projectionMatrix;u.x=(Math.sign(c.x)+v.elements[8])/v.elements[0],u.y=(Math.sign(c.y)+v.elements[9])/v.elements[5],u.z=-1,u.w=(1+v.elements[10])/v.elements[14],c.multiplyScalar(2/c.dot(u)),v.elements[2]=c.x,v.elements[6]=c.y,v.elements[10]=c.z+1-i,v.elements[14]=c.w,f.setFromMatrixPosition(e.matrixWorld)}}},H=(window.innerWidth,window.innerHeight,1e-4),G=function(e){this.graphicsEngine=e,this.mainFOV=75,this.mainAspect=window.innerWidth/window.innerHeight,this.mainNear=H,this.mainFar=1e5,this.mainCamera=this.createCamera(!1,-1),this.mainCamera.setCameraId(-1),this.mainCamera.setThirdPerson(),this.mainRaycasterCamera=this.createCamera(!0,-1),this.raycaster=this.createRaycaster(),this.subCameras=new Map,this.stencilCamera=new w.cPb(this.mainFOV,this.mainAspect,this.mainNear,this.mainFar),this.stencilCamera.matrixAutoUpdate=!1,this.waterCamera=this.createWaterCamera(),this._renderPortals=!1,this.incomingRotationEvents=[],this.oldTheta0=0,this.oldTheta1=0,this.correctSpikes=!1,this.smartAccumulation=!0,this._debug=!1,this._r=new w.Ltg(0,0,0,0),this._rotation=[0,0,0,0],this._acc=[0,0,0,0,0]};a(G.prototype,{createCamera:function(e,t){return this.mainAspect=window.innerWidth/window.innerHeight,new U(this.mainFOV,this.mainAspect,e?.1:this.mainNear,this.mainFar,t)},addCamera:function(e,t,n,i,a){var o=n;if(!this.subCameras.has(o)){var r=this.mainCamera,s=this.createCamera(!1);s.setCameraId(o),s.setCameraTransform(i),a&&s.setScreen(a),this.subCameras.set(o,s),s.copyCameraPosition(r),s.copyCameraUpRotation(r),s.setZRotation(r.getZRotation()),s.setXRotation(r.getXRotation())}},addCameraToScene:function(e,t,n){t=parseInt(t,10);var i=this.subCameras.get(e);i||e!==this.mainCamera.getCameraId()||(i=this.mainCamera),i?(i.setWorldId(t),n&&i.setScreen(n),this.graphicsEngine.addToScene(i.get3DObject(),t),i.getRecorder().updateProjectionMatrix(),i.getRecorder().updateMatrixWorld(),i.getRecorder().matrixWorldInverse.copy(i.getRecorder().matrixWorld).invert()):console.log("@addCamera: could not get wrapper for camera ".concat(e))},removeCameraFromScene:function(e,t){t=parseInt(t,10);var n=this.subCameras.get(e);n||e!==this.mainCamera.getCameraId()||(n=this.mainCamera),n?(t||(t=n.getWorldId()),this.graphicsEngine.removeFromScene(n.get3DObject(),t,!0)):console.log("@removeCamera: could not get wrapper for camera ".concat(e,"."))},switchMainCameraToWorld:function(e,t){var n=this.mainCamera,i=this.mainRaycasterCamera,a=this.graphicsEngine;a.removeFromScene(n.get3DObject(),e),a.removeFromScene(i.get3DObject(),e),a.addToScene(n.get3DObject(),t),a.addToScene(i.get3DObject(),t)},switchToCamera:function(e,t){console.log("Deprecated call to switchToCamera ".concat(t,"."))},updateCameraPosition:function(e){var t=e.x,n=e.y,i=e.z,a=this.mainCamera,o=this.graphicsEngine.animationManager;o.saveOldPosition(a.getCameraPosition()),a.setCameraPosition(t,n,i),o.saveNewPosition(a.getCameraPosition())},addCameraRotationEvent:function(e,t,n,i,a){this.incomingRotationEvents.push([e,t,n,i,a])},accumulateRotationEvents:function(e,t,n){if(this.smartAccumulation&&e.length>2){for(var i=this._debug,a=0,o=e.length;a<o;++a){var r=e[a],s=void 0,l=void 0;0===a?(s=e[a+1],l=e[a+2]):a===o-1?(s=e[a-1],l=e[a-2]):(s=e[a+1],l=e[a-1]);for(var c=0;c<4;++c){var h=Math.abs(s[c])+1,d=Math.abs(l[c])+1,u=Math.abs(r[c])+1;u>20*h&&u>20*d&&(i&&console.log("[Cameras] Smart accumulation corrected ".concat(u,",").concat(h,",").concat(d,".")),r[c]=0)}}for(var p=0,m=e.length;p<m;++p)for(var f=e[p],g=0;g<4;++g)t[g]+=n*f[g]}else for(var v=0,y=e.length;v<y;++v)for(var w=e[v],b=0;b<4;++b)t[b]+=n*w[b]},refresh:function(){var e=this.incomingRotationEvents;if(!(e.length<1)){var t=this._acc;t.fill(0);var n=.016;if(1===e.length){var i=e[0];t[0]=i[0]*n,t[1]=i[1]*n,t[2]=i[2]*n,t[3]=i[3]*n}else if(e.length>1){var a=!1;if(this.accumulateRotationEvents(e,t,n),this.correctSpikes){t[0]/=e.length,t[1]/=e.length,t[2]/=e.length,t[3]/=e.length;for(var o=0,r=e.length;o<r;++o){var s=e[o];Math.abs(s[0])>20*Math.abs(t[0])&&(a=!0,s[0]=t[0]),Math.abs(s[1])>20*Math.abs(t[1])&&(a=!0,s[1]=t[1]),Math.abs(s[2])>20*Math.abs(t[2])&&(a=!0,s[2]=t[2]),Math.abs(s[3])>20*Math.abs(t[3])&&(a=!0,s[3]=t[3])}a&&(t.fill(0),this.accumulateRotationEvents(e,t))}}this.incomingRotationEvents.length=0;var l=this._rotation;this.updateCameraRotation(t[0],t[1],t[2],t[3],l),l&&this.graphicsEngine.app.model.frontend.triggerEvent("r",l)}},clipOblique:function(e,t,n){var i=new w.yGw;i.extractRotation(e.matrix);var a=new w.Pa4(0,0,1);a.applyMatrix4(i);var o=e.position,r=new w.Pa4;r.setFromMatrixPosition(n.matrixWorld);var s=new w.Pa4;if(s.x=o.x-r.x,s.y=o.y-r.y,s.z=o.z-r.z,a&&s){var l=a.dot(s),c=Math.sign(l),h=new w.Pa4(0,0,1*c);h.applyMatrix4(i),t.updateProjectionMatrix(),t.updateMatrixWorld(),t.matrixWorldInverse.copy(t.matrixWorld).invert();var d=new w.JOQ;d.setFromNormalAndCoplanarPoint(h,e.position),d.applyMatrix4(t.matrixWorldInverse),d=new w.Ltg(d.normal.x,d.normal.y,d.normal.z,d.constant);var u=new w.Ltg,p=t.projectionMatrix,m=Math.sign;u.x=(m(d.x)+p.elements[8])/p.elements[0],u.y=(m(d.y)+p.elements[9])/p.elements[5],u.z=-1,u.w=(1+p.elements[10])/t.projectionMatrix.elements[14];var f=new w.Ltg;f=d.multiplyScalar(2/d.dot(u)),p.elements[2]=f.x,p.elements[6]=f.y,p.elements[10]=f.z+1,p.elements[14]=f.w}else console.log("[XCam] Dot product error.")},setAbsRotationFromServer:function(e,t){return(this.oldTheta1!==t||this.oldTheta0!==e)&&(this.setAbsRotation(e,t),this.oldTheta0=e,this.oldTheta1=t,!0)},setAbsRotation:function(e,t){var n=this.mainCamera;t=Math.max(0,Math.min(Math.PI,t)),n.setUpRotation(t,0,e)},setRelRotation:function(e,t){var n=this.mainCamera,i=this.mainRaycasterCamera;i.setZRotation(e),i.setXRotation(t),n.setZRotation(e),n.setXRotation(t)},updateCameraRotation:function(e,t,n,i,a){var o=this.mainCamera,r=this.graphicsEngine.animationManager,s=o.getZRotation(),l=o.getXRotation();r.saveOldRotation(l,s),o.rotateZ(-e),o.rotateX(-t),s=o.getZRotation(),l=o.getXRotation(),r.saveNewRotation(l,s);var c=o.get3DObject().rotation,h=c.z,d=c.x;0===n&&0===i||this.setAbsRotation(h+n,d+i),a&&(a[0]=s,a[1]=l,a[2]=h,a[3]=d)},updateCameraPortals:function(e,t,n,i,a){var o=this,r=e.getRecorder();this.subCameras.forEach((function(e){e.setZRotation(t),e.setXRotation(n),e.setUpRotation(i,0,a),e.addRotationTransform();var s=e.getRecorder(),l=e.getScreen().getMesh();s&&o.clipOblique(l,s,r)}))},resize:function(e,t){var n=e/t,i=this.mainCamera.getRecorder();i.aspect=n,i.updateProjectionMatrix();var a=this.mainRaycasterCamera.getRecorder();a.aspect=n,a.updateProjectionMatrix(),this.subCameras.forEach((function(e){var t=e.getRecorder();t.aspect=n,t.updateProjectionMatrix()})),this.stencilCamera.aspect=n,this.stencilCamera.updateProjectionMatrix(),this.waterCamera.camera.aspect=n,this.waterCamera.camera.updateProjectionMatrix()},createRaycaster:function(){return new w.iMs},performRaycast:function(){var e=this.graphicsEngine,t=e.app.model.backend.chunkModel,n=e.app.model.backend.selfModel,i=this.raycaster,a=this.mainRaycasterCamera.getRecorder(),o=this.mainCamera.getRecorder();o.updateMatrixWorld(),a.matrixWorld.copy(o.matrixWorld);var r=t.getCloseTerrain(n.worldId,n.position);return i.setFromCamera(new w.FM8(0,0),a),i.intersectObjects(r)},cleanup:function(){this.mainCamera=this.createCamera(!1,-1),this.mainCamera.setCameraId(-1),this.mainCamera.setThirdPerson(),this.subCameras.clear(),this.mainRaycasterCamera=this.createCamera(!0,-1),this.raycaster=this.createRaycaster(),this.oldTheta0=0,this.oldTheta1=0}}),a(G.prototype,V);var q=n(980),Y=n(552),X=n(334),K=n(546),Z=n(903),J=n(426),Q=n(441),$=n(336),ee=n(740),te=function(e,t,n,i){ee.w.call(this),this.scene=e,this.camera=t,this.sceneShadows=i,this.lights=n,this.clear=!1,this.needsSwap=!1};o(te,ee.w),a(te.prototype,{render:function(e,t,n){e.setRenderTarget(this.renderToScreen?null:n);var i=e.getContext(),a=this.scene,o=this.camera,r=this.sceneShadows;e.clear();var s=this.lights;s.directionalLight.intensity=0,s.hemisphereLight.intensity=0,e.render(a,o),i.enable(i.STENCIL_TEST),i.stencilFunc(i.ALWAYS,1,255),i.depthMask(!1),i.colorMask(!1,!1,!1,!1),i.cullFace(i.FRONT),i.stencilOp(i.KEEP,i.INCR,i.KEEP),e.render(r,o),i.cullFace(i.BACK),i.stencilOp(i.KEEP,i.DECR,i.KEEP),e.render(r,o),i.stencilFunc(i.EQUAL,0,255),i.stencilOp(i.KEEP,i.KEEP,i.KEEP),i.depthMask(!0),i.colorMask(!0,!0,!0,!0),s.directionalLight.intensity=x.DIRECTIONAL,s.hemisphereLight.intensity=x.HEMISPHERE,e.clearDepth(),e.render(a,o),i.disable(i.STENCIL_TEST)}});var ne=n(114),ie={createPortalComposer:function(e,t,n,i,a,o){var r=new Y.F(a,o),s=new X.$,l=new Y.M,c=new q.T(K.C),h=new Z.x(e,i);h.renderTarget1.stencilBuffer=!0,h.renderTarget2.stencilBuffer=!0;var d=new J.C(t,n);d.clear=!1,r.inverse=!1,h.addPass(s),h.addPass(r),h.addPass(d),h.addPass(c),h.addPass(l);var u=1/window.innerWidth,p=1/window.innerHeight,m=new q.T(Q.C);m.uniforms.resolution.value.set(u,p);var f=new $.m(new w.FM8(window.innerWidth,window.innerHeight),1.5,.4,.85);f.exposure=.5,f.threshold=.3,f.strength=1,f.radius=0;var g=new Z.x(e,i);g.renderToScreen=!1,g.renderTarget1.stencilBuffer=!0,g.renderTarget2.stencilBuffer=!0,g.addPass(s),g.addPass(r),g.addPass(d),g.addPass(l),g.addPass(f);var v=new q.T(new w.jyz({uniforms:{baseTexture:{value:null},bloomTexture:{value:g.renderTarget2.texture}},vertexShader:this.graphics.getBloomSelectiveVertexShader(),fragmentShader:this.graphics.getBloomSelectiveFragmentShader(),defines:{}}),"baseTexture");v.needsSwap=!0;var y=new Z.x(e,i);return y.renderTarget1.stencilBuffer=!0,y.renderTarget2.stencilBuffer=!0,y.addPass(s),y.addPass(r),y.addPass(d),y.addPass(v),y.addPass(m),y.addPass(l),y.addPass(c),[g,y,h]},createMainComposer:function(e,t,n,i){var a=1/window.innerWidth,o=1/window.innerHeight,r=new q.T(Q.C);r.uniforms.resolution.value.set(a,o);var s=new Z.x(e);s.renderTarget1.stencilBuffer=!0,s.renderTarget2.stencilBuffer=!0;var l,c=new J.C(t,n);this.shadowVolumes?(l=new te(t,n,i,this.sceneShadows),s.addPass(l)):s.addPass(c),s.addPass(r);var h=new $.m(new w.FM8(256,256),1.5,.4,.85);h.exposure=1,h.threshold=0,h.strength=1.5,h.radius=0;var d=new Z.x(e);d.renderTarget1.stencilBuffer=!0,d.renderTarget2.stencilBuffer=!0,d.renderToScreen=!1,this.shadowVolumes?d.addPass(l):d.addPass(c),d.addPass(h);var u=new q.T(new w.jyz({uniforms:{baseTexture:{value:null},bloomTexture:{value:d.renderTarget2.texture}},vertexShader:this.graphics.getBloomSelectiveVertexShader(),fragmentShader:this.graphics.getBloomSelectiveFragmentShader(),defines:{}}),"baseTexture");u.needsSwap=!0;var p=new Z.x(e);if(p.addPass(c),p.addPass(r),p.addPass(u),this.ambientOcclusion){var m=new ne.F(t,n,!1,!1);m.params.output=ne.F.OUTPUT.Default,m.params.saoBias=.1,m.params.saoIntensity=1.8,m.params.saoScale=1e4,m.params.saoKernelRadius=100,m.params.saoMinResolution=4e-6,m.params.saoBlur=1,m.params.saoBlurRadius=8,m.params.saoBlurStdDev=4,m.params.saoBlurDepthCutoff=.01,p.addPass(m)}return[d,p,s]},createRenderer:function(){var e=new w.CP7({antialias:!1,alpha:!0,logarithmicDepthBuffer:!0});return this.shadowMap&&(e.shadowMap.enabled=!0,e.shadowMap.type=w.ntZ),e.autoClear=!1,e.outputEncoding=w.knz,e.toneMapping=w.LY2,e.toneMappingExposure=.8,e.setClearColor(this.cssToHex("#000000"),1),e.setSize(window.innerWidth,window.innerHeight),e.info.autoReset=!1,e}},ae={darkenNonBloomed:function(e,t){e.isMesh&&!0!==e.userData.bloom&&(t[e.uuid]=e.material,e.material=this.darkMaterial)},restoreMaterial:function(e,t){e.isMesh&&t[e.uuid]&&(e.material=t[e.uuid],delete t[e.uuid])},selectObjectsWithReflection:function(e,t){e.traverse((function(e){if(e.userData.isMainXYFlipped){var n=e.position;n.set(n.y,n.x,n.z),e.updateWorldMatrix(!1,!1),e.traverse((function(e){e.isSkinnedMesh&&e.updateWorldMatrix(!0,!1)}))}if(e.isMesh&&!0===e.userData.hasReflection&&(e.visible=!0,e.userData.hasTransparency)){var i=e.material.opacity;if(i>=1)return;e.material.opacity=Math.min(i+t/2e5,1)}}))},selectObjectsWithPrimaryImage:function(e){e.traverse((function(e){if(e.userData.isMainXYFlipped){var t=e.position;t.set(t.y,t.x,t.z),e.updateWorldMatrix(!1,!1),e.traverse((function(e){e.isSkinnedMesh&&e.updateWorldMatrix(!0,!0)}))}e.isMesh&&(!0===e.userData.hasPrimaryImage?e.visible=!0:e.visible=!1)}))},updateSkies:function(e){var t=this;this.graphics.app.model.backend.chunkModel.skies.forEach((function(n,i){t.graphics.updateSunPosition(e,n,i)}))},updateFootsteps:function(e){var t=this.graphics.app.model.backend.selfModel.footstepMeshes;if(t)for(var n=0;n<t.length;++n){var i=e/1e3;t[n].getMesh().material.uniforms.time.value+=i/1}},updateWaterReflection:function(e,t,n,i,a){if("-1"===this.graphics.app.model.backend.selfModel.worldId.toString())this.updateWaters(e,t,n,i);else for(var o=0,r=a.length;o<r;++o){var s=a[o],l=s.scene;if(l&&"-1"===s.sceneId.toString()){var c=s.camera.cameraObject;this.updateWaters(e,t,l,c);break}}},updateWaters:function(e,t,n,i){var a=this,o=this.graphics.app.model.backend.chunkModel.worlds,r=this.graphics.app.model.backend.chunkModel.skies,s=e.mainCamera.getCameraPosition(),l=this.graphics.waterMaterials,c=this.darkWater;o.forEach((function(e){e.forEach((function(e){for(var t=e.meshes,n=0;n<t.length;++n)if(e.water[n]){var i=t[n];i.visible=!1,i.material&&(i.material=c)}}))})),this.updateWaterCamera(e,t,n,i),o.forEach((function(e,t){var n=r.get(t),i=a.graphics.getSunDirection(n),o=l.get(t);e.forEach((function(e){for(var t=e.meshes,n=0;n<t.length;++n)if(e.water[n]){var i=t[n];i.visible=!0,i.material&&(i.material=o)}})),o&&o.uniforms&&o.uniforms.eye&&(o.uniforms.eye.value.copy(s),o.uniforms.sunDirection.value=i,o.uniforms.time.value+=.01)}))},updateWaterCamera:function(e,t,n,i){if(e.updateWaterCamera(i),!this.shortCircuitWaterReflection){var a=n,o=e.waterCamera.waterRenderTarget,r=e.waterCamera.camera,s=t.getRenderTarget(),l=t.shadowMap.autoUpdate;t.shadowMap.autoUpdate=!1,t.setRenderTarget(o),!1===t.autoClear&&t.clear(),t.render(a,r),t.shadowMap.autoUpdate=l,t.setRenderTarget(s)}},updateShadows:function(){var e=this.graphics,t=e.app.model.backend.chunkModel.worlds,n=e.app.model.backend.chunkModel.skies,i=e.cameraManager.waterCamera.eye;t.forEach((function(t,a){var o=n.get(a),r=e.getSunDirection(o);r.set(-r.x,r.y,r.z).negate(),t.forEach((function(e){if(e.shadow){var t=e.shadow;t.material&&t.material.uniforms&&(t.material.uniforms.lightPosition.value=r,t.material.uniforms.eyePosition.value=i)}}))}))}},oe={renderPortals:function(e,t,n,i,a){for(var o,r,s,l,c,h,d,u,p=this,m=0,f=this.renderMax,g=0,v=a.length;g<v;++g)o=a[g],(c=o.scene)&&c.updateMatrixWorld();var y=t.stencilCamera;this.stencilScene.updateMatrixWorld(),this.graphics.cameraManager.updateCameraRotation(0,0,0,0);for(var w,b,x=this.graphics.app.model.backend.chunkModel.worlds,M=this.graphics.instancedMaterials,S=this.graphics.waterMaterials,C=function(t,g){if(m++>f)return"break";o=a[t],r=o.screen1,s=o.screen2,l=o.camera,b=o.sceneId.toString(),w=o.id;var v=M.get(b),C=void 0,T=void 0;v&&(C=v[0],T=S.get(b));var k=M.get(w),P=S.get(w);!k&&C&&(k=C.clone(),M.set(w,k),T&&(P=T.clone(),S.set(w,P)));var I=x.get(b);if(c=o.scene,!l)return"continue";if(h=l.getRecorder(),d=r.getRenderTarget(),!c)return p.corrupted<5&&p.corrupted++,o.sceneId&&(o.scene=n.getScene(o.sceneId)),"continue";if(!h)return console.log("Could not get buffer camera."),"continue";if(!d)return console.log("Could not get buffer texture."),"continue";s&&((u=s.getMesh()).visible=!1);var A=r.getMesh(),E=p.stencilScreen,O=l.getCameraTransform();E.position.copy(A.position),E.position.x+=O[0],E.position.y+=O[1],E.position.z+=O[2],E.rotation.copy(A.rotation),E.updateMatrixWorld(),y.matrixWorld.copy(h.matrixWorld);var L=o.id.toString(),_=void 0;p.composers.has(L)?_=p.composers.get(L):(_=p.createPortalComposer(e,c,h,d,p.stencilScene,y),p.composers.set(L,_)),I&&C&&k&&I.forEach((function(e){for(var t=e.meshes,n=0;n<t.length;++n){var i=t[n];i&&(e.water[n]||i.material&&(i.material=k))}})),A.visible=!1,p.selectiveBloom?(c.traverse((function(e){return p.darkenNonBloomed(e,i)})),_[0].render(),c.traverse((function(e){return p.restoreMaterial(e,i)})),_[1].render()):_[2].render(),A.visible=!0,I&&C&&k&&I.forEach((function(e){for(var t=e.meshes,n=0;n<t.length;++n){var i=t[n];i&&(e.water[n]||i.material&&(i.material=C))}})),s&&(u.visible=!0)},T=0,k=a.length;T<k;++T){if("break"===C(T))break}}},re={startSceneTransition:function(e){this.isTransitioning=!0,this.isInTitleScene=!1,this.toTitle=e,this.materialCrossFade.uniforms.mixRatio.value=e?0:1},endSceneTransition:function(){this.isTransitioning=!1},setTransitionDuration:function(e){this.transitionDuration=e},setInTitleScene:function(e){this.isInTitleScene=e,e?this.titleGraphics.center():this.titleGraphics.hide()},setupTitles:function(){this.isInTitleScene=!1,this.isTransitioning=!1,this.toTitle=!1,this.transitionDuration=1e3,this.titleGraphics=this.graphics.createTitleLabel(),this.setInTitleScene(!1);var e=window.innerWidth,t=window.innerHeight;this.mainSceneRenderTarget=new w.dd2(e,t,{minFilter:w.wem,magFilter:w.wem,format:w.UCm}),this.transitionSceneRenderTarget=new w.dd2(e,t,{minFilter:w.wem,magFilter:w.wem,format:w.UCm}),this.titleScene=new w.xsS,this.titleCamera=new w.iKG(1,1,1,1),this.sceneCrossFade=new w.xsS,this.cameraCrossFade=new w.iKG(e/-2,e/2,t/2,t/-2,-10,10),this.materialCrossFade=new w.jyz({uniforms:{tDiffuse1:{value:null},tDiffuse2:{value:null},mixRatio:{value:0}},vertexShader:this.graphics.getCrossFadeVertex(),fragmentShader:this.graphics.getCrossFadeFragment()}),this.geometryCrossFade=new w.BKK(e,t),this.quadCrossFade=new w.Kj0(this.geometryCrossFade,this.materialCrossFade),this.sceneCrossFade.add(this.quadCrossFade),this.materialCrossFade.uniforms.tDiffuse1.value=this.transitionSceneRenderTarget.texture,this.materialCrossFade.uniforms.tDiffuse2.value=this.mainSceneRenderTarget.texture},setupTitlesAfterWindowResize:function(e,t){this.mainSceneRenderTarget.setSize(e,t),this.transitionSceneRenderTarget.setSize(e,t)},updateTransition:function(){var e=this.transitionDuration,t=this.graphics.app.engine.ux.getElapsed()/e,n=this.materialCrossFade.uniforms.mixRatio;this.toTitle?(n.value+=t,n.value>=1&&(this.endSceneTransition(),this.setInTitleScene(!0),n.value=1)):(n.value-=t,n.value<=0&&(this.endSceneTransition(),this.setInTitleScene(!1),n.value=0))},renderCrossFadeScene:function(e,t){this.updateTransition(),t.renderToScreen=!1,t.writeBuffer=this.mainSceneRenderTarget,t.render(),e.setRenderTarget(this.transitionSceneRenderTarget),e.render(this.titleScene,this.titleCamera),e.setRenderTarget(null),e.clear(),e.render(this.sceneCrossFade,this.cameraCrossFade)},renderTitleScene:function(e){e.setRenderTarget(null),e.clear(),e.render(this.titleScene,this.titleCamera)},setTitleSceneText:function(e){this.titleGraphics.setText(e)},setTitleOpacity:function(e){this.titleGraphics.setOpacity(e)}},se=function(e){this.graphics=e,this.selectiveBloom=!0,this.waterReflection=!0,this.shortCircuitWaterReflection=!1,this.shadowVolumes=!1,this.shadowMap=!1,this.highResolutionShadowMap=!1,this.shadowVolumes&&this.shadowMap&&(console.error("[Renderer] Cannot use both shadow map and shadow volume."),this.shadowVolumes=!1),("ontouchstart"in window||navigator.msMaxTouchPoints>0)&&(this.selectiveBloom=!1,x.HEMISPHERE*=4,x.DIRECTIONAL*=4,x.AMBIENT*=4),this.ambientOcclusion=!1,this.renderer=this.createRenderer(),this.renderer.autoClear=!1,this.composers=new Map,this.setupTitles(),this.renderRegister=[],this.stencilScene=new w.xsS,this.stencilScreen=new w.Kj0(new w.BKK(1,2),new w.vBJ({color:11184810,side:w.ehD,transparent:!1})),this.stencilScene.add(this.stencilScreen),this.corrupted=0,this.stop=!1,this.renderMax=10,this.darkMaterial=new w.vBJ({color:"black",side:w.Wl3,skinning:!0,flatShading:!1}),this.darkWater=new w.vBJ({color:"black",side:w.ehD,morphTargets:!0}),this.shadowVolumes&&(this.sceneShadows=new w.xsS)};a(se.prototype,{addToShadows:function(e){this.sceneShadows.add(e)},removeFromShadows:function(e){this.sceneShadows.remove(e)},cssToHex:function(e){return 0|e.replace("#","0x")},getRenderRegister:function(){return this.renderRegister},setRenderRegister:function(e){this.renderRegister=e},render:function(e,t,n){var i=this;if(!this.stop){var a=this.renderer,o=this.renderRegister,r=e.mainScene,s=t.mainCamera.getRecorder(),l={};s.updateProjectionMatrix(),s.updateMatrixWorld(),s.matrixWorldInverse.copy(s.matrixWorld).invert(),r.updateMatrixWorld();try{this.updateSkies(s),this.updateFootsteps(n),this.selectObjectsWithReflection(r,n),this.waterReflection&&this.updateWaterReflection(t,a,r,s,o),this.selectObjectsWithPrimaryImage(r),this.shadowVolumes&&this.updateShadows(t,a,r,s)}catch(e){return console.error(e),void(this.stop=!0)}o.length>0&&this.renderPortals(a,t,e,l,o);var c,h=this.graphics.app.model.backend,d=h.selfModel.worldId.toString();if(this.composers.has(d))c=this.composers.get(d);else{var u=h.chunkModel.skies.get(d);if(!u||!u.lights)return;c=this.createMainComposer(a,r,s,u.lights),this.composers.set(d,c)}if(this.selectiveBloom)if(this.isTransitioning){r.traverse((function(e){return i.darkenNonBloomed(e,l)})),c[0].render(),r.traverse((function(e){return i.restoreMaterial(e,l)}));var p=c[1];this.renderCrossFadeScene(a,p)}else if(this.isInTitleScene)this.renderTitleScene(a);else{r.traverse((function(e){return i.darkenNonBloomed(e,l)})),c[0].render(),r.traverse((function(e){return i.restoreMaterial(e,l)}));var m=c[1];m.renderToScreen=!0,m.render()}else{var f=c[2];this.isTransitioning?this.renderCrossFadeScene(a,f):this.isInTitleScene?this.renderTitleScene(a):(f.renderToScreen=!0,f.render())}a.info.reset()}},resize:function(e,t){var n=this;e||(e=window.innerWidth),t||(t=window.innerHeight),this.renderer.setSize(e,t),this.setupTitlesAfterWindowResize(e,t),this.composers.forEach((function(i){for(var a=function(a){var o=i[a];o.setSize(e,t);var r=n.renderer.getPixelRatio(),s="resolution";o.passes.forEach((function(n){n&&n instanceof q.T&&n.material&&n.material.uniforms&&n.material.uniforms[s]&&(n.material.uniforms[s].value.x=1/(e*r),n.material.uniforms[s].value.y=1/(t*r))}))},o=0;o<i.length;++o)a(o)}))},switchAvatarToScene:function(){},cleanup:function(){this.composers.forEach((function(){})),this.composers=new Map,this.renderRegister.length=0,this.renderer.renderLists.dispose(),this.renderer.setRenderTarget(null),this.renderer.clear()}}),a(se.prototype,ie),a(se.prototype,ae),a(se.prototype,oe),a(se.prototype,re);var le=function(){this.mainScene=this.createScene(-1),this.subScenes=new Map,this.screens=new Map};a(le.prototype,{createScene:function(e){var t=new w.xsS;return t.sceneId=e,t.autoUpdate=!1,t},addScene:function(e,t){return t||(t=this.createScene(e)),this.subScenes.set(e,t),t},hasScene:function(e){return e=parseInt(e,10),this.subScenes.has(e)},switchToScene:function(e,t,n){e=parseInt(e,10);var i=this.subScenes.get(e);if(i){var a=this.mainScene,o=a.sceneId;this.mainScene=i,this.subScenes.delete(e),this.addScene(o,a),n&&(a.remove(n),i.add(n)),t.switchMainCameraToWorld(o,e)}else console.log("Failed to switch to scene ".concat(e,"!"))},addObject:function(e,t){var n=this.getScene(t);n&&e.parent!==n&&n.add(e)},removeObject:function(e,t,n){var i=this.getScene(t);i&&(i.remove(e),n||(e.geometry&&(e.geometry.dispose(),e.geometry=null),e.material&&(e.material.dispose(),e.material=null)))},getScene:function(e){return parseInt(e,10)===parseInt(this.mainScene.sceneId,10)?this.mainScene:this.subScenes.get(e)},resize:function(e,t){e||(e=window.innerWidth),t||(t=window.innerHeight),this.screens.forEach((function(n,i){n.isLinked()?n.getRenderTarget().setSize(e,t):console.log("Not resizing screen ".concat(i,"."))}))},removeScreen:function(e){var t=this.screens.get(e);if(t){var n=this.getScene(t.getWorldId());n&&n.remove(t),this.removeObject(t.getMesh(),t.getWorldId(),!0)}},cleanup:function(){var e=this;this.mainScene.traverse((function(t){t.isObject3D&&t.isMesh&&(t.geometry.dispose(),t.material.dispose()),t.isCamera&&e.mainScene.remove(t)})),this.mainScene=this.createScene(-1),this.subScenes.clear(),this.screens.forEach((function(e){e.mesh&&(e.mesh.geometry.dispose(),e.mesh.material.dispose()),e.renderTarget&&e.renderTarget.dispose()})),this.screens.clear()}});var ce={addToShadows:function(e){this.rendererManager.addToShadows(e)},removeFromShadows:function(e){this.rendererManager.removeFromShadows(e)},addToScene:function(e,t){var n=this.sceneManager;t||(t=n.mainScene.sceneId),t=parseInt(t,10),n.addObject(e,t)},removeFromScene:function(e,t,n){var i=this.sceneManager;t||(t=i.mainScene.sceneId),t=parseInt(t,10),i.removeObject(e,t,n)},addScene:function(e){e=parseInt(e,10);var t=this.sceneManager;if(parseInt(e,10)!==parseInt(t.mainScene.sceneId,10)&&!t.subScenes.has(e))return t.addScene(e)},forgetScene:function(e){var t=this.sceneManager;parseInt(e,10)!==parseInt(t.mainScene.sceneId,10)&&t.subScenes.has(e)?this.subScenes.delete(e):console.log("Trying to delete main scene or unknown scene: ".concat(e))},getScene:function(e,t){var n=this.sceneManager.getScene(e);return!n&&t&&(n=this.addScene(e)),n},addScreen:function(e,t){this.sceneManager.screens.set(e,t)},getScreen:function(e){return this.sceneManager.screens.get(e)},removeScreen:function(e){this.sceneManager.removeScreen(e)},switchToScene:function(e,t){this.sceneManager.switchToScene(t,this.cameraManager),this.rendererManager.switchAvatarToScene(t),this.previousFrameWorld=parseInt(e,10),this.currentFrameWorld=parseInt(t,10)}},he={initializeEntityAnimation:function(e,t){e.p0=new w.Pa4(0,0,0),e.p1=new w.Pa4(0,0,0),e.dt01=0,e.dt12=0,e.v0=new w.Pa4(0,0,0),e.v1=new w.Pa4(0,0,0),e.a0=new w.Pa4(0,0,0),e.a1=new w.Pa4(0,0,0),e.theta0=t,e.theta1=e.theta0,e.currentTheta=e.theta0,e.thetaT=0,e.velTilt=new w.FM8(0,0),e.xy0=new w.FM8(0,0),e.xy1=new w.FM8(0,0),e.xy2=new w.FM8(0,0),e.currentXY=new w.FM8(0,0),e.lastWantedXY=new w.FM8(0,0),e.xyT=0,e.towardsR=0,e.towardsT=0,e.idleBlendRatio=1,e.idleTime=0,e.timeToIdle=.3,e.walkingAdvancement=0},updateEntityPosition:function(e,t,n){var i=t,a=e.position,o=n/1e3;if(!i.p0){var r=e.rotation.z;return this.initializeEntityAnimation(i,r),i.p0.copy(a),void(i.dt01=o)}i.p1.copy(i.p0),i.p0.copy(a),i.dt01=o,i.v1.copy(i.v0),i.v0.copy(i.p1).addScaledVector(i.p0,-1),i.v0.multiplyScalar(1/i.dt01),i.a1.copy(i.a0),i.a0.copy(i.v0).addScaledVector(i.v1,-1),i.a0.multiplyScalar(1/i.dt01)}},de={updateEntityRotationAndTilt:function(e,t,n){var i=e.getTheta();if(t.p0){var a=n/1e3;this.applyRotationFromVelocity(e,t,i,a),this.applyTiltFromVelocity(e,t,a),t.isJumping||this.applyTiltFromAcceleration(e,t,a)}else this.initializeEntityAnimation(t,i)},applyRotationFromVelocity:function(e,t,n,i){var a=t,o=e,r=a.v0,s=Math.PI;if(Math.abs(r.x)+Math.abs(r.y)>0){var l=Math.atan2(r.y,r.x)-s/2;if(l>s)l-=2*s;else if(l<-s)l+=2*s;else if(l>2*s||l<-2*s)throw Error("[Animations] Invalid target theta.");this.almostEqual(a.theta1,l)||(a.theta1!==a.theta0?(a.thetaT=.1,a.theta0=n,a.theta1=l):(a.thetaT=0,a.theta0=n,a.theta1=l))}if(a.currentTheta!==a.theta1){var c=a.theta0,h=a.theta1;a.thetaT+=i;var d=this.smoothstep(0,.4,a.thetaT);if(1===d)a.currentTheta=a.theta1;else{var u=h;if(Math.abs(c-u)>s&&(null===(u=h>c?h-2*s:h<c?h+2*s:null)||Math.abs(c-u)>s))throw Error("[Animations] still target delta > pi.");var p=d*u+(1-d)*c;p>s?p-=2*s:p<-s&&(p+=2*s),a.currentTheta=p}var m=o.getRotation();m&&(this._r.set(m.x-s/2,m.y,a.currentTheta),o.setRotation(this._r))}else a.theta0=a.theta1},applyTiltFromVelocity:function(e,t,n){var i=.25*Math.PI/8,a=t,o=e,s=e.physicsEntity;r(s&&s.collisionModel,"[Animations] Could not get entity collision model.");var l=s.collisionModel,c=Math.PI,h=a.v0,d=l.isJumping?-1:1;l.isJumping&&(i*=4);var u=d*h.x,p=d*h.y,m=a.velTilt.x,f=a.velTilt.y,g=Math.atan2(p,u)-c/2,v=Math.sqrt(u*u+p*p);v/=l.maxSpeedInAir,v=Math.min(v,1),v*=i;var y=5.9*n*2,w=(y=Math.min(y,1))*(v*Math.cos(g)-m),b=y*(v*Math.sin(g)-f);if(Math.abs(w)+Math.abs(b)>0){var x=m+w;Math.abs(x)<.001&&(x=0);var M=f+b;Math.abs(M)<.001&&(M=0);var S=o.getRotation();S&&(this._r.set(S.x-c/2+w,S.y+b,S.z),o.setRotation(this._r),a.velTilt.set(x,M))}},applyTiltFromAcceleration:function(e,t,n){var i=.5*Math.PI/8,a=t,o=a.a0;if(Math.abs(o.x)+Math.abs(o.y)>-.1){var r=Math.sqrt(o.x*o.x+o.y*o.y),s=e.physicsEntity.collisionModel,l=s.wantedXY,c=1;s&&s.timeToReachMaxVel&&(c=s.maxSpeedInAir/s.timeToReachMaxVel);var h=(r/=c)>0,d=Math.PI,u=Math.atan2(o.y,o.x)-d/2,p=a.towardsR,m=a.towardsT;if(h&&r<=1&&Math.abs(m-u)<.5&&r<p&&(r=p),r>2?(Math.abs(d/2-Math.abs(a.a0.angleTo(a.v0))),r=.5,a.lastWantedXY.set(0,0)):r=0,r<1){var f=l.length(),g=a.lastWantedXY,v=g.length();(f>v||Math.abs(g.dot(l)/(f*v))<.999)&&this.dotV2V3(l,a.v0)<-.99&&(u=Math.atan2(-l.y,-l.x)-d/2,r=f),g.copy(l)}h=(r*=i)>0;var y=r*Math.cos(u),w=r*Math.sin(u);if(h&&(!this.almostEqual(y,a.xy1.x)||!this.almostEqual(w,a.xy1.y))){var b=e.getRotationX()-d/2,x=e.getRotationY(),M=a.velTilt;a.xyT=0,a.xy0.set(b-M.x,x-M.y),a.xy1.set(y,w),a.currentXY.copy(a.xy0),a.towardsR=r,a.towardsT=u}}if(a.currentXY.manhattanDistanceTo(a.xy1)>0){var S,C,T=a.xy0,k=a.xy1;if(a.xyT+=n,k.manhattanDistanceTo(a.xy2)<.001?(C=.6,S=this.smoothstep(0,C,a.xyT)):(C=.2,S=this.smoothstepAttack(0,C,a.xyT)),1===S)a.currentXY.copy(k);else{var P=S*k.x+(1-S)*T.x,I=S*k.y+(1-S)*T.y;a.currentXY.set(P,I)}var A=e,E=A.getRotation(),O=a.currentXY,L=a.velTilt;E&&(this._r.set(O.x+L.x,O.y+L.y,E.z),A.setRotation(this._r))}!(a.currentXY.manhattanDistanceTo(a.xy1)>0)&&a.xy1.manhattanDistanceTo(a.xy2)>0&&(a.xy0.copy(a.xy1),a.xy1.copy(a.xy2),a.currentXY.copy(a.xy0),a.xyT=0)},dotV2V3:function(e,t){var n=Math.sqrt(e.x*e.x+e.y*e.y),i=Math.sqrt(t.x*t.x+t.y*t.y);return 0===n||0===n?0:(e.x*t.x+e.y*t.y)/(n*i)},almostEqual:function(e,t){return Math.abs(e-t)<1e-5},lerp:function(e,t,n){return this.clamp((n-e)/(t-e),0,1)},smootherstep:function(e,t,n){var i=this.clamp((n-e)/(t-e),0,1);return i*i*i*(i*(6*i-15)+10)},smoothstep:function(e,t,n){var i=this.clamp((n-e)/(t-e),0,1);return i*i*(3-2*i)},smoothstepAttack:function(e,t,n){var i=this.clamp((n-e)/(t-e),0,1);return(i=Math.pow(i,.5))*i*(3-2*i)},smoothstepAttackReverse:function(e,t,n){var i=this.clamp((n-e)/(t-e),0,1);return 1-(i=Math.pow(1-i,.5))*i*(3-2*i)},clamp:function(e,t,n){return Math.min(n,Math.max(t,e))}},ue={setupMixer:function(e,t,n,i){var a=t.userData.animations;i.actionStates={},i.actions={},i.tracks={},i.times={};for(var o=i.actionStates,r=i.actions,s=i.tracks,l=i.times,c=0;c<a.length;++c){var h=a[c],d=h.name;o[d]=0;var u=n.clipAction(h);u.setEffectiveWeight(0),u.play(),r[d]=u,s[d]=h,l[d]=h.tracks[0].times}i.displacement=new w.FM8(0,0)},updateMixerAction:function(e,t,n,i){r(!!t.actionStates,"[Mixers] Animation not properly initialized.");var a=t.actions;r("Running"in a,"[Mixers] Running animation not found.");var o=e.physicsEntity.collisionModel;if(o.isPreparingJump)return this.updatePrepareJump(o,e,t,n,i),void(t.idleTime=0);(o.isJumping||o.hasJustLanded||o.isRecoveringFromLanding)&&(this.updateJump(o,e,t,n,i),t.idleTime=0);var s=t.p0,l=t.p1,c=t.displacement;c.copy(s).addScaledVector(l,-1);var h=c.length();h>1e-5?(o.onGround?this.updateWalkRunCycle(o,h,e,t,n,i):this.updateJump(o,e,t,n,i),t.idleTime=0):o.isJumping||o.hasJustLanded||o.isRecoveringFromLanding||o.isFalling||this.updateToIdle(e,t,n,i)},updateOtherAnimationWeights:function(e,t,n){if(1!==e){var i=0;for(var a in n)a!==t&&(i+=n[a].getEffectiveWeight());i+e<1&&i<.01&&e<1&&n[t].setEffectiveWeight(1);var o=1-e;if(i>0)for(var r in n)if(r!==t){var s=n[r],l=s.getEffectiveWeight()/i;s.setEffectiveWeight(o*l)}}else for(var c in n)c!==t&&n[c].setEffectiveWeight(0)},updateToIdle:function(e,t,n,i){var a=t.actions,o=a.Idle,r=i/1e3;t.idleTime+=r;var s=t.idleTime,l=t.timeToIdle,c=this.clamp(s/l,0,1),h=o.getEffectiveWeight();c<h&&(c=h),o.setEffectiveWeight(c);var d=e.getBounceAmount(),u=c<1?d/2:0;e.setBounceAmount(u),this.updateOtherAnimationWeights(c,"Idle",a),n.update(0)},updateWalkRunCycle:function(e,t,n,i,a,o){var r=i.actions,s=r.Running,l=i.times.Running,c=l[l.length-1],h=o/1e3,d=t/h,u=e.maxSpeedInAir,p=this.clamp(d/u,0,1),m=Math.max(.6,1.4*p),f=.7*t/m,g=m/1.4,v=s.getEffectiveWeight();s.setEffectiveWeight(g),g<v&&!e.isRecoveringFromLanding&&!e.isJumping&&r.Idle.setEffectiveWeight(1-g),e.isRecoveringFromLanding||this.updateOtherAnimationWeights(g,"Running",r),i.idleTime>i.timeToIdle&&(i.walkingAdvancement=.25*c,a.setTime(.25*c)),i.walkingAdvancement+=f*c*.5,i.walkingAdvancement%=c;var y=i.walkingAdvancement,w=this.doubleSmoothstep(y/c),b=.1*this.cycloidBounce(w);b*=this.catmullRom4(0,2,0,.2,p),n.setBounceAmount(b);var x=w*c,M=a.time/c,S=x/c;(M<.25&&S>.25||M<.75&&S>.75)&&(e.onWater?this.waterHit(n,e,h):this.groundHit(n,e,h)),a.setTime(x)},groundHit:function(){this.graphics.app.engine.audio.playFootstepSound()},waterHit:function(e,t){var n=e.footstepMeshes,i=n.length,a=e.currentFootStep,o=n[a].getMesh();o.material.uniforms.time.value=0;var r=t.position0;o.position.set(r.x,r.y,r.z-.7+.001*a),e.currentFootStep++,e.currentFootStep%=i,this.graphics.app.engine.audio.playFootstepWaterSound()},updatePrepareJump:function(e,t,n,i,a){var o=n.actions,r=o.Crouching,s=o.Jumping,l=a/1e3,c=e.timeSincePreparedJump+l,h=e.timeToPrepareJump,d=this.clamp(c/h,0,1);(d=this.smoothstepAttackReverse(0,1,d))<.5?(d*=2,r.setEffectiveWeight(d),this.updateOtherAnimationWeights(d,"Crouching",o)):(d=2*(d-.5),s.setEffectiveWeight(d),this.updateOtherAnimationWeights(d,"Jumping",o)),i.update(0)},updateJump:function(e,t,n,i,a){var o=n.actions,r=o.Jumping,s=n.times.Running,l=s[s.length-1],c=a/1e3,h=n.v1.z,d=n.v0.z;e._maxVZ=Math.max(e._maxVZ,-d);var u=e._maxVZ/2,p=-h>u&&-d<u;p&&(e.timeSinceFallStarted=0);var m=-d<u;if(e.hasJustLanded||e.isRecoveringFromLanding){e.hasJustLanded&&(e.onWater?this.waterHit(t,e,c):this.groundHit(t,e,c)),e.hasJustLanded=!1,e.isRecoveringFromLanding=!0,e.timeSinceHasLanded+=c;var f=e.timeToRecoverFromLanding,g=this.clamp(e.timeSinceHasLanded/f,0,1),v=this.smoothstepAttack(0,1,g);if(v<.5){var y=2*v;o.Crouching.setEffectiveWeight(y),this.updateOtherAnimationWeights(y,"Crouching",o),i.update(0)}else{var w=o.Idle,b=o.Running,x=2*(v-.5);b.getEffectiveWeight()>0?(b.setEffectiveWeight(x),this.updateOtherAnimationWeights(x,"Running",o)):(w.setEffectiveWeight(x),this.updateOtherAnimationWeights(x,"Idle",o)),i.update(0)}1===g&&(e.timeSinceHasLanded=0,e.isRecoveringFromLanding=!1,o.Idle.setEffectiveWeight(1),this.updateOtherAnimationWeights(1,"Idle",o),i.update(0))}else{if(d>0&&!e.isJumping){e.isFalling=!0;var M=o.Falling,S=M.getEffectiveWeight();return S=Math.min(S+c/l,1),M.setEffectiveWeight(S),this.updateOtherAnimationWeights(S,"Falling",o),void i.update(0)}if(p||m){var C=o.Falling;e.timeSinceFallStarted+=c;var T=this.clamp(e.timeSinceFallStarted/e.timeToSetFallState,0,1),k=this.smoothstep(0,1,T);return C.setEffectiveWeight(k),this.updateOtherAnimationWeights(k,"Falling",o),void i.update(0)}r.setEffectiveWeight(1),this.updateOtherAnimationWeights(1,"Jumping",o),i.setTime(0)}},catmullRom4:function(e,t,n,i,a){var o=a*a,r=a*o,s=2*r-3*o+1;return s*e+(r-2*o+a)*(t-e)+(1-s)*i+(r-o)*(i-n)},doubleSmoothstep:function(e){r(e>=0&&e<=1,"DSST: must normalize param.");var t=e<.5?2*e:2*(e-.5),n=this.clamp(t,0,1),i=n*n*(3-2*n)*.5;return e>=.5&&(i+=.5),i},cycloidBounce:function(e){var t=2*e;return t=(t-.5)*Math.PI,Math.pow(Math.abs(Math.sin(t)),2)}},pe={updateTextLabels:function(e){var t=this,n=this.graphics,i=n.app.model.backend;if(!i.selfModel.locked){var a=i.entityModel.labelledEntities,o=n.cameraManager.mainCamera.getRecorder();a.forEach((function(n,i){var a=n.textComponent;if(a||!t._debug){var r=a.getText();if(r&&!(r.length<1)){var s=n.animationComponent;a.advanceTime(e),a.updatePosition(o,s.p0)}}else console.warn("[Animations/Label] Labelled entity ".concat(i," has no label."))}))}},addLabelledEntity:function(e,t,n){var i=this.graphics,a=i.createTextLabel(e);return a.bindAudio(i.app.engine.audio),i.app.model.backend.entityModel.labelledEntities.set(t,n),n.textComponent=a,a}},me={saveOldRotation:function(e,t){this.oldPitchRotationX=e,this.oldYawRotationZ=t},saveNewRotation:function(e,t){this.newPitchRotationX=e,this.newYawRotationZ=t},saveOldPosition:function(e){this.oldCameraPosition.copy(e)},saveNewPosition:function(e){this.newCameraPosition.copy(e)},updateCameraFeedback:function(e){var t=this.graphics.cameraManager.mainCamera,n=this.currentCameraPosition,i=this.newCameraPosition;if(n.manhattanDistanceTo(i)>0){var a=Math.min(e/16,4),o=this._w0;o.set(.2*a*(i.x-n.x),.2*a*(i.y-n.y),.1*a*(i.z-n.z)),n.set(i.x,i.y,n.z+o.z)}t.setCameraPosition(n.x,n.y,n.z);var r=t.cameraObject,s=this._w0;r.getWorldPosition(s);var l=this.raycaster,c=n.distanceTo(s),h=this._w1;h.copy(s).addScaledVector(n,-1).normalize(),l.set(n,h),l.far=c+10;var d=this.raycastables;if(d.length){var u=l.intersectObjects(d);if(u.length){var p=u[0];if(p&&p.point){var m=p.distance;if(m<2){var f=(m-.5)/1.5,g=Math.pow(f,2);t.cameraObject.position.z=1.5*g+.5}}}}},addRaycastable:function(e){this.raycastables.push(e)},resetRaycastables:function(){this.raycastables=[]},resetCameraFeedback:function(){var e=this.graphics.cameraManager.mainCamera,t=this.newCameraPosition;e.setCameraPosition(t.x,t.y,t.z),e.cameraObject.position.z=2}};function fe(){this.q=new w._fP,this.targetVec=new w.Pa4,this.effectorPos=new w.Pa4,this.effectorVec=new w.Pa4,this.linkPos=new w.Pa4,this.invLinkQ=new w._fP,this.linkScale=new w.Pa4,this.axis=new w.Pa4,this.vector=new w.Pa4}function ge(){this.v1=new w.Pa4,this.v2=new w.Pa4,this.v3=new w.Pa4,this.v4=new w.Pa4,this.v5=new w.Pa4,this.v6=new w.Pa4,this.v7=new w.Pa4,this.v8=new w.Pa4,this.v9=new w.Pa4,this.v10=new w.Pa4,this.v11=new w.Pa4,this.v12=new w.Pa4,this.q1=new w._fP,this.q2=new w._fP,this.m1=new w.yGw,this.m2=new w.yGw,this.mFixedBaseLocation=new w.Pa4,this.mSolveDistanceThreshold=.001,this.mMinIterationChange=0,this.mFixedBaseMode=!0,this.ops=0,this.annealOnce=!1}fe.prototype.solve=function(e,t,n,i,a){for(var o=e,r=void 0!==n?n:1,s=i,l=o[s.effector],c=t,h=s.links,d=0;d<r&&this.iterate(h,o,s,l,t,c,a);d++);},fe.prototype.iterate=function(e,t,n,i,a,o,r){for(var s=Math,l=this.q,c=this.targetVec,h=this.effectorPos,d=this.effectorVec,u=this.linkPos,p=this.invLinkQ,m=this.linkScale,f=this.axis,g=this.vector,v=!1,y=e.length-1;y>=0;--y){var w=e[y].id;if(w!==y)throw Error("Please specify all links in the constraints array.");var b=t[w];if(!1===e[y].enabled)break;var x=e[y].limitation,M=e[y].rotationMin,S=e[y].rotationMax;if(b.matrixWorld.decompose(u,p,m),p.invert(),h.setFromMatrixPosition(i.matrixWorld),h.distanceTo(a)<1e-5)break;d.subVectors(h,u),d.applyQuaternion(p),d.normalize(),c.subVectors(o,u),c.applyQuaternion(p),c.normalize();var C=c.dot(d);if(C>1?C=1:C<-1&&(C=-1),!((C=s.acos(C))<1e-5)){if(void 0!==n.minAngle&&C<n.minAngle&&(C=n.minAngle),void 0!==n.maxAngle&&C>n.maxAngle&&(C=n.maxAngle),f.crossVectors(d,c),f.normalize(),l.setFromAxisAngle(f,C),b.quaternion.multiply(l),r&&void 0!==x){var T=b.quaternion.w;T>1&&(T=1);var k=s.sqrt(1-T*T);b.quaternion.set(x.x*k,x.y*k,x.z*k,T)}r&&void 0!==M&&b.rotation.setFromVector3(b.rotation.toVector3(g).max(M)),r&&void 0!==S&&b.rotation.setFromVector3(b.rotation.toVector3(g).min(S)),b.updateMatrixWorld(!0),v=!0}}return v},ge.prototype.solve=function(e,t,n,i,a){var o=Number.MAX_VALUE,r=Number.MAX_VALUE,s=Number.MAX_VALUE;this.mFixedBaseLocation=i.fixedBaseLocation,this.ops=0;var l,c,h=this.m1,d=e[0].parent;if(!d)throw Error("Bone chain must be attached to a SkinnedMesh.");h.copy(d.matrixWorld).invert();for(var u=this.q1,p=this.v1,m=this.v2,f=i.chainProxy,g=0;g<f.length;++g)e[g].matrixWorld.decompose(p,u,m),f[g].copy(p);if(this.annealOnce)for(var v=i.chainProxy,y=i.boneLengths,w=0;w<v.length;++w){var b=y[w],x=v[w],M=v[w+1];0===w?(x.set(0,0,0),M.set(0,b,0)):M&&M.set(0,b+x.y,0)}for(c=0;c<n;++c){if((l=this.iterate(t,e,i,a,c))<o){if(o=l,l<=this.mSolveDistanceThreshold)break}else if(Math.abs(l-r)<this.mMinIterationChange)break;r=l}s=o;for(var S=i.line,C=i.chainProxy,T=S.geometry.attributes.position.array,k=0;k<C.length;++k)T[3*k]=C[k].x,T[3*k+1]=C[k].y,T[3*k+2]=C[k].z;return S.geometry.attributes.position.needsUpdate=!0,this.recomputeChainQuaternions(e,i),s},ge.prototype.recomputeChainQuaternions=function(e,t){for(var n=t.chainProxy,i=new w.Pa4,a=new w.Pa4,o=new w._fP,r=new w._fP,s=new w.Pa4,l=new w.Pa4,c=new w.Pa4,h=new w.Pa4,d=0;d<e.length-1;++d){var u=e[d],p=n[d],m=n[d+1];if(0===d?i.set(0,1,0):i.copy(a),a.copy(m),a.addScaledVector(p,-1),a.normalize(),0===d)o.setFromUnitVectors(i,a),u.setRotationFromQuaternion(o);else{e[d-1].matrixWorld.decompose(s,r,l),c.copy(i),h.copy(a);var f=c.dot(h);f>1?f=1:f<-1&&(f=-1),f=Math.acos(f),c.crossVectors(c,h),c.normalize(),c.applyQuaternion(r.conjugate()),o.setFromAxisAngle(c,f),u.setRotationFromQuaternion(o)}}},ge.prototype.iterate=function(e,t,n,i,a){if(t.length<1)throw Error("0 bones");this.forward(e,t,n,i,a),this.backward(e,t,n,i,a);var o=t.length-1;return n.chainProxy[o].distanceTo(e)};ge.prototype.forward=function(e,t,n,i,a){var o=this.v1,r=this.v3,s=this.v2,l=this.v5,c=this.v4,h=this.v6,d=this.v7,u=this.q1,p=this.q2,m=n.boneLengths,f=n.chainProxy,g=t.length-1,v=n.links;a>=0&&this.recomputeChainQuaternions(t,n);for(var y=g-1;y>=0;--y){var w=f[y];o.copy(w);var b,x=m[y],M=v[y];if(M.id!==y)throw Error("Please specify all links in the constraints array.");var S=M.limitation,C=M.rotationMin,T=M.rotationMax;if(b=i?S?1:0:-1,y!==g-1)r.copy(f[y+1]),l.copy(r).addScaledVector(o,-1).normalize().negate(),0===b?(s.copy(f[y+2]),c.copy(s).addScaledVector(r,-1).normalize().negate(),this.applyBallConstraint(l,c,p,C,T)):2===b||1===b&&(y>0?(this.computeLocalTransform(u,y,t),h.copy(S).applyQuaternion(u)):h.copy(S),l.projectOnPlane(h).normalize()),d.copy(r).addScaledVector(l,x),w.copy(d);else if(y===g-1){var k=f[y+1];switch(k.copy(e),r.copy(k),l.copy(r).addScaledVector(o,-1).normalize().negate(),b){case 0:case 2:break;case 1:this.computeLocalTransform(u,y,t),h.copy(S).applyQuaternion(u),l.projectOnPlane(h).normalize()}d.copy(e).addScaledVector(l,x),w.copy(d)}}},ge.prototype.backward=function(e,t,n,i,a){var o,r=this.v1,s=this.v3,l=this.v5,c=this.v6,h=this.v7,d=this.v2,u=this.v4,p=this.v8,m=this.v9,f=this.v10,g=this.q1,v=this.q2,y=n.chainProxy,w=n.boneLengths,b=t.length-1,x=n.links[0];if(0!==x.id)throw Error("Please specify all links in the constraints array.");var M=x.limitation,S=x.rotationMin,C=x.rotationMax;o=i&&M?1:0,a>=0&&this.recomputeChainQuaternions(t,n);for(var T=0;T<b;++T){var k=y[T],P=w[T];if(r.copy(k),0!==T){var I=y[T-1];s.copy(I);var A=y[T+1];h.copy(A),l.copy(h).addScaledVector(r,-1).normalize(),c.copy(r).addScaledVector(s,-1).normalize();var E,O=n.links[T];if(O.id!==T)throw Error("Please specify all links in the constraints array.");var L=O.limitation,_=O.rotationMin,R=O.rotationMax;if(0==(E=i?L?1:0:-1))this.applyBallConstraint(l,d,v,_,R);else if(2===E);else if(1===E){var D=y[T-1];d.copy(r).addScaledVector(D,-1).normalize(),this.computeLocalTransform(g,T,t),u.copy(L).applyQuaternion(g),l.projectOnPlane(u).normalize(),void 0===_&&void 0===R||(p.set(0,1,0),m.copy(p).applyQuaternion(g).normalize(),this.applyBallConstraint(l,m,v,_,R))}f.copy(r).addScaledVector(l,P),A.copy(f)}else{var z=y[T+1];if(h.copy(z),this.mFixedBaseMode?k.copy(this.mFixedBaseLocation):(l.copy(h).addScaledVector(r,-1).normalize(),k.copy(h).addScaledVector(l,-P)),r.copy(k),0===o)l.copy(h).addScaledVector(r,-1).normalize(),f.copy(k).addScaledVector(l,P),z.copy(f);else if(2===o);else if(1===o){var F=M;l.copy(h).addScaledVector(r,-1).normalize(),l.projectOnPlane(F).normalize(),(S||C)&&(p.set(0,1,0),M.distanceTo(p)<.001&&p.set(1,0,0),m.copy(p).cross(F).normalize(),this.applyBallConstraint(l,m,v,S,C)),f.copy(k).addScaledVector(l,P),z.copy(f)}}}},ge.prototype.applyBallConstraint=function(e,t,n,i,a){var o=Math.acos(t.dot(e)),r=Math.PI;if(i&&(r=-Math.max(i.x,i.y,i.z)),a&&(r=Math.min(r,a.x,a.y,a.z)),Math.abs(o)>r){var s=new w.Pa4;s.crossVectors(t,e).normalize(),n.setFromAxisAngle(s,-Math.sign(o)*(Math.abs(o)-r)),e.applyQuaternion(n)}},ge.prototype.computeLocalTransform=function(e,t,n){var i=this.m1,a=this.m2,o=this.v11,r=this.v12;a.multiplyMatrices(i,n[t-1].matrixWorld),a.decompose(o,e,r)};var ve="CCD",ye="FABRIK",we=function(){this.ccdSolver=new fe,this.fabrikSolver=new ge};we.prototype.customSolve=function(e,t,n){this.solve(ye,e,t,3,null),this.solve(ve,e,t,3,n)},we.prototype.solve=function(e,t,n,i,a,o){switch(e){case ve:this.ccdSolver.solve(t,n,i,a,o);break;case ye:this.fabrikSolver.solve(t,n,i,a,o)}};var be={updateSecondaryAnimations:function(){var e=this;this.mixers.forEach((function(e){var t=e.iks;if(t){var n=t.solver,i=t.skeleton,a=t.targetPoint,o=i.constraints;n.solve(ve,i.bones,a,5,o,!0)}}));var t=this.graphics.app.model.backend,n=t.selfModel,i=n.position,a=!1,o=this._w2;t.entityModel.lookers.forEach((function(t){var n=t.graphicalComponent.children[0],r=n.children[1],s=n.children[2],l=e._w0,c=r.matrixWorld,h=e._mvpp;c.decompose(h,e._q,e._w0),l.copy(h),(c=s.matrixWorld).decompose(h,e._q,e._w0),l.add(h).multiplyScalar(.5);var d=e._w1;d.copy(i).addScaledVector(l,-1),d.normalize(),a||(o.copy(d).negate(),a=!0);var u=e._e;u.setFromVector3(d),r.rotation.z=-u.x,r.rotation.x=Math.PI/2-u.z,s.rotation.copy(r.rotation)}));var r=n.avatar;if(r){var s=Math.PI,l=s/2,c=r.children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0],h=n.getRotation(),d=this._xy;d.set(o.x,o.y).normalize();var u=h.z-l;u>s?u-=2*s:u<-s&&(u+=2*s);var p,m=Math.atan2(d.y,d.x);m>s?m-=2*s:m<-s&&(m+=2*s),p=Math.abs(m-u)<Math.PI/3?m-u:0,c.rotation.y=.9*c.rotation.y+.1*p}},createIKSolver:function(e,t,n){t=t||{effector:4,links:[{id:0},{id:1,rotationMin:new w.Pa4(-Math.PI/2,-Math.PI/2,-Math.PI/2),rotationMax:new w.Pa4(Math.PI/2,Math.PI/2,Math.PI/2)},{id:2,limitation:new w.Pa4(0,0,1)},{id:3,limitation:new w.Pa4(1,0,0)}],minAngle:0,maxAngle:1};var i=new w.OdW(e),a=[];a.push(new w.Pa4(0,0,0));for(var o=e.length,r=0;r<o;++r)a.push(new w.Pa4(0,0,0));i.constraints=t,i.chainProxy=a;var s=new we,l=new w.Pa4(0,10,0);n.iks={solver:s,targetPoint:l,skeleton:i}}},xe=function(e){this.graphics=e,this.mixers=new Map,this.times=new Map,this.clips=new Map,this.currentCameraPosition=new w.Pa4(0,0,0),this._q=new w._fP,this.oldCameraPosition=new w.Pa4(0,0,0),this.newCameraPosition=new w.Pa4(0,0,0),this.oldPitchRotationX=0,this.oldYawRotationZ=0,this.newPitchRotationX=0,this.newYawRotationZ=0,this.trauma=0,this.decayRate=0,this.raycastables=[],this.raycaster=new w.iMs,this._w0=new w.Pa4(0,0,0),this._w1=new w.Pa4(0,0,0),this._w2=new w.Pa4(0,0,0),this._e=new w.USm,this._r=new w.Pa4,this._xy=new w.FM8,this._mvpp=new w.Pa4(0,0,0),this._mvpq=new w._fP,this._mvps=new w.Pa4(0,0,0),this._debug=!0};a(xe.prototype,{initializeAnimations:function(){this.mixers=new Map,this.times=new Map,this.clips=new Map},refresh:function(e){this.updateAnimations(e),this.updateSecondaryAnimations(e),this.updateCameraFeedback(e),this.updateTextLabels(e)},restore:function(){this.resetCameraFeedback()},updateAnimations:function(e){var t=this,n=this.graphics.app.model.backend,i=n.entityModel.entitiesIngame;this.mixers.forEach((function(a,o){var s=0!==o?i.get(o):n.selfModel;if(r(!!s,"[Animations] Lone animation mixer."),s){var l=s.animationComponent;l&&(t.updateEntityPosition(s,l,e),t.updateEntityRotationAndTilt(s,l,e),t.updateMixerAction(s,l,a,e))}})),i.forEach((function(t){if(t.isRotating){var n=t.graphicalComponent.position,i=e/1e3,a=Math.sqrt(n.x*n.x+n.y*n.y),o=Math.atan2(n.y,n.x);return o+=.5*i,n.set(a*Math.cos(o),a*Math.sin(o),n.z),void(t.graphicalComponent.rotation.z+=i)}if(t.finalAxolotlIndex){var r=t.finalAxolotlIndex,s=t.graphicalComponent.position,l=e/1e3,c=t.graphicalComponent.ttt||0;return c+=l,t.graphicalComponent.ttt=c,void(1===r?s.y=2.7*Math.sin(c/2)-5:2===r&&(s.y=-15-2.7*Math.sin(c/2)))}if(t.isFinalCup){var h=t.graphicalComponent.position,d=e/1e3,u=t.graphicalComponent.ttt||0;return u+=d,t.graphicalComponent.ttt=u,void(h.x=-20-8*Math.sin(u/2))}if(t.isShrinking){var p=t.shrinkTime+e;if(!(p>100)){t.shrinkTime=p;var m=1-p/100,f=t.graphicalComponent;f&&f.scale&&f.scale.set(m,m,m)}}}))},updateAnimation:function(e){var t=this.mixers.get(e),n=this.times.get(e);if(t){var i=Date.now();t.update(.001*(i-n)),this.times.set(e,i)}},addSkinnedEntityAnimation:function(e,t,n){var i=this.mixers,a=this.times,o=new w.Xcj(t);i.set(e,o),a.set(e,Date.now()),this.setupMixer(e,t,o,n)},cleanup:function(){l()(".text-label").empty().remove()}}),a(xe.prototype,he),a(xe.prototype,de),a(xe.prototype,ue),a(xe.prototype,pe),a(xe.prototype,me),a(xe.prototype,be);var Me={setColor:function(){},getTexture:function(e){return this.textureCoordinates[e]},setPNC1:function(e,t,n,i,a,o,r,s,l,c,h,d,u,p,m,f,g,v,y,w,b,x,M){e[i+0]=u,e[i+1]=p,e[i+2]=m,e[i+3]=a?c:r,e[i+4]=a?h:s,e[i+5]=a?d:l,e[i+6]=a?r:c,e[i+7]=a?s:h,e[i+8]=a?l:d,f.set(r,s,l),a?g.set(c,h,d):g.set(u,p,m),a?v.set(u,p,m):v.set(c,h,d),w.subVectors(v,g),y.subVectors(f,g),w.cross(y),w.normalize();for(var S=w.x,C=w.y,T=w.z,k=0;k<3;++k)n[i+3*k]=-S,n[i+3*k+1]=-C,n[i+3*k+2]=-T;this.setColor(b,x,M,o);for(var P=0;P<3;++P)t[i+3*P]=o.r,t[i+3*P+1]=o.g,t[i+3*P+2]=o.b},setPNC2:function(e,t,n,i,a,o,r,s,l,c,h,d,u,p,m,f,g,v,y,w,b,x,M){e[i+9]=c,e[i+10]=h,e[i+11]=d,e[i+12]=a?r:u,e[i+13]=a?s:p,e[i+14]=a?l:m,e[i+15]=a?u:r,e[i+16]=a?p:s,e[i+17]=a?m:l,f.set(r,s,l),a?g.set(c,h,d):g.set(u,p,m),a?v.set(u,p,m):v.set(c,h,d),w.subVectors(v,g),y.subVectors(f,g),w.cross(y),w.normalize();for(var S=w.x,C=w.y,T=w.z,k=0;k<3;++k)n[i+9+3*k]=-S,n[i+9+3*k+1]=-C,n[i+9+3*k+2]=-T;this.setColor(b,x,M,o);for(var P=0;P<3;++P)t[i+9+3*P]=o.r,t[i+9+3*P+1]=o.g,t[i+9+3*P+2]=o.b},addFace:function(e,t,n,i,a,o,r,s,l,c,h,d,u,p,m,f,g,v,y,w){var b,x,M,S,C,T,k,P,I,A,E,O,L,_,R=18*t,D=2*R/3,z=.00390625/8,F=this.getTexture(c);if(F){var B,W,j=1===c&&Math.random()>.5;for(e<a?(M=x=h+1+(_=e%n),k=T=d+(e-_)%i/n,E=(A=u+Math.floor(e/i))+1,S=x,P=T+1,O=A+1,C=x,I=T+1,L=A,j?this.setPNC1(o,s,r,R,y,w,M,k,E,S,P,O,C,I,L,p,m,f,v,g,h,d,u):this.setPNC1(o,s,r,R,y,w,x,T,A,M,k,E,S,P,O,p,m,f,v,g,h,d,u),B=.0625*(y?F[0][0]:F[3][0]),W=.0625*(y?F[0][1]:F[3][1]),l[D]=B+z,l[D+1]=W+z,l[D+2]=B+(y?z:.0625-z),l[D+3]=W+.0625-z,l[D+4]=B+(y?.0625-z:z),l[D+5]=W+.0625-z,j?this.setPNC2(o,s,r,R,y,w,M,k,E,C,I,L,x,T,A,p,m,f,v,g,h,d,u):this.setPNC2(o,s,r,R,y,w,x,T,A,S,P,O,C,I,L,p,m,f,v,g,h,d,u),l[D+6]=B+z,l[D+7]=W+z,l[D+8]=B+.0625-z,l[D+9]=W+(y?.0625-z:z),l[D+10]=B+.0625-z,l[D+11]=W+(y?z:.0625-z)):e<2*a?(M=(x=h+(_=(e-=a)%n))+1,k=T=d+1+(e-_)%i/n,E=A=u+Math.floor(e/i),S=x+1,P=T,O=A+1,C=x,I=T,L=A+1,j?this.setPNC1(o,s,r,R,y,w,M,k,E,S,P,O,C,I,L,p,m,f,v,g,h,d,u):this.setPNC1(o,s,r,R,y,w,x,T,A,M,k,E,S,P,O,p,m,f,v,g,h,d,u),B=.0625*(y?F[1][0]:F[4][0]),W=.0625*(y?F[1][1]:F[4][1]),l[D]=B+(y?.0625-z:z),l[D+1]=W+z,l[D+2]=B+(y?z:.0625-z),l[D+3]=W+(y?z:.0625-z),l[D+4]=B+(y?z:.0625-z),l[D+5]=W+(y?.0625-z:z),j?this.setPNC2(o,s,r,R,y,w,M,k,E,C,I,L,x,T,A,p,m,f,v,g,h,d,u):this.setPNC2(o,s,r,R,y,w,x,T,A,S,P,O,C,I,L,p,m,f,v,g,h,d,u),l[D+6]=B+(y?.0625-z:z),l[D+7]=W+z,l[D+8]=B+z,l[D+9]=W+.0625-z,l[D+10]=B+.0625-z,l[D+11]=W+.0625-z):(M=x=h+(_=(e-=2*a)%n),k=(T=d+(e-_)%i/n)+1,E=A=u+1+Math.floor(e/i),S=x+1,P=T+1,O=A,C=x+1,I=T,L=A,j?this.setPNC1(o,s,r,R,y,w,M,k,E,S,P,O,C,I,L,p,m,f,v,g,h,d,u):this.setPNC1(o,s,r,R,y,w,x,T,A,M,k,E,S,P,O,p,m,f,v,g,h,d,u),B=.0625*(y?F[2][0]:F[5][0]),W=.0625*(y?F[2][1]:F[5][1]),l[D]=B+z,l[D+1]=W+z,l[D+2]=B+(y?z:.0625-z),l[D+3]=W+.0625-z,l[D+4]=B+(y?.0625-z:z),l[D+5]=W+.0625-z,j?this.setPNC2(o,s,r,R,y,w,M,k,E,C,I,L,x,T,A,p,m,f,v,g,h,d,u):this.setPNC2(o,s,r,R,y,w,x,T,A,S,P,O,C,I,L,p,m,f,v,g,h,d,u),l[D+6]=B+z,l[D+7]=W+z,l[D+8]=B+.0625-z,l[D+9]=W+(y?.0625-z:z),l[D+10]=B+.0625-z,l[D+11]=W+(y?z:.0625-z)),b=0;b<18;++b)if(isNaN(o[R+b]))return void console.log("Transferred miscalculation on ".concat(R,"th component.")+"\tnormal: ".concat(y,"\n")+"\tfaceId: ".concat(e))}else console.log("Texture not found for index ".concat(c,"."))}},Se={createChunkFromLevel:function(e,t){for(var n=e.nbSegmentsX,i=e.nbSegmentsY,a=e.widthX,o=e.widthY,r=e.x,s=e.y,l=e.points,c=new w.BKK(a,o,n,i),h=c.attributes.position.array,d=0,u=n+1,p=i+1,m=0;m<p;++m)for(var f=(p-m-1)*u,g=0;g<u;++g)h[3*(f+g)+2]=l[d],d++;c.computeBoundingSphere(),c.computeVertexNormals();var v=e.isWater,y=e.color,b=e.shininess,x=this.createChunkMesh(c,v,!0,t,y,b);return v||(x.receiveShadow=!0),x.userData.hasPrimaryImage=!0,x.userData.points=l,x.position.set(r,s,0),x},attachDebugHelpers:function(e){var t={v:new w.Pa4(1,0,0),o:new w.Pa4(.1,.1,.1),h:null};t.s=new w.Kj0(new w.Aip(.1),new w.vBJ({color:16776960})),t.sg1=new w.Kj0(new w.Aip(.1),new w.vBJ({color:255})),t.sg2=new w.Kj0(new w.Aip(.1),new w.vBJ({color:65280,side:w.ehD,wireframe:!0})),t.sg3=new w.Kj0(new w.Aip(.1),new w.vBJ({color:16711680})),t.h=new w.tGC(t.v,t.o,1,65535),t.h2=new w.tGC(t.v,t.o,1,16776960),t.ah=new w.y8_(5),window.dh=t}},Ce={getCrossFadeVertex:function(){return"\nvarying vec2 vUv;\n\nvoid main()\n{\n    vUv = vec2(uv.x, uv.y);\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n"},getCrossFadeFragment:function(){return"\nuniform float mixRatio;\nuniform sampler2D tDiffuse1;\nuniform sampler2D tDiffuse2;\n\n// uniform sampler2D tMixTexture;\n// uniform int useTexture;\n// uniform float threshold;\n\nvarying vec2 vUv;\n\nvoid main()\n{\n    vec4 texel1 = texture2D(tDiffuse1, vUv);\n    vec4 texel2 = texture2D(tDiffuse2, vUv);\n\n    // To use a transition grey-scale texture (black: first, white: last)\n    // if (useTexture == 1)\n    // {\n    //     vec4 transitionTexel = texture2D(tMixTexture, vUv);\n    //     float r = mixRatio * (1.0 + threshold * 2.0) - threshold;\n    //     float mixf = clamp((transitionTexel.r - r) * (1.0 / threshold), 0.0, 1.0);\n    //     gl_FragColor = mix(texel1, texel2, mixf);\n    // }\n    // else\n    // {\n    //     gl_FragColor = mix(texel2, texel1, mixRatio);\n    // }\n\n    gl_FragColor = mix(texel2, texel1, mixRatio);\n}\n"},getPortalVertexShader:function(){return"varying vec4 pos_frag;\n\nvoid main() {\n\n   pos_frag = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n   gl_Position = pos_frag;\n}\n"},getPortalFragmentShader:function(){return"uniform sampler2D texture1;\n\nvarying vec4 pos_frag;\n\nvoid main() {\n\n   vec2 ratio = pos_frag.xy / pos_frag.w;\n   vec2 correctedUv = (ratio + vec2(1.0)) * 0.5;\n\n   gl_FragColor = texture2D(texture1, correctedUv);\n}\n"},getFootStepVertexShader:function(){return"\n            #include <common>\n            ".concat("/* To use with PlaneBufferGeometry */\n\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nuniform float time;\nvarying vec3 vPosition;\n\n//varying vec2 vUv;\nvoid main()\n{\n    vPosition = position;\n//    vUv = uv;\n\n    #include <uv_vertex>\n    #include <uv2_vertex>\n    #include <color_vertex>\n    #include <skinbase_vertex>\n    #ifdef USE_ENVMAP\n    #include <beginnormal_vertex>\n    #include <morphnormal_vertex>\n    #include <skinnormal_vertex>\n    #include <defaultnormal_vertex>\n    #endif\n    #include <begin_vertex>\n    #include <morphtarget_vertex>\n    #include <skinning_vertex>\n    #include <project_vertex>\n    #include <logdepthbuf_vertex>\n    #include <worldpos_vertex>\n    #include <clipping_planes_vertex>\n    #include <envmap_vertex>\n    #include <fog_vertex>\n\n//    vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);\n//    gl_Position = projectionMatrix * modelViewPosition;\n}\n","\n        ")},getFootStepFragmentShader:function(){return"\n            #include <common>\n            ".concat("\nuniform float time;\nvarying vec3 vPosition;\n\nuniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\nvarying vec3 vNormal;\n#endif\n\nvec3 c1 = vec3(0.);\nvec3 c2 = vec3(0., 0.1, 0.);\nvec3 c3 = vec3(0.1, -0.01, 0.);\nvec3 c4 = vec3(-0.02, 0.03, 0.);\nvec3 c5 = vec3(-0.1, 0.02, 0.);\n\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_pars_fragment>\n#include <cube_uv_reflection_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nfloat sumCircle(vec3 center, float maxCircleRadius, float fade)\n{\n    float currentCircleRadius = time * maxCircleRadius;\n    float fragmentDistanceToCenter = distance(center, vPosition);\n    float ifIAmSmallThenWhite = abs(currentCircleRadius - fragmentDistanceToCenter);\n    float toNaught = .05 - clamp(ifIAmSmallThenWhite, 0., .05);\n    float res = pow(20. * toNaught, 2.) * 0.25;\n    return res * fade;\n}\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    vec4 diffuseColor = vec4( diffuse, opacity );\n    #include <logdepthbuf_fragment>\n    #include <map_fragment>\n    #include <color_fragment>\n    #include <alphamap_fragment>\n    #include <alphatest_fragment>\n    #include <specularmap_fragment>\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    // accumulation (baked indirect lighting only)\n    #ifdef USE_LIGHTMAP\n\n    vec4 lightMapTexel= texture2D( lightMap, vUv2 );\n    reflectedLight.indirectDiffuse += lightMapTexelToLinear( lightMapTexel ).rgb * lightMapIntensity;\n    #else\n    reflectedLight.indirectDiffuse += vec3( 1.0 );\n    #endif\n    // modulation\n    #include <aomap_fragment>\n    reflectedLight.indirectDiffuse *= diffuseColor.rgb;\n    vec3 outgoingLight = reflectedLight.indirectDiffuse;\n    #include <envmap_fragment>\n\n    //    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    //    vec3 center = vec3(0.);\n    float maxCircleRadius = 1.;\n    float fadeFactor = 2. * clamp(time, 0., 0.5);\n    float fade = 1. - fadeFactor;\n\n    float sum = 0.;\n    sum = max(sum, sumCircle(c1, maxCircleRadius, fade));\n    sum = max(sum, sumCircle(c2, maxCircleRadius * 0.5, fade));\n    sum = max(sum, sumCircle(c3, maxCircleRadius * 0.8, fade));\n    sum = max(sum, sumCircle(c4, maxCircleRadius * 1., fade));\n    sum = max(sum, sumCircle(c5, maxCircleRadius * 0.9, fade));\n    // sum = max(sum, sumCircle(c1, maxCircleRadius * 0.5, fade));\n\n    gl_FragColor = vec4( 1., 1., 1., sum);\n\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n    #include <fog_fragment>\n    #include <premultiplied_alpha_fragment>\n    #include <dithering_fragment>\n}\n","\n        ")},getSwordTrailVertexShader:function(){return"/* To use with RingBufferGeometry */\n\nuniform float time;\nvarying vec2 vUv;\nvarying vec3 vPosition;\nvoid main()\n{\n    vPosition = position;\n    vUv = uv;\n\n    vec4 modelViewPosition = modelViewMatrix * vec4(position, 1.0);\n    gl_Position = projectionMatrix * modelViewPosition;\n}\n"},getSwordTrailFragmentShader:function(){return"/* To use with RingBufferGeometry */\n/* Example:\nvar ringGeometry = new RingBufferGeometry(\n    5, 13, 20, 1, 0, Math.PI\n);\nvar material = new ShaderMaterial({\n    uniforms: {\n        time: { value: 1.0 },\n        outerRadius: { value: 13.0 },\n        innerRadius: { value: 5.0 }\n    },\n    vertexShader: document.getElementById('vertexShader').textContent,\n    fragmentShader: document.getElementById('fragmentShader').textContent,\n    side: DoubleSide,\n    transparent: true\n});\n// Time from 0. to 1.: ring appears\n// Time from 1. to 2.: inner ring continues to spin\n// Linear time interpolation.\n*/\n\nuniform float time;\nuniform float outerRadius;\nuniform float innerRadius;\nvarying vec3 vPosition;\nvarying vec2 vUv;\nconst float PI = 3.1415926535897932384626433832795;\n\n// Same noise fn as usual\nfloat rand(vec2 n)\n{\n    return fract(sin(dot(n, vec2(12.9898, 4.1414))) * 43758.5453);\n}\n\n// From https://gist.github.com/patriciogonzalezvivo/670c22f3966e662d2f83\nfloat noise(vec2 p)\n{\n    vec2 ip = floor(p);\n    vec2 u = fract(p);\n    u = u * u * (3.0 - 2.0 * u);\n    float res = mix(\n        mix(\n            rand(ip),\n            rand(ip + vec2(1.0, 0.0)),\n            u.x\n        ),\n        mix(\n            rand(ip + vec2(0.0, 1.0)),\n            rand(ip + vec2(1.0, 1.0)),\n            u.x\n        ),\n        u.y\n    );\n    return res*res;\n}\n\n// Sekiro inspired\nvoid main()\n{\n    float x = vPosition.x;\n    float y = vPosition.y;\n    float opacity = 1.0;\n\n    float ringWidth = outerRadius - innerRadius;\n    float dist = distance(vPosition.xy, vec2(0.0));\n    float distanceFromTop = (outerRadius - dist) / ringWidth;\n\n    float numberOfStripes = 7.0;\n    float stripeWidth = ringWidth / numberOfStripes;\n    float distanceFromTopI = (outerRadius - stripeWidth - dist) / (ringWidth - stripeWidth);\n\n    float stripeId = floor(mod(distanceFromTop * numberOfStripes, numberOfStripes));\n\n    float isOuterStripe = step(stripeId, 0.0);\n\n    float multStripe = 1.0 * PI; // 0.1 * isOuterStripe;\n    float angle = atan(y, x);\n    float distanceFromStart = angle + clamp(time * multStripe, 0.0, PI - 0.32) + 0.0; //+ offsetStripe;\n\n    float isHead = step(distanceFromStart, PI);\n    float isTail = step(PI - angle, 0.32);\n\n    // opacity = sin(PI * fract(distanceFromTop * numberOfStripes));\n    opacity = 1.0;\n\n    float d = distanceFromStart / PI;\n    float edge = 0.9;\n    d = 1.0 - max(d - edge, 0.0) / (1.0 - edge);\n    float isIn = step(0.0, d - edge - 0.1);\n    opacity -= isHead * d * d; // * sin(PI * fract(distanceFromStart));\n    opacity -= isHead * isOuterStripe * d * d;\n    float d2 = 1.0 - (PI - angle) / 0.32;\n    opacity -= isTail * pow(d2 * d2, 4.0);\n\n    float smoothOuterStripeEdges = 1.0 - sin(PI * fract(distanceFromTop * numberOfStripes));\n    opacity -= isOuterStripe * smoothOuterStripeEdges;\n\n    float chi = sin(PI * fract((distanceFromTopI) * (1.0)));\n    // x3 e-x/2\n    //float chi = 1.0 - fract((distanceFromTopI) * (1.0));\n    //chi = pow(chi, 3.0) * exp(-chi * chi);\n    float smoothSecondStripeEdges = 1.0 - pow(chi, 0.5);\n    opacity -= (1.0 - isOuterStripe) * (smoothSecondStripeEdges + 0.2);\n\n    opacity -= (1.0 - isIn) * (1.0 - isOuterStripe) *\n        noise(vec2(\n            distanceFromTop * ringWidth * 9.0,\n            (distanceFromStart + clamp(time * multStripe - PI + 0.4, 0.0, PI)) * 2.0\n        ));\n\n    gl_FragColor = vec4(1.0, 1.0, 1.0, opacity);\n}\n"},getSkyFlatVertexShader:function(){return"precision mediump float;\n\nuniform vec3 sunPosition;\nuniform float rayleigh;\nuniform float turbidity;\nuniform float mieCoefficient;\nconst vec3 up = vec3(0.0, 0.0, 1.0);\n\nvarying vec3 vWorldPosition;\nvarying vec3 vSunDirection;\nvarying float vSunfade;\nvarying vec3 vBetaR;\nvarying vec3 vBetaM;\nvarying float vSunE;\n\n// constants for atmospheric scattering\nconst float e = 2.71828182845904523536028747135266249775724709369995957;\n//const float pi = 3.141592653589793238462643383279502884197169;\n\n// wavelength of used primaries, according to preetham\n//const vec3 lambda = vec3( 680E-9, 550E-9, 450E-9 );\n// this pre-calcuation replaces older TotalRayleigh(vec3 lambda) function:\n// (8.0 * pow(pi, 3.0) * pow(pow(n, 2.0) - 1.0, 2.0) * (6.0 + 3.0 * pn)) / (3.0 * N * pow(lambda, vec3(4.0)) * (6.0 - 7.0 * pn))\nconst vec3 totalRayleigh = vec3( 5.804542996261093E-6, 1.3562911419845635E-5, 3.0265902468824876E-5 );\n\n// mie stuff\n// K coefficient for the primaries\n//const float v = 4.0;\n//const vec3 K = vec3( 0.686, 0.678, 0.666 );\n// MieConst = pi * pow( ( 2.0 * pi ) / lambda, vec3( v - 2.0 ) ) * K\nconst vec3 MieConst = vec3( 1.8399918514433978E14, 2.7798023919660528E14, 4.0790479543861094E14 );\n\n// earth shadow hack\n// cutoffAngle = pi / 1.95;\nconst float cutoffAngle = 1.6110731556870734;\nconst float steepness = 1.5;\nconst float EE = 1000.0;\n\nfloat sunIntensity( float zenithAngleCos ) {\n    zenithAngleCos = clamp( zenithAngleCos, -1.0, 1.0 );\n    return EE * max( 0.0, 1.0 - pow( e, -( ( cutoffAngle - acos( zenithAngleCos ) ) / steepness ) ) );\n}\n\nvec3 totalMie( float T ) {\n    float c = ( 0.2 * T ) * 10E-18;\n    return 0.434 * c * MieConst;\n}\n\nvoid main() {\n\n    vec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n    vWorldPosition = worldPosition.xyz;\n\n    gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n    gl_Position.z = gl_Position.w; // set z to camera.far\n\n    vSunDirection = normalize( sunPosition );\n\n    vSunE = sunIntensity( dot( vSunDirection, up ) );\n\n    vSunfade = 1.0 - clamp( 1.0 - exp( ( sunPosition.y / 450000.0 ) ), 0.0, 1.0 );\n\n    float rayleighCoefficient = rayleigh - ( 1.0 * ( 1.0 - vSunfade ) );\n\n// extinction (absorbtion + out scattering)\n// rayleigh coefficients\n    vBetaR = totalRayleigh * rayleighCoefficient;\n\n// mie coefficients\n    vBetaM = totalMie( turbidity ) * mieCoefficient;\n}\n"},getSkyFlatFragmentShader:function(){return"precision mediump float;\n\nvarying vec3 vWorldPosition;\nvarying vec3 vSunDirection;\nvarying float vSunfade;\nvarying vec3 vBetaR;\nvarying vec3 vBetaM;\nvarying float vSunE;\n\nuniform float mieDirectionalG;\nconst vec3 up = vec3(0.0, 0.0, 1.0);\n\nconst vec3 cameraPos = vec3( 0.0, 0.0, 0.0 );\n\n// constants for atmospheric scattering\nconst float pi = 3.141592653589793238462643383279502884197169;\n\n// optical length at zenith for molecules\nconst float rayleighZenithLength = 8.4E3;\nconst float mieZenithLength = 1.25E3;\n// 66 arc seconds -> degrees, and the cosine of that\nconst float sunAngularDiameterCos = 0.999956676946448443553574619906976478926848692873900859324;\n\nconst float THREE_OVER_SIXTEENPI = 0.05968310365946075;\nconst float ONE_OVER_FOURPI = 0.07957747154594767;\n\nfloat random(vec2 st) {\n    return fract(sin(dot(st.xy, vec2(12.9898,78.233))) * 43758.5453123);\n}\n\nfloat rayleighPhase( float cosTheta ) {\n    return THREE_OVER_SIXTEENPI * ( 1.0 + pow( abs(cosTheta), 2.0 ) );\n}\n\nfloat hgPhase( float cosTheta, float g ) {\n    float g2 = pow( abs(g), 2.0 );\n    float inverse = 1.0 / pow( abs(1.0 - 2.0 * g * cosTheta + g2), 1.5 );\n    return ONE_OVER_FOURPI * ( ( 1.0 - g2 ) * inverse );\n}\n\nvoid main() {\n\n    vec3 direction = normalize( vWorldPosition - cameraPos );\n\n    // night starry sky\n    bool closeToHorizon = false;\n    float vse = vSunE;\n    float fafa = 100.0;\n    float fdx = floor(direction.x * fafa + 0.5);\n    float fdy = floor(direction.y * fafa + 0.5);\n    float fdz = floor(direction.z * fafa + 0.5);\n    float d = distance(direction, (1.0 / fafa) * (vec3(fdx, fdy, fdz)));\n    float proba = random(vec2(fdx * fdz, fdy));\n    float probaMax = mix(0.05, 0.00, 0.001 * vSunE);\n    float dMax = mix(0.002, 0.00, 0.001 * vSunE);\n    if (d < dMax && proba < probaMax && direction.z > 0.0) {\n        // if (d < 0.002 && proba < 0.05) // from 0.05 to 0.005\n    \tvse = max(vSunE, 20.0 * proba * 500.0);\n    \tcloseToHorizon = vSunDirection.z < 0.1; // ? 0.1 - vSunDirection.y : 0.0;\n    }\n\n    // optical length\n    // cutoff angle at 90 to avoid singularity in next formula.\n    float zenithAngle = acos( max( 0.0, dot( up, direction ) ) );\n    float inverse = 1.0 / ( cos( zenithAngle ) + 0.15 * pow( abs(93.885 - ( ( zenithAngle * 180.0 ) / pi )), -1.253 ) );\n    float sR = rayleighZenithLength * inverse;\n    float sM = mieZenithLength * inverse;\n\n    // combined extinction factor\n    vec3 Fex = exp( -( vBetaR * sR + vBetaM * sM ) );\n\n    // in scattering\n    float cosTheta = dot( direction, vSunDirection );\n\n    float rPhase = rayleighPhase( cosTheta * 0.5 + 0.5 );\n    vec3 betaRTheta = vBetaR * rPhase;\n\n    float mPhase = hgPhase( cosTheta, mieDirectionalG );\n    vec3 betaMTheta = vBetaM * mPhase;\n\n    vec3 Lin = pow( abs(vse * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * ( 1.0 - Fex )), vec3( 1.5 ) );\n    Lin *= mix(\n        vec3( 1.0 ),\n        pow( abs(vse * ( ( betaRTheta + betaMTheta ) / ( vBetaR + vBetaM ) ) * Fex),\n        vec3( 1.0 / 2.0 ) ),\n        clamp( pow( abs(1.0 - dot( up, vSunDirection )), 5.0 ), 0.0, 1.0 )\n    );\n\n    // nightsky\n    vec3 L0 = vec3( 0.1 ) * Fex;\n\n    // composition + solar disc\n    float sundisk = smoothstep( sunAngularDiameterCos, sunAngularDiameterCos + 0.00002, cosTheta );\n    L0 += ( vse * 19000.0 * Fex ) * sundisk;\n\n    vec3 texColor = ( Lin + L0 ) * 0.04 + vec3( 0.0, 0.0003, 0.00075 );\n\n    vec3 retColor = pow( abs(texColor), vec3( 1.0 / ( 1.2 + ( 1.2 * vSunfade ) ) ) );\n\n    // starry sky colorfix\n    if (closeToHorizon) {\n        float mean = (retColor.x + retColor.y + retColor.z) / 3.0;\n        retColor = vec3(mean);\n    }\n\n\tgl_FragColor = vec4( retColor, 1.0 );\n\n    // quick dithering pass\n    vec3 vp = vSunDirection; // normalize(vWorldPosition);\n    float noise = random(vp.xy);\n    float m = mix(-0.5 / 255.0, 0.5 / 255.0, noise);\n    gl_FragColor.rgb += 1.0 * vec3(m);\n\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n\n}\n"},getWaterFragmentShader:function(){return"\n            #include <common>\n            ".concat("uniform sampler2D mirrorSampler;\nuniform float alpha;\nuniform float time;\nuniform float size;\nuniform float distortionScale;\nuniform sampler2D normalSampler;\nuniform vec3 sunColor;\nuniform vec3 sunDirection;\nuniform vec3 eye;\nuniform vec3 waterColor;\n\nvarying vec4 mirrorCoord;\nvarying vec4 worldPosition;\n\nvec4 getNoise(vec2 uv) {\n\tvec2 uv0 = (uv / 103.0) + vec2(time / 17.0, time / 29.0);\n\tvec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0);\n\tvec2 uv2 = uv / vec2(890.70, 980.30) + vec2(time / 101.0, time / 97.0);\n\tvec2 uv3 = uv / vec2(1091.0, 1027.0) - vec2(time / 109.0, time / -113.0);\n\tvec4 noise = texture2D(normalSampler, uv0) +\n\t\ttexture2D(normalSampler, uv1) +\n\t\ttexture2D(normalSampler, uv2) +\n\t\ttexture2D(normalSampler, uv3);\n\n    return noise * 0.5 - 1.0;\n\t//return vec4(1, 1, 1, 1) * 0.5 - 1.0; // activate water normals here\n}\n\nvoid sunLight(\n    const vec3 surfaceNormal, const vec3 eyeDirection,\n    float shiny, float spec, float diffuse,\n    inout vec3 diffuseColor, inout vec3 specularColor)\n{\n\tvec3 reflection = normalize( reflect(-sunDirection, surfaceNormal) );\n\tfloat direction = max( 0.0, dot(eyeDirection, reflection) );\n\tspecularColor += pow(abs(direction), shiny) * sunColor * spec;\n\tdiffuseColor += max( dot(sunDirection, surfaceNormal), 0.0 ) * sunColor * diffuse;\n}\n\n//#include <common>\n#include <packing>\n#include <bsdfs>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <lights_pars_begin>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n\nvoid main() {\n\n    #include <logdepthbuf_fragment>\n\n    vec4 noise = getNoise( worldPosition.xy * size );\n    vec3 surfaceNormal = normalize( noise.xyz * vec3( 1.5, 1.0, 1.5 ) ); // this for texture\n\n    vec3 diffuseLight = vec3(0.0);\n    vec3 specularLight = vec3(0.0);\n\n    vec3 worldToEye = eye - worldPosition.xyz;\n    vec3 eyeDirection = normalize( worldToEye );\n    sunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );\n\n    float distance = length(worldToEye);\n\n    vec2 distortion = surfaceNormal.xy * ( 0.001 + 1.0 / distance ) * distortionScale;\n    vec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );\n\n    float theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );\n    float rf0 = 0.3;\n    float reflectance = rf0 + ( 1.0 - rf0 ) * pow( abs( 1.0 - theta ), 5.0 );\n    vec3 scatter = 0.5 * pow(max( 0.0, dot( surfaceNormal, eyeDirection ) ), 0.1) * waterColor;\n    vec3 albedo = mix(\n    ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(),\n    ( vec3( 0.1 ) + reflectionSample * 0.9 + reflectionSample * specularLight ),\n    reflectance\n    );\n    vec3 outgoingLight = albedo;\n    gl_FragColor = vec4( outgoingLight, alpha );\n\n    #include <tonemapping_fragment>\n    #include <fog_fragment>\n}\n","\n        ")},getWaterVertexShader:function(){return"\n            #include <common>\n            ".concat("\nuniform mat4 textureMatrix;\nuniform float time;\n\nvarying vec4 mirrorCoord;\nvarying vec4 worldPosition;\n\n//#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n\nvoid main()\n{\n\tmirrorCoord = modelMatrix * vec4( position, 1.0 );\n\tworldPosition = mirrorCoord.xyzw;\n\tmirrorCoord = textureMatrix * mirrorCoord;\n\tvec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );\n    gl_Position = projectionMatrix * mvPosition;\n\n    #include <beginnormal_vertex>\n    #include <defaultnormal_vertex>\n    #include <logdepthbuf_vertex>\n    #include <fog_vertex>\n    #include <shadowmap_vertex>\n}\n","\n        ")},getOceanFragmentShader:function(){return"\n            #include <common>\n            ".concat("uniform sampler2D mirrorSampler;\nuniform float alpha;\nuniform float time;\nuniform float size;\nuniform float distortionScale;\nuniform sampler2D normalSampler;\nuniform vec3 sunColor;\nuniform vec3 sunDirection;\nuniform vec3 eye;\nuniform vec3 waterColor;\nvarying vec3 vvnormal;\nvarying vec4 mirrorCoord;\nvarying vec4 worldPosition;\n\nvec4 getNoise(vec2 uv) {\n    vec2 uv0 = (uv / 103.0) + vec2(time / 17.0, time / 29.0);\n    vec2 uv1 = uv / 107.0-vec2( time / -19.0, time / 31.0);\n    vec2 uv2 = uv / vec2(890.70, 980.30) + vec2(time / 101.0, time / 97.0);\n    vec2 uv3 = uv / vec2(1091.0, 1027.0) - vec2(time / 109.0, time / -113.0);\n    vec4 noise = texture2D(normalSampler, uv0) +\n    texture2D(normalSampler, uv1) +\n    texture2D(normalSampler, uv2) +\n    texture2D(normalSampler, uv3);\n\n    return noise * 0.5 - 1.0;\n}\n\nvoid sunLight(\nconst vec3 surfaceNormal, const vec3 eyeDirection,\nfloat shiny, float spec, float diffuse,\ninout vec3 diffuseColor, inout vec3 specularColor)\n{\n    vec3 reflection = normalize( reflect(-sunDirection, surfaceNormal) );\n    float direction = max( 0.0, dot(eyeDirection, reflection) );\n    specularColor += pow(abs(direction), shiny) * sunColor * spec;\n    diffuseColor += max( dot(sunDirection, surfaceNormal), 0.0 ) * sunColor * diffuse;\n}\n\n    //#include <common>\n    #include <packing>\n    #include <bsdfs>\n    #include <fog_pars_fragment>\n    #include <logdepthbuf_pars_fragment>\n    #include <lights_pars_begin>\n    #include <shadowmap_pars_fragment>\n    #include <shadowmask_pars_fragment>\n\nvoid main() {\n\n    #include <logdepthbuf_fragment>\n    //\tvec4 noise = getNoise( worldPosition.xz * size );\n    vec4 noise = getNoise( worldPosition.xy * size );\n    //\tvec3 surfaceNormal = normalize(vvnormal); //normalize( noise.xzy * vec3( 1.5, 1.0, 1.5 ) ); // this for gerstner\n    \tvec3 surfaceNormal = normalize( vvnormal + noise.xzy * vec3( 1.5, 1.0, 1.5 ) ); // this for mix\n    //  vec3 surfaceNormal = normalize( noise.xyz * vec3( 1.5, 1.0, 1.5 ) ); // this for texture\n\n    vec3 diffuseLight = vec3(0.0);\n    vec3 specularLight = vec3(0.0);\n\n    vec3 worldToEye = eye - worldPosition.xyz;\n    vec3 eyeDirection = normalize( worldToEye );\n    sunLight( surfaceNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight );\n\n    float distance = length(worldToEye);\n\n    vec2 distortion = surfaceNormal.xy * ( 0.001 + 1.0 / distance ) * distortionScale;\n    vec3 reflectionSample = vec3( texture2D( mirrorSampler, mirrorCoord.xy / mirrorCoord.w + distortion ) );\n\n    float theta = max( dot( eyeDirection, surfaceNormal ), 0.0 );\n    float rf0 = 0.3;\n    float reflectance = rf0 + ( 1.0 - rf0 ) * pow( abs( 1.0 - theta ), 5.0 );\n    vec3 scatter = max( 0.0, dot( surfaceNormal, eyeDirection ) ) * waterColor;\n    vec3 albedo = mix(\n    ( sunColor * diffuseLight * 0.3 + scatter ) * getShadowMask(),\n    ( vec3( 0.1 ) + reflectionSample * 0.9 + reflectionSample * specularLight ),\n    reflectance\n    );\n    vec3 outgoingLight = albedo;\n    gl_FragColor = vec4( outgoingLight, alpha );\n\n    #include <tonemapping_fragment>\n    #include <fog_fragment>\n}\n","\n        ")},getOceanVertexShader:function(){return"\n            #include <common>\n            ".concat("\nuniform mat4 textureMatrix;\nuniform float time;\n\nvarying vec4 mirrorCoord;\nvarying vec4 worldPosition;\n\nvarying vec3 vvnormal;\n//#include <common>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n\n// Ref. in GPU Gems 1\n// https://developer.nvidia.com/gpugems/gpugems/part-i-natural-effects/chapter-1-effective-water-simulation-physical-models\nvec3 gerstnerPositions(float x, float y) {\n    float ox = x;\n    float oy = y;\n    float oz = 0.0;\n    const int nbWaves = 1;\n    for (int i = 0; i < nbWaves; i++) {\n        float frequencyI = 0.05; // wi\n        float amplitudeI = 20.0; // Ai\n        float steepnessI = 1.0 / (frequencyI * amplitudeI); // Qi from 0 to 1/wiAi\n        vec2 directionI = normalize(vec2(1.0, 0.0));\n        float phaseI = 1.0; // phiI\n        ox += steepnessI * amplitudeI * directionI.x * cos(frequencyI * dot(directionI, vec2(x, y)) + phaseI * time);\n        oy += steepnessI * amplitudeI * directionI.y * cos(frequencyI * dot(directionI, vec2(x, y)) + phaseI * time);\n        oz += amplitudeI * sin(frequencyI * dot(directionI, vec2(x, y)) + phaseI * time);\n    }\n    return vec3(ox, oy, oz);\n}\n\nvec3 gerstnerNormals(float x, float y, vec3 p) {\n    float nx = 0.0;\n    float ny = 0.0;\n    float nz = 1.0;\n    const int nbWaves = 1;\n    for (int i = 0; i < nbWaves; i++) {\n        float frequencyI = 0.05; // wi\n        float amplitudeI = 20.0; // Ai\n        float steepnessI = 1.0 / (frequencyI * amplitudeI); // Qi from 0 to 1/wiAi\n        vec2 directionI = normalize(vec2(1.0, 0.0));\n        float phaseI = 1.0; // phiI\n        nx -= (directionI.x * frequencyI * amplitudeI * cos(frequencyI * dot(vec3(directionI, 0.0), p) + phaseI * time) );\n        ny -= (directionI.y * frequencyI * amplitudeI * cos(frequencyI * dot(vec3(directionI, 0.0), p) + phaseI * time) );\n        nz -= (steepnessI * frequencyI * amplitudeI * sin(frequencyI * dot(vec3(directionI, 0.0), p) + phaseI * time) );\n\n    }\n    return vec3(nx, ny, nz);\n}\n\nvoid main()\n{\n    mirrorCoord = modelMatrix * vec4( position, 1.0 );\n    worldPosition = mirrorCoord.xyzw;\n    mirrorCoord = textureMatrix * mirrorCoord;\n    vec4 mvPosition =  modelViewMatrix * vec4( position, 1.0 );\n\n    // this is how to use gerstner\n    vec3 newPo = gerstnerPositions(position.x, position.y);\n    vec3 gn = gerstnerNormals(position.x, position.y, newPo);\n    vvnormal = normalMatrix * gn;\n    mvPosition = modelViewMatrix * vec4(newPo.x, newPo.y, newPo.z, 1.0);\n\n    gl_Position = projectionMatrix * mvPosition;\n\n    #include <logdepthbuf_vertex>\n    #include <fog_vertex>\n    #include <shadowmap_vertex>\n}\n","\n        ")},getBloomSelectiveVertexShader:function(){return"varying vec2 vUv;\n\nvoid main() {\n    vUv = uv;\n    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n}\n"},getBloomSelectiveFragmentShader:function(){return"uniform sampler2D baseTexture;\nuniform sampler2D bloomTexture;\n\nvarying vec2 vUv;\n\nvoid main() {\n    gl_FragColor = ( texture2D( baseTexture, vUv ) + vec4( 1.0 ) * texture2D( bloomTexture, vUv ) );\n}\n"},getShadowVertexShader:function(){return"\n            #include <common>\n            ".concat("// @author madblade\n// MAKE SURE TO ACTIVATE THE LOG DEPTH BUFFER\n\nuniform vec3 lightPosition;\nuniform float bias;\nuniform vec3 eyePosition;\n\nvarying vec3 vViewPosition;\n\nvarying vec3 vLightFront;\nvarying vec3 vIndirectFront;\n#ifdef DOUBLE_SIDED\nvarying vec3 vLightBack;\nvarying vec3 vIndirectBack;\n#endif\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars_begin>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n    #include <uv_vertex>\n    #include <uv2_vertex>\n    #include <color_vertex>\n    #include <beginnormal_vertex>\n    #include <morphnormal_vertex>\n    #include <skinbase_vertex>\n    #include <skinnormal_vertex>\n    #include <defaultnormal_vertex>\n    #include <begin_vertex>\n    #include <morphtarget_vertex>\n    #include <skinning_vertex>\n\n    // #include <project_vertex>\n    vec3 nn = objectNormal;\n    vec3 translated = transformed;\n    vec3 nlight = normalize(vec3(lightPosition.x, lightPosition.y + 0.2, lightPosition.z));\n    float d = dot(normalize(nn), nlight);\n\n    float d2 = distance(eyePosition, translated);\n    float dot2 = dot(nlight, vec3(0.0, 0.0, 1.0));\n    bool allowed = dot2 > 0.01;\n\n    vec3 infty;\n    if (allowed)\n    {\n        if (d < bias) {\n            infty = translated - nlight * 10000000.0;\n        } else {\n            vec3 correction = nlight;\n            infty = translated - correction * 0.01;\n        }\n    } else {\n        infty = vec3(0);\n    }\n    translated = infty;\n    vec4 mvPosition =  modelViewMatrix * vec4(translated, 1.0);\n    gl_Position = projectionMatrix * mvPosition;\n\n    #include <logdepthbuf_vertex>\n    #include <clipping_planes_vertex>\n    #include <worldpos_vertex>\n    #include <envmap_vertex>\n    #include <lights_lambert_vertex>\n    #include <shadowmap_vertex>\n    #include <fog_vertex>\n}\n","\n        ")},getShadowFragmentShader:function(){return"\n            ".concat("\nvoid main()\n{\n    gl_FragColor = vec4(1.0, 1.0, 1.0, 0.1);\n}\n","\n        ")}},Te=function(e,t,n,i){w.Kj0.call(this,t);var a,o=void 0!==(n=n||{}).alpha?n.alpha:1,r=void 0!==n.time?n.time:0,s=void 0!==n.waterNormals?n.waterNormals:null,l=void 0!==n.sunDirection?n.sunDirection:new w.Pa4(.70707,.70707,0),c=new w.Ilk(void 0!==n.sunColor?n.sunColor:16777215),h=new w.Ilk(void 0!==n.waterColor?n.waterColor:8355711),d=void 0!==n.eye?n.eye:new w.Pa4(0,0,0),u=void 0!==n.size?n.size:1,p=void 0!==n.distortionScale?n.distortionScale:20,m=void 0!==n.side?n.side:w.Wl3,f=void 0!==n.fog&&n.fog,g=e.waterMaterials.get(i);if(g)a=g;else{var v={uniforms:w.rDY.merge([w.rBU.fog,w.rBU.lights,{normalSampler:{value:null},mirrorSampler:{value:null},alpha:{value:1},time:{value:0},size:{value:u},distortionScale:{value:20},textureMatrix:{value:new w.yGw},sunColor:{value:new w.Ilk(8355711)},sunDirection:{value:new w.Pa4(.70707,.70707,0)},eye:{value:new w.Pa4},waterColor:{value:new w.Ilk(7695)}}]),vertexShader:Ce.getWaterVertexShader(),fragmentShader:Ce.getWaterFragmentShader()};a=new w.jyz({fragmentShader:v.fragmentShader,vertexShader:v.vertexShader,uniforms:w.rDY.clone(v.uniforms),lights:!0,side:m,fog:f});var y=e.cameraManager.waterCamera.waterRenderTarget,b=e.cameraManager.waterCamera.textureMatrix;a.uniforms.mirrorSampler.value=y.texture,a.uniforms.textureMatrix.value=b,a.uniforms.alpha.value=o,a.uniforms.time.value=r,a.uniforms.normalSampler.value=s,a.uniforms.sunColor.value=c,a.uniforms.waterColor.value=h,a.uniforms.sunDirection.value=l,a.uniforms.distortionScale.value=p,a.uniforms.eye.value=d,e.waterMaterials.set(i,a)}this.renderOrder=800,this.material=a};o(Te,w.Kj0);var ke={createChunkMesh:function(e,t,n,i,a,o){if(t){if(n&&this.rendererManager.waterReflection&&"-1"===i){var r=this.waterRTTResolution;return new Te(this,e,{textureWidth:r,textureHeight:r,waterNormals:this.textureWaterNormals,alpha:1,sunDirection:new w.Pa4(0,0,.7),sunColor:16777215,waterColor:"#3c7385",distortionScale:.1,size:20,fog:!1},i)}var s=this.createMaterial("textured-phong-water",11184810,i);return s.transparent=!0,s.opacity=.5,s.side=w.ehD,new w.Kj0(e,s)}var l=this.createMaterial("smooth-phong",{color:a||"#645946",shininess:o||.5},i);return new w.Kj0(e,l)},createChunkDebugMesh:function(e,t,n){return new w.Kj0(new w.nvb(e,t,n,1,1,1),new w.vBJ({wireframe:!0,color:65280}))}},Pe=function(){var e={uniforms:{turbidity:{value:10},rayleigh:{value:3},mieCoefficient:{value:.005},mieDirectionalG:{value:.7},sunPosition:{value:new w.Pa4},cameraPos:{value:new w.Pa4}},vertexShader:Ce.getSkyFlatVertexShader(),fragmentShader:Ce.getSkyFlatFragmentShader()},t=new w.jyz({fragmentShader:e.fragmentShader,vertexShader:e.vertexShader,uniforms:w.rDY.clone(e.uniforms),side:w.ehD}),n=new w.nvb(1,1,1);w.Kj0.call(this,n,t)};function Ie(e){return(Ie="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}o(Pe,w.Kj0);var Ae={updateChunks:function(e){if(e){if(this.debug){console.log(e);var t=0;for(var n in e)e[n][1][1]&&(t+=e[n][1][1].length);console.log(t)}this.chunkUpdates.push(e),this.needsUpdate=!0}},processChunkInput:function(e,t){for(var n=this.app.engine.graphics,i=!1,a=0,o=e.length;a<o;++a){var r=e[a],s={};if("worlds"in r){var l=r.worlds,c=r.worldsMeta;for(var h in l)if(l.hasOwnProperty(h)){for(var d=l[h],u=0,p=d.length;u<p;++u)d[u]=parseInt(d[u],10);if(!this.hasWorld(h))if(c&&c.hasOwnProperty(h)){var m=c[h];this.addWorldIfNotPresent(h,d,m),n.addScene(h);var f=n.addSky(h,this.worldProperties.get(h));f&&this.skies.set(h,f)}else console.error("NO METADATA FOR NEW WORLD: ".concat(h,"."))}}for(var g in r)if(r.hasOwnProperty(g)&&"worlds"!==g&&"worldsMeta"!==g){var v=r[g],y={};for(var w in v)if(v.hasOwnProperty(w)){var b=v[w];if(b)if(this.isChunkLoaded(g,w)&&3===b.length)this.updateChunk(g,w,b);else{if(this.isChunkLoaded(g,w)&&3!==b.length)return console.error("WARN: corrupt update or model @refresh / updateChunk ".concat(w,".")),console.log(b),void(this.chunkUpdates=[]);if(2!==b.length)return console.error("WARN: corrupt update or model @refresh / initChunk."),void console.log(b);i?y[w]=b:(this.initializeChunk(g,w,b),i=!0)}else this.unloadChunk(g,w)}Object.keys(y).length>0&&(s[g]=y)}Object.keys(s).length>0&&t.push(s)}},initializeChunk:function(e,t,n){var i=this.app.engine.graphics,a=this.worlds.get(e);if(a){var o=this.worldProperties.get(e),r=o.chunkSizeX,s=o.chunkSizeY,l=o.chunkSizeZ,c=this.worldProperties.get(e);if(c){var h=c.type===Ee.FLAT,d=i.createChunk(t,n,r,s,l,h,e);if(a.set(t,d),!d||!d.hasOwnProperty("meshes"))return console.error("WARN. Update miss @ initializeChunk: ".concat(t)),void console.log(n);for(var u=d.meshes,p=0,m=u.length;p<m;++p)i.addToScene(u[p],e);d.shadow&&i.addToShadows(d.shadow),i._debugChunkBoundingBoxes&&(d.debugMesh||console.error("[Server/Chunk] Missing debug mesh."),i.addToScene(d.debugMesh,e))}else console.error('World "'.concat(e,'" type unknown.'))}else console.error("Got chunk ".concat(t," (").concat(Ie(e),") from an unknown world: ").concat(e))},updateChunk:function(e,t,n){var i=this.app.engine.graphics,a=this.worlds.get(e);if(a){var o=this.worldProperties.get(e),r=a.get(t);if(r){var s=o.chunkSizeX,l=o.chunkSizeY,c=o.chunkSizeZ,h=this.worldProperties.get(e);if(h){var d=h.type===Ee.FLAT;i.updateChunk(e,r,t,n,s,l,c,d)}else console.error('World "'.concat(e,'" type unknown.'))}else console.log("Error: updateChunk trying to update unloaded chunk.")}else console.log("Error: updateChunk trying to access unloaded world.")},unloadChunk:function(e,t){var n=this.app.engine.graphics,i=this.worlds.get(e);if(i){var a=i.get(t);if(a){for(var o=a.meshes,r=0,s=o.length;r<s;++r)n.removeFromScene(o[r],e);n._debugChunkBoundingBoxes&&(a.debugMesh||console.error("[Server/Chunk] Missing debug mesh."),n.removeFromScene(a.debugMesh,e)),i.delete(t)}else console.log("WARN. Update miss @unloadChunk ".concat(t))}}},Ee=Object.freeze({FLAT:0,CUBE:1,SHRIKE:2,UNSTRUCTURED:3,FANTASY:4}),Oe=function(e){this.app=e,this.worlds=new Map,this.worldProperties=new Map,this.chunkUpdates=[],this.skies=new Map,this.needsUpdate=!1,this.debug=!1};a(Oe.prototype,{hasWorld:function(e){return this.worlds.has(e)},addWorldIfNotPresent:function(e,t,n){var i=new Map,a={chunkSizeX:t[0],chunkSizeY:t[1],chunkSizeZ:t[2],type:n[0],radius:n[1],center:{x:n[2],y:n[3],z:n[4]}};return a.chunkCapacity=a.chunkSizeX*a.chunkSizeY*a.chunkSizeZ,this.worlds.set(e,i),this.worldProperties.set(e,a),a},init:function(e){var t=e.getTerrain();if(t){for(var n=this.app.engine.graphics,i=t.worlds,a=0;a<i.length;++a){var o=i[a],r=o.id;if(this.worlds.set(r,new Map),"standard"===o.sky){var s=n.addSky(r,{type:Ee.FLAT});this.skies.set(r,s)}}for(var l=t.heightmaps,c=0;c<l.length;++c){var h=l[c],d=h.world;if(this.worlds.has(d)){var u=this.worlds.get(d),p=h.chunks,m=h.nbChunksX,f=h.nbChunksY;if(m>32||f>32)console.error("[Graphics/Chunks] Not supporting large maps (> 32 chunks).");else for(var g=0;g<m;++g)for(var v=0;v<f;++v){var y="".concat(g,",").concat(v),w=p.get(y);w||console.warn("[Graphics/Chunks] Could not get chunk ".concat(y,".")),this.loadChunkFromLevel(w,d,u)}}else console.warn("[Graphics/Chunks] Got a HeightMap for an unknown world.")}}},loadChunkFromLevel:function(e,t,n){var i=this.app.engine.graphics,a=i.createChunkFromLevel(e,t);i.addToScene(a,t);var o="".concat(e.x,",").concat(e.y,",").concat(e.z),r=n.get(o);r?(r.meshes.push(a),r.water.push(e.isWater)):n.set(o,{meshes:[a],water:[e.isWater]}),this.app.engine.physics.addHeightMap(a,e.nbSegmentsX,e.nbSegmentsY,e.isWater)},refresh:function(){if(this.needsUpdate){var e=this.chunkUpdates,t=[];this.processChunkInput(e,t),this.chunkUpdates=t,t.length<1&&(this.needsUpdate=!1)}},isChunkLoaded:function(e,t){var n=this.worlds.get(e);return n&&n.has(t)},getCloseTerrain:function(e,t){e||(e="-1");var n=this.worlds.get(e);if(n)if(t){var i=this.worldProperties.get(e);if(i){var a=i.chunkSizeX,o=i.chunkSizeY,r=i.chunkSizeZ,s=Math.floor(t.x/a),l=Math.floor(t.y/o),c=Math.floor(t.z/r),h=function(e,t){return(Math.floor(e)%t+t)%t},d=h(t.x,a),u=a/2,p=h(t.y,o),m=o/2,f=h(t.z,r),g=r/2,v=["".concat(s,",").concat(l,",").concat(c),"".concat(d>u?s+1:s-1,",").concat(p>m?l+1:l-1,",").concat(f>g?c+1:c-1),"".concat(d>u?s+1:s-1,",").concat(p>m?l+1:l-1,",").concat(c),"".concat(d>u?s+1:s-1,",").concat(l,",").concat(f>g?c+1:c-1),"".concat(s,",").concat(p>m?l+1:l-1,",").concat(f>g?c+1:c-1),"".concat(d>u?s+1:s-1,",").concat(l,",").concat(c),"".concat(s,",").concat(l,",").concat(f>g?c+1:c-1),"".concat(s,",").concat(p>m?l+1:l-1,",").concat(c)],y=[];return n.forEach((function(e,t){if(!e||!e.hasOwnProperty("meshes"))return console.log("Warn: corrupted chunk inside client model ".concat(t)),void console.log(n);if(t){var i=t.split(",");if(i&&3===i.length){var a=parseInt(i[0],10),o=parseInt(i[1],10),r=parseInt(i[2],10),s="".concat(a,",").concat(o,",").concat(r);v.indexOf(s)<0||e.meshes.forEach((function(e){e&&e.geometry&&y.push(e)}))}}})),y}}else console.warn("[Raycaster] Player position undefined.")},cleanup:function(){this.worlds.forEach((function(e){e.forEach((function(e){e&&e.hasOwnProperty("meshes")&&e.meshes.forEach((function(e){e.geometry.dispose(),e.material.dispose()}))})),e.clear()})),this.worlds.clear(),this.worldProperties.clear(),this.chunkUpdates=[],this.skies.forEach((function(e){e.mesh&&(e.mesh.geometry.dispose(),e.mesh.material.dispose()),e.helper&&e.helper.mesh&&(e.helper.mesh.geometry.dispose(),e.helper.mesh.material.dispose())})),this.skies.clear(),this.needsUpdate=!1,this.debug=!1}}),a(Oe.prototype,Ae);var Le={createFlatSky:function(e){var t=new Pe;return t.scale.setScalar(45e4),t.userData.hasPrimaryImage=!0,t.userData.hasReflection=!0,{mesh:t,lights:this.createSkyLight(new w.Pa4(-1,-2,-1),"flat",e)}},createSkyLight:function(e,t,n){var i=this.createLight("sun",n,t),a=new w.Pa4;a.copy(e).normalize(),i.position.set(a.x,a.y,a.z),i.position.set(0,0,0);var o=this.createLight("hemisphere");o.position.set(a.x,a.y,a.z);var r=this.createLight();return r.position.set(a.x,a.y,a.z),{directionalLight:i,hemisphereLight:o,ambientLight:r,type:t}},createSunSphere:function(){var e=new w.Kj0(new w.Aip(2e4,16,8),new w.vBJ({color:16777215}));return e.position.y=-7e5,e.visible=!1,e},addSky:function(e,t){t||console.log("[Chunks] Default sky creation.");var n,i=new w.Pa4(0,-7e5,0),a=t.type;if(a===Ee.FLAT||a===Ee.FANTASY)return n=this.createFlatSky(e),this.addToScene(n.mesh,e),this.addToScene(n.lights.directionalLight,e),this.addToScene(n.lights.ambientLight,e),this.updateSky(n,i,10,2,.005,.8,1,-.15,3,!0),n;console.error("Unsupported sky type.")},getSunDirection:function(e){var t=this.distance,n=e.phi||0,i=this.theta,a=t*Math.cos(n),o=t*Math.sin(n)*Math.sin(i),r=t*Math.sin(n)*Math.cos(i),s=new w.Pa4(-a,o,r);return s.normalize().negate(),s},updateSunPosition:function(e,t,n){var i=t.mesh;if(i&&this.distance){var a=i,o=Math.cos,r=Math.sin,s=this.distance,l=t.phi,c=this.theta;l=Math.PI/3.5,c=Math.PI/8,t.phi=l;var h,d=s*o(l),u=s*r(l)*r(c),p=s*r(l)*o(c),m=new w.Pa4(d,u,p);e.projectionMatrix&&(h=new w.Pa4,e.getWorldPosition(h),a.material.uniforms.cameraPos.value.copy(h)),a.material.uniforms.sunPosition.value.copy(m);var f=this.app.model.backend,g=f.selfModel.position;if(g){i.position.copy(g),i.updateMatrix();var v=f.chunkModel.worldProperties.get(n),y=v&&v.type===Ee.FLAT,b=new w.Pa4;b.copy(m).normalize();var S=t.lights.hemisphereLight,C=t.lights.directionalLight;if(S.position.copy(b),C.position.copy(b).multiplyScalar(60),y&&h&&this.hasShadowMap()){var T=C.position;T.set(T.x+h.x,T.y+h.y,T.z),C.target.position.set(h.x,h.y,0),C.target.updateMatrixWorld()}if("flat"===t.lights.type){var k=Math.max(b.z,0),P=Math.pow(k,.1);if(S.intensity=x.HEMISPHERE*P,C.intensity=x.DIRECTIONAL*P,0===k){var I=Math.max(-b.z,0);P=Math.pow(I,.1),S.position.copy(new w.Pa4(0,0,-1)),S.intensity=.3*P,C.intensity=0,S.groundColor=new w.Ilk(255),S.skyColor=new w.Ilk(255)}else S.skyColor=new w.Ilk(M.HEMISPHERE_SKY),S.groundColor=new w.Ilk(M.HEMISPHERE_GROUND)}}}},updateSky:function(e,t,n,i,a,o,r,s,l){var c=Math.sin,h=Math.cos,d=e.mesh.material.uniforms;if(d){d.turbidity.value=n,d.rayleigh.value=i,d.mieCoefficient.value=a,d.mieDirectionalG.value=o;var u=Math.PI;u=Math.PI/4,e.phi=u;var p=4e5;this.distance=p,this.phi=u,this.theta=0,t.x=p*h(u),t.y=p*c(u)*c(0),t.z=p*c(u)*h(0),d.sunPosition.value.copy(t)}}},_e=function(e){if(this.textSequence=e,this.textIndex=0,this.unlockedTextIndex=0,e.length<1)throw Error("[Label] Must have a text sequence with TEXT INSIDE.");this.time=0,this.fadeInTime=100,this.fadeOutTime=500,this.displayTime=3e3;var t=e[0].text;this.text=t||"Allo?";var n=document.createElement("div");n.className="text-label",n.style.position="absolute",n.style.width="400",n.style.height="200",n.innerHTML=t,n.style.top="-1000",n.style.left="-1000",n.style.zIndex="2",n.style.display="none",document.body.appendChild(n),this.element=n,this.parent=null,this.position=new w.Pa4(0,0,0),this.coords2D=new w.FM8(0,0),this._w=new w.Pa4(0,0,0),this._m=new w.yGw};a(_e.prototype,{setText:function(e){this.text=e,this.setHTML(e)},getText:function(){return this.text},stepTextSequence:function(){var e=this.textSequence,t=e.length,n=this.textIndex+1;if(n<t){var i=e[n];if(!i.direct&&this.unlockedTextIndex<n){var a=i.timeToWaitBefore;if(this.time<a+this.displayTime)return}this.textIndex=n,this.unlockedTextIndex=Math.max(this.unlockedTextIndex,n);var o=i.text;this.setText(o),this.audioEngine&&this.audioEngine.playTextFromPosition(o,this.position),this.resetTime()}},bindAudio:function(e){this.audioEngine=e},unstepTextSequence:function(){var e=this.textSequence,t=this.textIndex-1;if(t>=0){this.textIndex=t;var n=e[t].text;this.setText(n),this.resetTime()}},setTextSequence:function(e){this.textSequence=e,this.textIndex=0;var t=this.textSequence[this.textIndex].text;this.unlockedTextIndex=0,this.setText(t),this.resetTime()},advanceTime:function(e){this.time+=e},resetTime:function(){this.time=0},setHTML:function(e){this.element.innerHTML=e},setParent:function(e){this.parent=e},updatePosition:function(e,t){!t&&this.parent&&this.position.copy(this.parent.position),t&&this.position.copy(t);var n,i=this.get2DCoords(this.position,e),a=this.fadeInTime,o=this.fadeOutTime,r=this.displayTime,s=this.time;0!=(n=s<a?s/a:s<a+r?1:s<a+r+o?1-(s-r-a)/o:0)?(this.element.style.opacity="".concat(Math.floor(100*n),"%"),0!==this.coords2D.manhattanDistanceTo(i)&&(this.coords2D.set(i.x,i.y),i.x<0||i.y<0||i.x>window.innerWidth||i.y>window.innerHeight?this.element.style.display="none":(this.element.style.display="block",this.element.style.left="".concat(Math.floor(i.x),"px"),this.element.style.top="".concat(Math.floor(i.y),"px")))):this.element.style.display="none"},get2DCoords:function(e,t){var n=this._m,i=this._w;n.copy(t.matrixWorld).invert(),i.copy(e).applyMatrix4(n);var a=e.project(t);return a.x=(a.x+1)/2*window.innerWidth,a.y=-(a.y-1)/2*window.innerHeight,i.z>0&&(a.x=2*window.innerWidth,a.y=2*window.innerHeight),a}});var Re=function(e){this.text=e;var t=document.createElement("div");t.id="title-label",t.className="title-label",t.style.position="absolute",t.style.textAlign="center",t.innerHTML=e,t.style.top="-1000",t.style.left="-1000",t.style.zIndex="2",t.style.userSelect="none",this.element=t,document.body.appendChild(t)};a(Re.prototype,{center:function(){var e=window.innerWidth,t=window.innerHeight,n=this.element;n.style.display="block",n.style.left="".concat(Math.floor(e/2-n.offsetWidth/2),"px"),n.style.top="".concat(Math.floor(t/2-n.offsetHeight/2),"px")},setText:function(e){this.text=e,this.element.innerHTML=e},setOpacity:function(e){this.element.style.opacity=e},hide:function(){this.element.style.display="none"}});var De={createTextLabel:function(e){return e||(e={direct:!0,text:"Je crois qu’on m’a oubliée."}),new _e(e)},createTitleLabel:function(e){var t=new Re(e);return t.center(),t}},ze=n(286),Fe=n(682),Be=new w.Pa4,We=new w.Pa4,je=new w.Pa4,Ne=new w.Pa4,Ue=new w.Pa4,Ve=new w.Pa4;function He(e,t){var n=e.index?e.toNonIndexed():e.clone(),i=n.getAttribute("position");if(!(t>i.count)){for(var a=[],o=[],r=0,s=t;r<s;r+=3)Be.x=i.getX(r),Be.y=i.getY(r),Be.z=i.getZ(r),We.x=i.getX(r+1),We.y=i.getY(r+1),We.z=i.getZ(r+1),je.x=i.getX(r+2),je.y=i.getY(r+2),je.z=i.getZ(r+2),Ne.subVectors(Be,We),Ue.subVectors(We,je),Ve.crossVectors(Ne,Ue).normalize(),o.push(Ve.x,Ve.y,Ve.z),o.push(Ve.x,Ve.y,Ve.z),o.push(Ve.x,Ve.y,Ve.z),a.push(Be.x,Be.y,Be.z),a.push(We.x,We.y,We.z),a.push(je.x,je.y,je.z);var l=[];l=new Array(t).fill().map((function(e,t){return t}));for(var c=new Map,h=0,d=t;h<d;h+=3)for(var u=0;u<3;u++){var p=h+u,m=h+(u+1)%3;if(Be.x=i.getX(p),Be.y=i.getY(p),Be.z=i.getZ(p),We.x=i.getX(m),We.y=i.getY(m),We.z=i.getZ(m),2===(Be.x===We.x)+(Be.y===We.y)+(Be.z===We.z)){var f=void 0;We.z!==Be.z?f=Be.z<We.z?~~Be.x+","+~~Be.y+","+~~Be.z+","+~~We.x+","+~~We.y+","+~~We.z:~~We.x+","+~~We.y+","+~~We.z+","+~~Be.x+","+~~Be.y+","+~~Be.z:We.y!==Be.y?f=Be.y<We.y?~~Be.x+","+~~Be.y+","+~~Be.z+","+~~We.x+","+~~We.y+","+~~We.z:~~We.x+","+~~We.y+","+~~We.z+","+~~Be.x+","+~~Be.y+","+~~Be.z:We.x!==Be.x&&(f=Be.x<We.x?~~Be.x+","+~~Be.y+","+~~Be.z+","+~~We.x+","+~~We.y+","+~~We.z:~~We.x+","+~~We.y+","+~~We.z+","+~~Be.x+","+~~Be.y+","+~~Be.z);var g=c.get(f);g?g.push(p,m):c.set(f,[p,m])}}var v=a.length/3;c.forEach((function(e){var t=e.length/2;if(2===t){var n=e[0],r=e[1],s=e[2],c=e[3],h=o[3*n],d=o[3*n+1],u=o[3*n+2],p=o[3*c],m=o[3*c+1],f=o[3*c+2];if(h===p&&d===m&&u===f)return;l.push(n),l.push(c),l.push(s),l.push(n),l.push(s),l.push(r)}else if(1===t){var g=e[0],y=e[1],w=v,b=w+1;v+=2,a.push(i.getX(g),i.getY(g),i.getZ(g)),a.push(i.getX(y),i.getY(y),i.getZ(y)),o.push(0,0,-1),o.push(0,0,-1),l.push(g),l.push(b),l.push(y),l.push(g),l.push(w),l.push(b)}else 3===t||4===t||console.warn("[ShadowVolumes] Non-manifold edge with more than four faces.")}));var y=new w.TlE(new Float32Array(o),3,!1);n.setAttribute("normal",y);var b=new w.TlE(new Uint32Array(l),1,!1);n.setIndex(b);var x=new w.TlE(new Float32Array(a),3,!1);return n.setAttribute("position",x),n}console.warn("inv geom count")}function Ge(e){var t=new w.Pa4,n=new w.Pa4,i=Fe.rD.merge([ze.V.basic.uniforms,{lightPosition:{value:t},eyePosition:{value:n},bias:{value:e}}]);return new w.jyz({uniforms:i,vertexShader:Ce.getShadowVertexShader(),fragmentShader:ze.V.basic.fragmentShader,side:w.Wl3})}function qe(e){return function(e){if(Array.isArray(e))return Ye(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return Ye(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ye(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function Ye(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Xe={createChunk:function(e,t,n,i,a,o,r){var s,l,c=t[0],h=t[1];if(!c.hasOwnProperty("1")&&!c.hasOwnProperty("2"))return this.createEmptyChunkComponent(e,n,i,a,r,o);var d,u=c.hasOwnProperty("1")&&h.hasOwnProperty("1"),p=c.hasOwnProperty("2")&&h.hasOwnProperty("2");if(u&&p){s=c[1],l=h[1],d=this.createChunkComponent(e,n,i,a,s,l,!1,0,o,r),s=c[2],l=h[2];var m=this.createChunkComponent(e,n,i,a,s,l,!0,1,o,r);d.capacities.push(m.capacities[0]),d.geometries.push(m.geometries[0]),d.sizes.push(m.sizes[0]),d.water.push(m.water[0]),d.meshes.push(m.meshes[0]),d.whereToFindFace=new Map([].concat(qe(d.whereToFindFace),qe(m.whereToFindFace))),d.whichFaceIs=new Map([].concat(qe(d.whichFaceIs),qe(m.whichFaceIs)))}else u?(s=c[1],l=h[1],d=this.createChunkComponent(e,n,i,a,s,l,!1,0,o,r)):p&&(s=c[2],l=h[2],d=this.createChunkComponent(e,n,i,a,s,l,!0,0,o,r));return d},createDebugMesh:function(e,t,n,i,a,o,r){e.debugMesh=this.createChunkDebugMesh(t,n,i),e.debugMesh.position.set(a+t/2,o+n/2,r+i/2)},createEmptyChunkComponent:function(e,t,n,i,a,o){var r=this._defaultEmptyChunkSize;this.debug&&console.log("On chunk ".concat(e,", init geometry will be ").concat(3*r*3,"-capable."));var s=new w.u9r;s.setAttribute("position",new w.TlE(new Float32Array(3*r*3),3)),s.setAttribute("normal",new w.TlE(new Float32Array(3*r*3),3)),s.setAttribute("color",new w.TlE(new Float32Array(3*r*3),3)),s.setAttribute("uv",new w.TlE(new Float32Array(3*r*2),2)),s.computeBoundingSphere();var l=this.createChunkMesh(s,!1,!1,a);o&&this.hasShadowMap()&&-1===parseInt(a,10)&&(l.castShadow=!0,l.receiveShadow=!0),l.userData.bloom=!0;var c={geometries:[s],meshes:[l],water:[!1],capacities:[r/2],sizes:[0],whereToFindFace:new Map,whichFaceIs:new Map};if(this._debugChunkBoundingBoxes){var h=e.split(","),d=parseInt(h[0],10)*t,u=parseInt(h[1],10)*n,p=parseInt(h[2],10)*i;this.createDebugMesh(c,t,n,i,d,u,p)}return c},createChunkComponent:function(e,t,n,i,a,o,r,s,l,c){var h=e.split(","),d=parseInt(h[0],10)*t,u=parseInt(h[1],10)*n,p=parseInt(h[2],10)*i,m=t,f=t*n,g=f*i,v=2*a.length,y=Math.floor(1.5*v);y+=y%2,this.debug&&console.log("On chunk ".concat(e,", init geometry will be ").concat(3*y*3,"-capable."));for(var b=new Float32Array(3*y*3),x=new Float32Array(3*y*3),M=new Float32Array(3*y*3),S=new Float32Array(3*y*2),C=new w.Pa4,T=new w.Pa4,k=new w.Pa4,P=new w.Pa4,I=new w.Pa4,A=new w.Ilk,E=new Map,O=new Map,L=0,_=0;_<a.length;++_){var R=Math.abs(a[_]),D=s;E.set(R,[D,_]);var z=O.get(D);void 0===z&&(z=new Map,O.set(D,z)),z.set(_,R);var F=o[_]>0;this.addFace(R,L,m,f,g,b,x,M,S,Math.abs(o[_]),d,u,p,C,T,k,P,I,F,A),++L}var B=new w.u9r;B.setAttribute("position",new w.TlE(b,3)),B.setAttribute("normal",new w.TlE(x,3)),B.setAttribute("color",new w.TlE(M,3)),B.setAttribute("uv",new w.TlE(S,2)),B.computeBoundingSphere();var W,j=this.createChunkMesh(B,r,l,c);if(!r){var N=-1===parseInt(c,10);l&&this.hasShadowVolumes()&&N&&(W=new w.Kj0(He(B,3*v),Ge(0))),l&&this.hasShadowMap()&&N&&(j.castShadow=!0,j.receiveShadow=!0),j.userData.bloom=!0}var U={geometries:[B],meshes:[j],water:[r],capacities:[y/2],sizes:[v/2],shadow:W,whereToFindFace:E,whichFaceIs:O};return this._debugChunkBoundingBoxes&&this.createDebugMesh(U,t,n,i,d,u,p),U},updateChunk:function(e,t,n,i,a,o,r,s){var l=t.geometries,c=t.meshes,h=t.capacities,d=t.sizes,u=t.water,p=t.whereToFindFace,m=t.whichFaceIs,f=i[0],g=i[1],v=i[2];for(var y in this.debug&&(console.log("BUD"),console.log(f),console.log(g),console.log(v)),v)if(v.hasOwnProperty(y)){var b=v[y];f[y]=null,g[y]=b}if(this.removeChunkFaces(e,f,l,c,h,d,p,m),this.addChunkFaces(e,g,l,c,h,d,u,p,m,n,a,o,r,s),this.hasShadowVolumes()&&t.shadow)for(var x=0;x<c.length;++x)if(!u[x]){var M=l[x],S=d[x];this.removeFromShadows(t.shadow),t.shadow=new w.Kj0(He(M,2*S*3),Ge(0)),this.addToShadows(t.shadow);break}},removeChunkFaces:function(e,t,n,i,a,o,r,s){var l,c,h,d,u,p;for(var m in t)if(t.hasOwnProperty(m)){var f=parseInt(m,10);if(r.has(f)){var g=r.get(f);p=g[0];var v=g[1];c=(l=n[p]).attributes.position.array,h=l.attributes.color.array,d=l.attributes.normal.array,u=l.attributes.uv.array;var y=o[p]-1,w=y===v,b=void 0,x=void 0;if(w){for(b=0;b<18;++b)c[x=18*v+b]=d[x]=h[x]=0;for(b=0;b<12;++b)u[12*v+b]=0}else{for(b=0;b<18;++b){var M=18*y+b;c[x=18*v+b]=c[M],d[x]=d[M],h[x]=h[M],c[M]=d[M]=h[M]=0}for(b=0;b<12;++b){var S=12*y+b;u[x=12*v+b]=u[S],u[S]=0}}if(!w){var C=s.get(p);void 0===C.get(y)&&(console.log("WARN: swapping"),console.log("".concat(s[p][y]," @mesh ").concat(p," ")+"@lastposition ".concat(y," @position ").concat(v))),r.set(C.get(y),[p,v]),C.set(v,C.get(y))}s.get(p).delete(y),r.delete(f),o[p]-=1,0===o[p]?(console.log("INFO: geometry deletion."),this.removeFromScene(i[p],e),n[p]=void 0,i[p]=void 0,o[p]=void 0,a[p]=void 0,s.delete(p)):(l.attributes.position.needsUpdate=!0,l.attributes.color.needsUpdate=!0,l.attributes.normal.needsUpdate=!0,l.attributes.uv.needsUpdate=!0,l.computeBoundingSphere())}else console.log("Trying to remove a face that is not present in chunk: ".concat(f))}},addChunkFaces:function(e,t,n,i,a,o,r,s,l,c,h,d,u,p){var m,f,g,v,y,b,x,M=h,S=h*d,C=S*u,T=c.split(","),k=parseInt(T[0],10)*h,P=parseInt(T[1],10)*d,I=parseInt(T[2],10)*u,E=this.defaultGeometrySize;for(var O in t)if(t.hasOwnProperty(O)){var L=parseInt(O,10);if(x=Math.abs(L),s.hasOwnProperty(x))console.log("Trying to add a face that is already present in chunk.");else{var _,R=t[L],D=Math.abs(R)===A.BLOCK_WATER;for(b=0;void 0!==i[b]&&(o[b]===a[b]||r[b]!==D);)++b;if(_=void 0===o[b],this.debug){var z=Math.floor(100*o[b]/a[b]);z%20==0&&console.log("INFO: Geometry ".concat(b," at ").concat(z,"% capacity."))}if(_){this.debug&&console.log("INFO: Geometry addition: "+"".concat(b)+"".concat(b%10==1?"st":b%10==2?"nd":b%10==3?"rd":"th")+" geometry."),m=new w.u9r,n[b]=m,o[b]=1,r[b]=D,l.set(b,new Map);var F=2*E,B=Math.floor(1.5*F);a[b]=B/2,f=new Float32Array(3*B*3),v=new Float32Array(3*B*3),g=new Float32Array(3*B*3),y=new Float32Array(3*B*2),this.debug&&console.log("New capacity will be ".concat(3*B*3,"."))}else m=n[b],o[b]+=1,f=m.attributes.position.array,g=m.attributes.color.array,v=m.attributes.normal.array,y=m.attributes.uv.array;var W=new w.Pa4,j=new w.Pa4,N=new w.Pa4,U=new w.Pa4,V=new w.Pa4,H=new w.Ilk,G=o[b]-1,q=R>0;s.set(L,[b,G]);var Y=l.get(b);if(Y)Y.set(G,L);else{var X=new Map;X.set(G,L),l.set(b,X)}if(this.addFace(x,G,M,S,C,f,v,g,y,Math.abs(R),k,P,I,W,j,N,U,V,q,H,800),_){m.setAttribute("position",new w.TlE(f,3)),m.setAttribute("normal",new w.TlE(v,3)),m.setAttribute("color",new w.TlE(g,3)),m.setAttribute("uv",new w.TlE(y,2));var K=this.createChunkMesh(m,D,p,e);this.hasShadowMap()&&p&&-1===parseInt(e,10)&&(K.castShadow=!0,K.receiveShadow=!0),K.userData.bloom=!0,i[b]=K,this.addToScene(K,e)}m.attributes.position.needsUpdate=!0,m.attributes.color.needsUpdate=!0,m.attributes.normal.needsUpdate=!0,m.attributes.uv.needsUpdate=!0,m.computeBoundingSphere()}}}},Ke=function(e){this.app=e,this.settings={},this.debug=!1,this.windowHalfX=window.innerWidth/2,this.windowHalfY=window.innerHeight/2,this.defaultGeometrySize=64,this._defaultEmptyChunkSize=16,this.requestId=null,this.sceneManager=new le(this),this.rendererManager=new se(this),this.cameraManager=new G(this),this.animationManager=new xe(this),this.controls=null,this.loadingManager=null,this.textureAtlas=null,this.textureWaterNormals=null,this.textureCoordinates=null,this._nbTexturesLoaded=0,this._nbTexturesToLoad=0,this.oneWater=!1,this.referenceMeshes=null,this._nbMeshesToLoad=0,this._nbMeshesLoadedOrError=0,this._debugChunkBoundingBoxes=!1,this.instancedMaterials=new Map,this.waterMaterials=new Map,this.waterRTTResolution=512,this.mixers=null,this.portalUpdates=[],this.lastRenderPaths=new Set,this.lastRenderGates=new Set,this.previousFrameWorld=null,this.currentFrameWorld=null};a(Ke.prototype,b),a(Ke.prototype,S),a(Ke.prototype,C),a(Ke.prototype,_),a(Ke.prototype,D),a(Ke.prototype,F),a(Ke.prototype,B),a(Ke.prototype,N),a(Ke.prototype,{getCameraCoordinates:function(){return this.cameraManager.mainCamera.getCameraPosition()},getCameraForwardVector:function(){return this.cameraManager.mainCamera.getCameraForwardVector()},getModelForwardVector:function(){return this.cameraManager.mainCamera.getModelForwardVector()},switchToCamera:function(e,t){return this.cameraManager.switchToCamera(e,t)}}),a(Ke.prototype,{hasShadowMap:function(){return this.rendererManager.shadowMap},hasHighResShadows:function(){return this.rendererManager.highResolutionShadowMap},hasShadowVolumes:function(){return this.rendererManager.shadowVolumes}}),a(Ke.prototype,ce),a(Ke.prototype,Me),a(Ke.prototype,Se),a(Ke.prototype,ke),a(Ke.prototype,Xe),a(Ke.prototype,Ce),a(Ke.prototype,Le),a(Ke.prototype,De);var Ze=.1,Je=.03,Qe=.05,$e=new Map([[" ",[82.41,.2]],["a",[82.41,Ze]],["e",[246.94,Ze]],["o",[329.63,Ze]],["u",[587.33,Ze]],["i",[174.61,Ze]],["y",[1760,Ze]],["b",[87.31,Je]],["c",[98,Je]],["d",[220,Je]],["g",[146.83,Je]],["h",[164.81,Je]],["j",[196,Je]],["k",[440,Je]],["p",[349.23,Je]],["q",[392,Je]],["t",[523.25,Je]],["x",[783.99,Je]],["l",[493.88,Qe]],["r",[880,Qe]],["w",[698.46,Qe]],["f",[130.81,Qe]],["m",[261.63,Qe]],["n",[293.66,Qe]],["s",[987.77,Qe]],["v",[659.26,Qe]],["z",[1975.53,Qe]]]),et=function(e){this.audioEngine=e,this.notes=[],this.currentlyPlayinNotes=[],this.frequencies=$e,this.whoSingsWhat=new Map,this.singingHandle=0,this.mainVoiceMaxVolume=0,this.mainVoice=null,this.mainOscillator=null,this.isFirefox=navigator.userAgent.toLowerCase().indexOf("firefox")>-1};a(et.prototype,{generateHandle:function(){return this.singingHandle+1},refresh:function(){},isReady:function(){return null!==this.mainVoice},getMainVoice:function(){return this.mainVoice},generateMainVoice:function(e){r(this.frequencies.size>0,"[Audio/Notes] Could not find notes.");var t=new w.BbS(e),n=e.context.createOscillator();n.type="sine";var i=t.context.currentTime;n.frequency.setValueAtTime(144,i),n.start(0),t.setNodeSource(n);var a=this.mainVoiceMaxVolume;t.setVolume(a),t.gain.gain.setValueAtTime(a,i),this.mainVoice=t,this.mainOscillator=n},singLetter:function(e,t,n,i){var a=this,o=this.frequencies.get(e);if(o){var r=o[0],s=o[1],l=n.context,c=l.currentTime;if(this.mainOscillator.frequency.setValueAtTime(r,c),i&&i.length){var h=this.generateHandle();this.singingHandle=h,setTimeout((function(){a.mainVoice.setVolume(a.mainVoiceMaxVolume),a.singRemainingText(i,t,n,h)}),500*s)}else setTimeout((function(){a.mainVoice.setVolume(0),a.fadeOutVolumeIfFirefox(l)}),500*s)}else console.error("[Audio] ".concat(e," not found."))},singText:function(e,t,n){var i=e.replace(/[^a-zA-Z\s]/gi,"").toLowerCase().replace(/\s+/g," ");if(!(i.length<1)){i.length>10&&(i=i.substring(0,10));var a=i[0];i=i.substring(1),this.whoSingsWhat.set(t,i),this.fadeInVolumeIfFirefox(this.mainVoiceMaxVolume,n.context),this.isFirefox||this.mainVoice.setVolume(this.mainVoiceMaxVolume),this.singLetter(a,t,n,i)}},singRemainingText:function(e,t,n,i){var a=this;if(this.singingHandle===i){var o=e[0],r=e.substring(1),s=this.frequencies.get(o),l=s[0],c=s[1],h=n.context,d=h.currentTime;this.mainOscillator.frequency.setValueAtTime(l,d),r&&r.length?(this.whoSingsWhat.set(t,r),setTimeout((function(){a.mainVoice.setVolume(a.mainVoiceMaxVolume),a.singRemainingText(r,t,n,i)}),1e3*c)):setTimeout((function(){a.mainVoice.setVolume(0),a.fadeOutVolumeIfFirefox(h)}),1e3*c)}else this.mainVoice.setVolume(0)},fadeInVolumeIfFirefox:function(e,t){if(this.isFirefox){var n=this.mainVoice.gain,i=t.currentTime,a=this.audioEngine.settings.globalVolume;n.gain.setValueAtTime(0,i),n.gain.linearRampToValueAtTime(a,i+.05)}},fadeOutVolumeIfFirefox:function(e){if(this.isFirefox){var t=this.mainVoice.gain,n=e.currentTime,i=this.audioEngine.settings.globalVolume;t.gain.setValueAtTime(i,n),t.gain.linearRampToValueAtTime(0,n+.05)}}});const tt=n.p+"75302b102772de7725f481b0a222dabf.mp3",nt=n.p+"587c52b3310ae50060ee2eeb4bbff3db.mp3",it=n.p+"cbf432e0ae61d47d582734b3085eb2b7.mp3",at=n.p+"d66a566aff2e5341c4ab685caac93382.mp3",ot=n.p+"45681cd06b930a5f2ccb1dfce0a9befc.mp3",rt=n.p+"8bab165abfa203663d3565e2d549150e.mp3",st=n.p+"91e2fe9f6dfbe65ec40ea46a45abcec0.wav",lt=n.p+"b83d4afca045221715a89c59ec20e7e7.wav",ct=n.p+"b9b3f11715585a5014309f5cb4fafca7.mp3";var ht={global:[["menu",st],["pickup",lt]],music:[["ambience-1",tt],["ambience-2",nt],["ambience-3",it],["ambience-4",at],["credits",ot],["bonus-credits",rt]],positional:[["footstep-hard-1",n.p+"c27d3dbf44938e6d58476022955c0b2a.mp3"],["footstep-hard-2",n.p+"aa8f054c7dca4483efada2dc5bdff0a8.mp3"],["footstep-hard-3",n.p+"b304aed01a9df6a098ab3e46dde17a98.mp3"],["footstep-hard-4",n.p+"927945d68abc4ce4160d33e8849a07b8.mp3"],["footstep-hard-5",n.p+"bb35f4c8c9d78c30ded1dd7ae64edc9f.mp3"],["footstep-hard-6",n.p+"d699289ec513800a73ea3b2f38b04f21.mp3"],["footstep-hard-7",n.p+"19d65d9160c4a074d0d64d9822bb73af.mp3"],["footstep-hard-8",n.p+"074edd692d963c821814db55445e9670.mp3"],["footstep-dirt-1",n.p+"c06b1d8a89195b621a461eb79872ee64.mp3"],["footstep-dirt-2",n.p+"01d904a82f18b03180ac52e9de1cbc4c.mp3"],["footstep-dirt-3",n.p+"66d364afde2795886df9dd860cca9ab1.mp3"],["footstep-puddle-1",n.p+"e95df0d692c9854ab8044310ccb512d7.mp3"],["footstep-puddle-2",n.p+"c9f13b1b9c0d23d1002d2b6690b44d45.mp3"],["jump",ct]]},dt=function(e){this.app=e,this.settings={globalVolume:0,mute:!0},this.listener=new w.SJI,this.audioSources=[],this.musicSources=[],this.positionalAudioSources=[];var t=ht;this.source=null,this.sounds={sfx:t.global.map((function(e){return e[1]})),positionalSfx:t.positional.map((function(e){return e[1]})),music:t.music.map((function(e){return e[1]}))},this.soundMap=new Map(t.global.map((function(e,t){return[e[0],t]}))),this.positionalSoundMap=new Map(t.positional.map((function(e,t){return[e[0],t]}))),this.musicMap=new Map(t.music.map((function(e,t){return[e[0],t]}))),this.isMusicMute=!1,this.nbSoundsToLoad=this.sounds.sfx.length+this.sounds.music.length+this.sounds.positionalSfx.length,this.nbSoundsLoadedOrError=0,this.notesEngine=new et(this),this.currentWaterFootstep=0,this.nbWaterFootsteps=2,this.currentFootstep=0,this.nbFootsteps=8};a(dt.prototype,{refresh:function(){this.notesEngine.refresh()},preload:function(e){this.audioLoader=new w.mTL(e);var t=this.sounds.sfx,n=this.sounds.positionalSfx,i=this.sounds.music;this.loadAudios(t,!0),this.loadAudios(i,!0,!0),this.loadAudios(n,!1)},loadAudios:function(e,t,n){var i=this,a=this.listener,o=this.settings.globalVolume,r=this.app.state.getState("loading");e.forEach((function(e,s){i.audioLoader.load(e,(function(e){var r=t?new w.BbS(a):new w.VYz(a);r.setBuffer(e),r.setVolume(o),r.gain.gain.setValueAtTime(1e-5,a.context.currentTime),n?i.musicSources[s]=r:t?i.audioSources[s]=r:i.positionalAudioSources[s]=r,i.nbSoundsLoadedOrError++}),(function(){r.notifyTaskName("audio")}),(function(e){console.error(e),i.nbSoundsLoadedOrError++}))}))},_resume:function(){this.listener.context.resume()},isDoneLoadingSounds:function(){return this.nbSoundsLoadedOrError>=this.nbSoundsToLoad},isMute:function(){return this.settings.mute},mute:function(){this.settings.mute=!0;var e=this.positionalAudioSources,t=this.audioSources,n=this.musicSources;t.forEach((function(e){return e.setVolume(0)})),e.forEach((function(e){return e.setVolume(0)})),n.forEach((function(e){return e.setVolume(0)})),this.notesEngine.mainVoiceMaxVolume=0,this.notesEngine.mainVoice&&this.notesEngine.mainVoice.setVolume(0)},unMute:function(){this.settings.mute=!1;var e=this.positionalAudioSources,t=this.audioSources,n=this.musicSources,i=this.settings.globalVolume;t.forEach((function(e){return e.setVolume(i)})),e.forEach((function(e){return e.setVolume(i)})),n.forEach((function(e){return e.setVolume(i)}))},playCredits:function(){this.stopMusic();var e=this.musicMap.get("credits");this.musicSources[e].play()},playBonusCredits:function(){this.stopMusic();var e=this.musicMap.get("bonus-credits");this.musicSources[e].play()},playMusic:function(){this.stopMusic();var e=this.musicMap.get("ambience-1"),t=this.musicMap.get("ambience-2"),n=this.musicMap.get("ambience-3"),i=this.musicMap.get("ambience-4"),a=this.musicSources[e],o=this.musicSources[t],r=this.musicSources[n],s=this.musicSources[i];a.currentTime=0,a.onEnded=function(){a.isPlaying=!1,o.currentTime=0,o.play()},o.onEnded=function(){o.isPlaying=!1,r.currentTime=0,r.play()},r.onEnded=function(){r.isPlaying=!1,s.currentTime=0,s.play()},s.onEnded=function(){s.isPlaying=!1,a.currentTime=0,a.play()},a.play()},stopMusic:function(){var e=this;this.musicMap.forEach((function(t){var n=e.musicSources[t];n.isPlaying&&n.hasPlaybackControl&&n.pause()}))},muteMusic:function(){this.isMusicMute=!0,this.musicSources.forEach((function(e){return e.setVolume(0)})),this.stopMusic()},unmuteMusic:function(){this.isMusicMute=!1;var e=this.musicSources,t=this.settings.globalVolume;e.forEach((function(e){return e.setVolume(t)})),this.playMusic()},setVolume:function(e){r("number"==typeof e&&e<=1&&e>=0,"[Audio] Invalid volume."),this.settings.mute=0===e,this.settings.globalVolume=e;var t=this.positionalAudioSources,n=this.audioSources,i=this.musicSources;n.forEach((function(t){return t.setVolume(e)})),t.forEach((function(t){return t.setVolume(1.5*e)})),i.forEach((function(t){return t.setVolume(e)})),this.notesEngine.mainVoiceMaxVolume=.5*e},getVolume:function(){return this.settings.globalVolume},playValidateSound:function(){var e=this.soundMap.get("pickup");this.audioSources[e].play()},playJumpSound:function(){var e=this.positionalSoundMap.get("jump");this.positionalAudioSources[e].play()},playFootstepWaterSound:function(){var e=this.currentWaterFootstep,t="footstep-puddle-".concat(e+1),n=this.positionalSoundMap.get(t);this.positionalAudioSources[n].play(),e++,e%=this.nbWaterFootsteps,this.currentWaterFootstep=e},playFootstepSound:function(){var e=this.currentFootstep,t="footstep-hard-".concat(e+1),n=this.positionalSoundMap.get(t);this.positionalAudioSources[n].play(),e++,e%=this.nbFootsteps,this.currentFootstep=e},playMenuSound:function(){this._resume();var e=this.soundMap.get("menu");this.audioSources[e].play()},playTextFromPosition:function(e,t){this.playText(e)},playText:function(e,t){r("string"==typeof e);var n=this.listener,i=this.notesEngine;i.isReady()||i.generateMainVoice(n),t||(t=i.getMainVoice()),i.singText(e,t,n)},run:function(){},stop:function(){this.stopAllSounds()},stopAllSounds:function(){}});var ut={getKeyControls:function(e){var t;switch(e){case"en":case"en-US":case"en-GB":t=this.getQWERTY();break;case"fr":t=this.getAZERTY();break;case"bp":t=this.getBEPO();break;default:return console.log("Invalid keyboard layout. Switching to English as default."),void(t=this.getQWERTY())}return t}},pt={getAZERTY:function(){return Object.freeze({arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:90,leftHandLeft:81,leftHandDown:83,leftHandRight:68,leftHandNorthWest:65,leftHandNorthEast:69,leftHandNorthEast2:82,leftHandEast2:70,leftHandSouthWest:87,leftHandSouth:88,leftHandSouthEast:67,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:73,rightHandDown:75,rightHandLeft:74,rightHandLeft2:72,rightHandRight:76,rightHandRight2:77,rightHandSouth:190,rightHandNorthWest:85,rightHandNorthWest2:89,rightHandNorthEast:79,rightHandNorthEast2:80,rightHandSouthWest:188,rightHandSouthWest2:78,rightHandSouthWest3:66,rightHandSouthEast:191,rightHandSouthEast2:223})}},mt={getQWERTY:function(){return Object.freeze({arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:87,leftHandLeft:65,leftHandDown:83,leftHandRight:68,leftHandNorthWest:81,leftHandNorthEast:69,leftHandNorthEast2:82,leftHandEast2:70,leftHandSouthWest:90,leftHandSouth:88,leftHandSouthEast:67,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:73,rightHandDown:75,rightHandLeft:74,rightHandLeft2:72,rightHandRight:76,rightHandRight2:186,rightHandSouth:188,rightHandNorthWest:85,rightHandNorthWest2:89,rightHandNorthEast:79,rightHandNorthEast2:80,rightHandSouthWest:77,rightHandSouthWest2:78,rightHandSouthWest3:66,rightHandSouthEast:190,rightHandSouthEast2:191})}},ft={getBEPO:function(){return Object.freeze({arrowUp:38,arrowDown:40,arrowRight:39,arrowLeft:37,leftHandUp:186,leftHandLeft:65,leftHandDown:85,leftHandRight:73,leftHandNorthWest:66,leftHandNorthEast:80,leftHandNorthEast2:79,leftHandEast2:69,leftHandSouthWest:221,leftHandSouth:89,leftHandSouthEast:88,alt:18,shift:16,control:17,tab:9,escape:27,space:32,backspace:8,enter:13,pageUp:33,pageDown:34,one:49,two:50,three:51,four:52,five:53,six:54,seven:55,eight:56,nine:57,padOne:97,padTwo:98,padThree:99,padFour:100,padFive:101,padSix:102,padSeven:103,padEight:104,padNine:105,padOneAlt:35,padTwoAlt:40,padThreeAlt:34,padFourAlt:37,padFiveAlt:12,padSixAlt:39,padSevenAlt:36,padEightAlt:38,padNineAlt:33,leftHandNorthEast3:84,leftHandEast3:71,leftHandSouthEast3:86,rightHandUp:68,rightHandDown:83,rightHandLeft:84,rightHandLeft2:67,rightHandRight:82,rightHandRight2:78,rightHandSouth:71,rightHandNorthWest:86,rightHandNorthWest2:219,rightHandNorthEast:76,rightHandNorthEast2:74,rightHandSouthWest:81,rightHandSouthWest2:192,rightHandSouthWest3:75,rightHandSouthEast:72,rightHandSouthEast2:70})}},gt={setupCustomLayout:function(e){if(e&&2===e.length){var t=this.keyControls,n=e[0],i=e[1];if(t.hasOwnProperty(n)){for(var a in t)if(a!==n&&t[a]===i)return t[a]=t[n],void(t[n]=i);t[n]=i}else console.log("Binding ".concat(e," not supported."))}else console.log("Binding ".concat(e," not supported."))}},vt={setupKeyboard:function(){this.settings.language=window.navigator.userLanguage||window.navigator.language||"en-US",this.settings.language="en","fr-FR"!==navigator.language&&"fr"!==navigator.language||(this.settings.language="fr"),this.keyControls=this.getKeyControls(this.settings.language)},startKeyboardListeners:function(){this.isTouch&&console.warn("[Keyboard] requested keyboard listeners on a touch device."),this.registerKeyDown(),this.registerKeyUp()},stopKeyboardListeners:function(){this.stopKeyboardInteraction(),this.unregisterKeyDown(),this.unregisterKeyUp()},changeLayout:function(e,t,n){switch(this.stopKeyboardListeners(),e){case"fr":case"en":case"en-US":case"en-GB":case"bp":this.keyControls=this.getKeyControls(e);break;case"custom":default:this.setupCustomLayout(n)}t||this.startKeyboardListeners()}};a(vt,{registerKeyDown:function(){var e=this,t=this.app;l()(window).keydown((function(n){if(n.preventDefault(),n.keyCode&&"ingame"===t.getState()){var i=e.keyControls,a=t.model.frontend,o=t.engine.graphics;switch(n.keyCode){case i.arrowUp:case i.leftHandUp:a.triggerEvent("m","f");break;case i.arrowRight:case i.leftHandRight:a.triggerEvent("m","r");break;case i.arrowLeft:case i.leftHandLeft:a.triggerEvent("m","l");break;case i.arrowDown:case i.leftHandDown:a.triggerEvent("m","b");break;case i.shift:a.triggerEvent("m","run");break;case i.control:a.triggerEvent("m","d");break;case i.space:a.triggerEvent("m","u");break;case i.leftHandEast2:a.triggerChange("camera",["toggle"]);break;case i.leftHandNorthEast2:break;case i.pageUp:a.triggerChange("interaction",["itemSelect",1]);break;case i.pageDown:a.triggerChange("interaction",["itemSelect",-1]);break;case i.leftHandEast3:a.triggerEvent("a","g");break;case i.leftHandNorthWest:break;case i.padFour:o.cameraManager.addCameraRotationEvent(10,0,0,0,100);break;case i.padSix:o.cameraManager.addCameraRotationEvent(-10,0,0,0,100);break;case i.padFive:o.cameraManager.addCameraRotationEvent(0,10,0,0,100);break;case i.padEight:o.cameraManager.addCameraRotationEvent(0,-10,0,0,100);break;case i.enter:}}}))},stopKeyboardInteraction:function(){this.app.model.frontend.triggerEvent("m","xx")},registerKeyUp:function(){var e=this,t=this.app;l()(window).keyup((function(n){if(n.preventDefault(),n.keyCode&&"ingame"===t.getState()){var i=e.keyControls,a=t.model.frontend;switch(n.keyCode){case i.arrowUp:case i.leftHandUp:a.triggerEvent("m","fx");break;case i.arrowRight:case i.leftHandRight:a.triggerEvent("m","rx");break;case i.arrowLeft:case i.leftHandLeft:a.triggerEvent("m","lx");break;case i.arrowDown:case i.leftHandDown:a.triggerEvent("m","bx");break;case i.control:a.triggerEvent("m","dx");break;case i.shift:a.triggerEvent("m","runx");break;case i.space:a.triggerEvent("m","ux")}}}))},unregisterKeyDown:function(){l()(window).off("keydown")},unregisterKeyUp:function(){l()(window).off("keyup")}}),a(vt,ut),a(vt,pt),a(vt,ft),a(vt,mt),a(vt,gt);var yt={onMouseMove:function(e){if(this.threeControlsEnabled){var t=e.movementX,n=e.movementY,i=this.settings.mouseCameraSpeed;t*=i,n*=i,this.app.engine.graphics.cameraManager.addCameraRotationEvent(t,n,0,0)}},unregisterMouseMove:function(){this.omm?document.removeEventListener("mousemove",this.omm,!1):console.error("[TPS] Failed to get listener.")},registerMouseMove:function(){this.omm||(this.omm=this.onMouseMove.bind(this)),document.addEventListener("mousemove",this.omm,!0)}};function wt(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var n=[],i=!0,a=!1,o=void 0;try{for(var r,s=e[Symbol.iterator]();!(i=(r=s.next()).done)&&(n.push(r.value),!t||n.length!==t);i=!0);}catch(e){a=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(a)throw o}}return n}}(e,t)||function(e,t){if(e){if("string"==typeof e)return bt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?bt(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function bt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var xt={setupPointerLock:function(){var e=this.app;if("webkitPointerLockElement"in document||"mozPointerLockElement"in document||"pointerLockElement"in document){var t=this,n=document,i=document.body;"webkitPointerLockElement"in n?(this.pointerLockFunction||(this.pointerLockFunction=function(){t.pointerLockChanged(n.webkitRequestPointerLock===i)}),i.requestPointerLock=i.webkitRequestPointerLock,n.removeEventListener("webkitpointerlockchange",this.pointerLockFunction),n.addEventListener("webkitpointerlockchange",this.pointerLockFunction,!1)):"mozPointerLockElement"in n?(this.pointerLockFunction||(this.pointerLockFunction=function(){t.pointerLockChanged(n.mozPointerLockElement===i)}),i.requestPointerLock=i.mozRequestPointerLock,n.removeEventListener("mozpointerlockchange",this.pointerLockFunction),n.addEventListener("mozpointerlockchange",this.pointerLockFunction,!1)):"pointerLockElement"in n?(this.pointerLockFunction||(this.pointerLockFunction=function(){t.pointerLockChanged(n.pointerLockElement===i)}),n.removeEventListener("pointerlockchange",this.pointerLockFunction),n.addEventListener("pointerlockchange",this.pointerLockFunction,!1)):console.log("ERROR: POINTER LOCK NOT SUPPORTED."),l()(document).mousedown((function(t){"ingame"!==e.getState()||e.isFocused()||t.which}))}},exitPointerLock:function(){var e=document;"mozExitPointerLock"in e?e.mozExitPointerLock():"exitPointerLock"in e&&e.exitPointerLock()},requestPointerLockAgain:function(){document.body.requestPointerLock()},startPointerLockedControls:function(){var e=this.app.engine.controls;document.body.requestPointerLock(),e.startKeyboardListeners(),e.resetGamepadListeners(),e.startMouseListeners(),e.startWindowListeners()},pointerLockChanged:function(e){var t=this.app;t.engine.controls.threeControlsEnabled=e,e||(t.setState("settings"),t.setFocused(!1))}},Mt={setupMouse:function(){this.buttons=Object.freeze({left:1,middle:2,right:3}),this.setupPointerLock()},startMouseListeners:function(){this.isTouch&&console.warn("[Keyboard] requested keyboard listeners on a touch device."),this.registerMouseMove(),this.registerMouseDown(),this.registerMouseUp(),this.registerMouseWheel()},stopMouseListeners:function(){this.unregisterMouseMove(),this.unregisterMouseDown(),this.unregisterMouseUp(),this.unregisterMouseWheel()}};a(Mt,{registerMouseDown:function(){var e=this,t=this.app;l()(window).mousedown((function(n){if("ingame"===t.getState())if(t.engine.controls.threeControlsEnabled)switch(n.which){case e.buttons.left:e.onLeftMouseDown();break;case e.buttons.middle:e.onMiddleMouseDown();break;case e.buttons.right:e.onRightMouseDown()}else t.engine.controls.requestPointerLockAgain()}))},registerMouseUp:function(){var e=this,t=this.app;l()(window).mouseup((function(n){if("ingame"===t.getState())switch(n.which){case e.buttons.left:e.onLeftMouseUp();break;case e.buttons.middle:e.onMiddleMouseUp();break;case e.buttons.right:e.onRightMouseUp()}}))},getRaycastCoordinates:function(){var e=this.app.engine.graphics.cameraManager.performRaycast();if(!(e.length<=0)){for(var t=e[0],n=1;n<e.length;++n){var i=e[n];i.distance<t.distance&&(t=i)}var a=t.point,o=Math.round,r=Math.abs,s=a.x,l=a.y,c=a.z,h=r(r(o(s))-r(s)),d=r(r(o(l))-r(l)),u=r(r(o(c))-r(c)),p=h<1e-7;p&&(s=o(s));var m=d<1e-7;m&&(l=o(l));var f=u<1e-7;return f&&(c=o(c)),p+m+f!==1?(console.log("".concat(p,",").concat(m,",").concat(f)),void console.warn("[OnLeftMouse] Error: precision on intersection @addBlock.")):[p,m,f,s,l,c]}console.log("[Listeners] Nothing intersected.")},requestAddBlock:function(e){var t=this.app.model.frontend,n=this.app.engine.graphics,i=this.getRaycastCoordinates();if(i){var a,o,r,s,l,c,h=wt(i,6),d=h[0],u=h[1],p=h[2],m=h[3],f=h[4],g=h[5],v=Math.floor,y=n.getCameraCoordinates(),w=y.x,b=y.y,x=y.z,M=!0;d?(M=w>m)?(a=m,o=v(f),r=v(g)):w<m&&(a=m-1,o=v(f),r=v(g)):u?(M=b>f)?(a=v(m),o=f,r=v(g)):b<f&&(a=v(m),o=f-1,r=v(g)):p&&((M=x>g)?(a=v(m),o=v(f),r=g):x<g&&(a=v(m),o=v(f),r=g-1));var S=0;d?(s=M?a+1:a-1,l=o,c=r,S=Math.atan2(c+.5-x,l+.5-b)):u?(s=a,l=M?o+1:o-1,c=r,S=Math.atan2(c+.5-x,s+.5-w)):p&&(s=a,l=o,c=M?r+1:r-1,S=Math.atan2(l+.5-b,s+.5-w)),t.selfComponent.setAngleFromIntersectionPoint(S.toFixed(4)),t.triggerEvent("ray",["add",a,o,r,s,l,c,e])}},requestDelBlock:function(){var e=this.app.model.frontend,t=this.app.engine.graphics,n=this.getRaycastCoordinates();if(n){var i,a,o,r=wt(n,6),s=r[0],l=r[1],c=r[2],h=r[3],d=r[4],u=r[5],p=Math.floor,m=t.getCameraCoordinates(),f=m.x,g=m.y,v=m.z;s?f<h?(i=h,a=p(d),o=p(u)):f>h&&(i=h-1,a=p(d),o=p(u)):l?g<d?(i=p(h),a=d,o=p(u)):g>d&&(i=p(h),a=d-1,o=p(u)):c&&(v<u?(i=p(h),a=p(d),o=u):v>u&&(i=p(h),a=p(d),o=u-1)),e.triggerEvent("ray",["del",i,a,o])}},requestItemUse:function(e,t){var n=this.app.model.frontend,i=this.app.engine.graphics,a=i.getCameraCoordinates(),o=i.getModelForwardVector();n.triggerEvent("u",[a.x,a.y,a.z,o.x,o.y,o.z,e,t])},requestMainHandItemAction:function(e){var t=this.app.model.backend;e||t.selfModel.canTalkToCup&&t.entityModel.talkToHelperCup()},requestSecondaryHandItemAction:function(e){var t=this.app.model.backend;e||t.selfModel.canTalkToCup&&t.entityModel.untalkToHelperCup()},onLeftMouseUp:function(){this.requestMainHandItemAction(!0)},onRightMouseUp:function(){this.requestSecondaryHandItemAction(!0)},onMiddleMouseUp:function(){},onLeftMouseDown:function(){this.requestMainHandItemAction(!1)},onRightMouseDown:function(){this.requestSecondaryHandItemAction(!1)},onMiddleMouseDown:function(){},mouseWheelCallback:function(e){var t=this.app.model.frontend,n=-e.deltaY;t.triggerChange("interaction",["itemSelect",n])},registerMouseWheel:function(){this.omwh||(this.omwh=this.mouseWheelCallback.bind(this)),document.addEventListener("wheel",this.omwh)},unregisterMouseDown:function(){l()(window).off("mousedown")},unregisterMouseUp:function(){l()(window).off("mouseup")},unregisterMouseWheel:function(){document.removeEventListener("wheel",this.omwh)}}),a(Mt,yt),a(Mt,xt);var St={onLeftStickMove:function(e,t){this.touch.leftX=e,this.touch.leftY=t},onRightStickMove:function(e,t){this.touch.rightX=e,this.touch.rightY=t},onButtonChange:function(e,t){var n=this.app.model.frontend;switch(e){case"triangle":break;case"cross":this.requestMainHandItemAction(!t);break;case"circle":t?n.triggerEvent("m","u"):t||n.triggerEvent("m","ux");break;case"square":this.requestSecondaryHandItemAction(!t);break;case"dpadLeft":t&&n.triggerChange("interaction",["itemSelect",1]);break;case"dpadRight":t&&n.triggerChange("interaction",["itemSelect",-1]);break;case"dpadDown":n.triggerChange("camera",["toggle"]);break;case"dpadUp":t&&n.triggerChange("camera",["toggle"]);break;case"home":t&&this.touchControlsStatusChanged(!1)}},rotateCameraFromRightStickTouch:function(e){var t=this.app.engine.graphics,n=12*this.touch.rightX,i=16*this.touch.rightY;(Math.abs(n)>0||Math.abs(i)>0)&&t.cameraManager.addCameraRotationEvent(n,i,0,0,e)},movePlayerFromLeftStickTouch:function(){var e=this.app.model.frontend,t=this.touch.leftX,n=this.touch.leftY,i=this.touch.leftLast,a=[];if(0!==n&&0!==t){var o=Math.atan2(n,t),r=Math.PI/8;switch(!0){case o<-7*r||o>7*r:a.push("l");break;case o<-5*r:a.push("f","l");break;case o<-3*r:a.push("f");break;case o<-r:a.push("f","r");break;case o>5*r:a.push("b");break;case o>3*r:a.push("b","l");break;case o>r:a.push("b","r");break;default:a.push("r")}}a.length>2&&console.error("[Touch] too many events detected.");for(var s=0;s<a.length;++s){var l=a[s];i.indexOf(l)<0&&e.triggerEvent("m","".concat(l))}for(var c=0;c<i.length;++c){var h=i[c];a.indexOf(h)<0&&e.triggerEvent("m","".concat(h,"x"))}this.touch.leftLast=a}},Ct=function(e,t,n,i,a){var o=this;if(!(e instanceof HTMLElement))throw Error("[MobileWidgetControls] Expected element to be an HTMLElement.");var r=window.innerWidth,s=window.innerHeight,l=window.devicePixelRatio;this.element=e,this.leftStickMoveCallback=t,this.rightStickMoveCallback=n,this.buttonPressCallback=i,this.controllerType=a||"default",this.currentDPR=l,this.initialDPR=l,this.CANVAS_ID="widget-drawing-canvas",this.TIME_MS_TO_GET_TO_ORIGINAL_POSITION=60,this.minOpacity=.1,this.leftStick={},this.rightStick={},this.buttons=[],this.fingers=[];var c=document.getElementById(this.CANVAS_ID);c?this.canvas=c:(this.canvas=document.createElement("canvas"),this.canvas.setAttribute("id",this.CANVAS_ID),this.canvas.setAttribute("width","".concat(r)),this.canvas.setAttribute("height","".concat(s)),this.canvas.setAttribute("style","position: absolute; width: 100%; bottom: 0px; z-index: 999;"),this.element.appendChild(this.canvas));var h=function(e){return function(t){if("start"===e&&t.preventDefault(),"move"===e&&(t.preventDefault(),t.stopPropagation()),o.fingers=[],"cancel"!==e){for(var n=t.touches,i=0;i<n.length;++i){var a=n[i],r=a.clientX,s=a.clientY;o.fingers.push({x:r,y:s})}for(var l=t.changedTouches,c=0;c<l.length;++c){var h=l[c];"end"===e?o.updateUp(h):"move"===e?o.updateMove(h):"start"===e&&o.updateDown(h)}}else console.error("[MobileWidgetControls] Too many fingers or unsupported action.")}};this.touchStart=h("start"),this.touchMove=h("move"),this.touchEnd=h("end"),this.touchCancel=h("cancel"),this._resizeRequest=null,this.init()};Ct.prototype.stopWidgetListeners=function(){window.removeEventListener("resize",this.resize),window.removeEventListener("orientationchange",this.resize),this.canvas.removeEventListener("touchstart",this.touchStart),this.canvas.removeEventListener("touchmove",this.touchMove),this.canvas.removeEventListener("touchend",this.touchEnd),this.canvas.removeEventListener("touchcancel",this.touchCancel)},Ct.prototype.startWidgetListeners=function(){window.addEventListener("resize",this.resize),window.addEventListener("orientationchange",this.resize),this.canvas.addEventListener("touchstart",this.touchStart,!1),this.canvas.addEventListener("touchmove",this.touchMove,!1),this.canvas.addEventListener("touchend",this.touchEnd,!1),this.canvas.addEventListener("touchcancel",this.touchCancel,!1)},Ct.prototype.init=function(){var e=window.innerHeight,t=window.innerWidth;this.canvas.style.width="".concat(t,"px"),this.canvas.style.height="".concat(e,"px");var n=window.devicePixelRatio;n!==this.currentDPR&&(console.log("[MobileWidgetControls] Zoom triggered: updating DPR."),this.currentDPR=n);var i=n*t,a=n*e;this.canvas.width=i,this.canvas.height=a;var o=this.controllerType;this.initButtons(o,i,a),this.initSticks(o,i,a),this.draw()},Ct.PlaystationControllerButtons=[{name:"cross",from:"r",x:85,y:75,label:String.fromCharCode(10761),labelSize:30,diameter:30,labelOffset:2,theme:"gradient"},{name:"circle",from:"r",x:40,y:120,labelSize:23,diameter:30,label:String.fromCharCode(9711),labelOffset:2,theme:"gradient"},{name:"square",from:"r",x:130,y:120,labelSize:36,diameter:30,label:String.fromCharCode(9723),labelOffset:2,theme:"gradient"},{name:"triangle",from:"r",x:85,y:165,labelSize:35,diameter:30,label:String.fromCharCode(9651),labelOffset:0,theme:"gradient"},{name:"L1",from:"l",x:110,y:260,labelSize:30,diameter:30,label:"L1",labelOffset:3,theme:"gradient"},{name:"R1",from:"r",x:110,y:260,labelSize:30,diameter:30,label:"R1",labelOffset:3,theme:"gradient"},{name:"L2",from:"l",x:50,y:280,labelSize:30,diameter:30,label:"L2",labelOffset:3,theme:"gradient"},{name:"R2",from:"r",x:50,y:280,labelSize:30,diameter:30,label:"R2",labelOffset:3,theme:"gradient"},{name:"back"},{name:"forward"},{name:"stickLB"},{name:"stickRB"},{name:"dpadUp",from:"l",x:65,y:205,label:String.fromCharCode(8593),labelSize:20,diameter:23,labelOffset:0,theme:"gradient"},{name:"dpadDown",from:"l",x:65,y:135,label:String.fromCharCode(8595),labelSize:20,diameter:23,labelOffset:0,theme:"gradient"},{name:"dpadLeft",from:"l",x:30,y:170,label:String.fromCharCode(8592),labelSize:20,diameter:23,labelOffset:0,theme:"gradient"},{name:"dpadRight",from:"l",x:100,y:170,label:String.fromCharCode(8594),labelSize:20,diameter:23,labelOffset:0,theme:"gradient"},{name:"home",from:"l",x:25,y:25,label:String.fromCharCode(8617),labelSize:20,diameter:23,labelOffset:2,theme:"gradient"}],Ct.XBoxControllerButtons=[{name:"A",from:"r",diameter:25,x:80,y:35,label:"A",labelSize:20,labelOffset:2},{name:"B",from:"r",diameter:25,x:45,y:75,label:"B",labelSize:20,labelOffset:2},{name:"X",from:"r",diameter:25,x:115,y:75,label:"X",labelSize:20,labelOffset:2},{name:"Y",from:"r",diameter:25,x:80,y:115,label:"Y",labelSize:20,labelOffset:2},{name:"LB",from:"l",diameter:35,x:135,y:205,label:"LB",labelSize:20,labelOffset:2},{name:"RB",from:"r",diameter:35,x:130,y:180,label:"RB",labelSize:20,labelOffset:2},{name:"LT",from:"l",diameter:35,x:45,y:210,label:"LT",labelSize:20,labelOffset:2},{name:"RT",from:"r",diameter:35,x:45,y:200,label:"RT",labelSize:20,labelOffset:2},{name:"back"},{name:"forward"},{name:"stickLB"},{name:"stickRB"},{name:"dpadUp",from:"l",diameter:15,x:220,y:73,label:String.fromCharCode(8593),labelSize:20,labelOffset:0},{name:"dpadDown",from:"l",diameter:15,x:220,y:27,label:String.fromCharCode(8595),labelSize:20,labelOffset:0},{name:"dpadLeft",from:"l",diameter:15,x:197,y:50,label:String.fromCharCode(8592),labelSize:20,labelOffset:0},{name:"dpadRight",x:243,y:50,from:"l",diameter:15,label:String.fromCharCode(8594),labelSize:20,labelOffset:0},{name:"home"}],Ct.prototype.initButtons=function(e,t,n){var i;switch(e){case"playstation":i=Ct.PlaystationControllerButtons;break;case"xbox":i=Ct.XBoxControllerButtons;break;default:return}var a=this.initialDPR,o=[];for(var r in i)if(i.hasOwnProperty(r)){var s=i[r];if(s.x&&s.y&&s.diameter){s.name||console.error("[MobileWidgetControls] A button must have a name property.");var l={held:!1};l.id=s.name,l.modelOriginX="l"===s.from?a*s.x:t-a*s.x,l.modelOriginY=n-a*s.y,l.BUTTON_DIAMETER=a*s.diameter,l.style=s.theme,l.BUTTON_LABEL=s.label,l.BUTTON_LABEL_SIZE=a*s.labelSize,l.BUTTON_LABEL_OFFSET=a*s.labelOffset,o.push(l)}}this.buttons=o},Ct.prototype.notifyButtonChanged=function(e,t){this.buttonPressCallback&&this.buttonPressCallback(e.id,t)},Ct.prototype.updateButtonModelHold=function(e,t,n,i){for(var a=!1,o=0,r=n.length;o<r;++o){var s=n[o];if(!(this.distanceToObjectCenter(e,t,s)>s.BUTTON_DIAMETER)){a=!0,s.held!==i&&(s.held=i,this.notifyButtonChanged(s,i));break}}return a},Ct.prototype.updateButtonModelMove=function(e,t,n){for(var i=!1,a=0,o=n.length;a<o;++a){var r=n[a];if(r.held&&!(this.distanceToObjectCenter(e,t,r)<r.BUTTON_DIAMETER)){for(var s=!1,l=this.fingers,c=this.currentDPR,h=0;h<l.length;++h){var d=l[h];if(this.distanceToObjectCenter(c*d.x,c*d.y,r)<r.BUTTON_DIAMETER){s=!0;break}}s||(i=!0,r.held=!1,this.notifyButtonChanged(r,!1))}}return i},Ct.prototype.drawButton=function(e,t){e.beginPath(),e.globalAlpha=this.minOpacity+.2;var n=t.modelOriginX,i=t.modelOriginY;if(e.arc(n,i,t.BUTTON_DIAMETER,0,2*Math.PI),"gradient"===t.style){var a=e.createRadialGradient(n,i,2,n,i,t.BUTTON_DIAMETER);a.addColorStop(0,t.held?"silver":"black"),a.addColorStop(.7,t.held?"silver":"black"),a.addColorStop(.9,"silver"),a.addColorStop(1,"silver"),e.fillStyle=a}else e.fillStyle=t.held?"#222222":"black";e.fill(),"gradient"!==t.style&&(e.lineWidth=1,e.strokeStyle="white",e.stroke()),e.closePath(),e.beginPath(),e.font="".concat(t.BUTTON_LABEL_SIZE,"px Arial"),e.fillStyle="white",e.textAlign="center",e.textBaseline="middle",e.globalAlpha=this.minOpacity+.3,e.fillText(t.BUTTON_LABEL,n,i+(t.BUTTON_LABEL_OFFSET||0)),e.closePath()},Ct.DefaultSticks=[{name:"left",from:"l",x:100,y:120,head:25,base:70,grab:150,reach:55,label:String.fromCharCode(10021),labelSize:30,labelOffset:2,theme:"gradient"},{name:"right",from:"r",x:100,y:120,head:25,base:70,grab:150,reach:55,label:String.fromCharCode(10021),labelSize:30,labelOffset:2,theme:"gradient"}],Ct.PlaystationSticks=[{name:"left",from:"l",x:155,y:80,head:25,base:70,grab:140,reach:55,theme:"gradient"},{name:"right",from:"r",x:240,y:100,head:25,base:70,grab:140,reach:55,theme:"gradient"}],Ct.XBoxSticks=[{name:"left",from:"l",x:90,y:90,head:35,base:80,grab:150,reach:65,theme:"dark"},{name:"right",from:"r",x:240,y:80,head:30,base:70,grab:130,reach:55,theme:"dark"}],Ct.prototype.initStick=function(e,t,n,i){var a=this.initialDPR;n.x=n.y=n.lastHeldX=n.lastHeldY=n.timeStampReleased=0,n.modelOriginX="l"===i.from?a*i.x:e-a*i.x,n.modelOriginY=t-a*i.y,n.held=!1,n.needsUpdate=!0,n.STICK_HEAD_DIAMETER=a*i.head,n.STICK_BASE_DIAMETER=a*i.base,n.STICK_GRAB_DISTANCE=a*i.grab,n.STICK_REACH_DISTANCE=a*i.reach,n.STICK_LABEL=i.label,n.STICK_LABEL_SIZE=a*i.labelSize,n.STICK_LABEL_OFFSET=a*i.labelOffset,n.style=i.theme},Ct.prototype.initSticks=function(e,t,n){var i;switch(e){case"playstation":i=Ct.PlaystationSticks;break;case"xbox":i=Ct.XBoxSticks;break;default:i=Ct.DefaultSticks}this.initStick(t,n,this.leftStick,i[0]),this.initStick(t,n,this.rightStick,i[1])},Ct.prototype.notifyStickMoved=function(e,t,n){var i=e/n.STICK_REACH_DISTANCE,a=t/n.STICK_REACH_DISTANCE;n===this.leftStick?this.leftStickMoveCallback&&this.leftStickMoveCallback(i,a):n===this.rightStick&&this.rightStickMoveCallback&&this.rightStickMoveCallback(i,a)},Ct.prototype.updateStickModelFromMove=function(e,t,n,i){var a=e-i.modelOriginX,o=t-i.modelOriginY;n>i.STICK_REACH_DISTANCE&&(a*=i.STICK_REACH_DISTANCE/n,o*=i.STICK_REACH_DISTANCE/n),i.x=a,i.y=o,i.lastHeldX=a,i.lastHeldY=o,this.notifyStickMoved(a,o,i)},Ct.prototype.updateStickModelMove=function(e,t,n){var i=this.distanceToObjectCenter(e,t,n);if(i<n.STICK_GRAB_DISTANCE)n.needsUpdate=!0,n.held&&this.updateStickModelFromMove(e,t,i,n);else if(n.held){for(var a=!1,o=this.fingers,r=this.currentDPR,s=0;s<o.length;++s){var l=o[s];if(this.distanceToObjectCenter(r*l.x,r*l.y,n)<n.STICK_GRAB_DISTANCE){a=!0;break}}a||(n.held=!1,n.needsUpdate=!0,this.updateStickModelFromMove(e,t,i,n),n.timeStampReleased=this.getTimeInMilliseconds())}},Ct.prototype.updateStickModelHold=function(e,t,n,i){if(this.distanceToObjectCenter(e,t,n)<n.STICK_GRAB_DISTANCE){var a=n.held;n.held=i,a&&!i&&(n.timeStampReleased=this.getTimeInMilliseconds()),n.needsUpdate=!0}},Ct.prototype.updateMove=function(e){var t=this.currentDPR,n=e.clientX*t,i=e.clientY*t;this.updateButtonModelMove(n,i,this.buttons),this.updateStickModelMove(n,i,this.leftStick),this.updateStickModelMove(n,i,this.rightStick)},Ct.prototype.getClosestStick=function(e,t){return this.distanceToObjectCenter(e,t,this.leftStick)<=this.distanceToObjectCenter(e,t,this.rightStick)?this.leftStick:this.rightStick},Ct.prototype.updateDown=function(e){var t=this.currentDPR,n=e.clientX*t,i=e.clientY*t;if(!this.updateButtonModelHold(n,i,this.buttons,!0)){var a=this.getClosestStick(n,i);this.updateStickModelHold(n,i,a,!0),this.updateStickModelMove(n,i,a)}},Ct.prototype.updateUp=function(e){var t=this.currentDPR,n=t*e.clientX,i=t*e.clientY;this.updateButtonModelHold(n,i,this.buttons,!1),this.updateStickModelHold(n,i,this.leftStick,!1),this.updateStickModelHold(n,i,this.rightStick,!1)},Ct.prototype.drawStick=function(e,t){var n=t.modelOriginX,i=t.modelOriginY;if(e.beginPath(),e.globalAlpha=this.minOpacity,e.arc(n,i,t.STICK_BASE_DIAMETER,0,2*Math.PI),"gradient"===t.style){var a=e.createRadialGradient(n,i,2,n,i,t.STICK_BASE_DIAMETER);a.addColorStop(0,"gray"),a.addColorStop(.7,"gray"),a.addColorStop(.9,"silver"),a.addColorStop(1,"white"),e.fillStyle=a}else e.fillStyle="black";e.fill(),"gradient"!==t.style&&(e.lineWidth=1,e.strokeStyle="white",e.stroke()),e.closePath();var o=t.x,r=t.y;if(e.beginPath(),e.globalAlpha=this.minOpacity,e.arc(n+o,i+r,t.STICK_HEAD_DIAMETER,0,2*Math.PI),"gradient"===t.style){e.globalAlpha=this.minOpacity+.05;var s=e.createRadialGradient(n+o,i+r,2,n+o,i+r,t.STICK_HEAD_DIAMETER);s.addColorStop(0,"darkgray"),s.addColorStop(.7,"darkgray"),s.addColorStop(.9,"whitesmoke"),s.addColorStop(1,"white"),e.fillStyle=s}else e.fillStyle="black";e.fill(),"gradient"!==t.style&&(e.lineWidth=1,e.strokeStyle="white",e.stroke()),e.closePath(),t.STICK_LABEL&&t.STICK_LABEL_SIZE&&(e.beginPath(),e.font="".concat(t.STICK_LABEL_SIZE,"px Arial"),e.fillStyle="white",e.textAlign="center",e.textBaseline="middle",e.globalAlpha=this.minOpacity,e.fillText(t.STICK_LABEL,n+o,i+r+(t.STICK_LABEL_OFFSET||0)),e.closePath())},Ct.prototype.draw=function(){var e=this.canvas,t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),this.drawStick(t,this.leftStick),this.drawStick(t,this.rightStick);for(var n=this.buttons,i=0,a=n.length;i<a;++i)this.drawButton(t,n[i])},Ct.prototype.interpolateStick=function(e,t){var n=t-e.timeStampReleased,i=this.TIME_MS_TO_GET_TO_ORIGINAL_POSITION,a=this.smootherstep(0,i,n),o=e.modelOriginX,r=e.modelOriginY,s=(o+e.lastHeldX)*(1-a)+o*a-o,l=(r+e.lastHeldY)*(1-a)+r*a-r;e.x===e.y&&e.x===e.y&&(e.needsUpdate=!1),e.x=s,e.y=l,e.needsUpdate&&this.notifyStickMoved(s,l,e)},Ct.prototype.animate=function(){var e=this.getTimeInMilliseconds(),t=this.leftStick;!t.held&&t.needsUpdate&&this.interpolateStick(t,e);var n=this.rightStick;!n.held&&n.needsUpdate&&this.interpolateStick(n,e),this.draw()},Ct.prototype.resize=function(){var e=this;this._resizeRequest&&clearTimeout(this._resizeRequest),this._resizeRequest=setTimeout((function(){window.scrollTo(0,document.body.scrollHeight),e.init&&e.init()}),100)},Ct.prototype.getTimeInMilliseconds=function(){return performance.now()},Ct.prototype.distanceToObjectCenter=function(e,t,n){return Math.sqrt(Math.pow(e-n.modelOriginX,2)+Math.pow(t-n.modelOriginY,2))},Ct.prototype.clamp=function(e,t,n){return Math.min(n,Math.max(t,e))},Ct.prototype.smootherstep=function(e,t,n){var i=this.clamp((n-e)/(t-e),0,1);return i*i*i*(i*(6*i-15)+10)},Ct.prototype.makeDocumentUnselectable=function(){var e="mobile-widget-controls-style";if(!document.getElementById(e)){var t=document.getElementsByTagName("head")[0],n=document.createElement("style");n.id=e,n.innerText="\n            *.noselect {\n               -webkit-touch-callout: none; /* iOS Safari */\n                 -webkit-user-select: none; /* Safari */\n                  -khtml-user-select: none; /* Konqueror HTML */\n                    -moz-user-select: none; /* Firefox */\n                     -ms-user-select: none; /* Internet Explorer/Edge */\n                         user-select: none; /* Non-prefixed version, currently\n                                               supported by Chrome and Opera */\n            }\n        ",t.appendChild(n)}document.body.className+=" noselect"};var Tt={setupTouchWidget:function(){var e=document.getElementById("widget"),t=new Ct(e,this.onLeftStickMove.bind(this),this.onRightStickMove.bind(this),this.onButtonChange.bind(this),"playstation");return t.element.style.visibility="hidden",t},setupTouch:function(){},startTouchListeners:function(){if(this.isTouch){console.log("[Touch] Starting touch listeners.");var e=this.touch;e.leftX=e.leftY=0,e.rightX=e.rightY=0,e.rx=e.ry=0,e.leftLast=[];var t=this.touchWidgetControls;t.init(),t.element.style.visibility="visible",t.startWidgetListeners()}else console.error("[Touch] Trying to initialize touch on non-touch device.")},stopTouchListeners:function(){var e=this.touchWidgetControls;e.stopWidgetListeners(),e.element.style.visibility="hidden"},startTouchControls:function(){this.touchControlsEnabled=!0;var e=this.app.engine.controls;e.startTouchListeners(),e.startWindowListeners()},touchControlsStatusChanged:function(e){var t=this.app;t.engine.controls.touchControlsEnabled=e,e||(t.setState("settings"),t.setFocused(!1))},updateControlsTouchDevice:function(e){this.isTouch&&this.touchControlsEnabled&&(this.touchWidgetControls.animate(),this.rotateCameraFromRightStickTouch(e),this.movePlayerFromLeftStickTouch())}};a(Tt,St);var kt={setupWindowListeners:function(){var e,t;if(void 0!==document.hidden)t="hidden",e="visibilitychange";else if(void 0!==document.msHidden)t="msHidden",e="msvisibilitychange";else{if(void 0===document.webkitHidden)return console.log("Visibility change API not supported!"),void console.log("Rolling back - using Alt-Tab, Ctrl-Tab or the likes may result in focus-state bugs (rejoin to cancel if any).");t="webkitHidden",e="webkitvisibilitychange"}var n=function(){document[t]?this.isTouch?this.stopTouchListeners():this.stopKeyboardListeners():document[t]||(this.isTouch?this.stopTouchListeners():this.startKeyboardListeners())}.bind(this);this.windowListeners={start:function(){document.addEventListener(e,n,!1)},stop:function(){document.removeEventListener(e,n)}}},startWindowListeners:function(){this.windowListeners.start()},stopWindowListeners:function(){this.windowListeners.stop()}},Pt={rotateCameraFromRightStickGamepad:function(e,t,n){var i=this.app.engine.graphics,a=this.settings.stickCameraSpeed,o=e,r=t;o=Math.sign(e)*Math.pow(Math.abs(o),2),r=Math.sign(t)*Math.pow(Math.abs(r),2),o*=2*a,r*=1.1*a,(Math.abs(o)>0||Math.abs(r)>0)&&i.cameraManager.addCameraRotationEvent(o,r,0,0,n)},stopMovePlayerFromLeftStickGamepad:function(){this.app.model.frontend.triggerEvent("m","vecx")},movePlayerFromLeftStickGamepad:function(e,t){this.app.model.frontend.triggerEvent("m","vec",[e,-t])},goToHomeMenu:function(){this.exitPointerLock()},dPadUp:function(){this.threeControlsEnabled||this.app.state.navigate("up")},dPadDown:function(){this.threeControlsEnabled||this.app.state.navigate("down")},dPadRight:function(){this.threeControlsEnabled||this.app.state.navigate("right")},dPadLeft:function(){this.threeControlsEnabled||this.app.state.navigate("left")},circleButton:function(e){!this.threeControlsEnabled&&e?this.app.state.navigate("back"):this.app.model.frontend.triggerEvent("m",e?"u":"ux")},crossButton:function(e){if(this.threeControlsEnabled||!e){if(this.threeControlsEnabled&&e){var t=this.app.model.backend;t.selfModel.canTalkToCup&&t.entityModel.talkToHelperCup()}}else this.app.state.navigate("enter")},triangleButton:function(e){if(this.threeControlsEnabled&&e){var t=this.app.model.backend;t.selfModel.canTalkToCup&&t.entityModel.untalkToHelperCup()}}};function It(e){return(It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}var At=function(e){this.controlsEngine=e,this.gamepads={},this.numberOfGamepadsConnected=0,this.mainGamepad=null,this.mainGamepadState={buttons:new Array(18),axes:new Array(4)},this.initMainGamepadState(),this.oscillationDetection=[{last:0,lastDifferent:0},{last:0,lastDifferent:0},{last:0,lastDifferent:0},{last:0,lastDifferent:0}],this.started=!1};a(At.prototype,{initMainGamepadState:function(){var e=this.mainGamepadState;e.buttons.fill(!1),e.axes.fill(0)},gamepadConnected:function(e){r(this.numberOfGamepadsConnected<1,"[GamepadControls] Only one gamepad at a time is supported."),this.numberOfGamepadsConnected++,this.gamepads[e.index]=e,this.mainGamepad=e},gamepadDisconnected:function(e){this.numberOfGamepadsConnected--,this.numberOfGamepadsConnected<1||e.index===this.mainGamepad.index&&(this.initMainGamepadState(),this.mainGamepad=this.gamepads[Object.keys(e)[0]]),delete this.gamepads[e.index]},start:function(){this.started=!0},stop:function(){this.started=!1,this.initMainGamepadState()},refreshGamepads:function(e){if(this.started){var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];if(!(t.length<1)){var n=t[0];if(n){this.mainGamepad=n;var i=this.mainGamepadState.buttons,a=n.buttons,o=i.length;r(18===o,"[Gamepad] Did not expect ".concat(o," buttons."));for(var s=0;s<o;++s){var l=a[s],c=1===l,h=!1;"object"===It(l)&&(c=l.pressed,"touched"in l&&(h=l.touched),l=l.value),c!==i[s]?(i[s]=c,this.aButtonWasUpdated(s,l,c,h)):c&&this.aButtonWasHeld(s,l,c,h)}var d=this.mainGamepadState.axes,u=this.oscillationDetection,p=n.axes,m=p.length;r(4===m,"[Gamepad] Did not expect ".concat(m," axes."));for(var f=0;f<m/2;++f){var g=2*f,v=g+1,y=p[g],w=p[v];if(Math.abs(y)<.15&&(y=0),Math.abs(w)<.15&&(w=0),y!==d[g]||w!==d[v]||0!==y||0!==w){if(0===g){var b=u[g];0!==y&&b.lastDifferent===y?y=b.last:b.last!==y&&(b.lastDifferent=b.last,b.last=y);var x=u[v];0!==w&&x.lastDifferent===w?w=x.last:x.last!==w&&(x.lastDifferent=x.last,x.last=w)}var M=Math.sqrt(y*y+w*w);M>1&&(y/=M,w/=M),d[g]=y,d[v]=w,this.aStickWasHeldOrReleased(g,v,y,w,e)}}}}}},aButtonWasUpdated:function(e,t,n,i){var a=this.controlsEngine;switch(e){case 0:a.crossButton(n);break;case 1:a.circleButton(n);break;case 2:break;case 3:a.triangleButton(n);break;case 4:case 5:case 6:case 7:case 8:break;case 9:n&&a.goToHomeMenu();break;case 10:case 11:break;case 12:n&&a.dPadUp();break;case 13:n&&a.dPadDown();break;case 14:n&&a.dPadLeft();break;case 15:n&&a.dPadRight();break;case 16:n&&a.goToHomeMenu()}},aButtonWasHeld:function(e,t,n,i){},aStickWasHeldOrReleased:function(e,t,n,i,a){r(t===e+1&&(0===e||2===e),"[Controls] Unexpected stick state.");var o=this.controlsEngine;o.threeControlsEnabled&&(0===e?0===n&&0===i?o.stopMovePlayerFromLeftStickGamepad():o.movePlayerFromLeftStickGamepad(n,i):2===e&&(0===n&&0===i||o.rotateCameraFromRightStickGamepad(n,i,a)))},doVibration:function(e,t,n){var i=this.mainGamepad.vibrationActuator;r(!!i,"[Gamepad] Vibration actuator not found."),i&&i.playEffect("dual-rumble",{startDelay:0,duration:e||100,weakMagnitude:t||1,strongMagnitude:n||1})}});var Et={setupGamepad:function(){this.gamepadControls=new At(this),window.addEventListener("gamepadconnected",this.connectGamepad.bind(this)),window.addEventListener("gamepaddisconnected",this.disconnectGamepad.bind(this)),this.startGamepadListeners()},connectGamepad:function(e){this.gamepadControls.gamepadConnected(e.gamepad),this.app.engine.settings.gamepadActive=!0,"main"===this.app.getState()&&this.app.state.getState("main").updateGamepadStatus(),console.log("[Controls] Gamepad connected.")},disconnectGamepad:function(e){this.gamepadControls.gamepadDisconnected(e.gamepad),console.log("[Controls] Gamepad disconnected.");var t=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads?navigator.webkitGetGamepads():[];(t.length<1||!t[0])&&(this.app.engine.settings.gamepadActive=!1,"main"===this.app.getState()&&this.app.state.getState("main").updateGamepadStatus())},startGamepadListeners:function(){this.gamepadControls.start()},resetGamepadListeners:function(){this.stopMovePlayerFromLeftStickGamepad()},stopGamepadListeners:function(){console.error("[Gamepad] Stopping gamepad listeners."),this.gamepadControls.stop()},updateControlsGamepadDevice:function(e){this.gamepadControls.refreshGamepads(e)}};a(Et,Pt);var Ot=function(e){this.app=e,this.settings={mouseCameraSpeed:.125,maxMouseSpeed:.5,minMouseSpeed:.03125,stickCameraSpeed:2,maxStickSpeed:8,minStickSpeed:.5},this.threeControlsEnabled=!1,this.mouse={},this.keyControls={},this.setupGamepad(),this.touchControlsEnabled=!1,this.isTouch="ontouchstart"in window||navigator.msMaxTouchPoints>0,this.isTouch&&(console.log("[Controls] Touch device detected."),this.touch={leftX:0,leftY:0,rightX:0,rightY:0,rx:0,ry:0,leftLast:""},this.touchWidgetControls=this.setupTouchWidget()),this.isTouch||(this.settings.language=""),this._stamp=Date.now()};a(Ot.prototype,{run:function(){var e=this.app.engine.graphics;this.isTouch?this.setupTouch():(this.setupKeyboard(),this.setupMouse()),this.setupWindowListeners(),l()(window).resize(e.resize.bind(e))},stop:function(){this.stopListeners()},stopListeners:function(){this.isTouch?this.stopTouchListeners():(this.stopKeyboardListeners(),this.stopMouseListeners()),this.stopWindowListeners()},stamp:function(){return this._stamp=Date.now(),this._stamp},now:function(){return this._stamp},requestStartControls:function(){this.isTouch?this.startTouchControls():this.startPointerLockedControls()},updateControlsDevice:function(e){this.updateControlsGamepadDevice(e),this.updateControlsTouchDevice(e)}}),a(Ot.prototype,vt),a(Ot.prototype,Mt),a(Ot.prototype,Tt),a(Ot.prototype,Et),a(Ot.prototype,kt);var Lt=function(e){u.call(this,2),this.settingsModule=e};o(Lt,u),a(Lt.prototype,{getHTML:function(){var e=this.settingsModule.gamepadActive,t=this.activeItem,n=this.settingsModule.app.engine.audio.isMusicMute;return'\n            <div class="container">\n            <table class="table table border rounded noselect" style="width:100%">\n                <tr><td colspan="2" id="settings-audio-volume">\n                <div class="row mt-3" id="settings-inner-audio-volume">\n                    <div class="col-4"></div>\n                    <div id="volume-control-wrapper"\n                        class="input-group mb-1 center-block col-4 slider-container '.concat(this.hl(e,t,0),'">\n                        <div class="col-2" id="volume-status"><i class="fas fa-volume-mute fa-2x"></i></div>\n                        <div class="col-10 input-group-append flex-fill">\n                            <input type="range" min="0" max="100" value="0" class="slider"\n                                id="main-volume-controller">\n                        </div>\n                    </div>\n                </div>\n                </td></tr>\n\n                <tr>\n                <td>Musique</td>\n                <td>\n                    <label class="w3switch">\n                        <input type="checkbox" id="switch-music" ').concat(n?"":"checked",'>\n                        <span class="w3slider w3round"></span>\n                    </label>\n                </td>\n                </tr>\n\n                \x3c!-- <tr>--\x3e\n                \x3c!-- <td>Effets</td>--\x3e\n                \x3c!-- <td>--\x3e\n                \x3c!--     <label class="w3switch">--\x3e\n                \x3c!--         <input type="checkbox" id="switch-effects">--\x3e\n                \x3c!--         <span class="w3slider w3round"></span>--\x3e\n                \x3c!--     </label>--\x3e\n                \x3c!-- </td>--\x3e\n                \x3c!-- </tr>--\x3e\n\n                <tr id="return"><td colspan="2">Retour</td></tr>\n        ')+"\n            </table>\n            </div>"},hl:function(e,t,n){return e&&t===n?"gamepad-selected":""},listen:function(){this.listenReturn(),this.startVolumeController()},listenReturn:function(){var e=this.settingsModule;l()("#return").click((function(){e.switchToMenu(e.homeMenu)}))},unlisten:function(){l()("#return").off("click"),this.stopVolumeController()},startVolumeController:function(){var e=this.settingsModule.app.engine.audio,t=l()("#volume-status"),n=l()("#main-volume-controller"),i=Math.floor(100*e.getVolume());n.val(i),0===i||e.isMute()?t.html('<i class="fas fa-volume-mute fa-2x">'):t.html('<i class="fas fa-volume-up fa-2x">'),n.on("input change",(function(n){var i=parseInt(n.target.value,10);e.setVolume(i/100),0===i?t.html('<i class="fas fa-volume-mute fa-2x">'):t.html('<i class="fas fa-volume-up fa-2x">')})),n.change((function(){e.playText(" Cxy")})),t.click((function(){if(e.isMute()){var i=Math.floor(100*e.getVolume());n.val(i),t.html('<i class="fas fa-volume-up fa-2x">'),e.unMute()}else t.html('<i class="fas fa-volume-mute fa-2x">'),e.mute()})),l()("#switch-music").change((function(t){t.target.checked?e.unmuteMusic():e.muteMusic()}))},stopVolumeController:function(){l()("#volume-status").off("click"),l()("#main-volume-controller").off("input change"),l()("#switch-music").off("change")},selectItems:function(){return[l()("#volume-control-wrapper"),l()("#return")]},navigate:function(e){var t=this.settingsModule.app.engine.audio;if(this.super.navigate.call(this,e),0===this.activeItem){var n=l()("#main-volume-controller"),i=l()("#volume-status");if("right"===e||"left"===e){var a=t.getVolume(),o="right"===e?Math.min(a+.05,1):Math.max(a-.05,0);t.setVolume(o),0===o?i.html('<i class="fas fa-volume-mute fa-2x">'):(i.html('<i class="fas fa-volume-up fa-2x">'),t.playText(" Cxy")),n.val(Math.floor(100*o))}else if("enter"===e)if(t.isMute()){var r=Math.floor(100*t.getVolume());n.val(r),i.html('<i class="fas fa-volume-up fa-2x">'),t.unMute()}else i.html('<i class="fas fa-volume-mute fa-2x">'),t.mute()}}});var _t=function(e){u.call(this,3),this.settingsModule=e};o(_t,u),a(_t.prototype,{getHTML:function(){var e=this.settingsModule.controlsSettings,t=this.settingsModule.gamepadActive,n=this.activeItem,i='\n            <div class="container">\n            <table class="table table border rounded noselect" style="width:100%">\n        ';return i+='\n            <tr id="mouse-speed-wrapper"\n                class="camspeed-control-wrapper '.concat(this.hl(t,n,0),'"><td>Sensibilité (Souris)</td>\n            <td>\n            <div class="row mt-3">\n                <div class="input-group mb-1 center-block col-12 slider-container">\n                    <div class="col-12 input-group-append flex-fill">\n                        <input type="range" min="0" max="100" value="50" class="slider"\n                            id="mouse-speed-controller">\n                    </div>\n                </div>\n            </div>\n            </td></tr>\n\n            <tr id="gamepad-speed-wrapper"\n                class="camspeed-control-wrapper ').concat(this.hl(t,n,1),'"><td>Sensibilité (Manette)</td>\n            <td>\n            <div class="row mt-3">\n                <div class="camspeed-control-wrapper\n                        input-group mb-1 center-block col-12 slider-container">\n                    <div class="col-12 input-group-append flex-fill">\n                        <input type="range" min="0" max="100" value="50" class="slider"\n                            id="gamepad-speed-controller">\n                    </div>\n                </div>\n            </div>\n            </td></tr>\n        '),e.hasOwnProperty("language")&&(i+="<tr><td>Disposition Clavier</td><td>".concat('\n                <select id="language" class="form-control">\n                    \x3c!-- <option value="default">Disposition clavier</option>--\x3e\n                    <option value="fr">AZERTY</option>\n                    <option value="en">QWERTY</option>\n                    <option value="bp">BÉPO</option>\n                </select>',"</td></tr>")),i+'\n            <tr id="return"><td colspan="2">Retour</td></tr>\n            </table>\n            </div>'},hl:function(e,t,n){return e&&t===n?"gamepad-selected":""},listen:function(){var e=this.settingsModule,t=e.app.engine.controls.settings,n=l()("#mouse-speed-controller"),i=l()("#gamepad-speed-controller"),a=t.mouseCameraSpeed,o=t.maxMouseSpeed,r=t.minMouseSpeed,s=t.stickCameraSpeed,c=t.maxStickSpeed,h=t.minStickSpeed,d=(s-h)/(c-h);d=Math.log(1+16*d)/Math.log(17),i.val(Math.floor(100*d)),d=(a-r)/(o-r),d=Math.log(1+16*d)/Math.log(17),n.val(Math.floor(100*d)),n.on("input change",(function(e){var n=parseInt(e.target.value,10),i=n/100;n=r*Math.pow(2,i/.25),t.mouseCameraSpeed=n})),i.on("input change",(function(e){var n=parseInt(e.target.value,10),i=n/100;n=h*Math.pow(2,i/.25),t.stickCameraSpeed=n}));var u=e.controlsEngine;if(e.controlsSettings.hasOwnProperty("language")){var p=l()("#language");p.change((function(){var e=p.find("option:selected").val();u.changeLayout(e,!0)}))}this.listenReturn()},listenReturn:function(){var e=this.settingsModule;l()("#return").click((function(){e.switchToMenu(e.homeMenu)}))},unlisten:function(){this.settingsModule.controlsSettings.hasOwnProperty("language")&&l()("#language").off("change"),l()("#return").off("click"),l()("#mouse-speed-controller").off("input change"),l()("#gamepad-speed-controller").off("input change")},selectItems:function(){return[l()("#mouse-speed-wrapper"),l()("#gamepad-speed-wrapper"),l()("#return")]},navigate:function(e){this.super.navigate.call(this,e);var t=this.settingsModule.app.engine.controls.settings;if(0===this.activeItem){var n=l()("#mouse-speed-controller");if("right"===e||"left"===e){var i=t.mouseCameraSpeed,a=t.maxMouseSpeed,o=t.minMouseSpeed,r="right"===e?Math.min(1.1*i,a):Math.max(i/1.1,o);t.mouseCameraSpeed=r;var s=(r-o)/(a-o);s=Math.log(1+16*s)/Math.log(17),n.val(Math.floor(100*s))}}else if(1===this.activeItem){var c=l()("#gamepad-speed-controller");if("right"===e||"left"===e){var h=t.stickCameraSpeed,d=t.maxStickSpeed,u=t.minStickSpeed,p="right"===e?Math.min(1.1*h,d):Math.max(h/1.1,u);t.stickCameraSpeed=p;var m=(p-u)/(d-u);m=Math.log(1+16*m)/Math.log(17),c.val(Math.floor(100*m))}}}});var Rt=function(e){u.call(this,1),this.settingsModule=e};o(Rt,u),a(Rt.prototype,{getHTML:function(){var e=this.settingsModule.graphicsSettings,t='\n            <div class="container">\n            <table class="table table border rounded noselect" style="width:100%"\n            ';for(var n in e)t+="<tr><td>".concat(e[n],"</td></tr>");return t+'\n            <tr id="return"><td>Retour</td></tr>\n            </table>\n            </div>'},listen:function(){this.listenReturn()},listenReturn:function(){var e=this.settingsModule;l()("#return").click((function(){e.switchToMenu(e.homeMenu)}))},unlisten:function(){l()("#return").off("click")},selectItems:function(){return[]},navigate:function(e){this.super.navigate.call(this,e)}});var Dt=function(e){u.call(this,4),this.settingsModule=e};o(Dt,u),a(Dt.prototype,{getHTML:function(){var e=this.settingsModule.gamepadActive,t=this.activeItem;return'\n            <div class="container">\n                <table class="table border rounded noselect" style="width:100%">\n                <tr '.concat(this.hl(e,t,0),' id="home"><td>Retour à l’Écran Titre</td></tr>\n                \x3c!-- <tr ').concat(this.hl(e,t,1),' id="graphics"><td>Graphismes</td></tr>--\x3e\n                <tr ').concat(this.hl(e,t,1),' id="gameplay"><td>Gameplay</td></tr>\n                <tr ').concat(this.hl(e,t,2),' id="audio"><td>Audio</td></tr>\n                <tr ').concat(this.hl(e,t,3),' id="return"><td>Retour au Jeu</td></tr>\n                </table>\n            </div>\n        ')},hl:function(e,t,n){return e&&t===n?'class="gamepad-selected"':""},listen:function(){var e=this,t=this.settingsModule,n=t.app.engine.audio,i=l()("#home");i.click((function(){return t.goBackToTitleScreen()})),i.mouseenter((function(){return n.playMenuSound()}));var a=l()("#gameplay");a.click((function(){return t.switchToMenu(t.controlsMenu)})),a.mouseenter((function(){return n.playMenuSound()}));var o=l()("#audio");o.click((function(){return t.switchToMenu(t.audioMenu)})),o.mouseenter((function(){return n.playMenuSound()}));var r=l()("#return");r.click((function(){e.unlisten(),t.stateManager.setState("ingame"),t.controlsEngine.requestStartControls(),t.app.setFocused(!0)})),r.mouseenter((function(){return n.playMenuSound()}))},unlisten:function(){var e=l()("#home"),t=l()("#gameplay"),n=l()("#audio"),i=l()("#return");l()(window).off("keydown"),t.off("click"),t.off("mouseenter"),n.off("click"),n.off("mouseenter"),e.off("click"),e.off("mouseenter"),i.off("click"),i.off("mouseenter")},navigate:function(e){this.super.navigate.call(this,e),("up"===e||"down"===e)&&this.settingsModule.app.engine.audio.playMenuSound()},selectItems:function(){return[l()("#home"),l()("#gameplay"),l()("#audio"),l()("#return")]}});var zt=function(e){this.app=e,this.homeMenu=new Dt(this),this.audioMenu=new Lt(this),this.controlsMenu=new _t(this),this.graphicsMenu=new Rt(this),this.activeMenu=null,this.gamepadActive=!1};a(zt.prototype,{run:function(){var e=this.app;this.controlsEngine=e.engine.controls,this.stateManager=e.state,this.graphicsSettings=e.engine.graphics.settings,this.controlsSettings=e.engine.controls.settings,this.audioSettings=e.engine.audio.settings,this.activeMenu&&this.activeMenu.unlisten(),this.activeMenu=this.homeMenu,l()("#announce").empty().removeClass().addClass("settings").append(this.activeMenu.getHTML()).center().show(),this.activeMenu.listen()},stop:function(){r(this.activeMenu===this.homeMenu,"[Settings/Menuing] Should be able to return to title from home menu only.");var e=this.activeMenu;return e&&e.unlisten(),this.activeMenu=null,new Promise((function(e){l()("#announce").empty().removeClass("settings"),e()}))},goBackToTitleScreen:function(){var e=this.app;e.stopGame(),e.setState("main")},switchToMenu:function(e){r(this.activeMenu!==e,"[Settings/Menuing] Trying to switch to the same menu."),r(e===this.homeMenu||e===this.audioMenu||e===this.controlsMenu||e===this.graphicsMenu,"[Settings/Menuing] Invalid menu."),this.activeMenu.unlisten(),this.activeMenu=e,l()("#announce").empty().append(this.activeMenu.getHTML()),this.activeMenu.listen()},navigate:function(e){var t=this.activeMenu;t?t.navigate(e):console.log("[Settings/Menuing] No active menu found.")}});var Ft=function(e){this.level=e,this.levelState=null,this.playerState=null};a(Ft.prototype,{getLevel:function(){return this.level},copyLevelState:function(){},copyPlayerState:function(){}});var Bt={refreshIngame:function(){var e=this.playerState,t=e.getLevel();if(t){var n=e.getProgressInLevel(),i=t.getScenario()[n];if(i){var a=this.app.model.backend,o=this.app.engine.graphics.rendererManager;switch(i.type){case"end":o.isTransitioning||i.performWhenConditionMet(a,this);break;case"splash":var r=i.titles,s=e.getProgressInCurrentTask();if(e.getProgressInCurrentTask()>=r.length){o.isTransitioning||(i.performWhenConditionMet(a,this),e.resetProgressInCurrentTask(),e.incrementProgressInLevel());break}var l=r[s],c=this.ingameTimeSinceLastEvent,h=i.fadeInTitle,d=i.keepTitle,u=i.fadeOutTitle;c<h?(o.setInTitleScene(!0),o.setTitleSceneText(l),o.setTitleOpacity(c/h)):c<h+d?(o.setInTitleScene(!0),o.setTitleSceneText(l),o.setTitleOpacity(1)):c<h+u+d?(o.setInTitleScene(!0),o.setTitleSceneText(l),o.setTitleOpacity(1-(c-h-d)/u)):(this.ingameTimeSinceLastEvent=0,e.incrementProgressInCurrentTask(),e.getProgressInCurrentTask()>=r.length&&(o.isTransitioning||(o.setTransitionDuration(i.fadeOutSplash),o.startSceneTransition(!1))));break;case"event":i.checkCondition(a,this)&&i.performWhenConditionMet(a,this);break;default:console.log("[UX] Task not recognized.")}}else console.error("[UX] Current task not found.")}else console.log("[UX] Player level not found")},playBigValidateFeedback:function(){var e=this.app.engine;if(e.audio.playValidateSound(),e.settings.gamepadActive){var t=e.controls.gamepadControls;t&&t.doVibration(200,1,1)}},playLittleValidateFeedback:function(){var e=this.app.engine;if(e.settings.gamepadActive){var t=e.controls.gamepadControls;t&&t.doVibration(100,1,1)}}},Wt=function(){this.level=null,this.unlockedLevels=0,this.progressInLevel=0,this.progressInCurrentTask=0};a(Wt.prototype,{setLevel:function(e){this.level=e;var t=e.getID();this.unlockedLevels=Math.max(t,this.unlockedLevels),this.progressInLevel=0,this.progressInCurrentTask=0},getLevel:function(){return this.level},getFarthestLevel:function(){return this.unlockedLevels},getProgressInLevel:function(){return this.progressInLevel},incrementProgressInLevel:function(){this.progressInLevel++},resetProgressInLevel:function(){this.progressInLevel=0},getProgressInCurrentTask:function(){return this.progressInCurrentTask},incrementProgressInCurrentTask:function(){this.progressInCurrentTask++},resetProgressInCurrentTask:function(){this.progressInCurrentTask=0}});var jt={setupClocks:function(){this.paused=!0,this.timeAppStarted=Date.now(),this.timeNow=this.timeAppStarted,this.timeOfLastIngameFrame=0,this.elapsedSinceLastIngameFrame=0,this.totalIngameTime=0,this.ingameTimeSinceLastEvent=0,this.resetTimeSinceLastEvent()},refreshClocks:function(){if(this.timeNow=Date.now(),!this.paused){this.timeOfLastIngameFrame?this.elapsedSinceLastIngameFrame=this.timeNow-this.timeOfLastIngameFrame:this.timeOfLastIngameFrame=0,this.timeOfLastIngameFrame=this.timeNow;var e=this.elapsedSinceLastIngameFrame;this.totalIngameTime+=e,this.ingameTimeSinceLastEvent+=e,this.refreshIngame()}},resetTimeSinceLastEvent:function(){this.ingameTimeSinceLastEvent=0},setGamePaused:function(e){this.paused=e,this.timeOfLastIngameFrame=e?0:Date.now()},isGamePaused:function(){return this.paused},getElapsed:function(){return this.elapsedSinceLastIngameFrame}},Nt=function(e){this.app=e,this.settings={},this.lastCheckpoint=null,this.playerState=new Wt,this.unlockedDialogues=new Map,this.setupClocks()};a(Nt.prototype,{refresh:function(){this.refreshClocks()},startNewGame:function(){var e=this.playerState,t=this.app.model.levels.getLevel(0);e.setLevel(t),e.resetProgressInLevel(),e.resetProgressInCurrentTask(),this.resetTimeSinceLastEvent(),this.joinLevel(t)},configureLevel:function(e){var t=this.app;return"ingame"!==t.getState()&&"preingame"!==t.getState()||(console.warn("[UX] A game is already running. Cleaning up!"),t.stopGame()),e?(t.configureGame(e),!0):(console.error("[UX] Undefined level."),t.setState("main"),!1)},joinLevel:function(e){if(this.configureLevel(e)){var t=this.playerState;t.setLevel(e),t.resetProgressInLevel(),t.resetProgressInCurrentTask(),this.resetTimeSinceLastEvent(),this.app.runGame()}},saveCheckpoint:function(){var e=this.app;return this.lastCheckpoint||(this.lastCheckpoint=new Ft(e.model.levels.getLevel(0))),this.lastCheckpoint},joinFarthestCheckpoint:function(){var e=(this.lastCheckpoint||this.saveCheckpoint()).getLevel();this.configureLevel(e)&&this.app.runGame()},informPlayer:function(e){console.log("[UX] Message: '".concat(e,"'"))},directJoinLevel:function(e){var t=this.app;t.model.backend.cleanupFullModel(),t.model.frontend.cleanupFullModel(),t.engine.graphics.cleanupFullGraphics(),t.engine.physics.cleanupFullPhysics(),t.model.frontend.init(),t.model.backend.init(e)},validateLevel:function(){var e=this.app.model.levels.getLevels(),t=this.playerState,n=e[t.getLevel().getID()+1];n?(this.resetTimeSinceLastEvent(),t.setLevel(n),this.directJoinLevel(n)):(this.informPlayer("You won!"),this.setGamePaused(!0))},validateTask:function(){var e=this.playerState;e.resetProgressInCurrentTask(),e.incrementProgressInLevel(),this.resetTimeSinceLastEvent(),e.getLevel().getScenario()[e.getProgressInLevel()]||(console.error("[UX/ValidateTask] ValidateTask called instead of ValidateLevel."),this.validateLevel())},updateDialogueAdvancement:function(e,t){var n=this.unlockedDialogues,i=n.get(e);i?n.set(e,Math.max(t,i)):n.set(e,t)}}),a(Nt.prototype,Bt),a(Nt.prototype,jt);var Ut=function(e,t){this.title=e,this.levelID=t};a(Ut.prototype,{getTitle:function(){return this.title},getID:function(){return this.levelID},getTerrain:function(){console.warn("[Model/Level] Abstract level function.")},getObjects:function(){console.warn("[Model/Level] Abstract level function.")},getPlayer:function(){console.warn("[Model/Level] Abstract level function.")},getScenario:function(){console.warn("[Model/Level] Abstract level function.")},startupObjects:function(){console.warn("[Model/Level] Abstract level function.")}});var Vt=100,Ht=function(e,t,n,i,a){this.isAnalytic=!1,this.isHeightBuffer=!1,this.isTrimeshMap=!0,this.isWater=a,this.isAxisAligned=!1,this.x=e,this.y=t,this.extentX=Vt,this.extentY=Vt,this.nbVerticesX=n,this.nbVerticesY=i,this.data=null,this.elementSizeX=this.extentX/(n-1),this.elementSizeY=this.extentY/(i-1),this.localTransform=new w.yGw,this._normal=new w.Pa4};a(Ht.prototype,{setData:function(e){this.data=e,this.isTrimeshMap&&this.localTransform.copy(e.matrixWorld)},getData:function(){if(!this.data)throw Error("[Terrain] Uninitialized height data.");return this.data},getNormal:function(e,t){if(!this.isTrimeshMap)throw Error("[Terrain] Unsupported heightmap");var n=this.getData(),i=this.nbVerticesX,a=this.nbVerticesY,o=Math.floor(e/this.extentX*(i-1)),r=Math.floor(t/this.extentY*(a-1)),s=n.geometry.attributes.normal.array,l=3*(o+i*r);return this._normal.set(s[l],s[l+1],s[l+2]),this._normal},collideTo:function(){}});var Gt={generateTerrain:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!1,color:"#161616",shininess:.1}),this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:e}]}}};function qt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Yt={generateWalls:function(){var e=17.5;return[{type:"box",image:!0,wall:!0,position:[0,e,4.9],rotation:[0,0,0],w:35,h:2,d:10},{type:"box",image:!0,wall:!0,position:[0,-e,4.9],rotation:[0,0,0],w:35,h:2,d:10},{type:"box",image:!0,wall:!0,position:[e,0,4.9],rotation:[0,0,0],w:2,h:35,d:10},{type:"box",image:!0,wall:!0,position:[-e,0,4.9],rotation:[0,0,0],w:2,h:35,d:10}]},generateStaticObjects:function(){var e,t=[],n=this.generateWalls();t.push.apply(t,function(e){if(Array.isArray(e))return qt(e)}(e=n)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return qt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?qt(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}());t.push({type:"box",image:!0,wall:!0,position:[-2,-14.5,4.9],rotation:[0,0,0],w:35,h:1,d:10}),t.push.apply(t,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,0,0],rotation:[0,0,0],w:1,h:1,d:.05},{type:"box",reflection:!0,image:!0,stone:!0,position:[-10,10,0],rotation:[0,0,0],w:1,h:1,d:.5},{type:"box",image:!0,stone:!0,position:[-3,10,0],rotation:[0,0,0],w:1,h:1,d:1},{type:"box",image:!0,stone:!0,position:[3,10,0],rotation:[0,0,0],w:1,h:1,d:2},{type:"box",image:!0,stone:!0,position:[10,10,0],rotation:[0,0,0],w:1,h:1,d:4}]),t.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=t}},Xt=function(e,t){Ut.call(this,e,t),this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.player={position:[0,-10,1.5],rotation:[0,0,Math.PI]},this.textSequence=[{direct:!0,text:""},{direct:!0,text:"Oh, salut!"},{direct:!0,text:"Tu dois être le joueur…"},{direct:!0,text:"Et je suppose que je suis l’objectif ?"},{direct:!0,text:"Tu vas bien ?"},{direct:!0,text:"…"},{timeToWaitBefore:2e3,text:"Bon."},{direct:!0,timeToWaitBefore:2e3,text:"Je me demande à quoi servent ces machins gris derrière."},{timeToWaitBefore:5e3,text:"Peut-être qu’en sautant dessus…"},{timeToWaitBefore:5e3,text:"La clé, c’est l’observation."},{timeToWaitBefore:5e3,text:"L’observation de tous les recoins…"},{timeToWaitBefore:1e4,text:"En tout cas, ça fait plaisir d’avoir de la visite."},{direct:!0,text:"Je commençais à m’ennuyer :("},{direct:!0,text:"Heureusement, je suis l’objectif de quelqu’un !"},{direct:!0,text:"Pas vrai ?"},{timeToWaitBefore:2e3,text:"…"},{direct:!0,text:"…pas vrai ?"},{direct:!0,text:'<span style="color: rebeccapurple">Je suis bien ton objectif, hein ?</span>'}],this.nbUnlockableDialogue=this.textSequence.length;var n=new w.Pa4(-15.75,-15.75);this.scenario=[{type:"splash",titles:["<h3>madblade présente</h3>","<h3>fait pour la <b>Potat0 Game Jam</b> No.6</h3>avec m&alpha;dengine<br/>thème: « le vrai objectif est caché »","<h1>Puddle Game</h1>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:3e3,performWhenConditionMet:function(e,t){t.informPlayer("Go to checkpoint!"),e.selfModel.unlock(),t.app.engine.audio.playMusic()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=3},performWhenConditionMet:function(e,t){var n=e.entityModel,i={},a=n.addNewLittleCup(i,-15.75,-15.75,.3,!0,!0,!1,[]);n.setObjectiveID(a),e.updateEntities(i),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var i=e.selfModel.position,a=n;return i.distanceTo(a)<1},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.playBigValidateFeedback(),e.entityModel.triggerObjectiveShrink(),t.validateTask();var n=e.app.engine.graphics.rendererManager;n.setTransitionDuration(500),n.startSceneTransition(!0),n.setTitleSceneText("")}},{type:"end",performWhenConditionMet:function(e,t){var n=e.entityModel.getHelperCupDialogueAdvancement();t.updateDialogueAdvancement(this.levelID,n),t.informPlayer("Level A cleared!"),t.validateLevel()}}]};o(Xt,Ut),a(Xt.prototype,{getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.6,!1,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}}),a(Xt.prototype,Gt),a(Xt.prototype,Yt);var Kt={generateTerrain:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!0}),this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:e}]}}};function Zt(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var Jt={generateWalls:function(){return[{type:"box",reflection:!0,image:!0,wall:!0,position:[0,15,4.9],rotation:[0,0,0],w:30,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[0,-15,4.9],rotation:[0,0,0],w:30,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[15,0,4.9],rotation:[0,0,0],w:2,h:30,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[-15,0,4.9],rotation:[0,0,0],w:2,h:30,d:10}]},generateStaticObjects:function(){var e,t=[],n=this.generateWalls();t.push.apply(t,function(e){if(Array.isArray(e))return Zt(e)}(e=n)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return Zt(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Zt(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),t.push.apply(t,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,-12,0],rotation:[0,0,0],w:2,h:2,d:.2},{type:"box",reflection:!0,image:!0,stone:!0,position:[0,0,0],rotation:[0,0,0],w:1,h:1,d:.05}]),t.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=t}},Qt=function(e,t){Ut.call(this,e,t),this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.player={position:[0,-12,1.5],rotation:[0,0,Math.PI]},this.textSequence=[{direct:!0,text:""},{direct:!0,text:"Ah !"},{direct:!0,text:"Tu m’as fait peur !"},{direct:!0,text:"J’ai cru que tu ne reviendrais pas."},{direct:!0,text:"Heureusement, tu sais où est ton <i>vrai</i> objectif."},{direct:!0,text:"Devant tes yeux !"},{timeToWaitBefore:5e3,text:"Hum."},{direct:!0,text:"Il y a quelque chose qui cloche…"},{direct:!0,text:"Pourquoi je n’ai pas de reflet ?"},{timeToWaitBefore:5e3,text:"Tu as bien un reflet, toi !"},{direct:!0,text:"…"},{direct:!0,text:"Étrange…"},{direct:!0,text:"Peut-être qu’on n’a pas tous la chance d’en avoir un."},{timeToWaitBefore:1e4,text:"J’aimerais bien avoir un reflet."},{timeToWaitBefore:5e3,text:"Mais bon, tant que tu es là…"},{direct:!0,text:"C’est que tout va pour le mieux !"},{timeToWaitBefore:5e3,text:"…pas vrai ?"},{timeToWaitBefore:5e3,text:'<span style="color: rebeccapurple">C’est bien pour moi que tu es là, non ?</span>'}],this.nbUnlockableDialogue=this.textSequence.length;var n=new w.Pa4(2,-12,3);this.scenario=[{type:"splash",titles:["<h3>Puddle 1</h3>","<h3>L’eaubjectif</h3>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:2e3,performWhenConditionMet:function(e,t){t.informPlayer("Go to checkpoint!"),e.selfModel.unlock()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=7},performWhenConditionMet:function(e,t){var i=e.entityModel;t.playLittleValidateFeedback();var a={},o=n.x,r=n.y,s=n.z,l=i.addNewLittleCup(a,o,r,s,!0,!1,!1,[]);i.setObjectiveID(l),e.updateEntities(a),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var i=e.selfModel.position,a=n;return i.distanceTo(a)<1},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.playBigValidateFeedback(),e.entityModel.triggerObjectiveShrink(),t.validateTask();var n=e.app.engine.graphics.rendererManager;n.setTransitionDuration(500),n.startSceneTransition(!0),n.setTitleSceneText("")}},{type:"end",performWhenConditionMet:function(e,t){var n=e.entityModel.getHelperCupDialogueAdvancement();t.updateDialogueAdvancement(this.levelID,n),t.informPlayer("Level B cleared!"),t.validateLevel()}}]};o(Qt,Ut),a(Qt.prototype,{getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.6,!1,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}}),a(Qt.prototype,Kt),a(Qt.prototype,Jt);var $t={generateTerrain:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!0}),this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:e}]}}};function en(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var tn={getPlatforms:function(){return[{type:"box",reflection:!0,image:!1,transplatform:!0,position:[-10,0,1.5],rotation:[0,0,0],w:1,h:1,d:.5},{type:"box",reflection:!0,image:!1,transplatform:!0,position:[-10,5,2.5],rotation:[0,0,0],w:1,h:1,d:.5},{type:"box",reflection:!0,image:!1,transplatform:!0,position:[-5,5,3.5],rotation:[0,0,0],w:1,h:1,d:.5},{type:"box",reflection:!0,image:!1,transplatform:!0,position:[0,5,4.5],rotation:[0,0,0],w:1,h:1,d:.5},{type:"box",reflection:!0,image:!1,transplatform:!0,position:[5,5,4.5],rotation:[0,0,0],w:1,h:1,d:.5}]},generateWalls:function(){return[{type:"box",reflection:!0,image:!0,wall:!0,position:[0,15,4.9],rotation:[0,0,0],w:30,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[0,-15,4.9],rotation:[0,0,0],w:30,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[15,0,4.9],rotation:[0,0,0],w:2,h:30,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[-15,0,4.9],rotation:[0,0,0],w:2,h:30,d:10}]},generateStaticObjects:function(){var e,t=[],n=this.generateWalls();t.push.apply(t,function(e){if(Array.isArray(e))return en(e)}(e=n)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return en(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?en(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),t.push.apply(t,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,-12,0],rotation:[0,0,0],w:2,h:2,d:.2},{type:"box",reflection:!0,image:!0,stone:!0,position:[0,0,0],rotation:[0,0,0],w:1,h:1,d:.05}]),t.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=t}},nn=function(e,t){Ut.call(this,e,t),this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.player={position:[0,-12,1.5],rotation:[0,0,Math.PI]},this.textSequence=[{direct:!0,text:""},{direct:!0,text:"Euh…"},{direct:!0,text:"J’ai bien vu ce que tu as fait…"},{direct:!0,text:"Ce n’était clairement pas mon reflet !"},{direct:!0,text:"Cette… <i>chose</i> que tu as prise !"},{timeToWaitBefore:5e3,text:"C’est pas moi ton objectif, alors ?"},{direct:!0,text:"Tristesse."},{timeToWaitBefore:5e3,text:"Oh, on dirait que la patience porte ses fruits."},{timeToWaitBefore:1e4,text:"J’ai toujours été une quiche en <i>platformer</i>."},{direct:!0,text:"…peut-être parce que je ne peux pas sauter."},{timeToWaitBefore:5e3,text:'<span style="color: rebeccapurple">Peu importe de ne pas savoir sauter tant qu’on sait rêver !</span>'}],this.nbUnlockableDialogue=this.textSequence.length;var n=new w.Pa4(5,5,5.5),i=this.getPlatforms();this.scenario=[{type:"splash",titles:["<h3>Puddle 2</h3>","<h3>Trop heaut</h3>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:2e3,performWhenConditionMet:function(e,t){t.informPlayer("Go to checkpoint!"),e.selfModel.unlock()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=4},performWhenConditionMet:function(e,t){var a=e.entityModel;t.playLittleValidateFeedback();var o=e.app.engine;a.addNewObjects(i,o.graphics,o.physics,o.graphics.animationManager);var r={},s=n.x,l=n.y,c=n.z,h=a.addNewLittleCup(r,s,l,c,!0,!1,!1,[]);a.setObjectiveID(h),e.updateEntities(r),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var i=e.selfModel.position,a=n;return i.distanceTo(a)<1},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.playBigValidateFeedback(),e.entityModel.triggerObjectiveShrink(),t.validateTask();var n=e.app.engine.graphics.rendererManager;n.setTransitionDuration(500),n.startSceneTransition(!0),n.setTitleSceneText("")}},{type:"end",performWhenConditionMet:function(e,t){var n=e.entityModel.getHelperCupDialogueAdvancement();t.updateDialogueAdvancement(this.levelID,n),t.informPlayer("Level C cleared!"),t.validateLevel()}}]};o(nn,Ut),a(nn.prototype,{getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.6,!1,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}}),a(nn.prototype,$t),a(nn.prototype,tn);var an={generateTerrain:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!0}),this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:e}]}}};function on(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var rn={getStelas:function(){return[{type:"box",red:!0,reflection:!0,image:!0,position:[-15,0,0],rotation:[0,0,0],w:5,h:5,d:.2},{type:"box",reflection:!0,image:!0,position:[15,0,0],rotation:[0,0,0],w:5,h:5,d:.2},{type:"box",reflection:!0,image:!0,position:[0,15,0],rotation:[0,0,0],w:5,h:5,d:.2},{type:"box",reflection:!0,image:!0,position:[0,-15,0],rotation:[0,0,0],w:5,h:5,d:.2}]},getBlockers:function(){return[{type:"box",wall:!0,reflection:!0,image:!0,position:[-5,-5,0],rotation:[0,0,0],w:20,h:1,d:5},{type:"box",wall:!0,reflection:!0,image:!0,position:[-10,5,0],rotation:[0,0,-Math.PI/4],w:.5,h:3,d:7}]},generateWalls:function(){var e=22.5;return[{type:"box",reflection:!0,image:!0,wall:!0,position:[0,e,4.9],rotation:[0,0,0],w:45,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[0,-e,4.9],rotation:[0,0,0],w:45,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[e,0,4.9],rotation:[0,0,0],w:2,h:45,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[-e,0,4.9],rotation:[0,0,0],w:2,h:45,d:10}]},generateStaticObjects:function(){var e,t=[],n=this.generateWalls();t.push.apply(t,function(e){if(Array.isArray(e))return on(e)}(e=n)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return on(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?on(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),t.push.apply(t,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,-15,0],rotation:[0,0,0],w:2,h:2,d:.1}]),t.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=t}},sn=function(e,t){Ut.call(this,e,t),this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.player={position:[0,-15,1.5],rotation:[0,0,Math.PI],isXYFlipped:!0},this.textSequence=[{direct:!0,text:""},{direct:!0,text:""},{direct:!0,text:"…"},{direct:!0,text:"Encore toi."},{direct:!0,text:"J’ai toujours pas de reflet."},{direct:!0,text:"Qu’est-ce que ça peut bien vouloir dire ?"},{direct:!0,text:"…"},{direct:!0,text:"J’imagine que tu ne veux toujours pas de moi…"},{direct:!0,text:"…comme objectif ?"}];var n=[{direct:!0,text:"Qu’est-ce que tu fais ?"},{timeToWaitBefore:5e3,text:"Hm…"},{direct:!0,text:"Hmmmmm…"},{direct:!0,text:"Ton reflet est…"},{direct:!0,text:"Bizarre."},{direct:!0,text:"C’est comme s’il s’était désynchronizé !"},{timeToWaitBefore:1e4,text:"J’ai le pied mouillé."},{direct:!0,text:"Ça rafraîchit !"},{timeToWaitBefore:1e4,text:"Je peux te dire un secret ?"},{direct:!0,text:'<span style="color: rebeccapurple">C’est près de l’eau que je rêve le mieux.</span>'}];this.nbUnlockableDialogue=n.length;var i=new w.Pa4(-15,0,.5),a=new w.Pa4(6,-11,3.5),o=this.getStelas(),r=this.getBlockers();this.scenario=[{type:"splash",titles:["<h3>Puddle 3</h3>","<h3>Réflexion</h3>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:2e3,performWhenConditionMet:function(e,t){t.informPlayer("Go to checkpoint!"),e.selfModel.unlock()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=7},performWhenConditionMet:function(e,t){var n=e.entityModel,i=e.app.engine;n.addNewObjects(o,i.graphics,i.physics,i.graphics.animationManager),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var n=e.selfModel.position,a=i;return n.distanceTo(a)<2},performWhenConditionMet:function(e,t){var i=e.entityModel;i.setHelperCupTextSequence(n);var o=e.app.engine;i.addNewObjects(r,o.graphics,o.physics,o.graphics.animationManager);var s={},l=a.x,c=a.y,h=a.z,d=i.addNewLittleCup(s,c,l,h,!0,!1,!1,[]);i.setObjectiveID(d),e.updateEntities(s),e.selfModel.flipXYMain(),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var n=e.selfModel.position,i=a;return n.distanceTo(i)<1},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.playBigValidateFeedback(),e.entityModel.triggerObjectiveShrink(),t.validateTask();var n=e.app.engine.graphics.rendererManager;n.setTransitionDuration(500),n.startSceneTransition(!0),n.setTitleSceneText("")}},{type:"end",performWhenConditionMet:function(e,t){var n=e.entityModel.getHelperCupDialogueAdvancement();t.updateDialogueAdvancement(this.levelID,n),t.informPlayer("Level D cleared!"),t.validateLevel()}}]};o(sn,Ut),a(sn.prototype,{getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.5,!1,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}}),a(sn.prototype,an),a(sn.prototype,rn);var ln={generateTerrain:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!0}),this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:e}]}}};function cn(e){return function(e){if(Array.isArray(e))return hn(e)}(e)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return hn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?hn(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function hn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var dn={getPlatforms:function(){return[{type:"box",reflection:!0,image:!0,stone:!0,position:[-10,10,0],rotation:[0,0,Math.PI/16],w:1,h:1,d:.5},{type:"box",image:!0,stone:!0,position:[-3,10,0],rotation:[0,0,Math.PI/8],w:1,h:1,d:1},{type:"box",image:!0,stone:!0,position:[3,10,0],rotation:[0,0,Math.PI/4],w:1,h:1,d:2},{type:"box",image:!0,stone:!0,position:[10,10,0],rotation:[0,0,Math.PI/3],w:1,h:1,d:4}]},generateWalls:function(){return[{type:"box",reflection:!0,image:!0,wall:!0,position:[0,20,4.9],rotation:[0,0,0],w:40,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[0,-20,4.9],rotation:[0,0,0],w:40,h:2,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[20,0,4.9],rotation:[0,0,0],w:2,h:40,d:10},{type:"box",reflection:!0,image:!0,wall:!0,position:[-20,0,4.9],rotation:[0,0,0],w:2,h:40,d:10}]},generateStaticObjects:function(){var e=[],t=this.generateWalls();e.push.apply(e,cn(t));var n=this.getPlatforms();e.push.apply(e,cn(n)),e.push.apply(e,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,-12,0],rotation:[0,0,0],w:2,h:2,d:.2},{type:"box",reflection:!0,image:!0,stone:!0,position:[0,0,0],rotation:[0,0,0],w:1,h:1,d:.05}]),e.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=e}},un=function(e,t){Ut.call(this,e,t),this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.player={position:[0,-12,1.5],rotation:[0,0,Math.PI]},this.textSequence=[{direct:!0,text:"Encore ?"},{direct:!0,text:"J’ai des yeux, je te signale !"},{direct:!0,text:"Je te vois me tourner autour…"},{direct:!0,text:"Si tu ne veux pas de moi, rien ne t’oblige à rester."},{direct:!0,text:"Puisque c’est comme ça, tiens !"},{direct:!0,text:"Et bonne chance pour trouver la bonne !"},{timeToWaitBefore:5e3,text:"Elles ne peuvent pas te voir."},{timeToWaitBefore:5e3,text:"Elles n’ont pas d’yeux !"},{direct:!0,text:"Toi, en revanche…"},{direct:!0,text:"Tu peux toutes les voir."},{direct:!0,text:"Absolument toutes."},{direct:!0,text:"Sans aucune exception."},{direct:!0,text:"Non ?"},{timeToWaitBefore:2e3,text:"Burp."},{direct:!0,text:"J’ai le tournis."},{direct:!0,text:"Si tu as le tournis aussi, n’hésite pas à faire une pause !"},{timeToWaitBefore:2e4,text:"Je ne t’en veux pas, tu sais."},{direct:!0,text:'<span style="color: rebeccapurple">Ce n’est pas comme si tu avais le choix.</span>'}],this.nbUnlockableDialogue=this.textSequence.length,this.scenario=[{type:"splash",titles:["<h3>Puddle 4</h3>","<h3>Beaucoup</h3>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:2e3,performWhenConditionMet:function(e,t){t.informPlayer("Go to checkpoint!"),e.selfModel.unlock()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=4},performWhenConditionMet:function(e,t){var n=e.entityModel;t.playLittleValidateFeedback();for(var i=[],a={},o=n.addNewLittleCup(a,-4.8,1.2*-6,3,!1,!1,!1,i,!0),r=1;r<15;++r)for(var s=1;s<15;++s)4===r&&6===s||n.addNewLittleCup(a,1.2*(r%2>0?r:-r),1.2*(s%2>0?s:-s),3,!0,!1,!1,i,!0);n.setObjectiveID(o),e.updateEntities(a),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var n=e.entityModel.getObjectivePosition();return e.selfModel.position.distanceTo(n)<1},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.playBigValidateFeedback(),e.entityModel.triggerObjectiveShrink(),t.validateTask();var n=e.app.engine.graphics.rendererManager;n.setTransitionDuration(500),n.startSceneTransition(!0),n.setTitleSceneText("")}},{type:"end",performWhenConditionMet:function(e,t){t.informPlayer("Level E cleared!"),t.validateLevel()}}]};o(un,Ut),a(un.prototype,{getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.6,!1,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}}),a(un.prototype,ln),a(un.prototype,dn);var pn={generateHillsChunk:function(){for(var e=new Map,t=[],n=0;n<65;++n)for(var i=0;i<65;++i){var a=2.5*Math.sin(n/8-.5-i/8),o=.8*Math.cos(1.8+n*i/80),r=1.5*Math.sin(.5+i/12+n/12);t.push(a+o+r)}return console.log(0),e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:64,nbSegmentsY:64,widthX:100,widthY:100,points:t,isWater:!1}),e},generateFlatChunk:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);return e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!0}),e},generateTerrain:function(){this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:this.generateFlatChunk()},{world:"-1",nbChunksX:1,nbChunksY:1,chunks:this.generateHillsChunk()}]}}};function mn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}var fn={getPlatforms:function(){return[{type:"box",color:"#735656",wall:!0,reflection:!0,image:!0,position:[10,0,0],rotation:[0,Math.PI/32,0],w:1,h:1,d:10},{type:"box",color:"#706854",wall:!0,reflection:!0,image:!0,position:[10,12,0],rotation:[0,0,0],w:1,h:1,d:10},{type:"box",color:"#67705b",wall:!0,reflection:!0,image:!0,position:[10,20,0],rotation:[0,-Math.PI/32,0],w:1,h:1,d:10},{type:"box",color:"#567774",wall:!0,reflection:!0,image:!1,position:[10,5,5],rotation:[0,0,Math.PI/4],w:1,h:1,d:.5}]},getClimbers:function(){return[{type:"box",reflection:!0,transplatform:!0,image:!1,position:[0,-8,7],rotation:[0,Math.PI/2+Math.PI/8,0],w:1,h:1,d:20}]},generateWalls:function(){var e=37.5;return[{type:"box",reflection:!0,image:!0,wall:!0,position:[0,e,7.4],rotation:[0,0,0],w:75,h:2,d:15},{type:"box",reflection:!0,image:!0,wall:!0,position:[0,-e,7.4],rotation:[0,0,0],w:75,h:2,d:15},{type:"box",reflection:!0,image:!0,wall:!0,position:[e,0,7.4],rotation:[0,0,0],w:2,h:75,d:15},{type:"box",reflection:!0,image:!0,wall:!0,position:[-e,0,7.4],rotation:[0,0,0],w:2,h:75,d:15}]},generateStaticObjects:function(){var e,t=[],n=this.generateWalls();t.push.apply(t,function(e){if(Array.isArray(e))return mn(e)}(e=n)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return mn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?mn(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),t.push.apply(t,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,0,0],rotation:[0,0,0],w:1,h:1,d:.05}]),t.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=t}},gn=function(e,t){Ut.call(this,e,t),this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.player={position:[0,-17,1.5],rotation:[0,0,Math.PI]},this.textSequence=[{direct:!0,text:"Regarde !"},{direct:!0,text:"Je brille !!"}];var n=[{direct:!0,text:"Je brille !!"},{direct:!0,text:"Je brille !!"}],i=[{direct:!0,text:"Hein ?"},{direct:!0,text:"Tu as bien vu que je brillais ?"},{timeToWaitBefore:5e3,text:"Ça te donne pas envie que je sois ton objectif ?"},{direct:!0,text:"…s’il te plaît ?"},{direct:!0,text:"…tant pis, j’imagine."},{timeToWaitBefore:5e3,text:"Ces colonnes m’ont l’air glissantes…"},{direct:!0,text:"Et ces reflets pour le moins <i>insolites</i>."},{timeToWaitBefore:5e3,text:"Tant que tout bouge en rythme,"},{direct:!0,text:"la vie est moins monotone."},{timeToWaitBefore:2e4,text:"J’aimerais bien savoir danser."},{direct:!0,text:'<span style="color: rebeccapurple">Comme ça on pourrait valser ensemble…</span>'}];this.nbUnlockableDialogue=i.length;var a=this.getPlatforms(),o=this.getClimbers(),r=new w.Pa4(-8.5,-8,12);this.scenario=[{type:"splash",titles:["<h3>Puddle 5</h3>","<h3>Synchreaune</h3>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:2e3,performWhenConditionMet:function(e,t){t.informPlayer("Go to checkpoint!"),e.selfModel.unlock()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=1},performWhenConditionMet:function(e,t){var i=e.entityModel;i.setHelperCupTextSequence(n),i.debloomMainCup(),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=1},performWhenConditionMet:function(e,t){var n=e.entityModel,r=e.app.engine;n.addNewObjects(a,r.graphics,r.physics,r.graphics.animationManager);var s=[],l={},c=n.addNewAxolotl(l,30,-5,6,!1,!1,s,1),h=n.addNewAxolotl(l,30,-15,6,!1,!1,s,2),d=n.addNewLittleCup(l,-20,-8,12,!0,!0,!1,s,!1,!0);n.setObjectiveID(d),n.setAxolotlIndex1(c),n.setAxolotlIndex2(h),e.updateEntities(l),n.setHelperCupTextSequence(i),t.playLittleValidateFeedback(),n.addNewObjects(o,r.graphics,r.physics,r.graphics.animationManager),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){return e.selfModel.position.distanceTo(r)<1},performWhenConditionMet:function(e,t){t.playLittleValidateFeedback();var n=e.entityModel;n.disappearObjective(),n.revealAxolotl1(),n.revealAxolotl2(),t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask()}},{type:"event",checkCondition:function(e,t){var n=e.entityModel.getObjectivePosition();return e.selfModel.position.distanceTo(n)<2},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.playBigValidateFeedback(),e.entityModel.triggerObjectiveShrink(),t.validateTask();var n=e.app.engine.graphics.rendererManager;n.setTransitionDuration(500),n.startSceneTransition(!0),n.setTitleSceneText("")}},{type:"end",performWhenConditionMet:function(e,t){t.app.engine.audio.playCredits(),t.informPlayer("Level E cleared!"),t.validateLevel()}}]};function vn(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}o(gn,Ut),a(gn.prototype,{getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.6,!0,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}}),a(gn.prototype,pn),a(gn.prototype,fn);var yn=function(e,t){Ut.call(this,e,t),this.player={position:[0,-10,1.5],rotation:[0,0,Math.PI]},this.terrain={},this.generateTerrain(),this.objects=[],this.generateStaticObjects(),this.textSequence=[{direct:!0,text:"Merci d’avoir joué !"},{direct:!0,text:"Ce dernier niveau avec les plateformes était particulièrement frustrant…"},{direct:!0,text:"Bravo !"},{direct:!0,text:"Voilà, c’est fini."},{direct:!0,text:"Tada !"},{timeToWaitBefore:5e3,text:'<span style="color: rebeccapurple">Merci de m’avoir tenu compagnie !</span>'}],this.scenario=[{type:"splash",titles:["<h3>FIN</h3>","<h3><b>Potat0 Game Jam</b> No.6</h3>thème: « le vrai objectif est caché »","<h3>musique originale<br/> <small>TheLevg34</small></h3>","<h3>musique originale <small>(post-crédits)</small><br/> <small>TheLevg34 et Nicolas Dross</small></h3>","<h3>gameplay, programmation, modèles, animations, design et bugs divers<br/><small>madblade</small></h3>","<h3>moteur maison (open-source GPLv3)<br/><small>madblade</small></h3>","<h3>asset CC BY 4.0 (attribution)<br/><small>modèle d’axolotl par xiaotian_63</small></h3>","<h3>assets CC0 (domaine public)<br/><small>sfx de marche / saut</small></h3>","<h1>Puddle Game</h1>","<h3>Merci d’avoir joué !</h3>","<h3></h3>","<h3></h3>","<h3></h3>","<h3></h3>","<h3></h3>","<h3></h3>","<h3></h3>","<h3></h3>","<h3></h3>"],fadeInTitle:1e3,fadeOutTitle:1e3,keepTitle:2e3,fadeOutSplash:3e3,performWhenConditionMet:function(e,t){t.informPlayer("Vous gagnâtes !"),e.selfModel.unlock()}},{type:"event",checkCondition:function(e,t){return e.entityModel.getHelperCupDialogueAdvancement()>=4},performWhenConditionMet:function(e,t){t.informPlayer("Checkpoint passed! Go to the next checkpoint…"),t.validateTask(),t.app.engine.audio.playBonusCredits()}},{type:"event",checkCondition:function(e,t){return!1},performWhenConditionMet:function(e,t){}}]};o(yn,Ut),a(yn.prototype,{generateTerrain:function(){for(var e=new Map,t=[],n=0;n<3;++n)for(var i=0;i<3;++i)t.push(0);e.set("0,0",{x:0,y:0,z:0,nbSegmentsX:2,nbSegmentsY:2,widthX:100,widthY:100,points:t,isWater:!1,color:"#161616",shininess:.1}),this.terrain={worlds:[{id:"-1",sky:"standard"}],heightmaps:[{world:"-1",nbChunksX:1,nbChunksY:1,chunks:e}]}},generateStaticObjects:function(){var e,t=[],n=this.generateWalls();t.push.apply(t,function(e){if(Array.isArray(e))return vn(e)}(e=n)||function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return vn(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?vn(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),t.push.apply(t,[{type:"box",reflection:!0,image:!0,stone:!0,position:[0,0,0],rotation:[0,0,0],w:1,h:1,d:.05}]),t.push({type:"box",reflection:!1,image:!1,platform:!0,position:[0,0,.5],rotation:[0,0,0],w:.5,h:.5,d:1.15}),this.objects=t},generateWalls:function(){var e=17.5;return[{type:"box",image:!0,wall:!0,position:[0,e,4.9],rotation:[0,0,0],w:35,h:2,d:10},{type:"box",image:!0,wall:!0,position:[0,-e,4.9],rotation:[0,0,0],w:35,h:2,d:10},{type:"box",image:!0,wall:!0,position:[e,0,4.9],rotation:[0,0,0],w:2,h:35,d:10},{type:"box",image:!0,wall:!0,position:[-e,0,4.9],rotation:[0,0,0],w:2,h:35,d:10}]},getTerrain:function(){return this.terrain},getObjects:function(){return this.objects},getPlayer:function(){return this.player},getScenario:function(){return this.scenario},startupObjects:function(e){var t=e.model.backend,n=t.entityModel,i={},a=n.makeNewBigCup(0,0,.6,!1,this.textSequence),o=n.addNewBigCup(i,a,[]);n.setHelperCupID(o),t.updateEntities(i)}});var wn=function(e){this.app=e,this.levels=[new Xt("Introduction",0),new Qt("Flaque 1",1),new nn("Flaque 2",2),new sn("Flaque 3",3),new un("Flaque 4",4),new gn("Flaque 5",5),new yn("Générique",6)]};a(wn.prototype,{getLevels:function(){return this.levels},getLevel:function(e){var t=this.levels[e];return t||console.warn("[Model/Levels] Level ".concat(e," not found!")),t}});var bn=function(e,t,n){this.id=e,this.worldId=n,this.position=new w.Pa4(0,0,0),this.rotation=new w.Pa4(0,0,0),this.needsUpdate=!0,this.useInterpolation=!1,this.isProjectile=!1,this.inScene=!1,this.helper=null,this.graphicalComponent=t,this.shrinkTime=0,this.isShrinking=!1,this.textComponent=null,this.animationComponent=Object.create(null),this.bounceAmount=0,this.originalZ=0,this.physicsEntity=null,this.intelligence=null,this._r=new w.Pa4(0,0,0)};a(bn.prototype,{getHelper:function(){return this.helper},setHelper:function(e){this.helper=e},getObject3D:function(){return this.graphicalComponent},getTheta:function(){return r(!!this.graphicalComponent,"[EntityModel] Cannot get graphical component."),this.graphicalComponent.getInnerObject().rotation.y},setRotation:function(e,t){t||(t=this.graphicalComponent);var n=t.getInnerObject();t.rotation.x=e.x+Math.PI/2,t.rotation.y=e.y+0,n.rotation.y=e.z},getRotation:function(){var e=this.graphicalComponent;if(r(!!e,"[EntityModel] Cannot get graphical component."),e){var t=e.getInnerObject();return this._r.set(e.rotation.x,e.rotation.y,t.rotation.y),this._r}},getRotationX:function(){return r(!!this.graphicalComponent,"[SelfModel] Cannot get graphical component."),this.avatar.rotation.x},getRotationY:function(){return r(!!this.graphicalComponent,"[SelfModel] Cannot get graphical component."),this.graphicalComponent.rotation.y},setBounceAmount:function(e){this.bounceAmount=e,this.graphicalComponent.position.z=this.originalZ+e},getBounceAmount:function(){return this.bounceAmount},getWorldId:function(){return this.worldId},setWorldId:function(e){this.worldId=e},getTime:function(){return window.performance.now()},initInterpolation:function(){this.useInterpolation=!0,this.lastUpdateTime=this.getTime(),this.averageDeltaT=this.lastUpdateTime,this.lastServerUpdateTime=this.lastUpdateTime,this.lastPFromServer=new w.Pa4(0,0,0),this.currentPFromServer=new w.Pa4(0,0,0),this.interpolatingP=new w.Pa4(0,0,0),this.lastRFromServer=new w.Pa4(0,0,0),this.currentRFromServer=new w.Pa4(0,0,0),this.interpolatingR=new w.Pa4(0,0,0)}});var xn={loadBigCupEntity:function(e,t,n){var i=this.app.engine.graphics,a=i.loadReferenceMeshFromMemory("bigcup",!1,!0),o=new bn(e,a,parseInt(t.w,10)),r=i.animationManager;r.initializeEntityAnimation(o.animationComponent,o.getTheta()),t.t&&r.addLabelledEntity(t.t,e,o),a.traverse((function(e){e.isMesh&&(t.b&&(e.userData.bloom=!0),e.userData.hasPrimaryImage=!0)})),i.addToScene(o.getObject3D(),o.getWorldId()),this.updateEntity(e,o,t,i,n),this.entitiesLoading.delete(e),this.lookers.set(e,o)},loadLittleCupEntity:function(e,t,n){var i=this.app.engine.graphics,a=i.loadReferenceMeshFromMemory("littlecup",!1,!0);a.traverse((function(e){e.isMesh&&(e.position.set(0,0,0),e.rotation.set(0,Math.PI/2,0),e.userData.hasPrimaryImage=t.primaryImage,e.userData.hasReflection=t.reflection,e.userData.isCupXYFlipped=t.isCupXYFlipped)}));var o=new bn(e,a,parseInt(t.w,10));t.isRotating&&(o.isRotating=!0),t.isFinalCup&&(o.isFinalCup=!0),i.addToScene(o.getObject3D(),o.getWorldId()),this.updateEntity(e,o,t,i,n),this.entitiesLoading.delete(e)},loadAxolotl:function(e,t,n){var i=this.app.engine.graphics,a=i.loadReferenceMeshFromMemory("axolotl",!1,!0),o=t.finalAxolotlIndex;a.traverse((function(e){e.isMesh&&(e.position.set(0,0,0),e.rotation.set(0,Math.PI/2,0),e.userData.hasPrimaryImage=t.primaryImage,e.userData.hasReflection=t.reflection)}));var r=new bn(e,a,parseInt(t.w,10));o&&(r.finalAxolotlIndex=o),i.addToScene(r.getObject3D(),r.getWorldId()),this.updateEntity(e,r,t,i,n),this.entitiesLoading.delete(e)},createFootStepMesh:function(){var e=new w.BKK,t={uniforms:Fe.rD.merge([w.rBU.common,w.rBU.specularmap,w.rBU.envmap,w.rBU.aomap,w.rBU.lightmap,w.rBU.fog,{time:{value:0},radius:{value:1}}]),vertexShader:Ce.getFootStepVertexShader(),fragmentShader:Ce.getFootStepFragmentShader(),side:w.ehD,transparent:!0},n=new w.jyz(t),i=new w.Kj0(e,n);i.userData.bloom=!1,i.userData.hasPrimaryImage=!0,i.userData.hasReflection=!1;var a=new w.Tme;return a.add(i),a.getMesh=function(){return i},a},createMeleeMesh:function(){var e=new w.V4E(.5,1.3,20,1,0,Math.PI),t={uniforms:{time:{value:0},outerRadius:{value:1.3},innerRadius:{value:.5}},vertexShader:Ce.getSwordTrailVertexShader(),fragmentShader:Ce.getSwordTrailFragmentShader(),side:w.ehD,transparent:!0,depthTest:!1},n=new w.jyz(t),i=new w.Kj0(e,n);i.userData.bloom=!1,i.userData.hasPrimaryImage=!0,i.userData.hasReflection=!1;var a=new w.Tme;a.position.set(0,0,0),a.rotation.x=Math.PI/2,a.rotation.y=Math.PI,a.add(i),i.rotation.set(0,Math.PI/2+Math.PI/4,0),i.position.set(1,1,-.5),i.renderOrder=999;var o=new w.Tme;return a.rotation.reorder("ZYX"),i.rotation.reorder("ZYX"),o.add(a),o.getWrapper=function(){return a},o.getMesh=function(){return i},o},createArrowTrail:function(e){var t=new w.u9r,n=new Float32Array(750);t.setAttribute("position",new w.TlE(n,3));var i=0;n[i++]=e.x,n[i++]=e.y,n[i++]=e.z,t.setDrawRange(0,1),t.attributes.position.needsUpdate=!0,t.computeBoundingSphere();var a=new w.FT0({color:16776960,linewidth:2,scale:1,dashSize:3,gapSize:1}),o=new w.x12(t,a);return o.computeLineDistances(),o},loadArrow:function(e,t,n){var i=this.app.engine.graphics,a=new w.Tme,o=i.getItemMesh(A.YA,!1,!0);o.userData.bloom=!0,a.add(o),a.rotation.x=Math.PI/2,a.rotation.y=Math.PI,a._id=e;var r=new w.Tme;r.rotation.reorder("ZYX"),r.add(a),a.rotation.x=Math.PI/2,a.rotation.y=Math.PI,r._id=e,r.getWrapper=function(){return a};var s=new bn(e,r,parseInt(t.w,10));s.isProjectile=!0,this.updateEntity(e,s,t,i,n),s.inScene=!0,i.addToScene(s.getObject3D(),s.getWorldId());var l=s.position,c=this.createArrowTrail(s.position);s.setHelper(c),i.addToScene(s.getHelper(),s.getWorldId()),r.position.set(l.x,l.y,l.z),s.lastPFromServer.set(l.x,l.y,l.z),s.currentPFromServer.set(l.x,l.y,l.z);var h=this.app.model.backend.selfModel.rotation,d=s.rotation;d.set(h[1],h[2],h[3]);var u=s.getObject3D();u.rotation.x=d.z,u.rotation.z=d.y,u.getWrapper().rotation.y=Math.PI+d.x,s.lastRFromServer.set(d.x,d.y,d.z),s.currentRFromServer.set(d.x,d.y,d.z),this.entitiesLoading.delete(e)},loadCube:function(e,t,n){var i=this.app.engine.graphics,a=new w.Tme,o=i.createMesh(i.createGeometry("box"),i.createMaterial("flat-phong",6171652));a.add(o),a.rotation.x=Math.PI/2,a.rotation.y=Math.PI,a._id=e;var r=new w.Tme;r.rotation.reorder("ZYX"),r.add(a),a.rotation.x=Math.PI/2,a.rotation.y=Math.PI,r._id=e,r.getWrapper=function(){return a};var s=new bn(e,r,parseInt(t.w,10));i.addToScene(s.getObject3D(),s.getWorldId()),this.updateEntity(e,s,t,i,n),this.entitiesLoading.delete(e)},loadPlayer:function(e,t,n){var i=this.app.engine.graphics,a=t.a?65280:16711680,o=i.initializeEntity(e,"steve",a),r=i.finalizeEntity(e,o,a),s=new bn(e,r,parseInt(t.w,10));i.addToScene(s.getObject3D(),s.getWorldId()),this.updateEntity(e,s,t,i,n),this.entitiesLoading.delete(e)}},Mn={interpolatePredictEntities:function(){var e=this,t=this.getTime();this.entitiesNeedingInterpolation.forEach((function(n){n.needsUpdate&&e.interpolatePredictEntity(n,t)}))},interpolatePredictEntity:function(e,t){var n=e.position,i=e.rotation,a=e.currentPFromServer,o=e.currentRFromServer,r=e.lastPFromServer,s=e.lastRFromServer;(a.distanceTo(n)>0||o.distanceTo(i)>0)&&(r.copy(a),a.copy(n),s.copy(o),o.copy(i),e.lastUpdateTime=t,e.averageDeltaT=t-e.lastServerUpdateTime,e.lastServerUpdateTime=t);var l=e.averageDeltaT,c=t-e.lastUpdateTime;if(c<l){var h=c/l,d=a.x-r.x,u=o.x-s.x;u>Math.PI&&(u=2*Math.PI-u),u<-Math.PI&&(u+=2*Math.PI);var p=a.y-r.y,m=o.y-s.y,f=a.z-r.z,g=o.z-s.z;this.setLerp(e,r.x+h*d,r.y+h*p,r.z+h*f,s.x+h*u,s.y+h*m,s.z+h*g)}else(e.interpolatingP.distanceTo(a)>0||e.interpolatingR.distanceTo(o)>0)&&(this.setLerp(e,a.x,a.y,a.z,o.x,o.y,o.z),e.needsUpdate=!1)},setLerp:function(e,t,n,i,a,o,r){var s=new w.Pa4;e.interpolatingP.set(t,n,i),e.interpolatingR.set(a,o,r),this.updateGraphicalEntity(e,e.interpolatingP,e.interpolatingR,s)},cerp:function(e,t,n,i,a){var o=e?[n[0]-e[0],n[1]-e[1],n[2]-e[2]]:[n[0]-t[0],n[1]-t[1],n[2]-t[2]],r=i?[i[0]-t[0],i[1]-t[1],i[2]-t[2]]:[n[0]-t[0],n[1]-t[1],n[2]-t[2]];return this.catmull(t,n,o,r,a)},catmull:function(e,t,n,i,a){var o=a*a,r=1+o*(2*a-3),s=a*(1+o*(a-2)),l=o*(3-2*a),c=o*(a-1);return[r*e[0]+s*n[0]+l*t[0]+c*i[0],r*e[1]+s*n[1]+l*t[1]+c*i[1],r*e[2]+s*n[2]+l*t[2]+c*i[2]]}},Sn={updateEntities:function(e){if(e){var t=this.entitiesOutdated;for(var n in e)e.hasOwnProperty(n)&&t.set(n,e[n]);this.needsUpdate=!0}else console.log("Empty update @ server.sub.entities")},addEntity:function(e,t){var n=this.entitiesIngame;switch(this.entitiesLoading.add(e),t.k){case"ia":case"player":this.loadSkeletalEntity(e,t,n);break;case"bigcup":this.loadBigCupEntity(e,t,n);break;case"littlecup":this.loadLittleCupEntity(e,t,n);break;case"axolotl":this.loadAxolotl(e,t,n);break;case"projectile":this.loadArrow(e,t,n);break;case"cube":this.loadCube(e,t,n);break;default:console.log("\n                    ServerModel::addEntity: Unknown entity type '".concat(t.k,"'.\n                "))}},removeEntity:function(e){var t=this.app.engine.graphics,n=this.entitiesIngame,i=n.get(e);if(i){var a=i.getWorldId();t.removeFromScene(i.getObject3D(),a),i.helper&&t.removeFromScene(i.getHelper(),a)}n.delete(e)},updateEntity:function(e,t,n){var i=this.app.engine.graphics,a=this.entitiesIngame,o=t.position,r=t.rotation,s=n.p,l=n.r;o&&r&&o.x===s.x&&o.y===s.y&&o.z===s.z&&r.x===l.x&&r.y===l.y&&r.z===l.z||(t.position.set(s.x,s.y,s.z),t.rotation.set(l.x,l.z,l.y),t.needsUpdate=!0);var c=parseInt(n.w,10),h=t.getWorldId();if(h!==c){i.removeFromScene(t.getObject3D(),h,!0),t.setWorldId(c),i.addToScene(t.getObject3D(),c);var d=t.getHelper();d&&(i.removeFromScene(d,h,!0),i.addToScene(d,c),console.log(d))}a.set(e,t),n.d&&n.d[1]&&console.log("Someone meleed.")},directUpdateEntities:function(){var e=this;this.entitiesIngame.forEach((function(t){t.needsUpdate&&e.directUpdateEntity(t)}))},directUpdateEntity:function(e){var t=e.position,n=e.rotation;this.updateGraphicalEntity(e,t,n)},updateGraphicalEntity:function(e,t,n){var i=e.getObject3D(),a=i.position;e.isProjectile?this.updateProjectile(e,i,a,t):(i.rotation.x=n.x+Math.PI/2,i.rotation.y=n.y,i.getInnerObject().rotation.y=n.z,i.updateMatrixWorld()),a.copy(t),e.originalZ=a.z}},Cn={updateProjectile:function(e,t,n,i){var a,o,r=this.app.engine.graphics,s=i.x-n.x,l=i.y-n.y,c=i.z-n.z,h=Math.PI,d=s*s+l*l;if(d+c*c<1e-12){var u=this.app.model.backend.selfModel.rotation;a=u[2],o=u[3];var p=e.currentRFromServer;t.rotation.x=Math.PI+p[3],t.rotation.z=p[2]}else{a=l>0?Math.atan(-s/l):l<0?s<0?h-Math.atan(s/l):s>0?-h+Math.atan(-s/l):h:s<0?h/2:s>0?-h/2:0,o=c<0?-Math.atan(Math.sqrt(d)/c):c>0?h-Math.atan(Math.sqrt(d)/c):h/2,t.rotation.x=Math.PI+o,t.rotation.z=a,e.inScene||(e.inScene=!0,r.addToScene(t,e.getWorldId()));var m=e.getHelper();if(m&&m.geometry){var f=m.geometry.attributes.position.array,g=f.length/3,v=m.geometry.drawRange.count,y=3*v;if(v<g)f[y++]=i.x,f[y++]=i.y,f[y++]=i.z,m.computeLineDistances(),m.geometry.setDrawRange(0,v+1),m.geometry.attributes.position.needsUpdate=!0,m.geometry.computeBoundingSphere();else{y=0;for(var w=0;w<g-1;++w)f[y]=f[y+3],f[y+1]=f[y+4],f[y+2]=f[y+5],y+=3;f[y]=i.x,f[y+1]=i.y,f[y+2]=i.z,m.computeLineDistances(),m.geometry.setDrawRange(0,v+1),m.geometry.attributes.position.needsUpdate=!0,m.geometry.computeBoundingSphere()}}}t.updateMatrixWorld()}},Tn=function(e){this.app=e,this.entitiesOutdated=new Map,this.entitiesLoading=new Set,this.entitiesIngame=new Map,this.entitiesNeedingInterpolation=new Map,this.lookers=new Map,this.helperCupID=-1,this.objectiveID=-1,this.labelledEntities=new Map,this.needsUpdate=!1,this.useInterpolation=!1};a(Tn.prototype,{loadSkeletalEntity:function(e,t,n){var i=this.app.engine.graphics,a=i.loadReferenceMeshFromMemory("tato",!1,!0),o=new bn(e,a,parseInt(t.w,10));i.animationManager.addSkinnedEntityAnimation(e,a,o.animationComponent),i.addToScene(o.getObject3D(),o.getWorldId()),this.updateEntity(e,o,t,i,n),this.entitiesLoading.delete(e),this.app.engine.physics.addCharacterController(o)}}),a(Tn.prototype,xn),a(Tn.prototype,{init:function(e){var t=this.app.engine.graphics,n=this.app.engine.physics,i=t.animationManager;i.resetRaycastables();var a=e.getObjects();this.addNewObjects(a,t,n,i),e.startupObjects(this.app)},addNewObjects:function(e,t,n,i){e&&e.forEach((function(e){switch(e.type){case"box":var a,o=new w.nvb(e.w,e.h,e.d,2,2,2);e.wall?a=new w.xoR({color:e.color?e.color:"#eceaea",side:w.ehD}):e.color?a=new w.xoR({color:e.color,side:w.Wl3}):e.platform?a=new w.vBJ({color:"#797979"}):e.red?a=new w.xoR({color:"#945252"}):e.transplatform?a=new w.vBJ({color:"#3500b3",transparent:!0,opacity:0}):e.stone&&(a=new w.xoR({color:"#727272"}));var r=new w.Kj0(o,a);r.userData.hasReflection=e.reflection,r.userData.hasPrimaryImage=e.image,e.transplatform&&(r.userData.hasTransparency=!0);var s=e.position,l=e.rotation;r.position.set(s[0],s[1],s[2]),r.rotation.set(l[0],l[1],l[2]),r.updateMatrixWorld(),t.addToScene(r,"-1"),n.addStaticMesh(r),e.wall&&i.addRaycastable(r)}}))},refresh:function(){var e=this;if(this.needsUpdate){var t=this.entitiesIngame;this.entitiesOutdated.forEach((function(n,i){if(!e.entitiesLoading.has(i)){var a=t.get(i);n?a?e.updateEntity(i,a,n):e.addEntity(i,n):e.removeEntity(i)}})),this.useInterpolation?this.interpolatePredictEntities():this.directUpdateEntities(),this.entitiesOutdated.clear(),this.needsUpdate=!1}else this.useInterpolation&&this.interpolatePredictEntities()},getTime:function(){return window.performance.now()},cleanup:function(){this.entitiesIngame.clear(),this.entitiesOutdated.clear(),this.entitiesLoading.clear(),this.lookers.clear(),this.helperCupID=-1,this.objectiveID=-1,this.needsUpdate=!1},generateNewEntityID:function(e){for(var t=this.entitiesIngame,n=this.entitiesLoading,i=1,a=0;(t.has(i)||n.has(i)||t.has(i.toString())||n.has(i.toString())||e&&(e.indexOf(i)>-1||e.indexOf(i.toString())>-1))&&++a<1e4;)i++;if(a>=1e4)throw Error("[Entities] Too many entities.");return i},makeNewBigCup:function(e,t,n,i,a){var o={p:new w.Pa4(e,t,n),r:new w.Pa4(0,0,0),k:"bigcup",b:i};return a&&(o.t=a),o},addNewBigCup:function(e,t,n){r(!!n,"[Entities] Argument mismatch.");var i=this.generateNewEntityID(n);return e[i]=t,n.push(i),i},setHelperCupID:function(e){this.helperCupID=e},setObjectiveID:function(e){this.objectiveID=e},getObjectivePosition:function(){var e=this.objectiveID;return e<=0?null:this.entitiesIngame.get(e.toString()).graphicalComponent.position},triggerObjectiveShrink:function(){var e=this.objectiveID;r(-1!==e,"[Entities] Cannot shrink objective."),e<0||this.triggerShrink(e)},triggerShrink:function(e){var t=this.entitiesIngame.get(e.toString());r(!!t,"[Entities] Cannot shrink ".concat(e,".")),t&&(t.isShrinking=!0)},setHelperCupTextSequence:function(e){var t=this.helperCupID;if(r(-1!==t,"[Entities] Cannot feed text."),!(t<0)){var n=this.lookers.get(t.toString());r(!!n,"[Entities] Cannot feed text.");var i=n.textComponent;i&&i.setTextSequence(e)}},talkToHelperCup:function(){var e=this.helperCupID;if(!(e<0)){var t=this.lookers.get(e.toString()).textComponent;t&&t.stepTextSequence()}},untalkToHelperCup:function(){var e=this.helperCupID;if(!(e<0)){var t=this.lookers.get(e.toString()).textComponent;t&&t.unstepTextSequence()}},debloomMainCup:function(){var e=this.helperCupID;e<0||this.lookers.get(e.toString()).graphicalComponent.traverse((function(e){e.isMesh&&(e.userData.bloom=!1)}))},getHelperCupDialogueAdvancement:function(){var e=this.helperCupID;if(!(e<0)){var t=this.lookers.get(e.toString()).textComponent;if(t)return t.textIndex}},addNewLittleCup:function(e,t,n,i,a,o,s,l,c,h){r(!!l,"[Entities] Argument mismatch.");var d=this.generateNewEntityID(l);return e[d]={p:new w.Pa4(t,n,i),r:new w.Pa4(0,0,0),k:"littlecup",bloom:s,primaryImage:o,reflection:a,isRotating:c,isFinalCup:h},l.push(d),d},disappearObjective:function(){var e=this.objectiveID;if(!(e<0)){if(e<=0)return null;this.entitiesIngame.get(e.toString()).graphicalComponent.traverse((function(e){e.isMesh&&(e.userData.hasReflection=!1,e.userData.hasPrimaryImage=!1)}))}},setAxolotlIndex1:function(e){this.axolotlIndex1=e},setAxolotlIndex2:function(e){this.axolotlIndex2=e},revealAxolotl1:function(){var e=this.axolotlIndex1;e<0||this.entitiesIngame.get(e.toString()).graphicalComponent.traverse((function(e){e.isMesh&&(e.userData.hasReflection=!0,e.userData.hasPrimaryImage=!1)}))},revealAxolotl2:function(){var e=this.axolotlIndex2;e<0||this.entitiesIngame.get(e.toString()).graphicalComponent.traverse((function(e){e.isMesh&&(e.userData.hasReflection=!0,e.userData.hasPrimaryImage=!1)}))},addNewAxolotl:function(e,t,n,i,a,o,s,l){r(!!s,"[Entities] Argument mismatch.");var c=this.generateNewEntityID(s),h=new w.Pa4(0,0,0);return 1===l?h.set(0,-Math.PI/2,-Math.PI/2):2===l&&h.set(0,Math.PI/2,-Math.PI/2),e[c]={p:new w.Pa4(t,n,i),r:h,k:"axolotl",primaryImage:o,reflection:a,finalAxolotlIndex:l},s.push(c),c}}),a(Tn.prototype,Sn),a(Tn.prototype,Cn),a(Tn.prototype,Mn);var kn=function(){this.activeItemId=0,this.inventorySize=256,this.items=new Uint16Array(this.inventorySize),this.outfit=new Uint8Array(0),this.reset()};a(kn.prototype,{reset:function(){},getItem:function(e){return(e!==parseInt(e,10)||e<0||e>this.inventorySize)&&console.error("[Model/Inventory] Invalid inventory slot."),this.items[e]},setItem:function(e,t){(e!==parseInt(e,10)||e<0||e>this.inventorySize)&&console.warn("[Model/Inventory] Invalid inventory slot."),this.isItemIDSupported(t)||console.warn("[Model/Inventory] Invalid item ID."),this.items[e]=t}}),a(kn.prototype,E);var Pn,In,An,En={initInterpolation:function(){this.lastPositionFromServer=new w.Pa4(0,0,0),this.currentPositionFromServer=new w.Pa4(0,0,0),this.interpolatingPosition=new w.Pa4(0,0,0),this.lastRotationFromServer=new w.Ltg(0,0,0,0),this.currentRotationFromServer=new w.Ltg(0,0,0,0),this.interpolatingRotation=new w.Ltg(0,0,0,0),this.lastServerUpdateTime=this.getTime(),this.averageDeltaT=-1,this.interpolationUpToDate=!1,this.needsWorldSwitchRetry=!1},_d42:function(e,t){var n=e.x-t.x,i=e.y-t.y,a=e.z-t.z,o=e.w-t.w;return n*n+i*i+a*a+o*o},interpolatePredictSelfPosition:function(){var e=this.lastPositionFromServer,t=this.currentPositionFromServer,n=this.lastRotationFromServer,i=this.currentRotationFromServer,a=this.position,o=this.rotation,r=new w.Pa4(a.x,a.y,a.z),s=new w.Ltg(o[0],o[1],o[2],o[3]),l=this.getTime();if(t.distanceTo(r)>0||this._d42(i,s)>0){e.copy(t),t.copy(r),n.copy(i),i.copy(s);var c=l-this.lastServerUpdateTime;this.averageDeltaT=c,this.lastServerUpdateTime=l}var h=l-this.lastServerUpdateTime,d=this.averageDeltaT;if(h<d){var u=h/d,p=t.x-e.x,m=i.x-n.x,f=t.y-e.y,g=i.y-n.y,v=t.z-e.z,y=i.z-n.z,b=i.w-n.w;this.setLerp(e.x+u*p,e.y+u*f,e.z+u*v,n.x+u*m,n.y+u*g,n.z+u*y,n.w+u*b)}else(this.interpolatingPosition.distanceTo(t)>0||this._d42(this.interpolatingRotation,i)>0)&&(this.interpolationUpToDate=!0,this.setLerp(t.x,t.y,t.z,i.x,i.y,i.z,i.w));this.needsWorldSwitchRetry&&this.interpolateSwitchWorld()},setLerp:function(e,t,n,i,a,o,r){this.interpolatingRotation.set(i,a,o,r),this.interpolatingPosition.set(e,t,n),this.worldNeedsUpdate&&this.oldWorldId&&(this.interpolationUpToDate?this.interpolateSwitchWorld():this.intersectPortals(this.avatar.position,this.interpolatingPosition)),this.updatePosition(this.interpolatingPosition,this.avatar)},interpolateSwitchWorld:function(){if(!this.app.engine.graphics.sceneManager.hasScene(this.newWorldId))return console.warn("[UpdateWorld] New world not loaded yet, retrying to switch later."),this.interpolationUpToDate=!1,void(this.needsWorldSwitchRetry=!0);this.worldId=this.newWorldId,this.updateWorld();var e=this.position,t=this.lastPositionFromServer,n=this.currentPositionFromServer;t.copy(n),n.copy(e),this.interpolatingPosition.copy(e),this.updatePosition(this.interpolatingPosition,this.avatar),this.interpolationUpToDate=!0,this.worldNeedsUpdate=!1,this.needsWorldSwitchRetry=!1},intersectPortals:function(e,t){var n=this,i=this.xModel.portals,a=this.xModel.worldToPortals,o=parseInt(this.oldWorldId,10),r=a.get(o);if(r){var s=e.x,l=e.y,c=e.z,h=t.x,d=t.y,u=t.z,p=!1;r.forEach((function(e){if(!p&&e){var t=i.get(e);if(t||console.warn("[Self/Intersection] Portal not found: ".concat(e,".")),t.tempPosition&&t.tempOtherPosition&&t.tempPosition.length){var a=parseFloat(t.tempPosition[0]),o=parseFloat(t.tempPosition[1]),r=parseFloat(t.tempPosition[2]),m=parseFloat(t.tempOtherPosition[0]),f=parseFloat(t.tempOtherPosition[1]),g=parseFloat(t.tempOtherPosition[2]),v=parseFloat(t.tempOrientation),y=t.portalId;if(2===0+(m===a)+(f===o)+(g===r)){var w=m!==a?"x":f!==o?"y":g!==r?"z":"?",b=-parseFloat(v);"x"===w&&(b+=Math.PI/2),"y"===w&&(b=-b+Math.PI/2);var x,M,S,C,T,k,P,I,A,E,O=Math.cos(b),L=Math.sin(b),_=function(e,t,n){return[e*O-t*L,t*O+e*L,n]};switch(w){case"x":P=u-(r+.5),I=d-(o+.5),A=_(c-(r+.5),l-(o+.5),s),E=_(P,I,h),A[0]+=r+.5,E[0]+=r+.5,A[1]+=o+.5,E[1]+=o+.5,M=x=r+.5,S=Math.min(o,f),C=Math.max(o,f)+1,T=Math.min(a,m)+.5,k=Math.max(a,m)+1.5;break;case"y":P=h-(a+.5),I=u-(r+.5),A=_(s-(a+.5),c-(r+.5),l),E=_(P,I,d),A[0]+=a+.5,E[0]+=a+.5,A[1]+=r+.5,E[1]+=r+.5,M=x=a+.5,S=Math.min(r,g),C=Math.max(r,g)+1,T=Math.min(o,f)+.5,k=Math.max(o,f)+1.5;break;case"z":P=h-(a+.5),I=d-(o+.5),A=_(s-(a+.5),l-(o+.5),c),E=_(P,I,u),A[0]+=a+.5,E[0]+=a+.5,A[1]+=o+.5,E[1]+=o+.5,M=x=a+.5,S=Math.min(o,f),C=Math.max(o,f)+1,T=Math.min(r,g)+.5,k=Math.max(r,g)+1.5;break;default:return void console.log("[XCollide] Unmanaged portal orientation.")}var R=A[0]>x&&E[0]<M||A[0]<x&&E[0]>M,D=A[1]>S&&A[1]<C&&E[1]>S&&E[1]<C,z=A[2]+.5>T&&A[2]+.5<k&&E[2]+.5>T&&E[2]+.5<k;R&&D&&z&&(p=!0,n.interpolateSwitchWorld())}else console.warn("[Self/Intersection] Invalid portal found: ".concat(y,"."))}else console.warn("[Self/Intersection] Corrupt portal found: ".concat(e,"."))}}))}else console.warn("[Self/Interpolate] Didn’t find any portal in world ".concat(o,"."))}},On={updatePosition:function(e,t){var n=this.app.engine.graphics,i=t.position;i.copy(e),this.originalZ=i.z,n.cameraManager.updateCameraPosition(i),this.updateCupHelper(i)},updateCupHelper:function(e){var t=this.app.model.backend.entityModel,n=t.helperCupID;if(n<0)this.canTalkToCup=!1;else{var i=t.lookers.get(n.toString());if(i){var a,o=i.graphicalComponent;if(o&&(a=o.position)){var r,s=a.distanceTo(e)/3,l=o.children[0].children[3];s<1?(this.canTalkToCup=!0,r=.8*Math.min(Math.sqrt(1-s),.5)):(this.canTalkToCup=!1,r=.001),l.scale.set(r,r,r)}else this.canTalkToCup=!1}else this.canTalkToCup=!1}},setRotation:function(e,t){t||(t=this.avatar),t.rotation.x=e.x+Math.PI/2,t.rotation.y=e.y+0,t.getInnerObject().rotation.y=e.z},getRotation:function(){var e=this.avatar;if(r(!!e,"[SelfModel] Cannot get avatar."),e){var t=e.getInnerObject();return this._r.set(e.rotation.x,e.rotation.y,t.rotation.y),this._r}},getRotationX:function(){return r(!!this.avatar,"[SelfModel] Cannot get avatar."),this.avatar.rotation.x},getRotationY:function(){return r(!!this.avatar,"[SelfModel] Cannot get avatar."),this.avatar.rotation.y},getTheta:function(){return r(!!this.avatar,"[SelfModel] Cannot get avatar."),this.avatar.getInnerObject().rotation.y},setBounceAmount:function(e){this.bounceAmount=e,this.avatar.position.z=this.originalZ+e},getBounceAmount:function(){return this.bounceAmount},updateRotation:function(e,t){var n=this.app.engine.graphics,i=this.handItemWrapper;e.rotation.x=t.w+Math.PI/2,e.rotation.y=t.x,e.rotation.z=t.z+Math.PI;var a=t.z,o=t.w,r=n.cameraManager.mainCamera.getXRotation();n.cameraManager.setAbsRotationFromServer(a,o)&&n.cameraManager.setRelRotation(t.x,r);var s=this.handItem;if(s&&i){var l=n.cameraManager.mainCamera;i.rotation.copy(l.up.rotation),s.rotation.x=l.pitch.rotation.x,s.rotation.z=l.yaw.rotation.z}},updateWorld:function(){var e=this.app.engine.graphics,t=this.avatar,n=this.handItemWrapper,i=this.xModel,a=this.worldId,o=this.oldWorldId,r=this.displayAvatar,s=this.displayHandItem;r&&e.removeFromScene(t,o),s&&e.removeFromScene(n,o),e.switchToScene(o,a),i.switchAvatarToWorld(o,a),r&&e.addToScene(t,a),s&&e.addToScene(n,a),i.forceUpdate=!0}},Ln={loadSelfGraphics:function(){var e=this,t=this.app.engine.graphics,n=e.worldId,i=t.loadReferenceMeshFromMemory("tato",!1,!0);e.avatar=i,t.animationManager.addSkinnedEntityAnimation(0,i,e.animationComponent),this.footstepMeshes=[];for(var a=this.app.model.backend.entityModel,o=0;o<4;++o){var r=a.createFootStepMesh();t.addToScene(r),this.footstepMeshes.push(r)}try{i.children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0].children[0].material=new w.vBJ({color:"#9d9d9d"})}catch(e){console.error("[Self/Objetts] Invalid skeleton hierarchy.")}t.addToScene(e.avatar,n)},loadSelf:function(){var e=this.app.engine.graphics,t=this.worldId,n=e.createMesh(e.createGeometry("box"),e.createMaterial("flat-phong",{color:65535})),i=new w.Tme,a=new w.Tme;i.rotation.reorder("ZYX"),i.add(a),a.add(n),i.getWrapper=function(){return a},n.scale.multiplyScalar(1),this.avatar=i,e.addToScene(this.avatar,t)},initMelee:function(){var e=this.app.engine.graphics;if(!this.meleeEffectMesh){var t=this.app.model.backend.entityModel;this.meleeEffectMesh=t.createMeleeMesh()}var n=this.worldId,i=this.meleeEffectMesh;null!==this.meleeWorld&&this.meleeWorld!==n&&e.removeFromScene(i,this.meleeWorld,!0),this.meleeWorld=n,this.isHittingMelee=!0,i.getMesh().material.uniforms.time.value=0;var a=this.avatar.position;i.position.copy(a),e.addToScene(i,n)},updateMelee:function(){var e=this.app.engine.graphics,t=this.meleeEffectMesh,n=t.getMesh().material.uniforms;if(n.time.value+=.1,n.time.value<2){this.isHittingMelee=!0;var i=e.cameraManager.mainCamera,a=e.cameraManager.mainCamera.up.position;t.position.copy(a),t.rotation.copy(i.up.rotation),t.getWrapper().rotation.x=-Math.PI/2+.2+i.pitch.rotation.x,t.getWrapper().rotation.z=i.yaw.rotation.z}else this.isHittingMelee=!1,this.meleeWorld=null,e.removeFromScene(t,this.meleeWorld,!0)},updateBow:function(){var e=this.app.engine.graphics.animationManager,t=e.times,n=e.mixers,i=e.clips,a=n.get("yumi");if(a)if(this.needsStartLoadingBow){a.setTime(0),a.update(0);var o=i.get("yumi");o.reset(),o.play(),t.set("yumi",Date.now()),this.needsStartLoadingBow=!1,this.needsStopLoadingBow=!1,this.loadingBow=!0}else if(this.needsStopLoadingBow)this.needsStartLoadingBow=!1,this.needsStopLoadingBow=!1,a.setTime(0),a.update(0),this.isLoadingBow=!1;else if(this.isLoadingBow){var r=t.get("yumi")||Date.now(),s=Date.now(),l=.001*(s-r);a.update(l),t.set("yumi",s)}},updateHandItem:function(){var e,t=this,n=this.app.engine.graphics,i=this.worldId,a=this.app.model.frontend.selfComponent.getCurrentItemID();if(E.isItemNaught(a)?e=null:E.isItemRanged(a)||E.isItemMelee(a)||E.isItemX(a)||E.isItemBlock(a)?e=n.getItemMesh(a,!0,!1):(console.warn("[ServerSelf] Handheld item unrecognized."),e=null),t.handItem!==e){var o=t.handItemWrapper;t.handItem&&o.remove(t.handItem),t.handItem=e,e&&(o.position.copy(n.cameraManager.mainCamera.up.position),this.cameraMoved(n.cameraManager.mainCamera),o.add(e),t.displayHandItem&&n.addToScene(o,i))}this.needsStopLoadingBow=!0,this.needsStartLoadingBow=!1}},_n=function(e){this.app=e,this.xModel=null,this.entityId="-1",this.worldId="-1",this.oldWorldId=null,this.position=new w.Pa4(0,0,0),this.rotation=new w.Ltg(0,0,0,0),this.inventoryModel=new kn,this._r=new w.Pa4(0,0,0),this.animationComponent=Object.create(null),this.physicsEntity=null,this.footstepMeshes=[],this.currentFootStep=0,this.locked=!1,this.canTalkToCup=!1,this.worldNeedsUpdate=!1,this.needsUpdate=!1,this.displayAvatar=!0,this.displayHandItem=!1,this.avatar=null,this.bounceAmount=0,this.originalZ=0,this.handItem=null,this.handItemWrapper=new w.Tme,this.handItemWrapper.rotation.reorder("ZYX"),this.meleeEffectMesh=null,this.needsStartMelee=!1,this.isHittingMelee=!1,this.meleeWorld=null,this.isLoadingBow=!1,this.needsStartLoadingBow=!1,this.needsStopLoadingBow=!1,this.useInterpolation=!1,this.useInterpolation&&this.initInterpolation()};a(_n.prototype,{init:function(e){this.loadSelfGraphics();var t=this.app.engine.graphics.animationManager,n=this.getTheta();t.initializeEntityAnimation(this.animationComponent,n);var i=e.getPlayer();if(i){var a=(new w.Pa4).fromArray(i.position),o=(new w.Ltg).fromArray(i.rotation);this.updateSelf(a,o,"-1"),this.updatePosition(this.position,this.avatar),this.setRotation(this.rotation,this.avatar),this.app.engine.physics.addCharacterController(this),this.lock()}},flipXYMain:function(){this.avatar.userData.isMainXYFlipped=!0},unlock:function(){this.locked=!1},lock:function(){this.locked=!0},refresh:function(){if(!this.needsUpdate)return this.useInterpolation&&!this.interpolationUpToDate&&this.interpolatePredictSelfPosition(),this.isHittingMelee&&this.updateMelee(),void this.updateBow();this.avatar&&(this.useInterpolation&&!this.interpolationUpToDate?this.interpolatePredictSelfPosition():this.directUpdateSelfPosition(),this.needsStartMelee&&(this.needsStartMelee=!1,this.initMelee()),this.isHittingMelee&&this.updateMelee(),this.updateBow(),this.needsUpdate=!1)},directUpdateSelfPosition:function(){var e=this.position;this.updatePosition(e,this.avatar)},updateSelf:function(e,t,n,i){n=n.toString();var a=this.position,o=this.rotation,r=this.worldId;if(a&&o&&a.x===e.x&&a.y===e.y&&a.z===e.z&&o.x===t.x&&o.y===t.y||(this.position.copy(e),this.rotation.copy(t),this.needsUpdate=!0,this.useInterpolation&&(this.interpolationUpToDate=!1)),r&&r===n||(this.needsUpdate=!0,this.worldNeedsUpdate=!0,this.oldWorldId=this.worldId,this.newWorldId=n),i){i[1]&&(this.needsStartMelee=!0);var s=!!i[2];s!==this.isLoadingBow&&(this.isLoadingBow=s,this.isLoadingBow?(this.needsStartLoadingBow=!0,this.needsStopLoadingBow=!1):(this.needsStopLoadingBow=!0,this.needsStartLoadingBow=!1))}},cameraMoved:function(e){var t=this.handItem;t&&(t.rotation.x=e.pitch.rotation.x,t.rotation.z=e.yaw.rotation.z,this.handItemWrapper.rotation.copy(e.up.rotation))},getSelfPosition:function(){return this.position},getHeadPosition:function(){var e=this.avatar.getHead();return e?e.position:null},getInventory:function(){return this.inventoryModel},getTime:function(){return window.performance.now()},cleanup:function(){this.entityId="-1",this.worldId="-1",this.oldWorldId=null,this.position.set(0,0,0),this.rotation.set(0,0,0,0),this.inventoryModel.reset(),this.locked=!1,this.canTalkToCup=!1,this.worldNeedsUpdate=!1,this.needsUpdate=!1,this.displayAvatar=!0,this.displayHandItem=!0,this.avatar=null,this.lastServerUpdateTime=this.getTime(),this.averageDeltaT=-1}}),a(_n.prototype,En),a(_n.prototype,On),a(_n.prototype,Ln),a((Pn=function(e,t){this.nodeId=e,this.parentArcs=t?[t]:[],this.childrenArcs=[]}).prototype,{getNodeId:function(){return this.nodeId},getNumberOfChildren:function(){return this.childrenArcs.length},addExistingChild:function(e,t,n){var i=new In(this,t,e);return n.setArc(e,this),t.parentArcs.push(i),this.childrenArcs.push(i),t},addNewChild:function(e,t,n){var i=new Pn(t),a=new In(this,i,e);return n.setArc(e,a),i.parentArcs.push(a),this.childrenArcs.push(a),i},getParentArcs:function(){if(null===this.parentArcs)throw Error("Root has no parent.");return this.parentArcs},getChildrenArcs:function(){return this.childrenArcs},forEachChild:function(e){this.childrenArcs.forEach((function(t){e(t)}))}}),a((In=function(e,t,n){this.arcId=n,this.parentNode=e,this.childNode=t}).prototype,{getChild:function(){return this.childNode},getParent:function(){return this.parentNode},getArcId:function(){return this.arcId}}),a((An=function(e){this.root=new Pn(e,null),this.nodes=new Map,this.arcs=new Map,this.nodes.set(e,this.root),this.flatGraph=[]}).prototype,{setArc:function(e,t){this.arcs.has(e)&&console.log("XGraph: adding an existing arc to the graph."),this.arcs.set(e,t)},insertNode:function(e,t,n,i){e="".concat(e,",").concat(t);var a=this.nodes.get(i);a||(a=new Pn(i,null),this.nodes.set(i,a));var o=this.nodes.get(n);return o?a.addExistingChild(e,o,this):(o=a.addNewChild(e,n,this),this.nodes.set(n,o)),o},hasNode:function(e){return this.nodes.has(e)},getNode:function(e){return this.nodes.get(e)},switchRoot:function(e,t){var n=this.root;if(n.getNodeId()===e){var i=n.getChildrenArcs();if(i)for(var a,o=0,r=i.length;o<r;++o)if((a=i[o].getChild())&&a.getNodeId()===t){this.root=a;break}}else console.log("XGraph Error: trying to switch from invalid root.")},applyFromPosition:function(e,t,n){var i=this.root;if(e){var a=this.arcs.get(e);if(!a)return void console.log("Error at XGraph: starter arc not found.");i=a.getChild()}var o=new Set,r=new Map;r.set(i.getNodeId(),0);var s=[],l=[],c=[],h=i.childrenArcs;if(h){h.forEach((function(e){s.push(e),l.push("".concat(e.getArcId())),c.push(1)}));for(var d,u,p,m=Number.POSITIVE_INFINITY;s.length>0;){d=s.pop(),p=l.pop(),u=c.pop();var f=d.getArcId();o.add(f),f===t&&(m=u);var g=d.getChild();if(!(g&&r.get(g.getNodeId())<u)){n(d,p,u);var v=u+1;if(!(v>m)&&g){var y=g.getNodeId();if(!(r.get(y)<v)){r.set(y,v);for(var w=g.getChildrenArcs(),b=0,x=w.length;b<x;++b){var M=w[b],S=M.getArcId();o.has(S)||(s.push(M),c.push(v),l.push("".concat(p,",").concat(S)))}}}}}}else console.log("XGraph: no arc found.")},computeString:function(){for(var e,t="",n=this.flatGraph,i=0,a=n.length;i<a;++i){for(var o=(e=n[i]).depth,r=e.type,s=e.pid,l=e.origin,c=e.destination,h=e.path,d=e.wpath,u=0,p=o;u<p;++u)t+="   ";t+="".concat(r," w.").concat(l," w.{").concat(c,"} p.").concat(s," // ").concat(h,"|").concat(d),t+="\n"}return t},computeCameraTransform:function(e,t){for(var n=[0,0,0,0,0,0],i=0,a=e.length;i<a;++i){var o=e[i].split(","),r=parseInt(o[0],10),s=t.get(r),l=parseInt(o[1],10),c=t.get(l);if(c&&s){var h=s.tempPosition,d=s.tempOtherPosition,u=c.tempPosition,p=c.tempOtherPosition,m=h[0]!==d[0],f=u[0]!==p[0],g=h[1]!==d[1],v=u[1]!==p[1],y=h[2]!==d[2],w=u[2]!==p[2];if(m+g+y!==1||f+v+w!==1)return void console.warn("[Tree/CameraTransform]: unmanaged portal type.");var b=0,x=0,M=0,S=0,C=0,T=0;switch(!0){case m:b=.5*(h[0]+d[0]),x=.5+h[1],M=.5+d[2];break;case g:x=.5*(h[1]+d[1]),b=.5+h[0],M=.5+d[2];break;case y:M=.5*(h[2]+d[2]),x=.5+h[1],b=.5+d[0]}switch(!0){case f:S=.5*(u[0]+p[0]),C=.5+u[1],T=.5+p[2];break;case v:C=.5*(u[1]+p[1]),S=.5+u[0],T=.5+p[2];break;case w:T=.5*(u[2]+p[2]),C=.5+u[1],S=.5+p[0]}var k=s.tempOrientation,P=c.tempOrientation;n[0]+=S-b,n[1]+=C-x,n[2]+=T-M,n[3]+=P-k}}return n},computeRenderingGraph:function(e,t){var n=this.flatGraph;if(!(n.length<1)){e.flushPortalUpdates();for(var i,a,o,r,s,l,c,h,d=e.cameraManager,u=t.portals,p=0,m=n.length;p<m;++p){a=(i=n[p]).destination,o=parseInt(i.pid.split(",")[0],10),r=parseInt(i.pid.split(",")[1],10),l=(s=i.path).split(";"),c=i.depth;var f=void 0,g=void 0;switch(i.type){case"lime":if(f=u.get(o),g=u.get(r),!f||!g){console.log("Problem while adding portal ".concat(o)+" / ".concat(r)),console.log("Origin: ".concat(f,", Destination ").concat(g));continue}h=this.computeCameraTransform(l,u,d),e.addPortalObject(f,g,s,h,c,o,r,a,s);break;case"orange":break;case"yellow":if(f=u.get(o),g=u.get(r),!f||!g){console.log("Problem while adding portal ".concat(o)+" / ".concat(r)),console.log("Origin: ".concat(f,", Destination ").concat(g));continue}console.log(l);var v=l.length;if(v<1)return void console.error("[X/Tree] Expected a longer camera path.");h=this.computeCameraTransform(l,u,d),e.addPortalObject(f,g,s,h,c,o,r,a,s);var y=l.slice(),w=l[v-1].split(","),b="".concat(w[1],",").concat(w[0]);y[v-1]=b;var x=y.join(";");h=this.computeCameraTransform(y,u,d),e.addPortalObject(g,f,x,h,c,r,o,a,x)}}e.unflushPortalUpdates()}},computeFlatGraph:function(){for(var e,t,n,i,a,o,r,s,l=[],c=new Set,h=new Set,d=[this.root],u=[null],p=0,m=[""],f=[""],g=[p],v=[null],y=new Map,w=new Map,b=!1;d.length>0;){t=d.pop(),p=g.pop(),i=v.pop(),r=f.pop(),s=m.pop(),o=u.pop(),n=t.getNodeId(),b=c.has(n);var x=r.split(";"),M=x.pop().split(",").reverse();x.pop(),x.push(M);var S=x.join(";"),C=r.split(";");C.pop(),C.join(";");var T=s.split(";");if(i&&(a=i.getArcId(),e={},b&&o&&o.getNodeId()===n?e.type="yellow":b&&h.has(S)?e.type="cyan":b&&T.indexOf(n)>-1?e.type="red":b?e.type="orange":b||(e.type="lime"),e.depth=p,e.origin=o.getNodeId(),e.destination=n,e.pid=a,e.path=r,e.wpath=s,l.push(e)),!b){(!y.has(n)||p<y.get(n))&&(w.set(n,r),y.set(n,p)),c.add(n),h.add(r);for(var k=p+1,P=t.getChildrenArcs(),I=0,A=P.length;I<A;++I){var E=P[I];v.push(E),d.push(E.getChild());var O="";r.length>0&&E.getArcId()&&(O=";"),f.push(r+O+E.getArcId()),s.length>0&&n.length>0&&(O=";"),m.push(s+O+n),g.push(k),u.push(E.getParent())}}}return this.flatGraph=l,this.flatGraph}});var Rn=function(e){this.xModel=e,this.xGraph=null,this.string="",this.needsUpdate=!0};a(Rn.prototype,{switchRoot:function(e,t){this.xGraph.switchRoot(e,t),this.invalidate()},computeWorldMap:function(){var e,t,n,i,a=this.xModel.portals,o=this.xModel.selfModel.worldId,r=new An(parseInt(o,10));return a.forEach((function(o,s){i=o.worldId,(e=o.portalLinkedForward)&&(t=a.get(e))&&(n=t.worldId,r.insertNode(parseInt(s,10),parseInt(e,10),parseInt(n,10),parseInt(i,10)))})),this.xGraph=r,this},computeFlatGraph:function(){return this.xGraph.computeFlatGraph()},computeRenderingGraph:function(e){return this.xGraph.computeRenderingGraph(e,this.xModel)},invalidate:function(){return this.needsUpdate=!0,this},renderString:function(){return this.computeWorldMap(),this.xGraph.computeFlatGraph(),this.string=this.xGraph.computeString(),this.needsUpdate=!1,this.string},computeString:function(){return this.needsUpdate&&this.renderString(),this.string}});var Dn=function(e,t,n,i,a,o,r,s){this.portalId=e,this.portalLinkedForward=t,this.chunkId=n,this.worldId=i;var l=a[0],c=o[0],h=a[1],d=o[1],u=a[2],p=o[2];r&&(this.tempOffset=r>=.001&&r<=.999?r:.999),this.tempOrientation=s,this.tempPosition=[l,h,u],this.tempOtherPosition=[c,d,p],this.tempWidth=1,this.tempHeight=2};a(Dn.prototype,{});var zn={addPortal:function(e,t,n,i,a,o,r,s){console.log("Adding portal ".concat(e," and linking to ").concat(t)),e=parseInt(e,10),this.portals.has(e)&&console.log("Portal ".concat(e," was here already..."));var l=new Dn(e,t,n,i,a,o,r,s);this.portals.set(e,l);var c=this.worldToPortals.get(i);c?c.add(e):((c=new Set).add(e),this.worldToPortals.set(i,c))},removePortal:function(e){e=parseInt(e,10);var t=this.portals,n=this.worldToPortals,i=t.get(e);if(i||console.log("\t... portal ".concat(e," not present in model.")),t.delete(e),i){var a=i.worldId,o=n.get(a);o.delete(e),o.size<1&&n.delete(a)}}},Fn=function(e,t){this.app=e,this.selfModel=t,this.portals=new Map,this.worldToPortals=new Map,this.worldMap=new Rn(this),this.xUpdates=[],this.needsUpdate=!1,this.forceUpdate=!1};a(Fn.prototype,{init:function(){},refresh:function(){if(this.needsUpdate||this.forceUpdate){for(var e=this.app.register,t=this.worldMap,n=this.xUpdates,i=!1,a=this.app.engine.graphics,o=0,r=n.length;o<r;++o){var s=n[o];for(var l in s)if(s.hasOwnProperty(l)){var c=s[l];if(c instanceof Array&&c.length>0){var h=c[0],d=c[1],u=c[2],p=[c[3],c[4],c[5]],m=[c[6],c[7],c[8]],f=c[9],g=c[10];this.addPortal(l,h,d,u,p,m,f,g),i=!0}else this.removePortal(l),i=!0}}if(i||this.forceUpdate){var v=t.invalidate().computeWorldMap().computeFlatGraph();e.updateSelfState({diagram:v}),t.computeRenderingGraph(a),this.forceUpdate=!1}this.xUpdates=[],this.needsUpdate=!1}},updateX:function(e){this.xUpdates.push(e),this.needsUpdate=!0},switchAvatarToWorld:function(e,t){console.log("[X] Switching avatar to other world"),e=parseInt(e,10),t=parseInt(t,10),this.worldMap.switchRoot(e,t)},cleanup:function(){this.portals.clear(),this.worldToPortals.clear(),this.worldMap=new Rn(this),this.xUpdates=[],this.needsUpdate=!1,this.forceUpdate=!1}}),a(Fn.prototype,zn);var Bn=function(e){this.app=e,this.selfModel=new _n(e),this.chunkModel=new Oe(e),this.entityModel=new Tn(e),this.xModel=new Fn(e,this.selfModel),this.selfModel.xModel=this.xModel,this.isRunning=!1};a(Bn.prototype,{updateMe:function(e){if(this.isRunning){var t=e[0],n=t[0],i=t[1],a=t[2],o=t[3];this.selfModel.updateSelf(n,i,a,o)}},updateEntities:function(e){this.isRunning&&this.entityModel.updateEntities(e)},updateChunks:function(e){this.isRunning&&this.chunkModel.updateChunks(e)},updateX:function(e){this.isRunning&&this.xModel.updateX(e)}}),a(Bn.prototype,{init:function(e){this.isRunning=!0,this.selfModel.init(e),this.chunkModel.init(e),this.entityModel.init(e),this.xModel.init()},stop:function(){this.isRunning=!1},refresh:function(){this.selfModel.refresh(),this.chunkModel.refresh(),this.entityModel.refresh(),this.xModel.refresh()},getSelfModel:function(){return this.selfModel},cleanupFullModel:function(){this.selfModel.cleanup(),this.chunkModel.cleanup(),this.entityModel.cleanup(),this.xModel.cleanup()}});var Wn=function(e){this.clientModel=e,this._cameraInteraction="third-person",this.cameraInteraction={isFirstPerson:function(){return"first-person"===this._cameraInteraction}.bind(this),isThirdPerson:function(){return"third-person"===this._cameraInteraction}.bind(this)},this.currentItemSlot=0,this.angleFromIntersectionPoint=0,this.changes=[],this._itemOffset=.999};a(Wn.prototype,{init:function(){this.clientModel.app.register.updateSelfState({itemSelected:this.currentItemSlot})},cleanup:function(){this.currentItemSlot=0,this._cameraInteraction="third-person"},getCurrentItemID:function(){},setAngleFromIntersectionPoint:function(e){this.angleFromIntersectionPoint=e},getAngleFromIntersectionPoint:function(){return this.angleFromIntersectionPoint},getItemOffset:function(){return this._itemOffset},triggerChange:function(e,t){this.changes.push([e,t])},processChanges:function(){var e=this.changes;if(!(e.length<1)){for(var t=0;t<e.length;++t){var n=e[t],i=n[0],a=n[1];if(!i||!a)return;switch(i){case"camera-update":this.processSimpleCameraUpdate();break;case"camera":this.processCameraModeChange(a);break;case"interaction":this.processInteractionChange(a)}}this.changes=[]}},processSimpleCameraUpdate:function(){this.clientModel.app.engine.graphics.cameraManager.updateCameraRotation(0,0,0,0)},processCameraModeChange:function(e){var t,n=this.clientModel.app.model.backend.selfModel,i=this.clientModel.app.engine.graphics,a=n.avatar,o=n.worldId;t="toggle"===e[0]&&!n.displayAvatar,n.displayAvatar=t,this._cameraInteraction=t?"third-person":"first-person",i.changeAvatarVisibility(t,a,o),i.cameraManager.updateCameraPosition(n.position)},processInteractionChange:function(e){}});var jn={triggerUse:function(e,t){var n=this.clientModel.selfComponent.getCurrentItemID();E.isItemIDSupported(n)||console.error("[Client/Event] Item ID unsupported");var i=this.eventsToPush;E.isItemMelee(n)?(t.push("melee"),t.push(n),i.push([e,t])):E.isItemRanged(n)&&(t.push("ranged"),t.push(n),i.push([e,t]))},triggerRayAction:function(e,t){var n=this.clientModel.selfComponent,i=n.getCurrentItemID();if(E.isItemIDSupported(i))if(E.isItemBlock(i))"add"===t[0]&&(t.pop(),t.splice(-3,3),t.push(i)),this.triggerBlock("b",t);else if(E.isItemX(i)){var a=t[1],o=t[2],r=t[3],s=t[4],l=t[5],c=t[6],h=E.isItemX2(i),d=t[7];t.pop(),s<a&&(t[1]=s,t[4]=a),l<o&&(t[2]=l,t[5]=o),c<r&&(t[3]=c,t[6]=r),t.push(n.getItemOffset()),t.push(n.getAngleFromIntersectionPoint()),t.push(h),t.push(d),this.triggerBlock("x",t)}else E.isItemNaught(i)&&"del"===t[0]?this.triggerBlock("b",t):console.warn("[Client/Event] Unsupported item.");else console.error("[Client/Event] Item ID unsupported")},triggerMovement:function(e,t,n){var i=this.activeControls,a=this.eventsToPush,o=function(){a.push([e,t,n])};switch(this.getEventsOfType(e).length,t){case"f":i.forward||o(),i.forward=!0;break;case"r":i.right||o(),i.right=!0;break;case"l":i.left||o(),i.left=!0;break;case"b":i.backwards||o(),i.backwards=!0;break;case"d":i.down||o(),i.down=!0;break;case"u":i.up||o(),i.up=!0;break;case"vec":i.vec=!0,o();break;case"vecx":i.vec=!1,o();break;case"run":i.run||o(),i.run=!0;break;case"runx":i.run&&o(),i.run=!1;break;case"fx":i.forward=!1,o();break;case"rx":i.right=!1,o();break;case"lx":i.left=!1,o();break;case"bx":i.backwards=!1,o();break;case"dx":i.down=!1,o();break;case"ux":i.up=!1,o();break;case"xx":i.forward=!1,i.backwards=!1,i.right=!1,i.left=!1,o();break;default:console.log("Unrecognized movement, could not trigger.")}},triggerAction:function(e,t){var n=this.eventsToPush;switch(t){case"g":n.push([e,t]);break;default:console.log("Unrecognized action, could not trigger.")}},triggerRotation:function(e,t){this.eventsToPush.push([e,t])},triggerBlock:function(e,t){this.eventsToPush.push([e,t])}},Nn=function(e){this.clientModel=e,this.eventsToPush=[],this.activeControls={},this.numberOfEvents=0,this.maxNumberOfEventsPer16ms=1e4};a(Nn.prototype,{init:function(){this.activeControls=this.getActiveControls()},triggerEvent:function(e,t,n){switch(e){case"m":this.triggerMovement(e,t,n);break;case"a":this.triggerAction(e,t);break;case"r":this.triggerRotation(e,t);break;case"u":this.triggerUse(e,t);break;case"ray":this.triggerRayAction(e,t)}this.numberOfEvents++},pushEvents:function(){if(!this.clientModel.app.model.backend.selfModel.locked){var e=this.eventsToPush,t=this.maxNumberOfEventsPer16ms;this.numberOfEvents>t&&(this.filterEvents(),console.log("Calm down, user... ".concat(this.numberOfEvents," unstacked events detected.")));for(var n=0,i=e.length;n<i;++n){var a=e[n];this.clientModel.app.engine.physics.pushEvent(a)}this.eventsToPush=[],this.numberOfEvents=0}},getEventsOfType:function(e){for(var t=this.eventsToPush,n=[],i=0,a=t.length;i<a;++i){var o=t[i];o[0]===e&&n.push(o)}return n},filterEvents:function(){for(var e,t=this.eventsToPush,n=[],i=0,a=t.length;i<a;++i){var o=t[i];o&&("r"!==o[0]?e=t[i]:n.push(o))}n.push(e),this.eventsToPush=n}}),a(Nn.prototype,jn),a(Nn.prototype,{getActiveControls:function(){return{forward:!1,backwards:!1,right:!1,left:!1,up:!1,down:!1,run:!1,vec:!1}}});var Un=function(e){this.app=e,this.selfComponent=new Wn(this),this.eventComponent=new Nn(this)};a(Un.prototype,{init:function(){this.selfComponent.init(),this.eventComponent.init()},refresh:function(){this.selfComponent.processChanges(),this.eventComponent.pushEvents()},pushForLaterUpdate:function(e){this.selfComponent.triggerChange("camera-update",e)},triggerEvent:function(e,t,n){this.eventComponent.triggerEvent(e,t,n)},triggerChange:function(e,t){this.selfComponent.triggerChange(e,t)},getCameraInteraction:function(){return this.selfComponent.cameraInteraction},cleanupFullModel:function(){this.selfComponent.cleanup()}});var Vn=function(e){this.register=e};a(Vn.prototype,{initModule:function(){},disposeModule:function(){},updateChat:function(e){console.log(e)},sendMessage:function(e){this.register.sendMessage("chat",e)}});var Hn=function(e){this.register=e,this.orangeColor="#c96530",this.html='\n        <div id="hud" class="noselect">\n            <div id="position"></div>\n            <div id="diagram"></div>\n            <div id="mini-map"></div>\n            \x3c!-- <div id="chat"></div>--\x3e\n        </div>\n    '};a(Hn.prototype,{initModule:function(){},disposeModule:function(){l()("#hud").remove(),l()("#items").remove()},updateSelfState:function(e){if(e.hasOwnProperty("position")){var t=Math.floor,n=e.position,i="".concat(t(n[0]),", ").concat(t(n[1]),", ").concat(t(n[2]));l()("#position").text(i).css("color",this.orangeColor)}if(e.hasOwnProperty("itemSelect")){var a=e.itemSelect[0],o=e.itemSelect[1];(a<0||a>7||o<0||o>7)&&console.error("[HUD] Invalid item slot."),l()("#item".concat(o)).removeClass("selected"),l()("#item".concat(a)).addClass("selected")}}}),a(Hn.prototype,{initInventory:function(){}});var Gn=function(){this.modules={}};a(Gn.prototype,{registerDefaultModules:function(){this.registerModule("chat",new Vn(this)),this.registerModule("hud",new Hn(this))},registerModule:function(e,t){if(this.modules.hasOwnProperty(e))throw Error("Error: module already registered.");this.modules[e]=t},gameStarted:function(){for(var e in this.modules)if(this.modules.hasOwnProperty(e)){var t=this.modules[e];"function"==typeof t.initModule&&t.initModule()}},gameStopped:function(){for(var e in this.modules)if(this.modules.hasOwnProperty(e)){var t=this.modules[e];"function"==typeof t.disposeModule&&t.disposeModule()}},updateSelfState:function(e){this.modules.hud.updateSelfState(e)},updateChat:function(e){this.modules.chat.updateChat(e)},sendMessage:function(){console.log("Sending message.")}});var qn,Yn,Xn,Kn,Zn=function(e){this.app=e,this.intelligentEntities=new Map,this._debug=!1};function Jn(){return new Worker(n.p+"engine.worker.b72d6aae5569070818f2.worker.js")}function Qn(){this.tolerance=-1,this.faces=[],this.newFaces=[],this.assigned=new ni,this.unassigned=new ni,this.vertices=[]}function $n(){this.normal=new w.Pa4,this.midpoint=new w.Pa4,this.area=0,this.constant=0,this.outside=null,this.mark=0,this.edge=null}function ei(e,t){this.vertex=e,this.prev=null,this.next=null,this.twin=null,this.face=t}function ti(e){this.point=e,this.prev=null,this.next=null,this.face=null}function ni(){this.head=null,this.tail=null}function ii(e,t){var n,i,a,o,r,s=!1;"mesh"!==t&&"convex"!==t||(s=!0);var l=e.isBufferGeometry?(new z.Z).fromBufferGeometry(e):e;l.mergeVertices();var c=e.attributes.position.array.length/3,h=l.vertices.length,d=l.faces.length;e.realVertices=new Float32Array(3*h),e.realIndices=new(3*d>65535?Uint32Array:Uint16Array)(3*d),e.setAttribute("color",new w.TlE(new Float32Array(3*c),3));var u=e.attributes.color.array;for(n=c;n--;)u[a=3*n]=1,u[a+1]=1,u[a+2]=1;for(n=h;n--;)o=l.vertices[n],a=3*n,e.realVertices[a]=o.x,e.realVertices[a+1]=o.y,e.realVertices[a+2]=o.z;for(n=d;n--;)o=l.faces[n],a=3*n,e.realIndices[a]=o.a,e.realIndices[a+1]=o.b,e.realIndices[a+2]=o.c;if(l.dispose(),s){var p=[];for(n=e.realIndices.length;n--;)a=3*n,o=3*e.realIndices[n],p[a]=e.realVertices[o],p[a+1]=e.realVertices[o+1],p[a+2]=e.realVertices[o+2];return p}var m=[],f=e.attributes.position.array;for(n=h;n--;)for(a=3*n,m[n]=[],i=c;i--;)f[r=3*i]===e.realVertices[a]&&f[r+1]===e.realVertices[a+1]&&f[r+2]===e.realVertices[a+2]&&m[n].push(i);var g=new(h>65535?Uint32Array:Uint16Array)(h),v=new(c>65535?Uint32Array:Uint16Array)(c);for(o=0,n=0;n<h;n++){for(a=m[n].length,g[n]=o,i=a;i--;)v[o+i]=m[n][i];o+=a}e.numFaces=d,e.numVertices=h,e.maxi=c,e.pPoint=g,e.lPoint=v}function ai(e,t,n,i){w.u9r.call(this),this.type="Capsule",e=e||1,t=t||1;var a=Math.PI;n=Math.floor(n)||12;var o=Math.floor(.5*n);i=Math.floor(i)||1;var r=2*Math.PI,s=.5*Math.PI,l=new z.Z,c=new w.fHI(e,e,t,n,i,!0),h=new w.yGw,d=new w.xo$(e,n,o,0,r,0,s),u=new w.xo$(e,n,o,0,r,s,s),p=(new w.yGw).makeTranslation(0,0,0),m=(new w.yGw).makeTranslation(0,.5*t,0),f=(new w.yGw).makeTranslation(0,.5*-t,0);h.makeRotationZ(a),l.merge(c,p.multiply(h)),l.merge(d,m),l.merge(u,f),l.mergeVertices(),l.computeVertexNormals(),c.dispose(),d.dispose(),u.dispose(),this.fromGeometry(l),l.dispose()}function oi(e){z.Z.call(this),this.fromBufferGeometry(new ri(e)),this.mergeVertices()}function ri(e){w.u9r.call(this);for(var t=[],n=[],i=(new Qn).setFromPoints(e).faces,a=0;a<i.length;a++){var o=i[a],r=o.edge;do{var s=r.head().point;t.push(s.x,s.y,s.z),n.push(o.normal.x,o.normal.y,o.normal.z),r=r.next}while(r!==o.edge)}this.setAttribute("position",new w.a$l(t,3)),this.setAttribute("normal",new w.a$l(n,3))}a(Zn.prototype,{refresh:function(){var e=this;this.intelligentEntities.forEach((function(t,n){e._debug&&console.log("".concat(t,", ").concat(n))}))},cleanupFullAI:function(){this.intelligentEntities.clear()}}),Object.assign(Qn.prototype,{setFromPoints:function(e){!0!==Array.isArray(e)&&console.error("ConvexHull: Points parameter is not an array."),e.length<4&&console.error("ConvexHull: The algorithm needs at least four points."),this.makeEmpty();for(var t=0,n=e.length;t<n;t++)this.vertices.push(new ti(e[t]));return this.compute(),this},setFromObject:function(e){var t=[];return e.updateMatrixWorld(!0),e.traverse((function(e){var n,i,a,o=e.geometry;if(void 0!==o)if(o.isGeometry){var r=o.vertices;for(n=0,i=r.length;n<i;n++)(a=r[n].clone()).applyMatrix4(e.matrixWorld),t.push(a)}else if(o.isBufferGeometry){var s=o.attributes.position;if(void 0!==s)for(n=0,i=s.count;n<i;n++)(a=new w.Pa4).fromBufferAttribute(s,n).applyMatrix4(e.matrixWorld),t.push(a)}})),this.setFromPoints(t)},containsPoint:function(e){for(var t=this.faces,n=0,i=t.length;n<i;n++)if(t[n].distanceToPoint(e)>this.tolerance)return!1;return!0},intersectRay:function(e,t){for(var n=this.faces,i=-1/0,a=1/0,o=0,r=n.length;o<r;o++){var s=n[o],l=s.distanceToPoint(e.origin),c=s.normal.dot(e.direction);if(l>0&&c>=0)return null;var h=0!==c?-l/c:0;if(!(h<=0)&&(c>0?a=Math.min(h,a):i=Math.max(h,i),i>a))return null}return i!==-1/0?e.at(i,t):e.at(a,t),t},makeEmpty:function(){return this.faces=[],this.vertices=[],this},addVertexToFace:function(e,t){return e.face=t,null===t.outside?this.assigned.append(e):this.assigned.insertBefore(t.outside,e),t.outside=e,this},removeVertexFromFace:function(e,t){return e===t.outside&&(null!==e.next&&e.next.face===t?t.outside=e.next:t.outside=null),this.assigned.remove(e),this},removeAllVerticesFromFace:function(e){if(null!==e.outside){for(var t=e.outside,n=e.outside;null!==n.next&&n.next.face===e;)n=n.next;return this.assigned.removeSubList(t,n),t.prev=n.next=null,e.outside=null,t}},deleteFaceVertices:function(e,t){var n=this.removeAllVerticesFromFace(e);if(void 0!==n)if(void 0===t)this.unassigned.appendChain(n);else{var i=n;do{var a=i.next;t.distanceToPoint(i.point)>this.tolerance?this.addVertexToFace(i,t):this.unassigned.append(i),i=a}while(null!==i)}return this},resolveUnassignedPoints:function(e){if(!1===this.unassigned.isEmpty()){var t=this.unassigned.first();do{for(var n=t.next,i=this.tolerance,a=null,o=0;o<e.length;o++){var r=e[o];if(0===r.mark){var s=r.distanceToPoint(t.point);if(s>i&&(i=s,a=r),i>1e3*this.tolerance)break}}null!==a&&this.addVertexToFace(t,a),t=n}while(null!==t)}return this},computeExtremes:function(){var e,t,n,i=new w.Pa4,a=new w.Pa4,o=[],r=[];for(e=0;e<3;e++)o[e]=r[e]=this.vertices[0];for(i.copy(this.vertices[0].point),a.copy(this.vertices[0].point),e=0,t=this.vertices.length;e<t;e++){var s=this.vertices[e],l=s.point;for(n=0;n<3;n++)l.getComponent(n)<i.getComponent(n)&&(i.setComponent(n,l.getComponent(n)),o[n]=s);for(n=0;n<3;n++)l.getComponent(n)>a.getComponent(n)&&(a.setComponent(n,l.getComponent(n)),r[n]=s)}return this.tolerance=3*Number.EPSILON*(Math.max(Math.abs(i.x),Math.abs(a.x))+Math.max(Math.abs(i.y),Math.abs(a.y))+Math.max(Math.abs(i.z),Math.abs(a.z))),{min:o,max:r}},computeInitialHull:function(){var e;void 0===qn&&(qn=new w.Zzh,Yn=new w.JOQ,Xn=new w.Pa4);var t,n,i,a,o,r,s,l,c=this.vertices,h=this.computeExtremes(),d=h.min,u=h.max,p=0,m=0;for(o=0;o<3;o++)(l=u[o].point.getComponent(o)-d[o].point.getComponent(o))>p&&(p=l,m=o);for(t=d[m],n=u[m],p=0,qn.set(t.point,n.point),o=0,r=this.vertices.length;o<r;o++)(e=c[o])!==t&&e!==n&&(qn.closestPointToPoint(e.point,!0,Xn),(l=Xn.distanceToSquared(e.point))>p&&(p=l,i=e));for(p=-1,Yn.setFromCoplanarPoints(t.point,n.point,i.point),o=0,r=this.vertices.length;o<r;o++)(e=c[o])!==t&&e!==n&&e!==i&&(l=Math.abs(Yn.distanceToPoint(e.point)))>p&&(p=l,a=e);var f=[];if(Yn.distanceToPoint(a.point)<0)for(f.push($n.create(t,n,i),$n.create(a,n,t),$n.create(a,i,n),$n.create(a,t,i)),o=0;o<3;o++)s=(o+1)%3,f[o+1].getEdge(2).setTwin(f[0].getEdge(s)),f[o+1].getEdge(1).setTwin(f[s+1].getEdge(0));else for(f.push($n.create(t,i,n),$n.create(a,t,n),$n.create(a,n,i),$n.create(a,i,t)),o=0;o<3;o++)s=(o+1)%3,f[o+1].getEdge(2).setTwin(f[0].getEdge((3-o)%3)),f[o+1].getEdge(0).setTwin(f[s+1].getEdge(1));for(o=0;o<4;o++)this.faces.push(f[o]);for(o=0,r=c.length;o<r;o++)if((e=c[o])!==t&&e!==n&&e!==i&&e!==a){p=this.tolerance;var g=null;for(s=0;s<4;s++)(l=this.faces[s].distanceToPoint(e.point))>p&&(p=l,g=this.faces[s]);null!==g&&this.addVertexToFace(e,g)}return this},reindexFaces:function(){for(var e=[],t=0;t<this.faces.length;t++){var n=this.faces[t];0===n.mark&&e.push(n)}return this.faces=e,this},nextVertexToAdd:function(){if(!1===this.assigned.isEmpty()){var e,t=0,n=this.assigned.first().face,i=n.outside;do{var a=n.distanceToPoint(i.point);a>t&&(t=a,e=i),i=i.next}while(null!==i&&i.face===n);return e}},computeHorizon:function(e,t,n,i){var a;this.deleteFaceVertices(n),n.mark=1,a=null===t?t=n.getEdge(0):t.next;do{var o=a.twin,r=o.face;0===r.mark&&(r.distanceToPoint(e)>this.tolerance?this.computeHorizon(e,o,r,i):i.push(a)),a=a.next}while(a!==t);return this},addAdjoiningFace:function(e,t){var n=$n.create(e,t.tail(),t.head());return this.faces.push(n),n.getEdge(-1).setTwin(t.twin),n.getEdge(0)},addNewFaces:function(e,t){this.newFaces=[];for(var n=null,i=null,a=0;a<t.length;a++){var o=t[a],r=this.addAdjoiningFace(e,o);null===n?n=r:r.next.setTwin(i),this.newFaces.push(r.face),i=r}return n.next.setTwin(i),this},addVertexToHull:function(e){var t=[];return this.unassigned.clear(),this.removeVertexFromFace(e,e.face),this.computeHorizon(e.point,null,e.face,t),this.addNewFaces(e,t),this.resolveUnassignedPoints(this.newFaces),this},cleanup:function(){return this.assigned.clear(),this.unassigned.clear(),this.newFaces=[],this},compute:function(){var e;for(this.computeInitialHull();void 0!==(e=this.nextVertexToAdd());)this.addVertexToHull(e);return this.reindexFaces(),this.cleanup(),this}}),Object.assign($n,{create:function(e,t,n){var i=new $n,a=new ei(e,i),o=new ei(t,i),r=new ei(n,i);return a.next=r.prev=o,o.next=a.prev=r,r.next=o.prev=a,i.edge=a,i.compute()}}),Object.assign($n.prototype,{getEdge:function(e){for(var t=this.edge;e>0;)t=t.next,e--;for(;e<0;)t=t.prev,e++;return t},compute:function(){void 0===Kn&&(Kn=new w.CJI);var e=this.edge.tail(),t=this.edge.head(),n=this.edge.next.head();return Kn.set(e.point,t.point,n.point),Kn.getNormal(this.normal),Kn.getMidpoint(this.midpoint),this.area=Kn.getArea(),this.constant=this.normal.dot(this.midpoint),this},distanceToPoint:function(e){return this.normal.dot(e)-this.constant}}),Object.assign(ei.prototype,{head:function(){return this.vertex},tail:function(){return this.prev?this.prev.vertex:null},length:function(){var e=this.head(),t=this.tail();return null!==t?t.point.distanceTo(e.point):-1},lengthSquared:function(){var e=this.head(),t=this.tail();return null!==t?t.point.distanceToSquared(e.point):-1},setTwin:function(e){return this.twin=e,e.twin=this,this}}),Object.assign(ni.prototype,{first:function(){return this.head},last:function(){return this.tail},clear:function(){return this.head=this.tail=null,this},insertBefore:function(e,t){return t.prev=e.prev,t.next=e,null===t.prev?this.head=t:t.prev.next=t,e.prev=t,this},insertAfter:function(e,t){return t.prev=e,t.next=e.next,null===t.next?this.tail=t:t.next.prev=t,e.next=t,this},append:function(e){return null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail,e.next=null,this.tail=e,this},appendChain:function(e){for(null===this.head?this.head=e:this.tail.next=e,e.prev=this.tail;null!==e.next;)e=e.next;return this.tail=e,this},remove:function(e){return null===e.prev?this.head=e.next:e.prev.next=e.next,null===e.next?this.tail=e.prev:e.next.prev=e.prev,this},removeSubList:function(e,t){return null===e.prev?this.head=t.next:e.prev.next=t.next,null===t.next?this.tail=e.prev:t.next.prev=e.prev,this},isEmpty:function(){return null===this.head}}),o(ai,w.u9r),o(oi,z.Z),o(ri,w.u9r);var si={Ar:null,ArLng:[],ArPos:[],ArMax:0,key:[0,0,0,0,0,0,0,0],constraintDebug:!1,flow:{ray:[],terrain:[],vehicle:[],key:[]},post:null,extraGeo:[],container:null,tmpMat:[],mat:{},geo:{},controler:null,torad:Math.PI/180,isRefView:!1,correctSize:function(e){return 1===e.length&&(e[1]=e[0]),2===e.length&&(e[2]=e[0]),e},tmpQ:new w._fP,tmpE:new w.USm,tmpM:new w.yGw,toQuatArray:function(e){return si.tmpQ.setFromEuler(si.tmpE.fromArray(e)).toArray()}},li=new Map,ci=function(e,t,n,i,a,o,r,s){w.u9r.call(this),this.type="ChamferBox",e=e||1,t=t||1,n=n||1,i=i||.1,a=Math.floor(a)||1,o=Math.floor(o)||1,r=Math.floor(r)||1,s=Math.floor(s)||3;var l=Math.PI,c=.5*l,h=2*i,d=.5*e,u=.5*t,p=.5*n,m=new w.yGw,f=new w.yGw,g=new w.yGw,v=new z.Z,y=new w._12(e-h,t-h,a,o),b=new w.fHI(i,i,e-h,s,a,!0,0,c),x=new w.fHI(i,i,t-h,s,o,!0,0,c),M=new w.xo$(i,s,s,0,c,0,-c);f.makeTranslation(0,d-i,0),m.makeRotationX(c),b.merge(M,f.multiply(m)),f.makeTranslation(0,-d+i,0),m.makeRotationX(c),g.makeRotationY(-c),b.merge(M,f.multiply(m).multiply(g)),f.makeTranslation(d-i,0,-i),y.merge(x,f),f.makeTranslation(-d+i,0,-i),m.makeRotationZ(l),y.merge(x,f.multiply(m)),m.makeRotationZ(c),f.makeTranslation(0,u-i,-i),y.merge(b,f.multiply(m)),f.makeTranslation(0,-u+i,-i),m.makeRotationZ(-c),y.merge(b,f.multiply(m)),f.makeTranslation(0,0,p),v.merge(y,f),f.makeTranslation(0,0,-p),m.makeRotationY(l),v.merge(y,f.multiply(m)),y.dispose(),b.dispose(),y=new w._12(n-h,t-h,r,o),b=new w.fHI(i,i,n-h,s,r,!0,0,c),f.makeTranslation(0,-(u-i),-i,0),m.makeRotationZ(-c),y.merge(b,f.multiply(m)),f.makeTranslation(0,u-i,-i,0),m.makeRotationZ(c),y.merge(b,f.multiply(m)),f.makeTranslation(-d,0,0),m.makeRotationY(-c),v.merge(y,f.multiply(m)),f.makeTranslation(d,0,0),m.makeRotationY(c),v.merge(y,f.multiply(m)),y.dispose(),y=new w._12(e-h,n-h,a,r),f.makeTranslation(0,u,0),m.makeRotationX(-c),v.merge(y,f.multiply(m)),f.makeTranslation(0,-u,0),m.makeRotationX(c),v.merge(y,f.multiply(m)),y.dispose(),b.dispose(),x.dispose(),M.dispose(),v.mergeVertices(),v.computeVertexNormals(),this.fromGeometry(v),v.dispose()};o(ci,w.u9r);var hi=function(e,t,n,i,a,o,r){w.u9r.call(this),this.type="ChamferCyl",e=void 0!==e?e:1,t=void 0!==t?t:1,n=n||1,i=i||.2,a=Math.floor(a)||24,o=Math.floor(o)||1,r=Math.floor(r)||3;var s=new w.yGw,l=new w.yGw,c=Math.PI,h=.5*c;c*=2,o=new w.fHI(e,t,n-2*i,a,o,!0,0);var d=new w.XvJ(e-i,i,r,a,c,0,h);e=new w.zf8(e-i,a),l.makeTranslation(0,0,i),d.merge(e,l),s.makeTranslation(0,0,.5*n-i),l.makeRotationX(-h),o.merge(d,l.multiply(s)),d.dispose(),e.dispose(),d=new w.XvJ(t-i,i,r,a,c,0,h),e=new w.zf8(t-i,a),l.makeTranslation(0,0,i),d.merge(e,l),s.makeTranslation(0,0,.5*n-i),l.makeRotationX(h),o.merge(d,l.multiply(s)),d.dispose(),e.dispose(),o.mergeVertices(),o.computeVertexNormals(),this.fromGeometry(o),o.dispose()};function di(){this.ID=0,this.solids=[],this.bodies=[]}function ui(){this.ID=0,this.joints=[]}function pi(e){this.type="constraint",this.name=e.name,this.isMesh=!1,si.constraintDebug&&this.init(e)}o(hi,w.u9r),Object.assign(di.prototype,{step:function(e,t){var n;this.bodies.forEach((function(i,a){e[n=t+8*a],i.enabled&&(i.position.fromArray(e,n+1),i.quaternion.fromArray(e,n+4))}))},clear:function(){for(;this.bodies.length>0;)this.destroy(this.bodies.pop());for(;this.solids.length>0;)this.destroy(this.solids.pop());this.ID=0},destroy:function(e){li.delete(e.name),si.destroy(e)},remove:function(e){if(li.has(e)){var t=li.get(e),n="solid"===t.type,i=n?this.solids.indexOf(t):this.bodies.indexOf(t);-1!==i&&(n?(this.solids.splice(i,1),this.destroy(t)):(this.bodies.splice(i,1),this.destroy(t)))}},add:function(e,t){void 0!==e.density&&(e.mass=e.density),void 0!==e.bounce&&(e.restitution=e.bounce),e.mass=void 0===e.mass?0:e.mass,e.kinematic=e.kinematic||!1;var n="body";0!==e.mass||e.kinematic||(n="static"),e.name=void 0!==e.name?e.name:n+this.ID++,this.remove(e.name),e.breakable&&("hardbox"!==e.type&&"box"!==e.type&&"sphere"!==e.type&&"cylinder"!==e.type&&"cone"!==e.type||(e.type="real".concat(e.type)));var i=!1;e.type=void 0===e.type?"box":e.type,e.pos=void 0===e.pos?[0,0,0]:e.pos,e.size=void 0===e.size?[1,1,1]:e.size,e.size=si.correctSize(e.size),e.geoSize&&(e.geoSize=si.correctSize(e.geoSize)),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=si.toQuatArray(e.rot),delete e.rot);var a=null,o=void 0!==e.noMesh&&e.noMesh;if("plane"!==e.type){var r,s,l;if(void 0!==e.material?r=e.material.constructor===String?si.mat[e.material]:e.material:(r=0!==e.mass||e.kinematic?si.mat.move:si.mat.static,e.kinematic&&(r=si.mat.kinematic)),"compound"===e.type){for(var c=0;c<e.shapes.length;c++)(l=e.shapes[c]).size=void 0===l.size?[1,1,1]:l.size,1===l.size.length&&(l.size[1]=l.size[0]),2===l.size.length&&(l.size[2]=l.size[0]),l.pos=void 0===l.pos?[0,0,0]:l.pos,l.rot=void 0===l.rot?[0,0,0]:l.rot,l.quat=void 0===l.quat?(new w._fP).setFromEuler((new w.USm).fromArray(l.rot)).toArray():l.quat;if(a=e.geometry?new w.Kj0(e.geometry,r):new w.ZAu,e.geometry&&si.extraGeo.push(e.geometry),!e.geometry||e.debug){a.material=r;for(var h=0;h<e.shapes.length;h++){var d=null;"capsule"===(l=e.shapes[h]).type?d=new ai(e.size[0],e.size[1]):"convex"===l.type?(d=l.shape,l.v=ii(l.shape,l.type),delete l.shape):d=si.geo[l.type],"capsule"!==l.type&&"convex"!==l.type||si.extraGeo.push(d),(s=new w.Kj0(d,e.debug?si.mat.debug:r)).scale.fromArray(l.size),s.position.fromArray(l.pos),s.quaternion.fromArray(l.quat),a.add(s)}}}else"mesh"===e.type||"convex"===e.type?(i=!0,e.shape&&(e.v=ii(e.shape,e.type),si.extraGeo.push(e.shape)),e.geometry?(e.geoScale&&(e.geometry=e.geometry.clone(),e.geometry.applyMatrix((new w.yGw).makeScale(e.geoScale[0],e.geoScale[0],e.geoScale[0]))),a=new w.Kj0(e.geometry,r),si.extraGeo.push(e.geometry)):o||(a=new w.Kj0(e.shape,r))):("capsule"===e.type&&(e.geometry=new ai(e.size[0],e.size[1])),"realbox"!==e.type&&"realhardbox"!==e.type||(e.geometry=new w.nvb(e.size[0],e.size[1],e.size[2])),"realsphere"===e.type&&(e.geometry=new w.Aip(e.size[0],16,12)),"realcylinder"===e.type&&(e.geometry=new w.m_w(e.size[0],e.size[0],.5*e.size[1],12,1)),"realcone"===e.type&&(e.geometry=new w.m_w(0,.5*e.size[0],.55*e.size[1],12,1)),void 0!==e.radius&&si.isRefView&&("box"===e.type&&(e.geometry=new ci(e.size[0],e.size[1],e.size[2],e.radius)),"cylinder"===e.type&&(e.geometry=new hi(e.size[0],e.size[0],.5*e.size[1],e.radius)),"cone"===e.type&&(e.geometry=new hi(e.radius,e.size[0],.5*e.size[1],e.radius))),e.geometry&&((e.geoRot||e.geoScale)&&(e.geometry=e.geometry.clone()),e.geoRot&&e.geometry.applyMatrix((new w.yGw).makeRotationFromEuler((new w.USm).fromArray(e.geoRot))),e.geoScale&&e.geometry.applyMatrix((new w.yGw).makeScale(e.geoScale[0],e.geoScale[1],e.geoScale[2]))),a=new w.Kj0(e.geometry||si.geo[e.type],r),e.geometry&&(si.extraGeo.push(e.geometry),e.geoSize&&a.scale.fromArray(e.geoSize),i=!0));if("highsphere"===e.type&&(e.type="sphere"),"isGeometry"===t)return l;if(a){if(!i&&!a.isGroup){a.scale.fromArray(e.size);var u=a;(a=new w.ZAu).add(u)}e.mesh&&(a=new w.ZAu).add(e.mesh),a.position.fromArray(e.pos),a.quaternion.fromArray(e.quat),a.updateMatrix(),a.name=e.name,a.enabled=!0,void 0!==e.parent?(e.parent.add(a),e.parent=null):si.container.add(a),void 0===e.noShadow&&(a.isGroup&&(Object.defineProperty(a,"receiveShadow",{get:function(){return this.children[0].receiveShadow},set:function(e){for(var t=this.children.length;t--;)this.children[t].receiveShadow=e}}),Object.defineProperty(a,"castShadow",{get:function(){return this.children[0].castShadow},set:function(e){for(var t=this.children.length;t--;)this.children[t].castShadow=e}})),a.receiveShadow=!0,a.castShadow=!(0===e.mass&&!e.kinematic))}return e.shape&&delete e.shape,e.geometry&&delete e.geometry,e.material&&delete e.material,e.mesh&&delete e.mesh,void 0===e.noPhy&&(a&&(0!==e.mass||e.kinematic?this.bodies.push(a):this.solids.push(a)),si.post("add",e)),a?(a.type=0!==e.mass||e.kinematic?"body":"solid",a.userData.mass=e.mass,li.set(e.name,a),void 0!==e.autoMatrix&&(a.matrixAutoUpdate=e.autoMatrix),a):void 0}si.post("add",e)}}),Object.assign(ui.prototype,{step:function(e,t){var n;si.constraintDebug&&this.joints.forEach((function(i,a){n=t+14*a,i.step(n,e)}))},clear:function(){for(;this.joints.length>0;)this.destroy(this.joints.pop());this.ID=0},destroy:function(e){li.delete(e.name),e.clear()},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.joints.indexOf(t);this.joints.splice(n,1),this.destroy(t)}},add:function(e){e.name=void 0!==e.name?e.name:"joint".concat(this.ID++),this.remove(e.name);var t=new pi(e);return this.joints.push(t),li.set(t.name,t),void 0!==e.parent&&(e.parent=null),si.post("add",e),t}}),Object.assign(pi.prototype,{step:function(e,t){if(this.isMesh){this.mesh.visible||(this.mesh.visible=!0);var n=this.pos.array;n[0]=t[e],n[1]=t[e+1],n[2]=t[e+2],n[3]=t[e+7],n[4]=t[e+8],n[5]=t[e+9],this.pos.needsUpdate=!0,this.p1.position.fromArray(t,e),this.p1.quaternion.fromArray(t,e+3),this.p2.position.fromArray(t,e+7),this.p2.quaternion.fromArray(t,e+10)}},init:function(e){var t=new Float32Array([0,0,0,0,0,0]),n=new Float32Array([0,1,0,1,1,0]),i=new w.u9r;i.setAttribute("position",new w.TlE(t,3)),i.setAttribute("color",new w.TlE(n,3)),this.mesh=new w.x12(i,si.mat.jointLine),this.mesh.name=e.name,this.p1=new w.Kj0(si.geo.joint,si.mat.jointP1),this.p2=new w.Kj0(si.geo.joint,si.mat.jointP2),this.p1.receiveShadow=!1,this.p1.castShadow=!1,this.p2.receiveShadow=!1,this.p2.castShadow=!1,this.mesh.receiveShadow=!1,this.mesh.castShadow=!1,this.mesh.add(this.p1),this.mesh.add(this.p2),this.mesh.frustumCulled=!1,this.pos=this.mesh.geometry.attributes.position,this.mesh.visible=!1,void 0!==e.parent?(e.parent.add(this.mesh),e.parent=null):si.container.add(this.mesh),this.isMesh=!0},clear:function(){this.isMesh&&(this.mesh.geometry.dispose(),si.destroy(this.mesh),this.mesh=null,this.p1=null,this.p2=null,this.isMesh=!1)}});var mi=function(e,t,n,i,a,o){if(w.u9r.call(this),this.debug=!1,this.type="Tubular",this.geoType=o||"tube",this.tubularSegments=t||64,this.radius=n||1,this.radialSegments=i||8,this.closed=a||!1,this.scalar=1,e instanceof Array)this.positions=e;else{for(this.positions=[],t=(new w.Pa4).fromArray(e.start),i=(n=(new w.Pa4).fromArray(e.end)).clone().sub(t),e=e.numSegment-1,this.positions.push(t),a=1;a<e;a++)this.positions.push(new w.Pa4(i.x/e*a,i.y/e*a,i.z/e*a).add(t));this.positions.push(n)}for(this.rotations=[],a=1;a<this.positions.length+1;a++)this.rotations.push(new w._fP);this.path=new w.YT8(this.positions),this.path.type="catmullrom",this.path.closed=this.closed,this.frames=fi(this.tubularSegments,this.closed,this.rotations),this.vertex=new w.Pa4,this.normal=new w.Pa4,this.uv=new w.FM8,this.vertices=[],this.colors=[],this.normals=[],this.uvs=[],this.indices=[],this.generatePath(),this.setIndex(new(this.indices.length>65535?w.lCJ:w.qlB)(this.indices,1)),this.setAttribute("position",new w.a$l(this.vertices,3)),this.setAttribute("color",new w.a$l(this.colors,3)),this.setAttribute("normal",new w.a$l(this.normals,3)),this.setAttribute("uv",new w.a$l(this.uvs,2))};o(mi,w.u9r),a(mi.prototype,{addDebug:function(e){this.path.g=new z.Z;for(var t=0;t<this.tubularSegments+1;t++)this.path.g.vertices.push(new w.Pa4);this.path.mesh=new w.x12(this.path.g,new w.nls({color:16746496,linewidth:1,depthTest:!1,depthWrite:!1,transparent:!0})),e.add(this.path.mesh),this.debug=!0},setTension:function(e){this.path.tension=e},generateSegment:function(e){var t=e/this.tubularSegments,n=this.scalar;"sphere"===this.geoType&&(n=2*Math.sqrt(Math.pow(.5,2)-Math.pow(t-.5,2)));var i=3*e*(this.radialSegments+1);t=this.path.getPointAt(t),this.debug&&this.path.g.vertices[e].copy(t);for(var a=this.frames.normals[e],o=this.frames.binormals[e],r=!0,s=1,l=0;l<=this.radialSegments;l++){var c=l/this.radialSegments*Math.PI*2;1===this.radialSegments&&(c=0),e=3*l;var h=Math.sin(c);c=-Math.cos(c),1===this.radialSegments?(r?(s=.5,r=!1):(s=-.5,r=!0),this.normal.copy(a).negate().projectOnPlane(new w.Pa4(0,1,0))):(this.normal.x=c*a.x+h*o.x,this.normal.y=c*a.y+h*o.y,this.normal.z=c*a.z+h*o.z),this.normal.normalize(),this.normals[i+e]=this.normal.x,this.normals[i+e+1]=this.normal.y,this.normals[i+e+2]=this.normal.z,this.normal.multiplyScalar(n),this.vertices[i+e]=t.x+this.radius*this.normal.x*s,this.vertices[i+e+1]=t.y+this.radius*this.normal.y*s,this.vertices[i+e+2]=t.z+this.radius*this.normal.z*s,this.colors[i+e]=Math.abs(this.normal.x),this.colors[i+e+1]=Math.abs(this.normal.y),this.colors[i+e+2]=Math.abs(this.normal.z),1===this.radialSegments&&(this.normals[i+e]=0,this.normals[i+e+1]=1,this.normals[i+e+2]=0)}},generateIndicesAndUv:function(){for(var e=0;e<=this.tubularSegments;e++)for(var t=0;t<=this.radialSegments;t++){if(t>0&&e>0){var n=(this.radialSegments+1)*e+(t-1),i=(this.radialSegments+1)*e+t,a=(this.radialSegments+1)*(e-1)+t;this.indices.push((this.radialSegments+1)*(e-1)+(t-1),n,a),this.indices.push(n,i,a)}this.uv.x=t/this.radialSegments,this.uv.y=e/this.tubularSegments,this.uvs.push(this.uv.x,this.uv.y)}},generatePath:function(e){for(e=0;e<=this.tubularSegments;e++)this.generateSegment(e);this.generateIndicesAndUv()},updatePath:function(e){for(this.frames=fi(this.tubularSegments,this.closed,this.rotations),this.normals=this.attributes.normal.array,this.vertices=this.attributes.position.array,this.colors=this.attributes.color.array,e=0;e<=this.tubularSegments;e++)this.generateSegment(e);this.attributes.color.needsUpdate=!0,this.attributes.position.needsUpdate=!0,this.attributes.normal.needsUpdate=!0,this.attributes.uv.needsUpdate=!0,this.debug&&(this.path.g.verticesNeedUpdate=!0),"sphere"===this.geoType&&this.computeVertexNormals(),this.computeBoundingSphere()},updateUV:function(){this.uvs=this.attributes.uv.array;for(var e,t,n=0;n<=this.tubularSegments;n++){e=2*n*(this.radialSegments+1);for(var i=0;i<=this.radialSegments;i++)t=2*i,this.uv.x=n/this.tubularSegments,this.uv.y=i/this.radialSegments,this.uvs[e+t]=this.uv.x,this.uvs[e+t+1]=this.uv.y}this.attributes.uv.needsUpdate=!0},updateIndices:function(){this.indices=[];for(var e,t,n=0;n<=this.tubularSegments;n++){t=2*n*(this.radialSegments+1);for(var i=0;i<=this.radialSegments;i++){if(i>0&&n>0){var a=(this.radialSegments+1)*n+(i-1),o=(this.radialSegments+1)*n+i,r=(this.radialSegments+1)*(n-1)+i;this.indices.push((this.radialSegments+1)*(n-1)+(i-1),a,r),this.indices.push(a,o,r)}this.uv.x=n/this.tubularSegments,this.uv.y=i/this.radialSegments,this.uvs[t+e]=this.uv.y,this.uvs[t+e+1]=this.uv.x,e=2*i}}}});var fi=function(e,t,n){var i=new w.Pa4,a=[],o=[],r=[],s=new w.Pa4,l=new w.yGw,c=n[n.length-1];for(new w._fP,n=0;n<=e;n++){var h=n/e;a[n]=this.getTangentAt(h),a[n].normalize()}for(o[0]=new w.Pa4,r[0]=new w.Pa4,i.set(0,0,1).applyQuaternion(c).normalize(),s.crossVectors(a[0],i).normalize(),o[0].crossVectors(a[0],s),r[0].crossVectors(a[0],o[0]),n=1;n<=e;n++)o[n]=o[n-1].clone(),r[n]=r[n-1].clone(),s.crossVectors(a[n-1],a[n]),s.length()>Number.EPSILON&&(s.normalize(),i=Math.acos(this.clamp(a[n-1].dot(a[n]),-1,1)),o[n].applyMatrix4(l.makeRotationAxis(s,i))),r[n].crossVectors(a[n],o[n]);if(!0===t)for(i=Math.acos(this.clamp(o[0].dot(o[e]),-1,1)),i/=e,a[0].dot(s.crossVectors(o[0],o[e]))>0&&(i=-i),n=1;n<=e;n++)o[n].applyMatrix4(l.makeRotationAxis(a[n],i*n)),r[n].crossVectors(a[n],o[n]);return{tangents:a,normals:o,binormals:r}};function gi(){this.ID=0,this.softs=[],this.tmpMat=null}function vi(){this.ID=0,this.terrains=[]}a(gi.prototype,{step:function(e,t){var n=t;this.softs.forEach((function(t){var i,a,o,r,s,l,c,h=t.geometry,d=t.softType,u=null,p=!!h.attributes.color,m=!!h.attributes.normal;if(2===d){for(s=h.positions.length;s--;)i=n+3*s,h.positions[s].set(e[i],e[i+1],e[i+2]);h.updatePath()}else{if(!h.attributes.position)return;if(r=h.attributes.position.array,p&&(a=h.attributes.color.array),5===d||4===d){var f=h.numVertices,g=h.maxi,v=h.pPoint,y=h.lPoint;for(s=f;s--;){i=3*s+n,l=s===f-1?g-v[s]:v[s+1]-v[s];for(var w=v[s];l--;)r[c=3*y[w+l]]=e[i],r[c+1]=e[i+1],r[c+2]=e[i+2]}}else if(h.attributes.order&&(u=h.attributes.order.array),s=r.length,i=2,null!==u)for(s=u.length;s--;)l=3*u[s],i=3*s+n,r[l]=e[i],r[l+1]=e[i+1],r[l+2]=e[i+2],o=Math.abs(e[i+1]/10),a[l]=o,a[l+1]=o,a[l+2]=o;else for(;s--;)r[s]=e[s+n],1===i&&(o=Math.abs(r[s]/10),a[s-1]=o,a[s]=o,a[s+1]=o),i=--i<0?2:i;if(2!==d&&h.computeVertexNormals(),m){var b=h.attributes.normal.array;for(s=f;s--;){l=s===f-1?g-v[s]:v[s+1]-v[s];for(var x=v[s],M=3*y[x];l--;)b[c=3*y[x+l]]=b[M],b[c+1]=b[M+1],b[c+2]=b[M+2]}h.attributes.normal.needsUpdate=!0}p&&(h.attributes.color.needsUpdate=!0),h.attributes.position.needsUpdate=!0,h.computeBoundingSphere()}n+=3*t.points}))},clear:function(){for(;this.softs.length>0;)this.destroy(this.softs.pop());this.ID=0},destroy:function(e){e.parent&&e.parent.remove(e),li.delete(e.name)},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.softs.indexOf(t);-1!==n&&(this.softs.splice(n,1),this.destroy(t))}},add:function(e){var t,n,i,a=void 0!==e.name?e.name:e.type+this.ID++;switch(this.remove(a),e.pos=void 0===e.pos?[0,0,0]:e.pos,e.size=null==e.size?[1,1,1]:e.size,e.size=si.correctSize(e.size),e.quat=void 0===e.quat?[0,0,0,1]:e.quat,void 0!==e.rot&&(e.quat=si.toQuatArray(e.rot),delete e.rot),t=void 0!==e.material?e.material.constructor===String?si.mat[e.material]:e.material:si.mat.soft,e.type){case"softMesh":case"softTriMesh":case"softConvex":n=function(e,t){var n=e.shape.clone();n.scale(e.size[0],e.size[1],e.size[2]),ii(n),si.extraGeo.push(n),e.v=n.realVertices,e.i=n.realIndices,e.ntri=n.numFaces,n.translate(e.pos[0],e.pos[1],e.pos[2]),n.applyMatrix(si.tmpM.makeRotationFromQuaternion(si.tmpQ.fromArray(e.quat)));var i=new w.Kj0(n,t);return i.castShadow=!0,i.receiveShadow=!0,i.softType=5,i.points=e.v.length/3,e.shape&&delete e.shape,e.material&&delete e.material,{mesh:i,o:e}}(e,t);break;case"softCloth":n=function(e,t){var n=e.div||[16,16],i=e.size||[100,0,100],a=e.pos||[0,0,0],o=n[0]*n[1],r=new w.BKK(i[0],i[2],n[0]-1,n[1]-1);r.setAttribute("color",new w.TlE(new Float32Array(3*o),3)),r.rotateX(-Math.PI/2);var s=new w.Kj0(r,t);return s.position.set(a[0],a[1],a[2]),s.castShadow=!0,s.receiveShadow=!0,s.softType=1,s.points=r.attributes.position.array.length/3,e.size=i,e.div=n,e.pos=a,{mesh:s,o:e}}(e,t);break;case"softRope":n=function(e,t){void 0===e.numSeg&&(e.numSeg=e.numSegment);var n=new mi(e,e.numSeg||10,e.radius||.2,e.numRad||6,!1),i=new w.Kj0(n,t);return i.castShadow=!0,i.receiveShadow=!0,i.softType=2,i.points=n.positions.length,{mesh:i,o:e}}(e,t);break;case"softEllipsoid":return this.tmpMat=t,void si.post("add",e)}i=n.mesh,e=n.o,i.name=a,i.type="soft",si.container.add(i),this.softs.push(i),li.set(a,i),si.post("add",e)},createEllipsoid:function(e){var t=function(e){var t,n,i,a,o,r=e.lng,s=[],l=e.a;for(t=0;t<r;t++)o=3*t,s.push(new w.Pa4(l[o],l[o+1],l[o+2]));var c=new oi(s),h=new Uint32Array(3*c.faces.length),d=new Float32Array(3*r),u=new Float32Array(r);for(a=c.vertices,t=r;t--;)for(n=r;n--;)l[o=3*n]==a[t].x&&l[o+1]==a[t].y&&l[o+2]==a[t].z&&(u[n]=t);for(t=r;t--;)o=3*t,d[i=3*u[t]]=l[o],d[i+1]=l[o+1],d[i+2]=l[o+2];for(t=c.faces.length;t--;){o=3*t;var p=c.faces[t];h[o]=p.a,h[o+1]=p.b,h[o+2]=p.c}var m=new w.u9r;if(m.setIndex(new w.TlE(h,1)),m.setAttribute("position",new w.TlE(d,3)),m.setAttribute("color",new w.TlE(new Float32Array(3*r),3)),m.setAttribute("order",new w.TlE(u,1)),c.uvs){var f=new Float32Array(2*c.uvs.length);m.setAttribute("uv",new w.TlE(f,2).copyVector2sArray(c.uvs),2)}m.computeVertexNormals(),si.extraGeo.push(m),c.dispose();var g=new w.Kj0(m,si.mat.soft);return g.softType=3,g.type="soft",g.points=m.attributes.position.array.length/3,g.castShadow=!0,g.receiveShadow=!0,g}(e);this.tmpMat&&(t.material=this.tmpMat),t.name=e.name,si.container.add(t),this.softs.push(t),li.set(e.name,t)}}),Object.assign(vi.prototype,{step:function(){si.flow.terrain=[],this.terrains.forEach((function(e){e.needsUpdate&&(e.updateGeometry(),si.flow.terrain.push({name:e.name,heightData:e.heightData}),e.needsUpdate=!1)}))},clear:function(){for(;this.terrains.length>0;)this.destroy(this.terrains.pop());this.ID=0},destroy:function(e){e.parent&&e.parent.remove(e),li.delete(e.name)},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.terrains.indexOf(t);-1!==n&&(this.terrains.splice(n,1),this.destroy(t))}},add:function(e){var t=void 0!==e.name?e.name:e.type+this.ID++;this.remove(t),e.sample=void 0===e.sample?[64,64]:e.sample,e.pos=void 0===e.pos?[0,0,0]:e.pos,e.complexity=void 0===e.complexity?30:e.complexity,e.name=t,e.offset=0,si.post("add",e)},move:function(e,t,n){if(li.has(e)){var i=li.get(e);i.local.x+=t||0,i.local.z+=n||0,i.update(!0),i.needsUpdate=!0}}});var yi=function(e,t,n){n=.6*-n,this.py=e[1]-t[1],e=new Float32Array([-.2,0,0,.2,0,0,0,0,0,0,.4,0,0,0,-.2,0,0,.2,e[0]-n,this.py,e[2],e[0]-n,this.py+1,e[2],-e[0]+n,this.py,e[2],-e[0]+n,this.py+1,e[2],-e[0]+n,this.py,-e[2],-e[0]+n,this.py+1,-e[2],e[0]-n,this.py,-e[2],e[0]-n,this.py+1,-e[2],e[0]-n,this.py,e[2],-e[0]+n,this.py,e[2],e[0]-n,this.py,-e[2],-e[0]+n,this.py,-e[2]]),t=new Float32Array([1,1,0,1,1,0,1,1,0,0,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0,1,1,0]),this.geometry=new w.u9r,this.geometry.setAttribute("position",new w.TlE(e,3)),this.geometry.setAttribute("color",new w.TlE(t,3)),this.positions=this.geometry.attributes.position.array,this.material=new w.nls({vertexColors:!0,name:"helper"}),w.ejS.call(this,this.geometry,this.material)};function wi(){this.ID=0,this.cars=[]}function bi(){this.ID=0,this.heroes=[]}function xi(){this.ID=0,this.pairs=[]}function Mi(e,t){this.name=e,this.callback=t||function(){},this.type="collision",this.hit=0}function Si(){this.ID=0,this.rays=[]}function Ci(e){w.x12.call(this),this.type="ray",this.name=e.name,this.enabled=void 0===e.enabled||e.enabled,this.precision=void 0!==e.precision?e.precision:1,this.callback=e.callback||function(){},this.position.fromArray(e.pos||[0,0,0]),this.group=void 0!==e.group?e.group:1,this.mask=void 0!==e.mask?e.mask:-1,this.origin=[0,0,0],this.dest=[0,0,0],this.start=(new w.Pa4).fromArray(e.start||[0,0,0]),this.end=(new w.Pa4).fromArray(e.end||[0,10,0]),this.maxDistance=this.start.distanceTo(this.end),this.tmp=new w.Pa4,this.normal=new w.Pa4,this.inv=new w.yGw,this.c1=[.1,.1,.1],this.c2=[1,.1,.1],this.vertices=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.local=[0,0,0,0,0,0],this.geometry.setAttribute("position",new w.a$l(this.vertices,3)),this.geometry.setAttribute("color",new w.a$l(this.colors,3)),this.vertices=this.geometry.attributes.position.array,this.colors=this.geometry.attributes.color.array,this.material.color.setHex(16777215),this.material.vertexColors=!0,this.base=!1,this.info={hit:!1,name:"",distance:0},this.upGeo()}function Ti(e,t){this.minSizeForBreak=e||1.4,this.smallDelta=t||1e-4,this.tempLine1=new w.Zzh,this.tempPlane1=new w.JOQ,this.tempPlane2=new w.JOQ,this.tempPlane_Cut=new w.JOQ,this.tempCM1=new w.Pa4,this.tempCM2=new w.Pa4,this.tempVector3=new w.Pa4,this.tempVector3_2=new w.Pa4,this.tempVector3_3=new w.Pa4,this.tempVector3_P0=new w.Pa4,this.tempVector3_P1=new w.Pa4,this.tempVector3_P2=new w.Pa4,this.tempVector3_N0=new w.Pa4,this.tempVector3_N1=new w.Pa4,this.tempVector3_AB=new w.Pa4,this.tempVector3_CB=new w.Pa4,this.tempResultObjects={object1:null,object2:null},this.segments=[];for(var n=0;n<900;n++)this.segments[n]=!1}o(yi,w.ejS),yi.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},yi.prototype.updateSuspension=function(e,t,n,i){this.positions[22]=this.py-e,this.positions[28]=this.py-t,this.positions[34]=this.py-n,this.positions[40]=this.py-i,this.geometry.attributes.position.needsUpdate=!0},Object.assign(wi.prototype,{step:function(e,t){var n;this.cars.forEach((function(i,a){var o,r,s=i.userData.NumWheels,l=56;n=t+64*a,i.userData.speed=e[n],i.userData.wr=[e[n+62],e[n+63]],i.position.fromArray(e,n+1),i.quaternion.fromArray(e,n+4);var c=i.userData.radius,h=e[n+8];if(i.userData.steering=h,i.userData.steeringWheel&&(i.userData.steeringWheel.rotation.y=15*-h),i.userData.isWithBrake){var d=e[n+8],u=e[n+16];for(o=s;o--;)0===o&&(i.userData.b[o].rotation.y=u),1===o&&(i.userData.b[o].rotation.y=Math.Pi-d),i.userData.b[o].position.y=c-e[n+l+o]}if(i.userData.isWithSusp)for(o=s;o--;)(r=(r=(r=5*e[n+l+o])>1?1:r)<-1?-1:r)>0?(i.userData.s[o].setWeight("low",r),i.userData.s[o].setWeight("top",0)):(i.userData.s[o].setWeight("low",0),i.userData.s[o].setWeight("top",-r));for(i.userData.helper&&(2===s&&i.userData.helper.updateSuspension(e[n+l+0],e[n+l+0],e[n+l+1],e[n+l+1]),4===s&&i.userData.helper.updateSuspension(e[n+l+0],e[n+l+1],e[n+l+2],e[n+l+3]));s--;)i.userData.suspension[s]=e[n+56+s],l=8*(s+1),i.userData.w[s].position.fromArray(e,n+l+1),i.userData.w[s].quaternion.fromArray(e,n+l+4)}))},clear:function(){for(;this.cars.length>0;)this.destroy(this.cars.pop());this.ID=0},destroy:function(e){for(var t,n=0,i=e.userData.w.length;n<i;n++)(t=e.userData.w[n]).parent&&t.parent.remove(t);e.parent&&e.parent.remove(e),li.delete(e.name)},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.cars.indexOf(t);-1!==n&&(this.cars.splice(n,1),this.destroy(t))}},add:function(e){var t=void 0!==e.name?e.name:e.type+this.ID++;this.remove(t);var n,i=e.size||[2,.5,4],a=e.pos||[0,0,0],o=e.rot||[0,0,0],r=e.wPos;if(e.masscenter=void 0===e.masscenter?[0,0,0]:e.masscenter,e.mesh)(n=new w.ZAu).add(e.mesh);else if(e.geometry)n=new w.Kj0(e.geometry,e.material),si.extraGeo.push(e.geometry);else{var s=(new w.u9r).fromGeometry(new w.DvJ(i[0],i[1],i[2]));s.translate(-e.masscenter[0],-e.masscenter[1],-e.masscenter[2]),si.extraGeo.push(s),n=new w.Kj0(s,si.mat.move)}e.debug&&e.shape&&(n=new w.Kj0(e.shape,si.mat.debug)),n.position.set(a[0],a[1],a[2]),n.rotation.set(o[0],o[1],o[2]),e.quat=n.quaternion.toArray(),si.container.add(n),n.userData.speed=0,n.userData.NumWheels=e.nWheel||4,n.userData.suspension=[0,0,0,0,0,0],n.userData.wr=[0,0],n.userData.steering=0,n.userData.type="car",n.userData.steeringWheel=e.meshSteeringWheel||null;var l=e.radius||.4,c=e.radiusBack||l,h=e.deep||.3;r=e.wPos||[1,-.25,1.6];var d,u=[],p=[],m=[],f=void 0!==e.meshSusp,g=void 0!==e.meshBrake,v=void 0===e.wheel,y=e.wheel||si.geo.wheel,b=y.clone();b.rotateY(Math.Pi),si.extraGeo.push(b);var x=si.mat.move;void 0!==e.wheelMaterial&&(x=e.wheelMaterial.constructor===String?si.mat[e.wheelMaterial]:e.wheelMaterial);for(var M,S=e.nWheel||4,C=(e.decalYBack,0);C<S;C++){if(0===C&&(r[0],r[1],r[2],M=!0),1===C&&(r[0],r[1],r[2],M=!0),2===C&&(r[0],r[1],r[2],M=!1),3===C&&(r[0],r[1],r[2],M=!1),4===C&&(r[0],r[1],r[3],M=!1),5===C&&(r[0],r[1],r[3],M=!1),2===S&&(0===C&&(r[1],r[2],M=!0),1===C&&(r[1],r[2],M=!1)),3===S&&(0===C&&(r[1],r[2],M=!0),1===C&&(r[0],r[1],r[2],M=!1),2===C&&(r[0],r[1],r[2],M=!1)),e.meshBrake&&(d=e.meshBrake.clone(),n.add(d),d.position.y=l,1===C||2===C?(d.rotation.y=Math.Pi,d.position.x=r[0],d.rotation.x=Math.Pi):d.position.x=-r[0],d.position.z=0===C||1===C?r[2]:-r[2],m[C]=d),e.meshSusp&&(d=e.meshSusp.clone(),n.add(d),d.position.y=l,1!==C&&2!==C||(d.rotation.y=Math.Pi),d.position.z=0===C||1===C?r[2]:-r[2],p[C]=d.children[0]),e.meshWheel)if(u[C]=e.meshWheel.clone(),v=!1,1===C||2===C){u[C]=new w.ZAu;var T=e.meshWheel.clone();T.rotation.y=Math.Pi,u[C].add(T)}else{u[C]=e.meshWheel.clone();for(var k=u[C].children.length;k--;)"h_pneu"===u[C].children[k].name&&(u[C].children[k].rotation.y=Math.Pi)}else u[C]=1===C||2===C?new w.Kj0(y,si.mat.move):new w.Kj0(b,si.mat.move);v&&u[C].scale.set(h,M?l:c,M?l:c),u[C].material=x,u[C].castShadow=!0,u[C].receiveShadow=!0,si.container.add(u[C])}if(e.extraWeels){var P=e.meshWheel.clone();P.children[0].visible=!1,P.rotation.z=.5*-Math.Pi,P.position.set(0,1.25,-1.11),n.add(P)}n.userData.radius=l,n.userData.w=u,n.userData.s=p,n.userData.b=m,n.userData.isWithSusp=f,n.userData.isWithBrake=g,void 0===e.noShadow&&(n.castShadow=!0,n.receiveShadow=!0),n.name=t,e.helper&&(n.userData.helper=new yi(r,e.masscenter,h),n.add(n.userData.helper)),e.mesh&&(e.mesh=null),e.wheel&&(e.wheel=null),"mesh"!==e.shapeType&&"convex"!==e.shapeType||(e.v=ii(e.shape,e.shapeType)),e.shape&&delete e.shape,e.geometry&&delete e.geometry,e.material&&delete e.material,e.mesh&&delete e.mesh,e.meshWheel&&delete e.meshWheel,e.meshSusp&&delete e.meshSusp,e.meshBrake&&delete e.meshBrake,e.meshSteeringWheel&&delete e.meshSteeringWheel,e.wheelMaterial&&delete e.wheelMaterial,this.cars.push(n),li.set(t,n),si.post("add",e)}}),a(bi.prototype,{step:function(e,t){var n;this.heroes.forEach((function(i,a){var o=3.33*e[n=t+8*a];i.userData.speed=100*o,i.position.fromArray(e,n+1),i.quaternion.fromArray(e,n+4),i.skin&&(0===o?i.skin.play(0,.3):(i.skin.play(1,.3),i.skin.setTimeScale(o)))}))},clear:function(){for(;this.heroes.length>0;)this.destroy(this.heroes.pop());this.ID=0},destroy:function(e){e.parent&&e.parent.remove(e),li.delete(e.name)},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.heroes.indexOf(t);-1!==n&&(this.heroes.splice(n,1),this.destroy(t))}},add:function(e){var t,n=-(Math.abs(gm.boundingBox.max.y)-Math.abs(gm.boundingBox.min.y))*e.scale*.5,i=void 0!==e.name?e.name:e.type+this.ID++;if(this.remove(i),e.scale=e.scale||1,e.size=void 0!==e.size?e.size:[.25,2],e.mesh){var a=e.mesh.geometry,o=(Math.abs(a.boundingBox.max.y)+Math.abs(a.boundingBox.min.y))*e.scale;e.size[1]=o}e.size[1]=e.size[1]-2*e.size[0],e.pos=void 0===e.pos?[0,0,0]:e.pos,e.rot=void 0===e.rot?[0,0,0]:e.rot,e.quat=(new w._fP).setFromEuler((new w.USm).fromArray(e.rot)).toArray(),t=void 0!==e.material?e.material.constructor===String?si.mat[e.material]:e.material:si.mat.hero;var r=new ai(e.size[0],e.size[1],6),s=new w.ZAu;if(e.debug){var l=new w.Kj0(r,si.mat.debug);si.extraGeo.push(r),s.add(l)}if(e.mesh){var c=e.mesh;c.material=t,c.scale.multiplyScalar(e.scale),c.position.set(0,n,0),c.setTimeScale(.5),c.play(0),s.add(c),s.skin=c}else{var h=new w.Kj0(r,t);si.extraGeo.push(r),s.add(h)}return s.userData.speed=0,s.userData.type="hero",s.position.fromArray(e.pos),s.quaternion.fromArray(e.quat),s.castShadow=!0,s.receiveShadow=!0,s.name=i,e.material&&delete e.material,e.mesh&&delete e.mesh,e.scale&&delete e.scale,si.container.add(s),this.heroes.push(s),li.set(i,s),si.post("add",e),s}}),Object.assign(xi.prototype,{step:function(e,t){this.pairs.forEach((function(n,i){n.hit=e[t+i]?e[t+i]:0,n.callback(e[t+i]||0)}))},clear:function(){for(;this.pairs.length>0;)this.destroy(this.pairs.pop());this.ID=0},destroy:function(e){e.clear(),li.delete(e.name)},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.pairs.indexOf(t);-1!==n&&(this.pairs.splice(n,1),this.destroy(t))}},add:function(e){var t=void 0!==e.name?e.name:"pair".concat(this.ID++);this.remove(t);var n=new Mi(t,e.callback);return this.pairs.push(n),delete e.callback,li.set(t,n),si.post("add",e),n}}),Object.assign(Mi.prototype,{clear:function(){this.name=null,this.hit=0,this.callback=null}}),Object.assign(Si.prototype,{step:function(){var e=this.rays.length,t=si.flow.ray.length;if(e){if(e===t)for(;t--;)this.rays[t].update(si.flow.ray[t]);si.flow.ray=[],this.rays.forEach((function(e){e.updateMatrixWorld(),si.flow.ray.push({origin:e.origin,dest:e.dest,group:e.group,mask:e.mask,precision:e.precision})}))}},clear:function(){for(;this.rays.length>0;)this.destroy(this.rays.pop());this.ID=0},destroy:function(e){e.parent&&e.parent.remove(e),li.delete(e.name)},remove:function(e){if(li.has(e)){var t=li.get(e),n=this.rays.indexOf(t);-1!==n&&(this.rays.splice(n,1),this.destroy(t))}},add:function(e){e.name=void 0!==e.name?e.name:"ray".concat(this.ID++),this.remove(e.name);var t=new Ci(e);return void 0!==e.visible&&(t.visible=e.visible),void 0!==e.parent?e.parent.add(t):si.container.add(t),this.rays.push(t),li.set(e.name,t),delete e.callback,delete e.parent,si.post("add",e),t}}),o(Ci,w.x12),a(Ci.prototype,{setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.start.setFromMatrixPosition(t.matrixWorld),this.tmp.set(e.x,e.y,.5).unproject(t).sub(this.start).normalize(),this.end.copy(this.tmp).multiplyScalar(t.far).add(this.start)):t&&t.isOrthographicCamera?(this.start.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.normal.set(0,0,-1).transformDirection(t.matrixWorld),this.end.addScaledVector(this.normal,t.far)):console.error("Raycaster: Unsupported camera type.")},updateMatrixWorld:function(e){w.x12.prototype.updateMatrixWorld.call(this,e),this.tmp.copy(this.start).applyMatrix4(this.matrixWorld),this.tmp.toArray(this.origin,0),this.tmp.copy(this.end).applyMatrix4(this.matrixWorld),this.tmp.toArray(this.dest,0),this.inv.getInverse(this.matrixWorld)},upGeo:function(e){if(this.enabled){var t,n,i=this.vertices,a=this.colors,o=this.local;if(e)this.isBase=!1,a[0]=a[3]=a[15]=a[18]=this.c2[0],a[1]=a[4]=a[16]=a[19]=this.c2[1],a[2]=a[5]=a[17]=a[20]=this.c2[2],i[3]=i[6]=i[12]=i[15]=o[0],i[4]=i[7]=i[13]=i[16]=o[1],i[5]=i[8]=i[14]=i[17]=o[2],i[18]=o[3],i[19]=o[4],i[20]=o[5],this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0;else{if(this.isBase)return;for(var r=7;r--;)n=r<3,a[t=3*r]=this.c1[0],a[t+1]=this.c1[1],a[t+2]=this.c1[2],i[t]=n?this.start.x:this.end.x,i[t+1]=n?this.start.y:this.end.y,i[t+2]=n?this.start.z:this.end.z;this.geometry.attributes.position.needsUpdate=!0,this.geometry.attributes.color.needsUpdate=!0,this.isBase=!0}}},update:function(e){if(this.info.hit=e.hit,this.info.name=e.name||"",this.info.distance=0,e.hit){if(this.enabled){this.tmp.fromArray(e.point).applyMatrix4(this.inv);var t=this.tmp.distanceTo(this.end);e.distance=this.maxDistance-t,this.info.distance=e.distance,this.tmp.toArray(this.local,0),this.normal.fromArray(e.normal),this.tmp.addScaledVector(this.normal,t),this.tmp.toArray(this.local,3),this.upGeo(!0)}}else this.upGeo();this.callback(e)}}),a(Ti.prototype,{prepareBreakableObject:function(e,t,n,i,a){e.geometry.isBufferGeometry||console.error("ConvexObjectBreaker.prepareBreakableObject(): Parameter object must have a BufferGeometry.");var o=e.userData;o.mass=t,o.velocity=void 0!==n?n.clone():new w.Pa4,o.angularVelocity=void 0!==i?i.clone():new w.Pa4,o.breakable=a},subdivideByImpact:function(e,t,n,i,a){var o=[],r=(new w.Pa4).fromArray(t),s=(new w.Pa4).fromArray(n),l=this.tempPlane1,c=this.tempPlane2;this.tempVector3.addVectors(r,s),l.setFromCoplanarPoints(r,e.position,this.tempVector3);var h=a+i,d=this;return function t(n,a,u,p){if(Math.random()<.05*p||p>h)o.push(n);else{var m=Math.PI;0===p?(c.normal.copy(l.normal),c.constant=l.constant):p<=i?(m=(u-a)*(.2+.6*Math.random())+a,d.tempVector3_2.copy(e.position).sub(r).applyAxisAngle(s,m).add(r),c.setFromCoplanarPoints(r,d.tempVector3,d.tempVector3_2)):(m=(.5*(1&p)+.2*(2-Math.random()))*Math.PI,d.tempVector3_2.copy(r).sub(n.position).applyAxisAngle(s,m).add(n.position),d.tempVector3_3.copy(s).add(n.position),c.setFromCoplanarPoints(n.position,d.tempVector3_3,d.tempVector3_2)),d.cutByPlane(n,c,d.tempResultObjects);var f=d.tempResultObjects.object1,g=d.tempResultObjects.object2;f&&t(f,a,m,p+1),g&&t(g,m,u,p+1)}}(e,0,2*Math.PI,0),o},cutByPlane:function(e,t,n){var i=e.geometry;if(!i)return console.log(e,"no geometry ?"),0;var a=i.attributes.position.array,o=i.attributes.normal.array,r=a.length/3,s=r/3,l=i.getIndex();function c(e,t){var n=3*e+t;return l?l[n]:n}l&&(s=(l=l.array).length/3);for(var h=[],d=[],u=this.smallDelta,p=r*r,m=0;m<p;m++)this.segments[m]=!1;for(var f=this.tempVector3_P0,g=this.tempVector3_P1,v=this.tempVector3_N0,y=this.tempVector3_N1,b=0;b<s-1;b++){var x=c(b,0),M=c(b,1),S=c(b,2);v.set(o[x],o[x]+1,o[x]+2);for(var C=b+1;C<s;C++){var T=c(C,0),k=c(C,1),P=c(C,2);y.set(o[T],o[T]+1,o[T]+2),1-v.dot(y)<u&&(x===T||x===k||x===P?M===T||M===k||M===P?(this.segments[x*r+M]=!0,this.segments[M*r+x]=!0):(this.segments[S*r+x]=!0,this.segments[x*r+S]=!0):M!==T&&M!==k&&M!==P||(this.segments[S*r+M]=!0,this.segments[M*r+S]=!0))}}var I=this.tempPlane_Cut;e.updateMatrix(),Ti.transformPlaneToLocalSpace(t,e.matrix,I);for(var A=0;A<s;A++)for(var E=c(A,0),O=c(A,1),L=c(A,2),_=0;_<3;_++){var R=0===_?E:1===_?O:L,D=0===_?O:1===_?L:E;if(!this.segments[R*r+D]){this.segments[R*r+D]=!0,this.segments[D*r+R]=!0,f.set(a[3*R],a[3*R+1],a[3*R+2]),g.set(a[3*D],a[3*D+1],a[3*D+2]);var z=0,F=I.distanceToPoint(f);F>u?(z=2,d.push(f.clone())):F<-u?(z=1,h.push(f.clone())):(z=3,h.push(f.clone()),d.push(f.clone()));var B=0;if((F=I.distanceToPoint(g))>u?(B=2,d.push(g.clone())):F<-u?(B=1,h.push(g.clone())):(B=3,h.push(g.clone()),d.push(g.clone())),1===z&&2===B||2===z&&1===B){this.tempLine1.start.copy(f),this.tempLine1.end.copy(g);var W=new w.Pa4;if(void 0===(W=I.intersectLine(this.tempLine1,W)))return console.error("Internal error: segment does not intersect plane."),n.segmentedObject1=null,n.segmentedObject2=null,0;h.push(W),d.push(W.clone())}}}var j=.5*e.userData.mass;this.tempCM1.set(0,0,0);var N=0,U=h.length;if(U>0){for(var V=0;V<U;V++)this.tempCM1.add(h[V]);this.tempCM1.divideScalar(U);for(var H=0;H<U;H++){var G=h[H];G.sub(this.tempCM1),N=Math.max(N,G.x,G.y,G.z)}this.tempCM1.add(e.position)}this.tempCM2.set(0,0,0);var q=0,Y=d.length;if(Y>0){for(var X=0;X<Y;X++)this.tempCM2.add(d[X]);this.tempCM2.divideScalar(Y);for(var K=0;K<Y;K++){var Z=d[K];Z.sub(this.tempCM2),q=Math.max(q,Z.x,Z.y,Z.z)}this.tempCM2.add(e.position)}var J=null,Q=null,$=0;return U>4&&((J=new w.Kj0(new ri(h),e.material)).position.copy(this.tempCM1),J.quaternion.copy(e.quaternion),this.prepareBreakableObject(J,j,e.userData.velocity,e.userData.angularVelocity,2*N>this.minSizeForBreak),$++),Y>4&&((Q=new w.Kj0(new ri(d),e.material)).position.copy(this.tempCM2),Q.quaternion.copy(e.quaternion),this.prepareBreakableObject(Q,j,e.userData.velocity,e.userData.angularVelocity,2*q>this.minSizeForBreak),$++),n.object1=J,n.object2=Q,$}}),Ti.transformFreeVector=function(e,t){var n=e.x,i=e.y,a=e.z,o=t.elements;return e.x=o[0]*n+o[4]*i+o[8]*a,e.y=o[1]*n+o[5]*i+o[9]*a,e.z=o[2]*n+o[6]*i+o[10]*a,e},Ti.transformFreeVectorInverse=function(e,t){var n=e.x,i=e.y,a=e.z,o=t.elements;return e.x=o[0]*n+o[1]*i+o[2]*a,e.y=o[4]*n+o[5]*i+o[6]*a,e.z=o[8]*n+o[9]*i+o[10]*a,e},Ti.transformTiedVectorInverse=function(e,t){var n=e.x,i=e.y,a=e.z,o=t.elements;return e.x=o[0]*n+o[1]*i+o[2]*a-o[12],e.y=o[4]*n+o[5]*i+o[6]*a-o[13],e.z=o[8]*n+o[9]*i+o[10]*a-o[14],e},Ti.transformPlaneToLocalSpace=function(){var e=new w.Pa4;return function(t,n,i){i.normal.copy(t.normal),i.constant=t.constant;var a=Ti.transformTiedVectorInverse(t.coplanarPoint(e),n);Ti.transformFreeVectorInverse(i.normal,n),i.constant=-a.dot(i.normal)}}();var ki="undefined"==typeof performance?Date:performance,Pi=.5*Math.PI,Ii=function(){this.option={worldscale:1,gravity:[0,-10,0],fps:60,substep:2,broadphase:2,soft:!0,animFrame:!1,fixed:!0,jointDebug:!1},this.key=[0,0,0],this.rigidBody=null,this.softBody=null,this.terrains=null,this.vehicles=null,this.character=null,this.collision=null,this.rayCaster=null,this.constraint=null,this.convexBreaker=null,this.ray=null,this.mouseMode="free",this.tmpRemove=[],this.tmpAdd=[],this.oldFollow="",this.stats={skip:0},this.isInternUpdate=!1,this.t={now:0,delta:0,then:0,deltaTime:0,inter:0,tmp:0,n:0,timerate:0,steptime:0},this.timer=null,this.refView=null,this.isBuffer=!1,this.isPause=!1,this.stepNext=!1,this.currentMode="",this.oldMode="",this.worker=null,this.callback=null};a(Ii.prototype,{message:function(e){var t=e.data;switch(t.Ar&&(si.Ar=t.Ar),t.flow&&(si.flow=t.flow),t.m){case"initEngine":this.initEngine();break;case"start":this.start();break;case"step":this.step(t.fps,t.delta);break;case"moveSolid":this.moveSolid(t.o);break;case"ellipsoid":this.ellipsoidMesh(t.o);break;case"makeBreak":this.makeBreak(t.o)}},init:function(e,t,n,i){this.initArray(i),this.defaultRoot(),n=n||{},this.callback=e,this.isInternUpdate=n.use_intern_update||!1,this.option={fps:n.fps||120,worldscale:n.worldscale||1,gravity:n.gravity||[0,-10,0],substep:n.substep||2,broadphase:n.broadphase||2,soft:void 0===n.soft||n.soft,fixed:void 0===n.fixed||n.fixed,animFrame:void 0===n.animFrame||n.animFrame,jointDebug:void 0!==n.jointDebug&&n.jointDebug,isInternUpdate:this.isInternUpdate},this.t.timerate=1/this.option.fps*1e3,this.startWorker()},set:function(e){e=e||this.option,this.t.timerate=void 0!==e.fps?1/e.fps*1e3:this.t.timerate,this.option.fixed=e.fixed||!1,this.option.animFrame=e.animFrame||!1,this.option.jointDebug=e.jointDebug||!1,e.isInternUpdate=this.isInternUpdate,si.constraintDebug=this.option.jointDebug,this.post("set",e)},startWorker:function(){var e=new Jn;this.worker=e,e.postMessage=e.webkitPostMessage||e.postMessage,e.onmessage=this.message.bind(this);var t=new ArrayBuffer(1);e.postMessage({m:"test",ab:t},[t]),this.isBuffer=!t.byteLength,this.isInternUpdate&&(this.isBuffer=!1),this.post("init",{ArPos:si.ArPos,ArMax:si.ArMax,isBuffer:this.isBuffer,option:this.option}),si.post=this.post.bind(this)},initArray:function(e){var t={maxBody:(e=e||{}).maxBody||1400,maxContact:e.maxContact||200,maxCharacter:e.maxCharacter||10,maxCar:e.maxCar||14,maxSoftPoint:e.maxSoftPoint||8192,maxJoint:e.maxJoint||1e3};si.ArLng=[8*t.maxBody,t.maxContact,8*t.maxCharacter,64*t.maxCar,3*t.maxSoftPoint,14*t.maxJoint],si.ArPos=[0,si.ArLng[0],si.ArLng[0]+si.ArLng[1],si.ArLng[0]+si.ArLng[1]+si.ArLng[2],si.ArLng[0]+si.ArLng[1]+si.ArLng[2]+si.ArLng[3],si.ArLng[0]+si.ArLng[1]+si.ArLng[2]+si.ArLng[3]+si.ArLng[4]],si.ArMax=si.ArLng[0]+si.ArLng[1]+si.ArLng[2]+si.ArLng[3]+si.ArLng[4]+si.ArLng[5]},initEngine:function(){this.initObject(),console.log("[Physics] Engine loaded, v. ".concat("Shotgun005+Mad"," | ").concat(this.isBuffer?"Buffering Mode":"Raw"," | WASM")),this.callback&&this.callback()},start:function(e){var t=this;if(!this.isPause){var n=this.option,i=this.t,a=this.isBuffer;if(this.stop(),this.stepNext=!0,a&&(si.Ar=new Float32Array(si.ArMax)),i.then=ki.now(),e||this.isInternUpdate||(this.timer=n.animFrame?requestAnimationFrame(this.sendData):setInterval((function(){return t.sendData()}),i.timerate)),!e&&this.isInternUpdate){var o=this.getKey();this.worker.postMessage({m:"internStep",o:{steptime:i.steptime,key:o},flow:si.flow,Ar:si.Ar})}this.setMode(this.oldMode)}},prevUpdate:function(){},postUpdate:function(){},pastUpdate:function(){},update:function(){this.postUpdate(this.t.delta),this.rigidBody.step(si.Ar,si.ArPos[0]),this.collision.step(si.Ar,si.ArPos[1]),this.character.step(si.Ar,si.ArPos[2]),this.vehicles.step(si.Ar,si.ArPos[3]),this.softBody.step(si.Ar,si.ArPos[4]),this.constraint.step(si.Ar,si.ArPos[5]),this.terrains.step(),this.rayCaster.step(),this.pastUpdate(this.t.delta)},step:function(e,t){var n=this.t;this.isInternUpdate?(n.fps=e,n.delta=t):(n.now-1e3>n.tmp&&(n.tmp=n.now,n.fps=n.n,n.n=0),n.n++),this.tell(),this.update(),si.controler&&si.controler.follow(),this.stepRemove(),this.stepAdd(),this.stepNext=!0,this.isInternUpdate&&this.sendStep()},moveActor:function(){},sendData:function(e){if(!this.isInternUpdate)if(this.refView&&this.refView.pause)this.stop();else{var t=this.t;if(this.option.animFrame)this.timer=requestAnimationFrame(this.sendData),t.now=void 0===e?ki.now():e,t.deltaTime=t.now-t.then,t.delta=.001*t.deltaTime,t.deltaTime>t.timerate&&(t.then=t.now-t.deltaTime%t.timerate,this.sendStep());else{if(!this.stepNext)return void this.stats.skip++;t.delta=.001*(t.now-t.then),t.then=t.now,this.sendStep()}}},sendStep:function(){if(this.stepNext){var e=this.worker,t=this.t;t.now=ki.now(),this.prevUpdate(t.delta);var n=this.getKey();this.isInternUpdate?this.isBuffer&&e.postMessage({m:"internStep",o:{steptime:t.steptime,key:n},flow:si.flow,Ar:si.Ar},[si.Ar.buffer]):this.isBuffer?e.postMessage({m:"step",o:{delta:t.delta,key:n},flow:si.flow,Ar:si.Ar},[si.Ar.buffer]):e.postMessage({m:"step",o:{delta:t.delta,key:n},flow:si.flow,Ar:si.Ar}),this.stepNext=!1}},simpleStep:function(e){var t=this.getKey();this.worker.postMessage({m:"step",o:{delta:e,key:t}})},stepRemove:function(){var e=this.tmpRemove;if(0!==e.length)for(this.post("setRemove",e);e.length>0;)this.remove(e.pop(),!0)},stepAdd:function(){var e=this.tmpAdd;if(0!==e.length)for(;e.length>0;)this.add(e.shift())},setView:function(e){this.refView=e,si.mat=Object.assign({},si.mat,e.getMat()),si.geo=Object.assign({},si.geo,e.getGeo()),si.container=e.getContent(),si.controler=e.getControler(),si.isRefView=!0},getFps:function(){return this.t.fps},getDelta:function(){return this.t.delta},getIsFixed:function(){return this.option.fixed},getKey:function(){return this.key},setKey:function(e){this.key=e},tell:function(){},log:function(){},post:function(e,t){this.worker.postMessage({m:e,o:t})},reset:function(e){for(this.stats.skip=0,this.postUpdate=function(){},this.pastUpdate=function(){},this.prevUpdate=function(){},this.isPause=!1,this.oldMode=this.currentMode,this.setMode(""),this.stop(),this.clear();si.tmpMat.length>0;)si.tmpMat.pop().dispose();this.tmpRemove=[],this.tmpAdd=[],this.oldFollow="",this.refView&&this.refView.reset(e),this.post("reset",{full:e})},pause:function(){this.isPause=!0},play:function(){this.isPause&&(this.isPause=!1,this.start())},stop:function(){null!==this.timer&&(this.option.animFrame?window.cancelAnimationFrame(this.timer):clearInterval(this.timer),this.timer=null)},destroy:function(){this.worker.terminate(),this.worker=null},addMat:function(e){si.tmpMat.push(e)},ellipsoidMesh:function(e){this.softBody.createEllipsoid(e)},updateTmpMat:function(e,t){for(var n,i=si.tmpMat.length;i--;)void 0!==(n=si.tmpMat[i]).envMap&&("MeshStandardMaterial"===n.type?n.envMap=e:n.envMap=t?null:e,n.needsUpdate=!0)},setVehicle:function(e){si.flow.vehicle.push(e)},drive:function(e){this.post("setDrive",e)},move:function(e){this.post("setMove",e)},forces:function(e,t){t=t||!1,this.post(t?"directForces":"setForces",e)},options:function(e,t){t=t||!1,this.post(t?"directOptions":"setOptions",e)},matrix:function(e,t){t=t||!1,this.post(t?"directMatrix":"setMatrix",e)},clearFlow:function(){si.flow={ray:[],terrain:[],vehicle:[]}},anchor:function(e){this.post("addAnchor",e)},break:function(e){this.post("addBreakable",e)},moveSolid:function(e){if(li.has(e.name)){var t=li.get(e.name);void 0!==e.pos&&t.position.fromArray(e.pos),void 0!==e.quat&&t.quaternion.fromArray(e.quat)}},getBodies:function(){return this.rigidBody.bodies},initObject:function(){this.rigidBody=new di,this.softBody=new gi,this.terrains=new vi,this.vehicles=new wi,this.character=new bi,this.collision=new xi,this.rayCaster=new Si,this.constraint=new ui},clear:function(){for(this.clearFlow(),this.rigidBody.clear(),this.collision.clear(),this.terrains.clear(),this.vehicles.clear(),this.character.clear(),this.softBody.clear(),this.rayCaster.clear(),this.constraint.clear();si.extraGeo.length>0;)si.extraGeo.pop().dispose()},remove:function(e,t){t||this.post("remove",e);var n=this.byName(e);if(null!==n)switch(n.type){case"solid":case"body":this.rigidBody.remove(e);break;case"soft":this.softBody.remove(e);break;case"terrain":this.terrains.remove(e);break;case"collision":this.collision.remove(e);break;case"ray":this.rayCaster.remove(e);break;case"constraint":this.constraint.remove(e)}},removes:function(e){this.tmpRemove=this.tmpRemove.concat(e)},removesDirect:function(e){this.post("directRemoves",e)},byName:function(e){return li.has(e)?li.get(e):(this.tell("[Ammo.labs] object ".concat(e," not found!")),null)},addGroup:function(e){this.tmpAdd=this.tmpAdd.concat(e)},add:function(e){var t=void 0===(e=e||{}).type?"box":e.type,n=t.substring(0,4);if("join"===n)return this.constraint.add(e);if("soft"===n)this.softBody.add(e);else if("terrain"===t)this.terrains.add(e);else{if("character"===t)return this.character.add(e);if("collision"===t)return this.collision.add(e);if("car"!==t)return"ray"===t?this.rayCaster.add(e):this.rigidBody.add(e);this.vehicles.add(e)}},defaultRoot:function(){var e={circle:new w.trn(1,6),plane:new w.BKK(1,1,1,1),box:new w.nvb(1,1,1),hardbox:new w.nvb(1,1,1),cone:new w.m_w(0,1,.5),wheel:new w.m_w(1,1,1,18),sphere:new w.Aip(1,16,12),highsphere:new w.Aip(1,32,24),cylinder:new w.m_w(1,1,1,12,1),hardcylinder:new w.m_w(1,1,1,12,1),joint:new w._3(.1,.2,4)};e.circle.rotateX(-Pi),e.plane.rotateX(-Pi),e.wheel.rotateZ(-Pi),e.joint.translate(0,.1,0),e.joint.rotateZ(.5*-Math.PI),si.geo=e;var t=!1;si.mat={hide:new w.vBJ({name:"debug",color:0,depthTest:!1,depthWrite:!1,visible:!1}),move:new w.YBo({color:13421772,name:"move",wireframe:t}),speed:new w.YBo({color:16763955,name:"speed",wireframe:t}),sleep:new w.YBo({color:3394815,name:"sleep",wireframe:t}),static:new w.YBo({color:16711680,name:"static",wireframe:t,transparent:!0,opacity:.5,depthTest:!0,depthWrite:!0}),kinematic:new w.YBo({color:8978227,name:"kinematic",wireframe:t}),soft:new w.YBo({name:"soft",vertexColors:!0}),debug:new w.vBJ({name:"debug",color:65280,depthTest:!1,depthWrite:!1,wireframe:!0}),jointLine:new w.nls({name:"jointLine",vertexColors:!0,depthTest:!1,depthWrite:!1,transparent:!0}),jointP1:new w.vBJ({name:"jointP1",color:65280,depthTest:!1,depthWrite:!0,wireframe:!0}),jointP2:new w.vBJ({name:"jointP2",color:16776960,depthTest:!1,depthWrite:!0,wireframe:!0})},si.container=new w.ZAu,si.destroy=function(e){for(var t;e.children.length>0;){for(t=e.children.pop();t.children.length>0;)t.remove(t.children.pop());e.remove(t)}e.parent&&e.parent.remove(e)}},getContainer:function(){return si.container},makeBreak:function(e){var t=e.name;if(li.has(t)){null===this.convexBreaker&&(this.convexBreaker=new Ti);var n=li.get(t),i=e.breakOption,a=this.convexBreaker.subdivideByImpact(n,e.pos,e.normal,i[1],i[2]);i[3]-=1,this.tmpRemove.push(t);for(var o=a.length;o--;)this.tmpAdd.push(this.addDebris(t,o,a[o],i))}},addDebris:function(e,t,n,i){var a={name:"".concat(e,"_debris").concat(t),material:n.material,type:"convex",shape:n.geometry,pos:n.position.toArray(),quat:n.quaternion.toArray(),mass:n.userData.mass,linearVelocity:n.userData.velocity.toArray(),angularVelocity:n.userData.angularVelocity.toArray(),margin:.05};return i[3]>0&&(a.breakable=!0,a.breakOption=i),a},setMode:function(e){e!==this.currentMode&&("picker"===this.currentMode&&this.removeRayCamera(),"shoot"===this.currentMode&&this.removeShootCamera(),"lock"===this.currentMode&&this.removeLockCamera()),this.currentMode=e,"picker"===this.currentMode&&this.addRayCamera(),"shoot"===this.currentMode&&this.addShootCamera(),"lock"===this.currentMode&&this.addLockCamera()},addLockCamera:function(){},removeLockCamera:function(){},addShootCamera:function(){},removeShootCamera:function(){},addRayCamera:function(){this.refView&&(this.ray=this.add({name:"cameraRay",type:"ray",callback:this.onRay,mask:1,visible:!1}),this.refView.activeRay(this.updateRayCamera,!1))},removeRayCamera:function(){this.refView&&(this.remove("cameraRay"),this.refView.removeRay(),this.log())},updateRayCamera:function(e){"drag"===this.mouseMode&&this.matrix([{name:"dragger",pos:e.toArray(),keepRot:!0}])},onRay:function(e){var t=this.refView,n=t.getMouse(),i=t.getControls(),a=void 0===e.name?"":e.name;this.ray.setFromCamera(n,i.object),0===n.z?("drag"===this.mouseMode&&(i.enableRotate=!0,this.removeConnector()),this.mouseMode="free"):"free"===this.mouseMode&&(a?"drag"!==this.mouseMode&&(t.setDragPlane(e.point),i.enableRotate=!1,this.addConnector(e),this.mouseMode="drag"):this.mouseMode="rotate"),this.log("".concat(this.mouseMode,"   ").concat(a))},addConnector:function(e){var t=this.byName(e.name);if(t){this.testCurrentFollow(e.name);var n=(new w.Pa4).fromArray(e.point),i=t.quaternion.toArray(),a=this.getLocalPoint(n,t).toArray();this.add({name:"dragger",type:"sphere",size:[.2],pos:e.point,quat:i,mass:0,kinematic:!0,group:32,mask:32}),this.add({name:"connector",type:"joint_fixe",b1:"dragger",b2:e.name,pos1:[0,0,0],pos2:a,collision:!1})}},removeConnector:function(){this.remove("dragger"),this.remove("connector"),""!==this.oldFollow&&this.setCurrentFollow(this.oldFollow)},getLocalPoint:function(e,t){t.updateMatrix();var n=new w.yGw,i=new w.Pa4(1,1,1),a=(new w.yGw).compose(t.position,t.quaternion,i);return n.copy(a).invert(),e.applyMatrix4(n)},setCurrentFollow:function(e,t){var n=this.refView;if(this.refView){var i=this.byName(e);null!==i?n.getControls().initFollow(i,t):n.getControls().resetFollow(),this.oldFollow=""}},testCurrentFollow:function(e){this.oldFollow="";var t=this.refView;t&&t.getControls().followTarget&&t.getControls().followTarget.name===e&&(t.getControls().resetFollow(),this.oldFollow=e)}});var Ai=function(e){this.physics=e,this.Ammo=null,this.AmmoWrapper=new Ii,this.characterHandle=null,this._q=new w._fP,this._p=new w.Pa4,this._qd=new w._fP,this._pd=new w.Pa4,this._dd=new w.Pa4,this._m=new w.yGw,this._matrixAggregate=[]};a(Ai.prototype,{preload:function(){var e=this,t=this.AmmoWrapper;window.addEventListener("DOMContentLoaded",(function(){t.init((function(){console.log("[Physics/Bullet] Bullet initialized."),t.set({fps:60,substep:2,gravity:[0,0,-10],fixed:!1}),t.start(!0),e.physics.isLoaded=!0}))}))},refresh:function(){var e=this.AmmoWrapper;this.characterHandle&&this._matrixAggregate.length>0&&e.matrix(this._matrixAggregate),e.sendData(),this._matrixAggregate.length=0},addHeightMap:function(e){for(var t=this.AmmoWrapper,n=this.physics.app.engine.graphics,i=e.geometry.parameters.widthSegments,a=e.geometry.parameters.heightSegments,o=new Float32Array((i+1)*(a+1)),r=e.geometry.attributes.position.array,s=0,l=0;l<i+1;++l)for(var c=0;c<a+1;++c)o[s]=r[3*s+2],s++;var h=e.position;t.add({type:"terrain",sample:[i+1,a+1],size:[10,10,10],upAxis:2,heightData:o,pos:[h.x,h.y,h.z]});var d=t.add({type:"capsule",kinematic:!0,friction:.5,restitution:.2,name:"bobby",pos:[2,-2,1],rot:[0,Math.PI/2,Math.PI/2],size:[.25,1],material:new w.vBJ({color:65280,wireframe:!0})});n.addToScene(d,"-1"),this.characterHandle=d,this._p.copy(d.position),this._q.copy(d.quaternion);for(var u=0;u<300;++u){var p=t.add({type:"sphere",size:[.1,.1,.1],pos:[2*Math.random()-1,2*Math.random()-1,.5+u/10],mass:2,friction:1,angular:.1});n.addToScene(p,"-1")}for(var m=0;m<2;++m){var f=m<1?-6.01:6.01,g=t.add({type:"box",size:[2,10,20],pos:[f,0,.5],flag:1}),v=t.add({type:"box",size:[10,2,20],pos:[0,f,.5],flag:1});n.addToScene(g,"-1"),n.addToScene(v,"-1")}var y=t.add({type:"box",size:[1,1,2],pos:[0,1,.5],flag:1});n.addToScene(y,"-1"),y=t.add({type:"box",size:[1,1,2],pos:[1,0,.5],flag:1}),n.addToScene(y,"-1"),y=t.add({type:"box",size:[1,1,2],pos:[1,1,.5],flag:1}),n.addToScene(y,"-1"),n.addToScene(y,"-1")},pushEvent:function(e){var t=[0,0,0];if("m"===e[0]){switch(e[1]){case"f":t[0]=1;break;case"b":t[0]=-1;break;case"r":t[1]=-1;break;case"l":t[1]=1;break;case"u":t[2]=1;break;case"d":t[2]=-1;break;case"fx":case"bx":case"rx":case"lx":case"ux":case"dx":break;default:return}if(this.characterHandle){var n,i=this._q,a=this._p;(n=this._pd).set.apply(n,t),this._pd.normalize().multiplyScalar(.1),a.add(this._pd),this._matrixAggregate.push({name:"bobby",pos:this._p.toArray(),quat:i.toArray()})}}},addCharacterController:function(){},cleanup:function(){}});var Ei=function(e,t,n,i){this.indexOnXArray=e,this.indexOnYArray=t,this.indexOnZArray=n,this.collisionModel={aabbCenter:i},this.isStatic=!0,this.isPlaceHolder=!0},Oi=function(e){this.physics=e,this.orderedObjectsByX=[],this.orderedObjectsByY=[],this.orderedObjectsByZ=[],this.entitiesNeedingToMove=new Set,this.dynamicEntities=new Set,this.potentialCollidingPairs=new Set,this.projectiles=new Set,this.physicsEntities=[],this.heightMaps=new Map,this.heightMapSideWidth=Vt,this.locks=[!1,!1,!1,!1,!1,!1],this.availableIndicesInPhysicalEntitiesArray=[]};a(Oi.prototype,{reorderObjects:function(){var e=this.physicsEntities,t=this.orderedObjectsByX,n=this.orderedObjectsByY,i=this.orderedObjectsByZ;r(t.length===n.length&&t.length===i.length,"sweeper length");for(var a=0;a<e.length;++a)t[a]=a,n[a]=a,i[a]=a;t.sort((function(t,n){return e[t].collisionModel.aabbCenter.x<e[n].collisionModel.aabbCenter.x?-1:e[t].collisionModel.aabbCenter.x>e[n].collisionModel.aabbCenter.x?1:0})),n.sort((function(t,n){return e[t].collisionModel.aabbCenter.y<e[n].collisionModel.aabbCenter.y?-1:e[t].collisionModel.aabbCenter.y>e[n].collisionModel.aabbCenter.y?1:0})),i.sort((function(t,n){return e[t].collisionModel.aabbCenter.z<e[n].collisionModel.aabbCenter.z?-1:e[t].collisionModel.aabbCenter.z>e[n].collisionModel.aabbCenter.z?1:0}));for(var o=e.length,s=0;s<o;++s)e[t[s]].indexOnXArray=s,e[n[s]].indexOnYArray=s,e[i[s]].indexOnZArray=s},insertObject:function(e){var t=this.orderedObjectsByX,n=this.orderedObjectsByY,i=this.orderedObjectsByZ;if(r(t.length===n.length&&t.length===i.length,"sweeper length"),t.length<1)return t.push(e),e.indexOnXArray=0,n.push(e),e.indexOnYArray=0,i.push(e),void(e.indexOnZArray=0);var a=e.collisionModel,o=a.aabbCenter.x,s=a.aabbCenter.y,l=a.aabbCenter.z,c=this.dichotomyLowerBound(t,o,"x"),h=this.dichotomyLowerBound(n,s,"y"),d=this.dichotomyLowerBound(i,l,"z");for(t.splice(c,0,e);++c<t.length;)t[c].indexOnXArray++;for(n.splice(h,0,e);++h<n.length;)n[h].indexOnYArray++;for(i.splice(d,0,e);++d<i.length;)i[d].indexOnZArray++},dichotomyLowerBound:function(e,t,n){for(var i,a=0,o=e.length-1;a<=o;)if(e[i=a+o>>1].collisionModel.aabbCenter[n]>t)o=i-1;else{if(!(e[i].collisionModel.aabbCenter[n]<t))return i;a=i+1}return a},reserveEntityId:function(){return this.availableIndicesInPhysicalEntitiesArray.length?this.availableIndicesInPhysicalEntitiesArray.pop():this.physicsEntities.length},getNumberOfEntities:function(){return this.physicsEntities.length},anEntityNeedsToMove:function(e){r(!e.isPlaceHolder,"[Sweeper] trying to move a placeholder?"),this.entitiesNeedingToMove.add(e)},addPhysicsEntity:function(e){r("number"==typeof e.entityId,"[Sweeper] entity id typecast failed."),this.physicsEntities[e.entityId]=e,this.insertObject(e),e.collisionModel.isStatic||this.dynamicEntities.add(e)},addPhysicsEntityWithoutSorting:function(e){r("number"==typeof e,"[Sweeper] entity id typecast failed."),this.physicsEntities[e.entityId]=e,this.orderedObjectsByX.push(e),this.orderedObjectsByY.push(e),this.orderedObjectsByZ.push(e),e.collisionModel.isStatic||this.dynamicEntities.add(e)},removeEntity:function(e){var t=this.physicsEntities[e];if(!t)throw Error("[Mad/Sweeper] Trying to remove entity that’s not there.");var n=this.orderedObjectsByX,i=t.indexOnXArray,a=this.orderedObjectsByY,o=t.indexOnYArray,r=this.orderedObjectsByZ,s=t.indexOnZArray,l=new Ei(i,o,s,t.collisionModel.aabbCenter);n[i]=l,a[o]=l,r[s]=l,this.dynamicEntities.remove(t),this.physicsEntities[e]=null,this.availableIndicesInPhysicalEntitiesArray.push(e),t.destroy()},sweepDetectOverlappingPairs:function(){var e=this;this.potentialCollidingPairs.clear(),this.physicsEntities.forEach((function(t){if(!t.isPlaceHolder)for(var n=t.entityId,i=e.getOverlappingNeighbors(t),a=0;a<i.length;++a){var o=i[a].entityId;e.potentialCollidingPairs.add("".concat(Math.min(n,o),",").concat(Math.max(n,o)))}}))},getOverlappingNeighbors:function(e){var t=this,n=this.orderedObjectsByX,i=this.orderedObjectsByY,a=this.orderedObjectsByZ,o=e.indexOnXArray,s=e.indexOnYArray,l=e.indexOnZArray,c=e.collisionModel,h=c.aabbCenter,d=c.isStatic,u=n.length,p=c.getP0P1Delta();p.add(c.getAABBHalf());var m,f=this.locks;for(m=0;m<6;++m)f[m]=!1;var g=0,v=!1,y=[];if(!d){do{if(m=o,--m>=0&&this.overlaps(n[m],h,p,d)?y.push(n[m]):f[0]=!0,m=o,++m<n.length&&this.overlaps(n[m],h,p,d)?y.push(n[m]):f[1]=!0,f[0]&&f[1])break;if(m=s,--m>=0&&this.overlaps(i[m],h,p,d)?y.push(i[m]):f[2]=!0,m=s,++m<i.length&&this.overlaps(i[m],h,p,d)?y.push(i[m]):f[3]=!0,f[2]&&f[3])break;if(m=l,--m>=0&&this.overlaps(a[m],h,p,d)?y.push(a[m]):f[2]=!0,m=l,++m<a.length&&this.overlaps(a[m],h,p,d)?y.push(a[m]):f[3]=!0,f[2]&&f[3])break;v=f[4]&&f[5]}while(!v&&g++<u/2);this.physicsEntities.forEach((function(e){e.isStatic&&!e.isPlaceHolder&&t.overlaps(e,h,p,d)&&y.push(e)})),r(g<5,"[Sweeper] more than 5 iterations")}return y},overlaps:function(e,t,n,i){if(e.isPlaceHolder)return!1;if(i&&e.isStatic)return!1;var a=e.collisionModel,o=a.aabbCenter,r=a.getP0P1Delta();return r.add(a.getAABBHalf()),r.add(n),!(Math.abs(o.x-t.x)>r.x)&&!(Math.abs(o.y-t.y)>r.y)&&Math.abs(o.z-t.z)<=r.z},updateOrderedArraysAfterMove:function(e){for(var t=this.orderedObjectsByX,n=this.orderedObjectsByY,i=this.orderedObjectsByZ,a=this.physicsEntities,o=a[e],r=t.length,s=o.center,l=s[0],c=s[1],h=s[2],d=o.indexOnXArray-1,u=o.indexOnXArray+1,p=o.indexOnYArray-1,m=o.indexOnYArray+1,f=o.indexOnZArray-1,g=o.indexOnZArray+1;d>-1&&a[t[d].entityId].collisionModel.aabbCenter.x>l;)this.swap(t,d,d+1),--d;for(;u<r&&a[t[u].entityId].collisionModel.aabbCenter.x<l;)this.swap(t,u,u-1),++u;for(;p>-1&&a[n[p].entityId].collisionModel.aabbCenter.y>c;)this.swap(n,p,p+1),--p;for(;m<r&&a[n[m].entityId].collisionModel.aabbCenter.y<c;)this.swap(n,m,m-1),++m;for(;f>-1&&a[i[f].entityId].collisionModel.aabbCenter.z>h;)this.swap(i,f,f+1),--f;for(;g<r&&a[i[g].entityId].collisionModel.aabbCenter.z<h;)this.swap(i,g,g-1),++g},swap:function(e,t,n){var i=this.entities;Li(e,t,n),e===this.orderedObjectsByX?(i[e[t].entityId].indexOnXArray=t,i[e[n].entityId].indexOnXArray=n):e===this.orderedObjectsByY?(i[e[t].entityId].indexOnYArray=t,i[e[n].entityId].indexOnYArray=n):e===this.orderedObjectsByZ&&(i[e[t].entityId].indexOnZArray=t,i[e[n].entityId].indexOnZArray=n)},refreshEntitiesNeedingMovement:function(){var e=this;this.entitiesNeedingToMove.clear(),this.dynamicEntities.forEach((function(t){var n=t.collisionModel;(!n.onGround||n.wantsToMove||n.isSubjectToContinuousForce)&&(n.isCharacter&&(n.wasLifted=!1,n.wasLiftedByAStaticObject=!1,n.stepDownCollisionData.length=0),n.wantsToMove&&(n.wasOnGround=n.onGround,n.canJumpFromGround=n.onGround),e.entitiesNeedingToMove.add(t))}))},cleanup:function(){this.orderedObjectsByX=[],this.orderedObjectsByY=[],this.orderedObjectsByZ=[],this.entitiesNeedingToMove.clear(),this.dynamicEntities.clear(),this.potentialCollidingPairs.clear(),this.physicsEntities=[],this.heightMaps.clear(),this.heightMapSideWidth=Vt,this.locks=[!1,!1,!1,!1,!1,!1],this.availableIndicesInPhysicalEntitiesArray=[]},movePhysicsEntity:function(e){this.anEntityNeedsToMove(e)}});var Li=function(e,t,n){var i=e[t];return e[t]=e[n],e[n]=i,e},_i=1e-6,Ri=function(e){this.sweeper=e,this.collisionModelsNeedingStepDown=new Set,this._w1=new w.Pa4,this._w2=new w.Pa4,this._w3=new w.Pa4,this._w4=new w.Pa4,this._w5=new w.Pa4,this._w6=new w.Pa4,this._w7=new w.Pa4,this._wSL=new w.Pa4,this._w8=new w.Pa4,this._w9=new w.Pa4,this._w10=new w.Pa4,this._w11=new w.Pa4,this._w12=new w.Pa4,this._insideFace=!1,this._debug=!1};a(Ri.prototype,{atLeastOneStaticEntityWasMoved:function(){this.sweeper.dynamicEntities.forEach((function(e){e.collisionModel.onGround=!1}))},collidePairs:function(){var e=this,t=this.sweeper.potentialCollidingPairs,n=this.sweeper.physicsEntities;t.forEach((function(t){var i=t.split(",");if(2!==i.length)throw Error("[Mad/Collider] Invalid collision pair");var a=parseInt(i[0],10),o=parseInt(i[1],10),r=n[a],s=n[o];e.collidePair(r,s)}))},collidePair:function(e,t){var n=e.collisionModel,i=t.collisionModel;if(n.isStatic&&i.isStatic)throw Error("[Mad/Collider] Static-to-static not allowed");return n.isStatic?this.collideStaticToDynamic(n,i):i.isStatic?this.collideStaticToDynamic(i,n):this.collideDynamicToDynamic(n,i)},collideTerrain:function(){var e=this,t=this.sweeper.entitiesNeedingToMove,n=this.sweeper.heightMaps,i=this.sweeper.heightMapSideWidth;t.forEach((function(t){var a=t.collisionModel;if(a.isSphere||a.isCharacter){var o=a.position1,r=o.x,s=o.y,l=Math.floor(r/i+.5),c=Math.floor(s/i+.5),h="".concat(l,",").concat(c),d=n.get(h);if(d){var u=r-(l-.5)*i,p=s-(c-.5)*i;a.collideAgainstTerrain(u,p,d,e)}else e._debug&&console.warn("[Mad/Collider] No height map underneath ".concat(t.entityId,"??"));var m=a.getMaxRadius(),f=i/2,g=e.positiveMod(r+f,i)<=m,v=e.positiveMod(r+f,i)+m>=i,y=e.positiveMod(s+f,i)<=m,w=e.positiveMod(s+f,i)+m>=i;g&&e.collideOnBorder(l-1,c,r,s,i,n,a),v&&e.collideOnBorder(l+1,c,r,s,i,n,a),y&&e.collideOnBorder(l,c-1,r,s,i,n,a),w&&e.collideOnBorder(l,c+1,r,s,i,n,a),g&&y&&e.collideOnBorder(l-1,c-1,r,s,i,n,a),v&&y&&e.collideOnBorder(l+1,c-1,r,s,i,n,a),g&&w&&e.collideOnBorder(l-1,c+1,r,s,i,n,a),v&&w&&e.collideOnBorder(l+1,c+1,r,s,i,n,a)}else console.warn("[Mad/Collider] Trying to terrain-collide a non-sphere.")}))},positiveMod:function(e,t){return(e%t+t)%t},collideOnBorder:function(e,t,n,i,a,o,r){var s=o.get("".concat(e,",").concat(t));s?r.collideAgainstTerrain(n-(e-.5)*a,i-(t-.5)*a,s,this):this._debug&&console.warn("[Map/Collider] No heightmap on border.")},collideStaticToDynamic:function(e,t){if(t.isSphere||t.isCharacter){if(t.isSphere)t.collideAgainstStatic(e,this);else if(t.isCharacter){if(t.onGround&&!t.wantsToMove&&!t.isSubjectToContinuousForce)return;t.collideAgainstStatic(e,this)}}else console.warn("[Mad] Only spheres and characters\n                can interact with statics:\n                ".concat(t.isPlatform?"platform":t,"."))},collideDynamicToDynamic:function(e,t){return e.isCharacter&&t.isCharacter?e.collideAgainstCharacter(t):e.isSphere&&t.isSphere?e.collideAgainstSphere(t):e.isCharacter?e.collideAgainstDynamicSphere(t):t.isCharacter?t.collideAgainstDynamicSphere(e):void 0},stepDownEntities:function(){var e=this;this.collisionModelsNeedingStepDown.forEach((function(t){if(!t.onGround&&t.wasOnGround){var n=!0;t.isJumping&&(t.onGround=!1,t.onWater=!1,n=!1),t.isPreparingJump&&(n=!1),n&&t.stepDown(e)}t.stepDownCollisionData.length=0})),this.collisionModelsNeedingStepDown.clear()},pushCollisionModelForStepDown:function(e){this.collisionModelsNeedingStepDown.add(e)},intersectSphereTriOrthogonal:function(e,t,n,i,a,o,r){var s=this.getClosestPointInTri(e,n,i,a),l=this._w5,c=this._w3;c.copy(s).addScaledVector(e,-1);var h=c.lengthSq();if(h>t+_i)return l.set(0,0,0),l;var d=this._w6,u=this._w1,p=this._w2;d.copy(u).cross(p),d.normalize();var m=d.length();if(m<_i)return l.set(0,0,0),l;d.multiplyScalar(1/m);var f=Math.sqrt(h),g=this._w12;g.copy(d).projectOnPlane(r).normalize();var v=d.dot(g);if(Math.abs(v)<_i)return l.set(0,0,0),l;var y=o-f;l.copy(g).multiplyScalar(y/v);var w=this._w8;w.copy(e).add(l);var b=this.getClosestPointInTri(w,n,i,a);if(!this._insideFace){var x=this._w9;if(x.copy(s).addScaledVector(w,-1),x.length()>o){var M=this._w10;M.copy(g).normalize().negate();var S=this._w11,C=this.intersectSphereLine(w,M,b,t,S);1!==C?this._debug&&console.warn(-1===C?"[Collider/H] r’s origin outside s (c > 0) and r pointing away from s (b > 0) ":-2===C?"[Collider/H] negative discriminant corresponds to ray missing sphere":"[Collider/H] unmanaged"):l.copy(S).addScaledVector(e,-1)}}return l},intersectSphereTriVertical:function(e,t,n,i,a,o,r){var s=this.getClosestPointInTri(e,n,i,a),l=this._w3;l.copy(s).addScaledVector(e,-1);var c=this._w5;if(l.lengthSq()>t+_i)return c.set(0,0,0),c;var h=this._w6,d=this._w1,u=this._w2;h.copy(d).cross(u);var p=h.lengthSq();if(p<=_i)return c.set(0,0,0),c;h.multiplyScalar(1/Math.sqrt(p)),h.dot(l)>0&&h.negate();var m=h.dot(r);if(m<_i&&!(m<0))return c.set(0,0,0),c;var f=this._w7,g=Math.abs(l.normalize().dot(h));f.copy(s).addScaledVector(h,g*o+_i),f.addScaledVector(e,-1);var v=Math.abs(f.dot(h))/m;return c.copy(r).multiplyScalar(v),c},getClosestPointInTri:function(e,t,n,i){this._insideFace=!1;var a=this._w1,o=this._w2,r=this._w3;a.copy(n).addScaledVector(t,-1),o.copy(i).addScaledVector(t,-1),r.copy(e).addScaledVector(t,-1);var s=a.dot(r),l=o.dot(r);if(s<=0&&l<=0)return t;r.copy(e).addScaledVector(n,-1);var c=a.dot(r),h=o.dot(r);if(c>=0&&h<=c)return n;var d=s*h-c*l;if(d<=0&&s>=0&&c<=0){var u=s/(s-c),p=this._w4;return p.copy(t).addScaledVector(a,u),p}r.copy(e).addScaledVector(i,-1);var m=a.dot(r),f=o.dot(r);if(f>0&&m<=f)return i;var g=m*l-s*f;if(g<=0&&l>=0&&f<=0){var v=l/(l-f),y=this._w4;return y.copy(t).addScaledVector(o,v),y}var w=c*f-m*h;if(w<=0&&h-c>=0&&m-f>=0){var b=(h-c)/(h-c+m-f),x=this._w4;return x.copy(i).addScaledVector(n,-1).multiplyScalar(b).add(n),x}var M=1/(w+g+d),S=g*M,C=d*M,T=this._w4;return T.copy(t).addScaledVector(a,S).addScaledVector(o,C),this._insideFace=!0,T},intersectSphereLine:function(e,t,n,i,a){var o=this._wSL;o.copy(e).addScaledVector(n,-1);var r=o.dot(t),s=o.dot(o)-i;if(s>0&&r>0)return-1;var l=r*r-s;if(l<0)return-2;var c=-r-Math.sqrt(l);return c<0&&(c=0),a.copy(e).addScaledVector(t,c),1},rayTriangleIntersection:function(e,t,n,i,a,o){var r=this._w1,s=this._w2;r.copy(i).addScaledVector(n,-1),s.copy(a).addScaledVector(n,-1);var l=this._w3;l.copy(t).cross(s);var c=r.dot(l);if(c>-1e-6&&c<_i)return-1;var h=1/c,d=this._w4;d.copy(e).addScaledVector(n,-1);var u=h*d.dot(l);if(u<0||u>1)return-2;var p=this._w5;p.copy(d).cross(r);var m=h*t.dot(p);if(m<0||u+m>1)return-3;var f=h*s.dot(p);return f<=_i?-4:(o.copy(e).addScaledVector(t,f),1)},cleanup:function(){this.collisionModelsNeedingStepDown.clear(),this._w1.set(0,0,0),this._w2.set(0,0,0),this._w3.set(0,0,0),this._w4.set(0,0,0),this._w5.set(0,0,0),this._w6.set(0,0,0),this._w7.set(0,0,0),this._wSL.set(0,0,0),this._w8.set(0,0,0),this._w9.set(0,0,0),this._w10.set(0,0,0),this._w11.set(0,0,0),this._w12.set(0,0,0),this._insideFace=!1}});var Di=function(e){this.sweeper=e,this.physics=e.physics,this._w0=new w.Pa4,this._w1=new w.Pa4,this._w2=new w.Pa4,this._vec20=new w.FM8,this._debug=!0};a(Di.prototype,{integrateMovement:function(e){var t=this;this.sweeper.entitiesNeedingToMove.forEach((function(n){return t.integrateEntity(n,e)}))},integrateEntity:function(e,t){var n=t,i=e.collisionModel;r(!i.isStatic,"[Integrator] Trying to integrate a static entity ".concat(e,"."));var a=i.position0,o=i.position1,s=i.velocity0,l=i.velocity1,c=i.accelera0,h=i.accelera1,d=i.gravity,u=this._w1,p=this._w0;if(p.copy(d),i.isSubjectToContinuousForce)for(var m=i.continuousForces,f=0;f<m.length;++f)p.add(m[f]);if(i.isJumping&&(i.timeSinceJumpStarted+=n,i.numberOfIterationsInAir+=1,i.numberOfIterationsInAir),i.isPreparingJump&&(i.timeSincePreparedJump+=n,i.timeSincePreparedJump>i.timeToPrepareJump)){i.isJumping=!0,i.isPreparingJump=!1,i.timeSinceJumpStarted=0,i.numberOfIterationsInAir=0;var g=5.061999999999999/(n*n);c.z=g/4,this.physics.physics.app.engine.audio.playJumpSound()}var v=i.wantedVelocity;v.z>0&&i.onGround&&!i.isPreparingJump&&!i.isJumping&&(i.isPreparingJump=!0,i.timeSincePreparedJump=0,i.isRecoveringFromLanding=!1);var y=n*this.physics.getTimeDilation(a,e);y>.051&&(this._debug&&console.warn("[Integrator] Large DT: ".concat(y,".")),y=.051);var w=this.physics.isWater(a)?i.maxSpeedInWater:i.maxSpeedInAir,b=.5*y*y;u.set(s.x*y+b*c.x,s.y*y+b*c.y,s.z*y+b*c.z);var x=w*y;if(v.manhattanLength()>0){var M=this._w2,S=v.x,C=v.y,T=i.instantaneousAccelerationXY,k=1/i.timeToReachMaxVel,P=i.instantaneousVelocityXY,I=this._vec20;I.set(S,C),T.copy(I).normalize().multiplyScalar(k),T.multiplyScalar(y),P.add(T),P.lengthSq()>S*S+C*C&&P.set(S,C),M.set(P.x*x,P.y*x,0),u.add(M)}var A=Math.sqrt(u.x*u.x+u.y*u.y);A>x&&(u.x*=x/A,u.y*=x/A),u.z<-.4&&(u.z=-.4),o.copy(a).add(u),h.copy(p),l.copy(c).add(h).multiplyScalar(.5*y).add(s);var E=l.length();E>w&&l.z>0&&l.multiplyScalar(w/E)},applyIntegration:function(e){var t=this;this.sweeper.entitiesNeedingToMove.forEach((function(n){return t.applyIntegrationTo(n,e)}))},applyIntegrationTo:function(e){var t=e.collisionModel;if(t.isStatic)throw Error("[Integrator] Can’t integrate a static entity.");t.position0.copy(t.position1),t.velocity0.copy(t.velocity1),t.accelera0.copy(t.accelera1),t.isCharacter&&(t.wasLifted=!1,t.wasLiftedByAStaticObject=!1,t.position0.z<.72&&(t.position0.z=.72,t.position1.z=.72)),this.sweeper.updateOrderedArraysAfterMove(e.entityId),e.center.copy(t.position0),t.updateCollisionModelAfterMovement();var n=this.physics.physics.app;if(0===e.entityId)n.model.backend.selfModel.updateSelf(t.position0,t.rotation0,-1);else{var i=n.model.backend.entityModel,a={};a[e.modelId]={p:t.position0,r:t.rotation0,w:-1},i.updateEntities(a),t.isCharacter||console.error("[Integrator] Entity ".concat(e.entityId," is dynamic but not a character."))}},cleanup:function(){this._w0.set(0,0,0),this._w1.set(0,0,0),this._w2.set(0,0,0)}});var zi=function(e,t,n){this.entityId=e,this.modelId=n,this.indexOnXArray=0,this.indexOnYArray=0,this.indexOnZArray=0,this.center=new w.Pa4,this.center.copy(t),this.collisionModel=null,this.isStatic=!0,this.isIntelligent=!1};function Fi(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}a(zi.prototype,{setCollisionModel:function(e){this.collisionModel=e,this.isStatic=e.isStatic,this.isIntelligent=e.isIntelligent,this.isStatic||(e.position0.copy(this.center),e.position1.copy(this.center))},destroy:function(){this.collisionModel.destroy(),this.center=null,this.collisionModel=null}});const Bi=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"getTimeSecMillis",value:function(){var e=n.g.performance||{},t=.001*(e.now||e.mozNow||e.msNow||e.oNow||e.webkitNow||function(){return(new Date).getTime()}).call(e);return Math.floor(t%1*1e9)/1e6}},{key:"getTimeSecNano",value:function(e){var t,i,a,o,r=n.g.performance||{};return t=e,i=.001*(r.now||r.mozNow||r.msNow||r.oNow||r.webkitNow||function(){return(new Date).getTime()}).call(r),a=Math.floor(i),o=Math.floor(i%1*1e9),t&&(a-=t[0],(o-=t[1])<0&&(a--,o+=1e9)),[a,o]}}],null&&Fi(t.prototype,null),i&&Fi(t,i),e}();var Wi={addCharacterController:function(e){var t=e.position,n=e.id,i=this.addPhysicsEntity(t,{intelligent:!0,static:!1,character:!0,bumperRadius:.5,lifterDelta:.31,lifterRadius:.41},n);e.physicsEntity=i},pushEvent:function(e){var t=this.sweeper.physicsEntities[0];if(t){var n=t.collisionModel,i=n._d,a=!1;if("r"!==e[0]&&"c"!==e[0]||(a=!0),"m"===e[0])switch(e[1]){case"f":i[0]||(a=!0),i[0]=!0;break;case"b":i[1]||(a=!0),i[1]=!0;break;case"r":i[2]||(a=!0),i[2]=!0;break;case"l":i[3]||(a=!0),i[3]=!0;break;case"u":i[4]||(a=!0),i[4]=!0;break;case"d":i[5]||(a=!0),i[5]=!0;break;case"vec":n._ww=e[2],a=!0;break;case"fx":i[0]&&(a=!0),i[0]=!1;break;case"bx":i[1]&&(a=!0),i[1]=!1;break;case"rx":i[2]&&(a=!0),i[2]=!1;break;case"lx":i[3]&&(a=!0),i[3]=!1;break;case"ux":i[4]&&(a=!0),i[4]=!1;break;case"dx":i[5]&&(a=!0),i[5]=!1;break;case"xx":i.fill(!1),a=!0;break;case"vecx":n._ww=null,a=!0;break;default:return}a&&this.computeWantedVelocity(n)}else console.warn("[Mad/Input] Entity ".concat(0," not found."))},computeWantedVelocity:function(e){var t=e.wantedVelocity,n=e._ww,i=e._d,a=i[0]!==i[1],o=i[2]!==i[3],r=i[4]!==i[5],s=e.isPreparingJump;if(!(a||o||r||n))return e.wantsToMove=!1,e.wantedXY.set(0,0),e.instantaneousVelocityXY.set(0,0),t.set(0,0,0),void(s&&(e.wantsToMove=!0));var l=this._q,c=this._f;if(c.set(0,0,-1),this.physics.app.engine.graphics.cameraManager.mainCamera.cameraObject.matrixWorld.decompose(this._p,l,this._s),c.applyQuaternion(l),Math.abs(c.x)+Math.abs(c.y)>.01)t.set(c.x,c.y,0).normalize();else{var h=this._f;h.copy(w.Tme.DefaultUp),h.applyQuaternion(l),t.set(h.x,h.y,0).normalize()}var d=this._ffr,u=this._fto;d.set(0,1,0);var p=1;n?(u.set(n[0],n[1],0),p=u.length(),u.multiplyScalar(1/p)):u.set(i[2]?1:i[3]?-1:0,i[0]?1:i[1]?-1:0,0).normalize(),u.manhattanLength()>0?(l.setFromUnitVectors(d,u),t.applyQuaternion(l)):t.set(0,0,0),t.x*=p,t.y*=p,t.z=i[4]?1:i[5]?-1:0,t.manhattanLength()>0?(e.wantsToMove=!0,e.wantedXY.set(t.x,t.y)):(e.instantaneousVelocityXY.set(0,0),e.wantedXY.set(0,0),s&&(e.wantsToMove=!0))}},ji=1e-5,Ni=function(e,t,n){this.entity=e,this.aabbCenter=new w.Pa4,this.aabbXExtent=new w.FM8,this.aabbYExtent=new w.FM8,this.aabbZExtent=new w.FM8,this.aabbHalf=new w.Pa4,this.p0p1Delta=new w.Pa4(0,0,0),this.isStatic=t.static,this.isIntelligent=t.intelligent,this.position=e.center,this.isStatic||(this.onGround=!1,this.groundNormal=new w.Pa4,this.wantsToMove=!1,this.isSubjectToContinuousForce=!1,this.position0=new w.Pa4,this.position1=new w.Pa4,this.velocity0=new w.Pa4,this.velocity1=new w.Pa4,this.accelera0=new w.Pa4,this.accelera1=new w.Pa4,this.rotation0=new w.Ltg(0,0,0,0),t.variableGravity?this.gravity=new w.Pa4:this.gravity=n.gravity,this.continuousForces=[],this.wantedXY=new w.FM8(0,0),this.instantaneousVelocityXY=new w.FM8(0,0),this.instantaneousAccelerationXY=new w.FM8(0,0),this.timeToReachMaxVel=.2,this.wantedVelocity=new w.Pa4,this.maxSpeedInAir=7,this.maxSpeedInWater=2.5,this.isPreparingJump=!1,this.timeSincePreparedJump=0,this.timeToPrepareJump=.2,this.isFalling=!1,this.isJumping=!1,this.timeSinceJumpStarted=0,this.timeSinceFallStarted=0,this.timeToSetFallState=.4,this.numberOfIterationsInAir=0,this._maxVZ=0,this.hasJustLanded=!1,this.isRecoveringFromLanding=!1,this.timeSinceHasLanded=0,this.timeToRecoverFromLanding=.6,this.onWater=!1,this._d=[!1,!1,!1,!1,!1,!1],this._ww=null),this.isSphere=!1,this.isCharacter=!1,this.isCylinder=!1,this.isTrimesh=!1,this.isPlatform=!1,this.isBox=!1};a(Ni.prototype,{computeBoundingSphere:function(){},computeAABB:function(){console.warn("[CollisionModel]: cannot compute AABB on an abstract.")},computeAABBHalf:function(){this.aabbHalf.set(Math.abs(this.aabbXExtent.x-this.aabbXExtent.y)/2+ji,Math.abs(this.aabbYExtent.x-this.aabbYExtent.y)/2+ji,Math.abs(this.aabbZExtent.x-this.aabbZExtent.y)/2+ji)},updateCollisionModelAfterMovement:function(){console.warn("[CollisionModel]: cannot move an abstract model.")},setGravity:function(e){if(this.isStatic)throw Error("[CollisionModel]: cannot apply gravity to a static object.");this.gravity.copy(e)},stop:function(){this._d[0]=this._d[1]=this._d[2]=this._d[3]=this._d[4]=this._d[5]=!1},getDistanceToTarget:function(){return this.isStatic?0:this.position0.distanceTo(this.position1)},getP0P1Delta:function(){return this.isStatic?(this.p0p1Delta.set(0,0,0),this.p0p1Delta):(this.p0p1Delta.set(Math.abs(this.position0.x-this.position1.x),Math.abs(this.position0.y-this.position1.y),Math.abs(this.position0.z-this.position1.z)),this.p0p1Delta)},getAABBHalf:function(){return this.aabbHalf},destroy:function(){this.isStatic||(this.position0=null,this.position1=null,this.velocity0=null,this.velocity1=null,this.accelera0=null,this.accelera1=null,this.gravity=null,this.wantedVelocity=null,this.continuousForces=null,this.aabbXExtent=null,this.aabbYExtent=null,this.aabbZExtent=null,this.aabbHalf=null,this.p0p1Delta=null,this.aabbCenter=null)}});var Ui={bumpAgainstHeightMap:function(e,t,n,i,a,o){for(var r,s=this._w1,l=this._w2,c=this._w3,h=a.nbVerticesX,d=h-1,u=a.nbVerticesY-1,p=a.elementSizeX,m=a.elementSizeY,f=a.getData().userData.points,g=this.bumperRadius,v=g*g,y=Math.ceil(g/p),w=Math.ceil(g/m),b=Math.max(e-y-1,0),x=Math.min(e+y+1,d),M=Math.max(t-w-1,0),S=Math.min(t+y+1,u),C=M;C<S;++C)for(var T=b;T<x;++T){var k=T+h*C,P=k+h,I=P+1,A=k+1,E=f[k],O=f[P],L=f[I],_=f[A];s.set(T*p,C*m,E),c.set(T*p,(C+1)*m,O),l.set((T+1)*p,C*m,_),r=o.intersectSphereTriOrthogonal(n,v,s,l,c,g,i),this.bump(r),s.set(T*p,(C+1)*m,O),c.set((T+1)*p,(C+1)*m,L),l.set((T+1)*p,C*m,_),r=o.intersectSphereTriOrthogonal(n,v,s,l,c,g,i),this.bump(r)}},liftAgainstHeightMap:function(e,t,n,i,a,o,r){var s=this._w1,l=this._w2,c=this._w3,h=a.nbVerticesX,d=h-1,u=a.nbVerticesY-1,p=a.elementSizeX,m=a.elementSizeY,f=a.getData().userData.points,g=this.lifterRadius,v=g*g,y=this.lifterCenter;y.set(n.x,n.y,n.z-this.lifterDelta);for(var w,b=y.z-g-_i,x=Math.ceil(g/p),M=Math.ceil(g/m),S=Math.max(e-x-1,0),C=Math.min(e+x+1,d),T=Math.max(t-M-1,0),k=Math.min(t+x+1,u),P=this.wasLifted,I=S;I<C;++I)for(var A=T;A<k;++A){var E=I+h*A,O=E+h,L=O+1,_=E+1,R=f[E],D=f[O],z=f[L],F=f[_];R<b&&D<b&&z<b&&F<b||(s.set(I*p,A*m,R),c.set(I*p,(A+1)*m,D),l.set((I+1)*p,A*m,F),w=o.intersectSphereTriVertical(y,v,s,l,c,g,i),this.lift(w,!1,r),s.set(I*p,(A+1)*m,D),c.set((I+1)*p,(A+1)*m,z),l.set((I+1)*p,A*m,F),w=o.intersectSphereTriVertical(y,v,s,l,c,g,i),this.lift(w,!1,r))}this.wasLifted&&a.isWater&&(P||(this.onWater=!0))},bumpAgainstTrimesh:function(e,t,n,i){for(var a,o=t.tris,r=this._w1,s=this._w2,l=this._w3,c=this.bumperRadius,h=c*c,d=o.length/9,u=0;u<d;++u){var p=3*u,m=3*u+1,f=3*u+2;r.set(o[3*p],o[3*p+1],o[3*p+2]),s.set(o[3*m],o[3*m+1],o[3*m+2]),l.set(o[3*f],o[3*f+1],o[3*f+2]),r.z<e.z&&s.z<e.z&&l.z<e.z||(a=i.intersectSphereTriOrthogonal(e,h,r,s,l,c,n),this.bump(a))}},liftAgainstTrimesh:function(e,t,n,i,a){var o,r=t.tris,s=this._w1,l=this._w2,c=this._w3,h=this.lifterRadius,d=h*h,u=this.lifterCenter;u.set(e.x,e.y,e.z-this.lifterDelta);for(var p=r.length/9,m=0;m<p;++m){var f=3*m,g=3*m+1,v=3*m+2;s.set(r[3*f],r[3*f+1],r[3*f+2]),l.set(r[3*g],r[3*g+1],r[3*g+2]),c.set(r[3*v],r[3*v+1],r[3*v+2]),o=i.intersectSphereTriVertical(u,d,s,l,c,h,n),this.lift(o,!0,a)}},bump:function(e){var t=this.position1,n=t.x,i=t.y,a=t.z,o=this.position0,r=o.x,s=o.y,l=o.z,c=n+e.x,h=i+e.y,d=a+e.z,u=!1;if(c>n&&c>r||c<n&&c<r){var p=this.bumperRadius;e.lengthSq()>p*p&&(e.normalize().multiplyScalar(p/2),u=!0)}if(h>i&&h>s||h<i&&h<s){var m=this.bumperRadius;e.lengthSq()>m*m&&(e.normalize().multiplyScalar(m/2),u=!0)}if(d>a&&d>l||d<a&&d<l){this._debug&&console.warn("[Collision/Character] Bumper changed Z."),d=a,e.z=0;var f=this.bumperRadius;e.lengthSq()>f*f&&(e.normalize().multiplyScalar(f/2),u=!0)}u&&(console.log("[Character response] Correcting bump."),c=r,h=s,d=l),e.manhattanLength()>0&&(this._hasBumped=!0),this.position1.set(c,h,d),this.updateBumperLifterAfterChange(e)},lift:function(e,t,n){var i=e.length();i>this.lifterRadius&&(this._debug&&console.warn("[Character/Response] Big lift clamped."),e.multiplyScalar(this.lifterRadius/i));var a=this.position1,o=a.x,r=a.y,s=a.z,l=o+e.x,c=r+e.y,h=s+e.z;i>0&&(t?(this.wasLiftedByAStaticObject=!0,this.onWater=!1):this.wasLifted=!0,this.velocity1.z=0,this.isJumping&&(this.isJumping=!1,this.isPreparingJump=!1,this.hasJustLanded=!0,this.isRecoveringFromLanding=!0,this._maxVZ=0),this.isFalling&&(this.isFalling=!1)),n||(this.position1.set(l,c,h),this.updateBumperLifterAfterChange(e))},stepDown:function(e){var t=this.bumperCenterTest,n=this.bumperCenterTestTranslated;t.copy(this.position1);var i=this._w4;i.copy(this.gravity).negate().normalize(),0===i.manhattanLength()&&(i.z=-10),t.z-=this.stepDownHeight;var a=this.stepDownCollisionData;this.wasLifted=!1,this.wasLiftedByAStaticObject=!1;for(var o=0;o<a.length;++o){var r=a[o];if("hm"===r[0]){var s=r[1],l=s.extentX,c=s.extentY,h=s.nbVerticesX-1,d=s.nbVerticesY-1;n.copy(t);var u=n.x-(s.x-.5)*l,p=n.y-(s.y-.5)*c,m=Math.floor(u/l*h),f=Math.floor(p/c*d);if(n.x=u,n.y=p,this.liftAgainstHeightMap(m,f,n,i,s,e,!0),this.wasLifted)break}else if("s"===r[0]){var g=r[1];if(this.liftAgainstTrimesh(t,g,i,e,!0),this.wasLiftedByAStaticObject)break}}if(!this.wasLiftedByAStaticObject&&!this.wasLifted)return this.onGround=!1,this.onWater=!1,void(this.wasOnGround=!1);this.wasLiftedByAStaticObject&&(this.onWater=!1),this.position1.z-=this.stepDownHeight,t.copy(this.position1);for(var v=0;v<a.length;++v){t.copy(this.position1);var y=a[v];if("hm"===y[0]){n=this.bumperCenter;var w=y[1],b=w.extentX,x=w.extentY,M=w.nbVerticesX-1,S=w.nbVerticesY-1;n.copy(t);var C=n.x-(w.x-.5)*b,T=n.y-(w.y-.5)*x,k=Math.floor(C/b*M),P=Math.floor(T/x*S);n.x=C,n.y=T,this.liftAgainstHeightMap(k,P,n,i,w,e),k=Math.floor(n.x/b*M),P=Math.floor(n.y/x*S),this.bumpAgainstHeightMap(k,P,n,i,w,e)}else if("s"===y[0]){var I=y[1];this.liftAgainstTrimesh(t,I,i,e),t.copy(this.position1),this.bumpAgainstTrimesh(t,I,i,e)}}this.onGround=!0,this.wasOnGround=!0}},Vi=function(e,t,n){Ni.call(this,e,t,n),this.isCharacter=!0,this.lifterCenter=new w.Pa4,this.lifterRadius=t.lifterRadius||.5,this.bumperCenter=new w.Pa4,this.bumperRadius=t.bumperRadius||1,this.lifterDelta=t.lifterDelta||.2,this.maxRadius=Math.max(this.bumperRadius,this.lifterRadius),this.bumperCenterTest=new w.Pa4,this.bumperCenterTestTranslated=new w.Pa4,this.stepDownHeight=this.lifterRadius/8,this.lifterHelper=new w.Kj0(new w.Aip(this.lifterRadius),new w.vBJ({color:65280,wireframe:!0})),this.bumperHelper=new w.Kj0(new w.Aip(this.bumperRadius),new w.vBJ({color:255,wireframe:!0})),this._w1=new w.Pa4,this._w2=new w.Pa4,this._w3=new w.Pa4,this._w4=new w.Pa4,this._w5=new w.Pa4,this.stepDownCollisionData=[],this._debug=!1,this._hasBumped=!1,this.wasLiftedByAStaticObject=!1,this.wasLifted=!1,this.wasOnGround=!1,this.canJumpFromGround=!1};o(Vi,Ni),a(Vi.prototype,{getMaxRadius:function(){return this.maxRadius},computeAABB:function(){var e=this.aabbCenter,t=Math.max(this.bumperRadius,this.lifterRadius),n=e.x-t,i=e.x+t,a=e.y-t,o=e.y+t,r=Math.max(this.lifterDelta+this.lifterRadius,t),s=e.z-r,l=e.z+r;this.aabbXExtent.set(n,i),this.aabbYExtent.set(a,o),this.aabbZExtent.set(s,l),this.computeAABBHalf()},updateCollisionModelAfterMovement:function(){var e=this.entity;this.bumperCenter.copy(e.center),this.aabbCenter.copy(e.center),this.lifterCenter.copy(e.center),this._w1.set(0,0,-this.lifterDelta),this.lifterCenter.add(this._w1)},updateBumperLifterAfterChange:function(e){this.bumperCenter.add(e),this.lifterCenter.add(e)},collideAgainstTerrain:function(e,t,n,i){for(var a=0;a<n.length;++a)this.collideAgainstHeightMap(e,t,n[a],i)},collideAgainstHeightMap:function(e,t,n,i){if(n.isTrimeshMap){var a=n.extentX,o=n.extentY,r=n.nbVerticesX-1,s=n.nbVerticesY-1,l=Math.floor(e/a*r),c=Math.floor(t/o*s),h=this._w4;h.copy(this.gravity).negate().normalize(),0===h.manhattanLength()&&(h.z=-10),this._hasBumped=!1;var d=this.bumperCenter;d.set(e,t,this.position1.z),this.bumpAgainstHeightMap(l,c,d,h,n,i),l=Math.floor(d.x/a*r),c=Math.floor(d.y/o*s),this.liftAgainstHeightMap(l,c,d,h,n,i),this.onGround=this.wasLifted||this.wasLiftedByAStaticObject,this.onGround||(this.onWater=!1),!this.onGround&&this.wasOnGround&&(this.stepDownCollisionData.push(["hm",n]),i.pushCollisionModelForStepDown(this))}else console.log("[Character] Unsupported heightmap type.")},collideAgainstStatic:function(e,t){if(!e.isTrimesh)throw Error("[Character] Only trimeshes can be static.");e.isTrimesh&&this.collideTrimesh(e,t)},collideTrimesh:function(e,t){var n=this._w4;n.copy(this.gravity).negate().normalize(),0===n.manhattanLength()&&(n.z=-10);var i=this.bumperCenter;i.copy(this.position1),this.bumpAgainstTrimesh(i,e,n,t),this.liftAgainstTrimesh(i,e,n,t),this.onGround=this.wasLiftedByAStaticObject,!this.onGround&&this.wasOnGround&&(this.stepDownCollisionData.push(["s",e]),t.pushCollisionModelForStepDown(this))},rayCastDown:function(){},collideAgainstCharacter:function(e){e.isCharacter||console.warn("[Character] expected other character.")},collideAgainstDynamicSphere:function(e){e.isSphere?console.log("[Character] C vs DSph not implemented."):console.warn("[Character] expected dynamic sphere.")}}),a(Vi.prototype,Ui);var Hi=function(e,t,n,i){Ni.call(this,e,t,n),this.isTrimesh=!0,this.positionAttribute=null,this.indexAttribute=null,this.localTransform=new w.yGw,this.localTransformInverse=new w.yGw,i&&(this.trimesh=i,this.localTransform.copy(i.matrixWorld),this.tris=[],this._v=new w.Pa4)};o(Hi,Ni),a(Hi.prototype,{computeAABB:function(){if(this.trimesh){var e=this.trimesh.geometry.index.array,t=this.trimesh.geometry.attributes.position.array,n=Number.POSITIVE_INFINITY,i=Number.POSITIVE_INFINITY,a=Number.POSITIVE_INFINITY,o=Number.NEGATIVE_INFINITY,r=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY,l=e?e.length/3:pos.length/9,c=this._v;this.tris.length=0;for(var h=this.tris,d=0;d<l;++d){var u=e?e[3*d]:3*d,p=e?e[3*d+1]:3*d+1,m=e?e[3*d+2]:3*d+2;c.set(t[3*u],t[3*u+1],t[3*u+2]),c.applyMatrix4(this.localTransform),n=Math.min(n,c.x),i=Math.min(i,c.y),a=Math.min(a,c.z),o=Math.max(o,c.x),r=Math.max(r,c.y),s=Math.max(s,c.z),h.push(c.x),h.push(c.y),h.push(c.z),c.set(t[3*p],t[3*p+1],t[3*p+2]),c.applyMatrix4(this.localTransform),n=Math.min(n,c.x),i=Math.min(i,c.y),a=Math.min(a,c.z),o=Math.max(o,c.x),r=Math.max(r,c.y),s=Math.max(s,c.z),h.push(c.x),h.push(c.y),h.push(c.z),c.set(t[3*m],t[3*m+1],t[3*m+2]),c.applyMatrix4(this.localTransform),n=Math.min(n,c.x),i=Math.min(i,c.y),a=Math.min(a,c.z),o=Math.max(o,c.x),r=Math.max(r,c.y),s=Math.max(s,c.z),h.push(c.x),h.push(c.y),h.push(c.z)}this.aabbXExtent.set(n,o),this.aabbYExtent.set(i,r),this.aabbZExtent.set(a,s),this.aabbCenter.applyMatrix4(this.localTransform)}this.computeAABBHalf()}});var Gi=function(e){this.physics=e,this.sweeper=new Oi(this),this.collider=new Ri(this.sweeper),this.integrator=new Di(this.sweeper),this.gravity=new w.Pa4(0,0,0),this.resetGravity(),this._stamp=Bi.getTimeSecNano(),this._variableDt=!0,this._f=new w.Pa4(0,0,0),this._ffr=new w.Pa4(0,0,0),this._fto=new w.Pa4(0,0,0),this._q=new w._fP,this._p=new w.Pa4,this._s=new w.Pa4};a(Gi.prototype,{resetGravity:function(){this.gravity.set(0,0,-19.6)},initObject:function(){this.sweeper.reorderObjects()},addHeightMap:function(e,t,n){var i=this.sweeper.heightMaps,a="".concat(e,",").concat(t),o=n.nbSegmentsX+1,r=n.nbSegmentsY+1,s=n.isWater,l=new Ht(e,t,o,r,s);n.threeMesh?(l.isTrimeshMap=!0,l.setData(n.threeMesh)):n.heightBuffer?(l.isHeightBuffer=!0,l.setData(n.heightBuffer)):n.analyticExpression&&(l.isAnalytic=!0,l.setData(n.analyticExpression));var c=i.get(a);c||(c=[],i.set(a,c)),c.push(l)},addStaticMesh:function(e){var t=e.position;this.addPhysicsEntity(t,{trimesh:!0,mesh:e,static:!0,intelligent:!1})},addPhysicsEntity:function(e,t,n){var i,a=this.sweeper.reserveEntityId(),o=new zi(a,e,n);return i=t.character?new Vi(o,t,this):t.trimesh?new Hi(o,t,this,t.mesh):new Ni(o,t,this),o.setCollisionModel(i),i.computeAABB(),this.sweeper.addPhysicsEntity(o),o},movePhysicsEntity:function(e){this.sweeper.movePhysicsEntity(e)},loadEntities:function(e){var t=this;e.forEach((function(e){t.loadEntityWithoutSorting(e)})),this.sweeper.reorderObjects()},loadEntityWithoutSorting:function(e){this.sweeper.addPhysicsEntityWithoutSorting(e)},solve:function(){var e;if(e=this._variableDt?Bi.getTimeSecNano(this._stamp)[1]/1e6:16.7,this._stamp=Bi.getTimeSecNano(),this.sweeper.refreshEntitiesNeedingMovement(),!(this.sweeper.entitiesNeedingToMove.length<1))return this.integrator.integrateMovement(e/1e3),this.sweeper.sweepDetectOverlappingPairs(),this.collider.collidePairs(),this.collider.collideTerrain(),this.collider.stepDownEntities(),this.integrator.applyIntegration(e),e},getTimeDilation:function(){return 1},isWater:function(){return!1},cleanup:function(){this.resetGravity(),this.sweeper.cleanup(),this.collider.cleanup(),this.integrator.cleanup()}}),a(Gi.prototype,Wi);var qi=function(e){this.app=e,this.isLoaded=!1,this.useBullet=!1,this.bulletEngine=new Ai(this),this.madEngine=new Gi(this)};a(qi.prototype,{preload:function(){this.useBullet?this.bulletEngine.preload():this.isLoaded=!0},init:function(){},refresh:function(){var e=this.madEngine.solve();return this.useBullet&&this.bulletEngine.refresh(),e},addHeightMap:function(e,t,n,i){this.madEngine.addHeightMap(0,0,{threeMesh:e,nbSegmentsX:t,nbSegmentsY:n,isWater:i})},addStaticMesh:function(e){this.madEngine.addStaticMesh(e)},pushEvent:function(e){this.madEngine.pushEvent(e)},addCharacterController:function(e){this.madEngine.addCharacterController(e)},cleanupFullPhysics:function(){this.madEngine.cleanup(),this.bulletEngine.cleanup()}});var Yi,Xi=Xi||{Core:{}};Xi.Core=function(){this.state=new v(this),this.engine={graphics:new Ke(this),audio:new dt(this),ai:new Zn(this),physics:new qi(this),controls:new Ot(this),settings:new zt(this),ux:new Nt(this)},this.model={levels:new wn(this),backend:new Bn(this),frontend:new Un(this)},this.register=new Gn(this),this.register.registerDefaultModules()},a(Xi.Core.prototype,{start:function(){var e=this;this.setState("loading"),this.engine.graphics.preload().then((function(){return e.setState("main")}))},stop:function(){this.setState("loading"),this.stopGame()}}),a(Xi.Core.prototype,{getState:function(){return this.state.state},setState:function(e,t){this.state.setState(e,t)},isLoading:function(){return"loading"===this.getState()},isFocused:function(){return this.state.focus},setFocused:function(e){this.state.focus=!!e},configureGame:function(e){console.log("[Main] Configuring Game..."),this.setState("preingame"),this.model.frontend.init(),this.model.backend.init(e)},runGame:function(){console.log("[Game/Client] Starting game."),this.engine.graphics.resize(),this.engine.controls.run(),this.engine.audio.run(),this.register.gameStarted()},stopGame:function(){this.register.gameStopped(),this.engine.ux.setGamePaused(!0),this.engine.graphics.stop(),this.engine.controls.stop(),this.engine.audio.stop(),this.model.backend.cleanupFullModel(),this.model.frontend.cleanupFullModel(),this.engine.graphics.cleanupFullGraphics(),this.engine.physics.cleanupFullPhysics(),this.engine.ai.cleanupFullAI(),this.state.cleanupDOM()}}),a(Xi.Core.prototype,{registerModule:function(){},restartModule:function(){}}),window.register=((Yi=new Xi.Core).start(),Yi.register)},29:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>f});var i=n(645),a=n.n(i),o=n(165),r=n(594),s=n(275),l=n(378),c=n(424),h=n(883),d=n(84),u=n(698),p=n(826),m=a()((function(e){return e[1]}));m.i(o.Z),m.i(r.Z),m.i(s.Z),m.i(l.Z),m.i(c.Z),m.i(h.Z),m.i(d.Z),m.i(u.Z),m.i(p.Z),m.push([e.id,'/* Vendor */\n\n/* Includes */\n/* inject:css */\n/* endinject */\n\n/* This removes the resizing glitch (no scrolling) */\nbody, html {\n    overflow: hidden !important;\n}\n\nbody::-webkit-scrollbar {\n    display: none;\n}\n\n.browserupgrade {\n    margin: 0.2em 0;\n    background: #ccc;\n    color: #000;\n    padding: 0.2em 0;\n}\n\n.ie10-11 {\n    display: none;\n}\n\n@media screen and (-ms-high-contrast: active), (-ms-high-contrast: none) {\n    /* IE-only styles here. Works for IS 10 & IE 11 */\n    .ie10-11 {\n        display: block;\n    }\n    body {\n        color: black;\n        background: white;\n    }\n    .smartphones {\n        display: none !important;\n    }\n}\n\n/* Main */\n\nhtml {\n    width: 100%;\n    height: 100%;\n}\n\nbody {\n    font-family: "Raleway", Raleway, sans-serif;\n    margin: 0;\n    padding: 0;\n    color: #db8e65;\n    width: 100%;\n    height: 100%;\n}\n\n#background {\n    position: fixed;\n    width: 100%;\n    height: 100%;\n    background-color: #16122c;\n    background-attachment: fixed;\n}\n\ncanvas {\n    top: 0; left: 0;\n    position: absolute;\n    z-index: 2;\n}\n\n.small-title {\n    position: relative;\n    display: block;\n    font-family: "Raleway", Raleway, sans-serif;\n    text-align: center;\n    padding-bottom: 40px;\n}\n\n.btn-outline-light {\n    background-color: #81411e;\n    border-color: #9e4f25;\n}\n\n.btn-outline-secondary {\n    background-color: #2b2356;\n    border-color: #372d6e;\n}\n\n.btn-outline-light:hover {\n    background-color: #9e4f25;\n    border-color: #9e4f25;\n}\n\n.btn-outline-secondary:hover,\n.btn-outline-secondary.gamepad-selected\n{\n    background-color: #423685;\n    border-color: #4e409c;\n}\n\n.btn-outline-light:active:focus {\n    background-color: #9e4f25 !important;\n    color: #c1ccc5 !important;\n    border: none !important;\n    box-shadow: none !important;\n    outline: none !important;\n}\n\n.btn {\n    font-weight: bold;\n    color: #c1ccc5;\n}\n\n.btn:hover {\n    color: #c1ccc5;\n}\n\n/* Main Menu */\n\n.main-menu,\n.level-select {\n    position: absolute;\n    display: block;\n    width: 100%;\n    padding-top: 50px;\n    padding-bottom: 50px;\n}\n\n.status-checking {\n    color: rgb(255, 255, 255);\n    background-color: rgb(240, 173, 78);\n    border-color: rgb(238, 162, 54);\n}\n\n.status-connected {\n    color: rgb(255, 255, 255);\n    background-color: rgb(92, 184, 92);\n    border-color: rgb(76, 174, 76);\n}\n\n.status-error {\n    color: rgb(255, 255, 255);\n    background-color: rgb(217, 83, 79);\n    border-color: rgb(212, 63, 58);\n}\n\n@media (max-width: 560px) {\n    html, body {\n        font: 0.8em "Source Sans Pro", "Helvetica Neue", Arial, sans-serif;\n        background-color: #458cd3;\n        text-align: center;\n    }\n    #background, #announce, #widget, #container, canvas\n    {\n        display: none !important;\n    }\n    .smartphones {\n        color: white;\n        display: block;\n        -webkit-animation: smanim 5s linear infinite;\n        -moz-animation: smanim 5s linear infinite;\n        -o-animation: smanim 5s linear infinite;\n    }\n    .hea1 {\n        padding-top: 50px;\n        font-size: 20pt; color: white;\n    }\n}\n\n@media (min-width: 560px) {\n    .smartphones {\n        display: none;\n    }\n}\n\n.not-done-loading {\n    display: none;\n}\n',""]);const f=m},378:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,"\n/* TODO [LOW] fonts alt dl local */\n\n/* latin-ext */\n@font-face {\n    font-family: 'Raleway';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/raleway/v18/1Ptug8zYS_SKggPNyCMIT5lu.woff2) format('woff2');\n    unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n    font-family: 'Raleway';\n    font-style: normal;\n    font-weight: 400;\n    src: url(https://fonts.gstatic.com/s/raleway/v18/1Ptug8zYS_SKggPNyC0ITw.woff2) format('woff2');\n    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}\n/* latin-ext */\n@font-face {\n    font-family: 'Raleway';\n    font-style: normal;\n    font-weight: 700;\n    src: url(https://fonts.gstatic.com/s/raleway/v18/1Ptug8zYS_SKggPNyCMIT5lu.woff2) format('woff2');\n    unicode-range: U+0100-024F, U+0259, U+1E00-1EFF, U+2020, U+20A0-20AB, U+20AD-20CF, U+2113, U+2C60-2C7F, U+A720-A7FF;\n}\n/* latin */\n@font-face {\n    font-family: 'Raleway';\n    font-style: normal;\n    font-weight: 700;\n    src: url(https://fonts.gstatic.com/s/raleway/v18/1Ptug8zYS_SKggPNyC0ITw.woff2) format('woff2');\n    unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02BB-02BC, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2122, U+2191, U+2193, U+2212, U+2215, U+FEFF, U+FFFD;\n}\n",""]);const o=a},883:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,"/* Menus */\n\n#widget {\n    z-index: 4;\n    top: 0; left: 0;\n    position: absolute;\n}\n\n#announce {\n    z-index: 3;\n    font-weight: bold;\n}\n\n#announce .table-bordered th, #announce .table-bordered td {\n    /*border: 1px solid #495057;*/\n    /*border: 1px solid orange;*/\n}\n\n#announce .table th, #announce .table td {\n    border: none;\n}\n\n.table {\n    border: 1px solid #2b2356 !important;\n    background: rgba(43, 35, 86, 0.8);\n    border-collapse: separate;\n    border-spacing: 2px;\n}\n\n#announce tr {\n    background-color: #2b2356;\n    color: #db805e;\n    cursor: pointer;\n}\n\n#announce tr:hover,\n#announce tr.gamepad-selected {\n    background-color: #413786;\n    color: #db805e;\n}\n\n/* Helpers */\n\n#hud {\n    position: absolute;\n    z-index: 3;\n}\n\n#position {\n    font-size: 16pt;\n}\n\n#diagram {\n\n}\n\n/* Items */\n\n#items {\n    position: absolute;\n    z-index: 3;\n    bottom: 20px;\n    left: 0;\n    right: 0;\n    margin: 0 auto;\n    width: 464px;\n}\n\n#items #item-table {\n    position: relative;\n}\n\n#item-table .square {\n    border: 2px solid black;\n    float: left;\n    float-wrap: wrap;\n    position: relative;\n    width: 54px;\n    padding-bottom: 50px;\n    margin: 0 2px;\n    overflow: hidden;\n}\n\n#item-table .content.selected {\n    background-color: #c96530;\n}\n\n#item-table .content {\n    background-color: transparent;\n    text-align: center;\n    position: absolute;\n    height: 100%;\n    width: 100%;\n    padding: 5px;\n}\n\n.content img {\n    width: 40px;\n    height: 40px;\n}\n\n/* In-game */\n\n.reticle-wrapper {\n    width: 32px;\n    height: 32px;\n}\n\n.reticle {\n    right: 32px;\n    top: 32px;\n    width: 32px;\n    height: 32px;\n    opacity: 0.3;\n}\n\n.reticle:before, .reticle:after {\n    position: absolute;\n    left: 15px;\n    content: ' ';\n    height: 33px;\n    width: 2px;\n    background-color: white;\n    color: white;\n}\n\n.reticle:after {\n    transform: rotate(90deg);\n}\n",""]);const o=a},84:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,'/* Text */\n\n.title {\n    margin: 20px auto;\n    /*font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;*/\n    font-family: "Raleway", Raleway, sans-serif;\n    font-size: 24px;\n    text-align: center;\n}\n\n#loading-file {\n    font-weight: lighter;\n    font-size: small;\n}\n\n#loading-task {\n    text-align: center;\n}\n\n.loading-menu {\n    text-align: center;\n}\n',""]);const o=a},424:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,'\n/* Slider */\n\n.slider {\n    /*margin-top: 10px;*/\n    /*margin-bottom: 10px;*/\n    -webkit-appearance: none;  /* Override default CSS styles */\n    appearance: none;\n    width: 100%; /* Full-width */\n    height: 5px; /* Specified height */\n    background: #403480; /* Grey background */\n    outline: none; /* Remove outline */\n    opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */\n    -webkit-transition: .2s; /* 0.2 seconds transition on hover */\n    transition: opacity .2s;\n}\n\n/* Mouse-over effects */\n.slider:hover {\n    opacity: 1; /* Fully shown on mouse-over */\n}\n\n/* The slider handle (use -webkit- (Chrome, Opera, Safari, Edge) and -moz- (Firefox) to override default look) */\n.slider::-webkit-slider-thumb {\n    -webkit-appearance: none; /* Override default look */\n    appearance: none;\n    width: 20px; /* Set a specific slider handle width */\n    height: 20px; /* Slider handle height */\n    border-radius: 50%;\n    background: #db805e; /* Green background */\n    cursor: pointer; /* Cursor on hover */\n}\n\n.slider::-moz-range-thumb {\n    width: 20px; /* Set a specific slider handle width */\n    height: 20px; /* Slider handle height */\n    border-radius: 50%;\n    background: #db805e; /* Green background */\n    cursor: pointer; /* Cursor on hover */\n}\n\n/* Gamepad */\n\n#gamepad-detector {\n    margin-top: 0 !important;\n}\n\n.gamepad-status {\n    display: flex;\n    align-items: center;\n}\n\n.nested-icon {\n    color: rgba(217, 83, 79, 0.7);\n}\n\n/* Gameplay */\n\n.camspeed-control-wrapper {\n    border-radius: 5px;\n}\n\ntr.camspeed-control-wrapper.gamepad-selected {\n    background-color: #413786;\n}\n\n/* Audio */\n\n.slider-container {\n    display: flex;\n    align-items: center;\n}\n\n#volume-status {\n    color: #db805e;\n    cursor: pointer;\n}\n\n#volume-control-wrapper {\n    border-radius: 5px;\n}\n\n#volume-control-wrapper.gamepad-selected {\n    background-color: #413786;\n}\n\n#settings-audio-volume {\n    padding: 0;\n}\n\n#settings-inner-audio-volume {\n    margin-bottom: 0.5rem;\n}\n\n/* w3schools switch */\n\n/* The switch - the box around the slider */\n.w3switch {\n    position: relative;\n    display: inline-block;\n    width: 30px;\n    height: 17px;\n}\n\n/* Hide default HTML checkbox */\n.w3switch input {\n    opacity: 0;\n    width: 0;\n    height: 0;\n}\n\n/* The slider */\n.w3slider {\n    position: absolute;\n    cursor: pointer;\n    top: 0;\n    left: 0;\n    right: 0;\n    bottom: 0;\n    background-color: #ccc;\n    -webkit-transition: .2s;\n    transition: .2s;\n}\n\n.w3slider:before {\n    position: absolute;\n    content: "";\n    height: 13px;\n    width: 13px;\n    left: 2px;\n    bottom: 2px;\n    background-color: white;\n    -webkit-transition: .2s;\n    transition: .2s;\n}\n\ninput:checked + .w3slider {\n    background-color: #2196F3;\n}\n\ninput:focus + .w3slider {\n    box-shadow: 0 0 1px #2196F3;\n}\n\ninput:checked + .w3slider:before {\n    -webkit-transform: translateX(13px);\n    -ms-transform: translateX(13px);\n    transform: translateX(13px);\n}\n\n/* Rounded sliders */\n.w3slider.w3round {\n    border-radius: 17px;\n}\n\n.w3slider.w3round:before {\n    border-radius: 50%;\n}\n\n/* Level select */\n\n.btn-outline-light.gamepad-selected {\n    background-color: #db805e;\n}\n\n.announce {\n    padding-top: 50px;\n    padding-bottom: 50px;\n}\n\n.announce #game-instances-table {\n    position: relative;\n    display: block;\n}\n\n.announce .table-bordered th, .announce .table-bordered td {\n    border: 1px solid #495057;\n}\n\n/* Load / save */\n\n.input-group-text,\n.custom-file-input, .custom-file-label\n{\n    background-color: #2b2356;\n    color: #db805e;\n    border-color: #686156;\n}\n\n.custom-file-input[disabled] ~ .custom-file-label, .custom-file-input:disabled ~ .custom-file-label,\n.custom-file-label::after\n{\n    background-color: #2b2356;\n    color: #db805e;\n    border-color: #686156;\n}\n\n/* Separator */\n\nhr {\n    display: block;\n    position: relative;\n    border-color: transparent;\n}\n',""]);const o=a},698:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,".noselect {\n    -webkit-touch-callout: none; /* iOS Safari */\n    -webkit-user-select: none;   /* Chrome/Safari/Opera */\n    -khtml-user-select: none;    /* Konqueror */\n    -moz-user-select: none;      /* Firefox */\n    -ms-user-select: none;       /* Internet Explorer/Edge */\n    user-select: none;           /* Non-prefixed version, currently\n                                  not supported by any browser */\n}\n",""]);const o=a},826:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,'/* In-game settings menus */\n\n.settings {\n    width: 50%;\n    font-family: "Raleway", Raleway, sans-serif;\n    font-size: 16px;\n    text-align: center;\n\n    position: absolute;\n    display: block;\n}\n\n.settings>table,\n.settings>.container>table\n{\n    margin-bottom: 0;\n}\n',""]);const o=a},275:(e,t,n)=>{"use strict";n.d(t,{Z:()=>o});var i=n(645),a=n.n(i)()((function(e){return e[1]}));a.push([e.id,'\n.text-label {\n    color: #ffffff;\n\n    text-shadow: 0 0 2px #000000, 0 0 4px #000000;\n\n    font-weight: bold;\n    font-size: 14pt;\n    font-family: "Fira Mono", Monaco,\n        "Andale Mono", "Lucida Console",\n        "Bitstream Vera Sans Mono", "Courier New",\n        Courier, monospace;\n    margin: -5px 0 0 15px;\n    pointer-events:none;\n}\n',""]);const o=a},493:(e,t,n)=>{"use strict";var i=n(379),a=n.n(i),o=n(29),r=a()(o.default,{insert:"head",singleton:!1});if(!o.default.locals||e.hot.invalidate){var s=o.default.locals;e.hot.accept(29,(t=>{o=n(29),function(e,t,n){if(!e&&t||e&&!t)return!1;var i;for(i in e)if(e[i]!==t[i])return!1;for(i in t)if(!e[i])return!1;return!0}(s,o.default.locals)?(s=o.default.locals,r(o.default)):e.hot.invalidate()}))}e.hot.dispose((function(){r()})),o.default.locals}},0,[[370,666,216]]]);